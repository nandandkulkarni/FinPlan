@page "/retirement-feedback-simple"
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.JSInterop
@using System.Text.Json
@using System.Net.Http.Json
@using FinPlan.Web.Components.Models
@inject IJSRuntime JSRuntime
@inject IHttpClientFactory HttpClientFactory
@inject FinPlan.Web.Services.UserGuidService UserGuidService
@inject IConfiguration Configuration

<PageTitle>Retirement Feedback (Simple)</PageTitle>

<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-sm mb-4">

                @if (questions is not null && questions.Count > 0)
                {
                    @foreach(var question in questions)
                    {
                        <div class="mb-2">
                            <span class="badge bg-secondary me-2">@question.QuestionText</span>
                            @if (question.Options?.Count > 0)
                            {
                                @foreach (var opt in question.Options)
                                {
                                    <button type="button" class="btn btn-outline-secondary btn-sm me-1" @onclick="() => OnMcqSelectedAsync(question.QuestionText, opt)">@opt</button>
                                }
                            }
                        </div>
                    }
                }

                <div class="card-body">
                    <h3 class="mb-3">Retirement Drawdown Feedback</h3>
                    <p class="text-muted">Please answer the question below. Your answers are not personally identifiable.</p>

                    <SurveyContainer Title="Multiple Choice (example)">
                        <McqQuestion Question="@mcqQuestion1" Selected="@OnMcqSelectedHandler" />
                    </SurveyContainer>

                    <SurveyContainer Title="Open-Ended">
                        <EssayQuestion Question="@essayQuestionObj" Answer="@essayAnswer" AnswerChanged="@OnEssayChangedHandler" />
                    </SurveyContainer>

                    <div class="mt-4 text-end">
                        <button class="btn btn-primary" @onclick="SubmitAsync">Submit</button>
                    </div>

                    @if (!string.IsNullOrEmpty(statusMessage))
                    {
                        <div class="alert alert-success mt-3">@statusMessage</div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    // question constants used by handlers
    private SurveyQuestion mcqQuestion1 = new SurveyQuestion("How easy was it to use the Retirement Drawdown Planner?", new List<string> { "Very Easy", "Easy", "Neutral", "Difficult", "Very Difficult" });
    private const string essayQuestion = "Please describe anything you found confusing or suggestions for improvement:";
    private SurveyQuestion essayQuestionObj = default!;
    private const string mcAnaswer1 = "Very Easy";

    private string essayAnswer = string.Empty;
    private string selectedMcqAnswer = string.Empty;
    private string statusMessage = string.Empty;

    // Store answers uniquely by question text
    private readonly Dictionary<string, string> answers = new();

    private List<SurveyQuestion> questions = new List<SurveyQuestion>()
    {
       new SurveyQuestion("How easy was it to use the Retirement Drawdown Planner?", new List<string> { "Very Easy", "Easy", "Neutral", "Difficult", "Very Difficult" }),
       new SurveyQuestion("Please describe anything you found confusing or suggestions for improvement:"),
       new SurveyQuestion("How likely are you to recommend our service to a friend or colleague?", new List<string> { "Very Likely", "Likely", "Neutral", "Unlikely", "Very Unlikely" })
    };

    private string userGuid = string.Empty;
    private readonly string surveyType = "RetirementDrawdown";

    protected override async Task OnInitializedAsync()
    {
        try
        {
            userGuid = await UserGuidService.GetOrCreateUserGuidAsync();
        }
        catch
        {
            userGuid = Guid.NewGuid().ToString();
        }

        // initialize derived question objects
        essayQuestionObj = new SurveyQuestion(essayQuestion);
    }

    private void CloseDetailsModal()
    {
        // Logic to close the modal can be implemented here
    }

    // store MCQ answer (ensures no duplicate questions - dictionary key enforces uniqueness),
    // then convert current answers to JSON and print to browser console and save via API
    private async Task OnMcqSelectedAsync(string questionText, string chosenAnswer)
    {
        if (string.IsNullOrEmpty(questionText)) return;

        answers[questionText] = chosenAnswer; // add or replace
        selectedMcqAnswer = chosenAnswer;
        statusMessage = $"Recorded: '{questionText}' → '{chosenAnswer}'";

        await PrintAnswersJsonAsync();
        await SaveAnswersToApiAsync();
        StateHasChanged();
    }

    private Task OnMcqSelectedHandler(string selected)
    {
        return OnMcqSelectedAsync(mcqQuestion1.QuestionText, selected);
    }

    // store essay answer and print JSON and save
    private async Task OnEssayChangedAsync(string questionText, string currentAnswer)
    {
        if (string.IsNullOrEmpty(questionText)) return;

        answers[questionText] = currentAnswer;
        statusMessage = $"Essay updated for: '{questionText}'";

        await PrintAnswersJsonAsync();
        await SaveAnswersToApiAsync();
        StateHasChanged();
    }

    private Task OnEssayChangedHandler(string value)
    {
        return OnEssayChangedAsync(essayQuestion, value);
    }

    // Convert answers dictionary to JSON and print to browser console
    private async Task PrintAnswersJsonAsync()
    {
        try
        {
            // create an array of { question, answer } objects for nicer JSON
            var payload = answers.Select(kvp => new { Question = kvp.Key, Answer = kvp.Value }).ToArray();
            var json = JsonSerializer.Serialize(payload, new JsonSerializerOptions { WriteIndented = true });

            // print to browser console
            await JSRuntime.InvokeVoidAsync("console.log", json);

            // also write to server console (useful during server-side debugging)
            Console.WriteLine(json);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error serializing answers: {ex}");
        }
    }

    private async Task SaveAnswersToApiAsync()
    {
        var apiBase = GetApiBaseUrl();

        try
        {
            var client = HttpClientFactory.CreateClient("Api");
            var req = new
            {
                UserGuid = userGuid,
                SurveyType = surveyType,
                SurveyJson = answers
            };

            await client.PostAsJsonAsync(apiBase + "/api/survey/save", req);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving survey: {ex}");
        }
    }

    private async Task SubmitAsync()
    {
        // Final submission logic can be implemented here.
        // For now show a confirmation message and save
        statusMessage = $"Submitted MCQ: '{selectedMcqAnswer}' and Essay length: {essayAnswer?.Length ?? 0}";
        await PrintAnswersJsonAsync();
        await SaveAnswersToApiAsync();
    }

    private string GetApiBaseUrl()
    {
#if DEBUG
                        return Configuration["FinPlanSettings:ApiBaseUrlLocal"] ?? "https://localhost:7330";
#else
        return Configuration["FinPlanSettings:ApiBaseUrlCloud"] ?? "api-money-amperespark-bnbva5h5g6gme6fm.eastus2-01.azurewebsites.net";
#endif
    }

}