@page "/future-cost-of-living"
@using FinPlan.Shared.Models.LivingCosts
@using FinPlan.Web.Components
@using FinPlan.Web.Pages.CostOfLiving.Components
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.JSInterop
@using FinPlan.Web.Services
@inject IHttpClientFactory HttpClientFactory
@inject IConfiguration Configuration
@inject IJSRuntime JSRuntime
@inject FinPlan.Web.Services.UserGuidService UserGuidService
@inject NavigationManager Navigation
<style>
    /* ----------------------------
                                                                                                                           Tweakable values
                                                                                                                           - TAB_PANEL_TOP_OFFSET: how far the panel is pulled up under the tabs (negative pulls up)
                                                                                                                           - TAB_PANEL_PADDING_TOP: extra top padding inside the panel to avoid overlapping content
                                                                                                                           Adjust these values to fine tune the 'kiss' between tabs and panel.
                                                                                                                           ---------------------------- */
    /* Example: change --tab-panel-top-offset to -8px or -4px to tweak */
    /* CSS variables used below for convenience */
    :root {
        --tab-panel-top-offset: -6px; /* Tweak this to move the panel up/down (more negative => more overlap) */
        --tab-panel-padding-top: 26px; /* Tweak this to add internal spacing at top if panel overlaps tabs */
    }

    .survey-card {
        border-right: 8px solid #1F6FEB !important;
        border-top: 1px solid #e9ecef;
        border-bottom: 1px solid #e9ecef;
        border-left: 1px solid #e9ecef;
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(31,111,235,0.08);
        background: #fff;
    }

    .survey-card-narrow {
        width: 75%;
        min-width: 180px;
        max-width: 320px;
        margin-left: 0;
        margin-right: auto;
        align-self: flex-start;
    }

    /* Compact Mode Toggle Styles */
    .form-switch .form-check-input {
        transition: all 0.2s ease;
    }

        .form-switch .form-check-input:checked {
            background-color: #0d6efd;
            border-color: #0d6efd;
        }

        .form-switch .form-check-input:focus {
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.2);
        }

    /* Large form switch for modal - 2x bigger */
    .form-check-modal-lg .form-check-input {
        width: 4rem;
        height: 2rem;
    }

    .form-check-modal-lg .form-check-label {
        font-size: 1rem;
        font-weight: 600;
        margin-left: 0.75rem;
    }

    .modal-mode-toggle {
        padding: 0.5rem 1rem;
        background: rgba(13, 110, 253, 0.05);
        border: 1px solid rgba(13, 110, 253, 0.1);
        border-radius: 8px;
    }


    /* Add missing empty-state styles */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 10px;
    }


    .start-planning-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(1px);
        z-index: 20;
        pointer-events: none;
    }

        .start-planning-overlay .empty-state {
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid #FFD600;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            margin: 20px;
            border-radius: 12px;
            padding: 40px;
            pointer-events: auto; /* Ensure the overlay content is clickable */
        }
    /* ensure tab row doesn't leave default bottom spacing */
    /* .nav, .nav-tabs, .nav.nav-tabs.mb-3 {
                                                margin-bottom: 0 !important; /* override bootstrap utility margin */
    padding-bottom: 0;
    position: relative; /* allow stacking with panel box */
    z-index: 100;
    }
    */

    /* Ensure navigation stays clickable */
    /* .nav, .nav-tabs, .nav.nav-tabs.mb-3 {
                                                margin-bottom: 0 !important;
                                                padding-bottom: 0;
                                                position: relative;
                                                z-index: 200; /* Higher than overlay */
    }

    */
    /* Ensure the top navigation stays above the overlay */
    .top-strip {
        position: relative;
        z-index: 1030; /* This matches your MainLayout z-index */
    }
    /* Blur and disable the tab navigation when overlay is active */
    .nav-tabs.overlay-blur {
        filter: blur(2px);
        transition: filter 0.3s ease;
        pointer-events: none; /* This makes the tabs non-clickable */
        opacity: 0.7; /* Optional: reduce opacity to make it more obvious they're disabled */
    }

    .section-card {
        /* darker border for stronger separation from the background */
        border: 1px solid rgba(16,24,36,0.12);
        padding: 10px;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        min-height: 92px;
        background: #fff;
    }

        .section-card .actions {
            margin-top: auto; /* push to bottom of the card */
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

    /* Totals boxes - make clearly non-interactive */
    .totals-box {
        cursor: default;
        user-select: none;
        box-shadow: none;
        border: none;
        border-left: 4px solid rgba(255, 255, 255, 0.4);
        border-right: 4px solid rgba(255, 255, 255, 0.4);
        border-top: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 12px 12px 0 0;
        min-width: 180px;
        transition: none;
        background-image: linear-gradient(to bottom, rgba(255, 255, 255, 0.1), transparent);
    }

    .totals-box:hover {
        transform: none;
    }

    .totals-box:active {
        transform: none;
    }

    .totals-label {
        font-size: 0.85rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        opacity: 0.95;
        margin-bottom: 4px;
    }

    .totals-value {
        font-size: 1.75rem;
        font-weight: 700;
        line-height: 1.2;
    }

    /* Info icon in totals should be clearly clickable */
    .totals-label .bi-info-circle {
        cursor: pointer;
        opacity: 0.9;
        transition: opacity 0.2s;
    }

    .totals-label .bi-info-circle:hover {
        opacity: 1;
    }

    .btn-edit {
        background: #1F6FEB; /* professional blue */
        color: #ffffff;
        border: 0;
        padding: 7px 12px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        /* Force left alignment inside the .actions flex container */
        margin-right: auto;
        align-self: center; /* keep vertical centering in the flex row */
    }


    /* Ensure left sidebar navigation stays clickable */
    .col-12.col-md-2 {
        position: relative;
        z-index: 150; /* Higher than overlay */
    }



    /* Panel that encloses everything below the tabs.
                                                                                                                           Use positioning (top) instead of negative margin to avoid layout gaps from surrounding elements.
                                                                                                                           Tweak the CSS variables above to adjust placement and padding. */
    .tab-panel-box {
        border: 2px solid #C79A00; /* dark yellow border */
        border-radius: 8px; /* matches tab corner feel */
        padding: var(--tab-panel-padding-top) 18px 20px 18px; /* top padding controlled by variable */
        margin-top: 0; /* reset margin approach */
        top: var(--tab-panel-top-offset); /* pull panel up under tabs - adjust variable above */
        position: relative; /* enable top offset */
        background: #ffffff; /* panel background; adjust for dark theme if needed */
        box-shadow: 0 4px 12px rgba(0,0,0,0.04);
        z-index: 10;
        /* ensure panel's top border isn't clipped by parent overflow */
        overflow: visible;
    }

    /* If using dark theme, slightly different background so border remains visible */
    .dark-theme .tab-panel-box {
        background: #171717;
    }

    /* Ensure active tab renders above the panel */
    .tab-item-active, .nav-link.tab-active-custom {
        position: relative;
        z-index: 30;
        margin-bottom: 0; /* prevent extra gap from tab element itself */
    }

    /* keep panel content visually aligned with rounded active tab */
    .tab-active-custom {
        background-color: #FFD600 !important;
        color: #222 !important;
        font-weight: 600;
        border: 1px solid #FFD600 !important;
        border-bottom: none !important;
        border-radius: 8px 8px 0 0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.07);
        transition: background 0.2s, color 0.2s;
    }

    .tab-item-active {
        background: #FFD600;
        border-radius: 8px 8px 0 0;
        padding: 4px 6px;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

        .tab-item-active .nav-link {
            background: transparent !important;
            border: none !important;
            color: #222 !important;
            font-weight: 600;
            padding: 0.18rem 0.4rem;
        }

    .grid-yellow-bg {
        background: transparent; /* remove yellow fill */
        border-radius: 0.75rem;
        border: 1px solid rgba(255,214,0,0.18); /* keep border as requested */
        box-shadow: none; /* remove shadow */
        padding: 1rem;
    }

    /* Use Bootstrap grid for layout (2-8-2). Left and right column styling intentionally minimal so Bootstrap handles spacing. */
    /* Remove fixed sidebars; layout is now responsive using Bootstrap classes in the markup. */


    .container-fluid {
        padding-left: 16px;
        padding-right: 16px;
        box-sizing: border-box;
    }

    @@media (max-width: 992px) {
        .container-fluid {
            padding-left: 16px !important;
            padding-right: 16px !important;
        }
    }

    .sidebar-link-highlight {
        background: linear-gradient(90deg,#FFD600,#FFB800);
        color: #111 !important;
        font-weight: 700;
        padding: 10px 12px;
        border-radius: 8px;
        box-shadow: 0 8px 20px rgba(0,0,0,0.12);
        display: flex;
        align-items: center;
        gap: 8px;
        text-decoration: none;
        transition: transform 0.12s ease, box-shadow 0.12s ease;
        border: 1px solid rgba(0,0,0,0.04);
    }

        /* Slight lift on hover/focus */
        .sidebar-link-highlight:hover,
        .sidebar-link-highlight:focus {
            transform: translateY(-2px);
            box-shadow: 0 12px 28px rgba(0,0,0,0.16);
            text-decoration: none;
        }

        /* Make icon slightly larger inside highlighted link */
        .sidebar-link-highlight .bi {
            font-size: 1.05rem;
        }

    /* Ensure it stacks nicely on small screens */
    @@media (max-width: 992px) {
        .sidebar-link-highlight {
            display: inline-flex;
            padding: 8px 10px;
            border-radius: 6px;
            box-shadow: none;
        }
    }

    .attention-wrapper {
        position: relative;
        padding-left: 44px; /* make room for the arrow */
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .attention-arrow {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        width: 20px;
        height: 20px;
        pointer-events: none;
        z-index: 5;
    }

        .attention-arrow svg {
            width: 100%;
            height: 100%;
            fill: #111;
            filter: drop-shadow(0 6px 12px rgba(0,0,0,0.12));
            animation: arrow-bob 1.6s ease-in-out infinite;
            transform-origin: center;
        }

    /* optional gentle pulse on the highlighted link */
    .sidebar-link-highlight.attention-wrapper {
        box-shadow: 0 8px 20px rgba(255, 182, 0, 0.10);
        transition: box-shadow 0.18s ease, transform 0.12s ease;
    }

    @@keyframes arrow-bob {
        0% {
            transform: translateY(-50%) translateX(0) rotate(0deg);
        }

        25% {
            transform: translateY(-58%) translateX(2px) rotate(-6deg);
        }

        50% {
            transform: translateY(-50%) translateX(0) rotate(0deg);
        }

        75% {
            transform: translateY(-54%) translateX(1px) rotate(6deg);
        }

        100% {
            transform: translateY(-50%) translateX(0) rotate(0deg);
        }
    }

    /* Grid typography tweaks: smaller, no bold to reduce visual weight */
    .card-body .table,
    .grid-yellow-bg .table,
    .table.table-sm {
        font-size: 0.88rem; /* slightly smaller than default */
    }

    .table thead th {
        font-size: 0.92rem;
        font-weight: 600; /* keep headers slightly emphasized but not overly bold */
    }

    .table tbody td,
    .table tbody th {
        font-weight: 400 !important; /* remove bold in grid body */
        color: #222;
    }

    /* Neutralize utility bold classes inside the grid so markup doesn't force heavy weight */
    .table .fw-bold,
    .table .fw-semibold,
    .table strong,
    .table b {
        font-weight: 400 !important;
    }

    /* Tighten spacing a little so reduced font doesn't create too much white space */
    .table td, .table th {
        padding: 0.45rem 0.5rem;
    }

    /* Simple Mode Styling */
    .simple-mode .complex-column {
        display: none !important;
    }

    .simple-mode .table {
        font-size: 1rem;
    }

    .simple-mode .card-header {
        background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);
        font-size: 1.1rem;
        border: none;
    }

        .simple-mode .card-header .small {
            font-size: 0.9rem !important;
        }

    /* Reduce tooltip overload in simple mode */
    .simple-mode .info-tooltip {
        display: none;
    }

    .simple-mode .bi-info-circle {
        display: none;
    }

    /* Keep essential info icons in simple mode */
    .simple-mode .essential-info {
        display: inline !important;
    }

    /* Modal backdrop and blur effect */
    .intro-modal-active {
        /* Mobile: completely hide content */
        display: none;
    }

    /* Desktop/Laptop: show but blur */
    @@media (min-width: 992px) {
        .intro-modal-active {
            display: block;
            filter: blur(8px);
            pointer-events: none;
            user-select: none;
            opacity: 0.6;
        }
    }

    /* Ensure modal backdrop is solid on mobile */
    @@media (max-width: 991px) {
        .modal-backdrop {
            opacity: 1 !important;
            background-color: #fff !important;
        }
    }

    /* Make sure modal stays on top and centered */
    .modal.d-block {
        display: flex !important;
        align-items: center;
        justify-content: center;
    }

    /* Mobile Card Layout - replaces table on small screens */
    @@media (max-width: 767px) {
        /* Hide the table on mobile */
        .mobile-hide-table {
            display: none !important;
        }

        /* Show card layout on mobile */
        .mobile-card-layout {
            display: block !important;
        }

        /* Individual expense card styling */
        .expense-card {
            background: white;
            border: 1px solid rgba(255, 214, 0, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .expense-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #e9ecef;
        }

        .expense-card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #222;
            flex: 1;
        }

        .expense-card-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .expense-card-body {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }

        .expense-card-field {
            display: flex;
            flex-direction: column;
        }

        .expense-card-field-full {
            grid-column: 1 / -1;
        }

        .expense-card-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: #6c757d;
            font-weight: 600;
            margin-bottom: 4px;
            letter-spacing: 0.5px;
        }

        .expense-card-value {
            font-size: 1rem;
            color: #222;
            font-weight: 500;
        }

        .expense-card-value-large {
            font-size: 1.25rem;
            font-weight: 700;
            color: #0d6efd;
        }

        /* Action buttons in card */
        .expense-card-btn {
            min-width: 44px;
            min-height: 44px;
            padding: 12px;
            font-size: 1rem;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
    }

    /* Desktop: hide mobile card layout */
    @@media (min-width: 768px) {
        .mobile-card-layout {
            display: none !important;
        }
    }

    /* Mobile Modal Improvements */
    @@media (max-width: 575px) {
        /* Fullscreen modals on small screens */
        .modal-fullscreen-sm-down .modal-content {
            border-radius: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .modal-fullscreen-sm-down .modal-body {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .modal-fullscreen-sm-down .modal-header,
        .modal-fullscreen-sm-down .modal-footer {
            flex-shrink: 0;
        }

        /* Ensure form inputs are visible above keyboard */
        .modal-fullscreen-sm-down input:focus,
        .modal-fullscreen-sm-down select:focus,
        .modal-fullscreen-sm-down textarea:focus {
            scroll-margin-top: 100px;
        }

        /* Larger touch targets for modal buttons */
        .modal-footer .btn {
            min-height: 48px;
            padding: 12px 24px;
            font-size: 1rem;
        }

        /* Increase form input sizes on mobile */
        .modal-body .form-control,
        .modal-body .form-select {
            min-height: 48px;
            font-size: 1rem;
        }

        .modal-body .form-check-input {
            min-width: 24px;
            min-height: 24px;
        }
    }

    /* Ensure modal scrolls properly when keyboard is visible */
    .modal-dialog-scrollable .modal-body {
        max-height: calc(100vh - 200px);
    }

    /* Touch Target Improvements - Minimum 44x44px for mobile */
    @@media (max-width: 767px) {
        /* Info icons - larger tap area */
        .bi-info-circle {
            padding: 12px;
            margin: -12px;
            min-width: 44px;
            min-height: 44px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        /* Close buttons in alerts/tooltips */
        .alert .btn-close,
        .alert .bi-x-lg {
            min-width: 44px;
            min-height: 44px;
            padding: 12px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        /* All buttons minimum size */
        .btn, button {
            min-height: 44px;
            padding: 10px 16px;
        }

        .btn-sm {
            min-height: 44px;
            padding: 10px 14px;
            font-size: 0.95rem;
        }

        /* Trash/delete buttons */
        .bi-trash-fill,
        .bi-trash {
            padding: 12px;
            min-width: 44px;
            min-height: 44px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        /* Edit/pencil buttons */
        .bi-pencil-square,
        .bi-pencil {
            padding: 8px;
        }

        /* Category accordion header - make entire header tappable */
        .card-header {
            min-height: 60px;
            padding: 12px 16px;
        }

        /* Form checkboxes and radio buttons */
        .form-check-input {
            min-width: 28px;
            min-height: 28px;
            margin-top: 0;
        }

        .form-check-label {
            padding-left: 8px;
            min-height: 44px;
            display: inline-flex;
            align-items: center;
        }

        /* Checkbox labels clickable area */
        .form-check {
            min-height: 44px;
            display: flex;
            align-items: center;
            padding: 8px 0;
        }

        /* Tab navigation */
        .nav-link {
            min-height: 48px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
        }

        /* Badge/link touch targets */
        .badge,
        a.badge {
            min-height: 36px;
            padding: 8px 12px;
            display: inline-flex;
            align-items: center;
        }

        /* Mode toggle switch */
        .form-switch .form-check-input {
            min-width: 48px;
            min-height: 28px;
        }

        /* Add category/item buttons */
        .btn-success,
        .btn-primary {
            min-height: 48px;
            font-size: 1rem;
        }

        /* Collapse/Expand all button */
        .btn-outline-secondary {
            min-height: 44px;
        }
    }

    /* Touch-friendly improvements for all screens */
    /* Add visual feedback for touch */
    @@media (hover: none) and (pointer: coarse) {
        /* These styles apply only to touch devices */
        button:active,
        .btn:active,
        a:active {
            transform: scale(0.98);
            transition: transform 0.1s;
        }

        /* Remove hover effects that don't work on touch */
        *:hover {
            /* Disable problematic hover states */
        }

        /* Larger tap targets for icon buttons */
        .bi {
            cursor: pointer;
        }

        /* Prevent accidental double-tap zoom */
        button,
        a,
        input,
        select,
        textarea {
            touch-action: manipulation;
        }
    }

    /* Responsive Layout Fixes for Mobile */
    @@media (max-width: 767px) {
        /* Stack absolutely positioned elements */
        .tab-panel-box > .position-absolute {
            position: relative !important;
            top: auto !important;
            right: auto !important;
            left: auto !important;
            margin-bottom: 12px;
        }

        /* Mode toggle - full width on mobile */
        .tab-panel-box > .position-absolute:first-child {
            width: 100%;
        }

        .tab-panel-box > .position-absolute:first-child > div {
            width: 100%;
            justify-content: space-between;
        }

        /* Action buttons - full width stack */
        .tab-panel-box > .position-absolute:nth-child(2) {
            width: 100%;
        }

        .tab-panel-box > .position-absolute:nth-child(2).d-flex {
            flex-direction: column;
            gap: 8px !important;
        }

        .tab-panel-box > .position-absolute:nth-child(2) button {
            width: 100%;
        }

        /* Totals strip - stack vertically */
        .totals-strip {
            flex-direction: column !important;
            gap: 12px !important;
        }

        .totals-box {
            width: 100% !important;
            min-width: auto !important;
        }

        /* Make totals boxes clearly non-interactive */
        .totals-box {
            cursor: default !important;
            transition: none !important;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.12) !important;
        }

        .totals-box:hover {
            transform: none !important;
        }

        .totals-box:active {
            transform: none !important;
        }

        /* Category header - wrap content */
        .card-header {
            flex-wrap: wrap;
        }

        .card-header .small {
            display: block !important;
            width: 100%;
            margin-top: 8px;
        }

        /* Hide some less critical info on mobile */
        .card-header .text-muted.d-none.d-md-inline {
            display: none !important;
        }

        /* Assumptions section - stack vertically */
        .section-card .d-flex.flex-wrap {
            flex-direction: column;
            align-items: flex-start !important;
        }

        .section-card .me-4 {
            margin-right: 0 !important;
            margin-bottom: 8px;
        }

        /* Add category button center */
        .d-flex.justify-content-center.mb-3 {
            flex-direction: column;
        }

        /* Collapse all button - full width */
        .d-flex.align-items-center.mb-2 {
            flex-direction: column;
            align-items: stretch !important;
        }

        .d-flex.align-items-center.mb-2 button {
            width: 100%;
            margin-bottom: 8px;
        }
    }

    /* Tablet adjustments */
    @@media (min-width: 768px) and (max-width: 991px) {
        /* Mode toggle - adjust position for tablet */
        .position-absolute[style*="right: 280px"] {
            right: 180px !important;
        }
    }

    /* Ensure tab panel content has proper spacing on mobile */
    @@media (max-width: 767px) {
        .tab-panel-box {
            padding: 16px 12px !important;
        }

        /* Reduce top panel offset on mobile */
        .tab-panel-box {
            top: 0 !important;
        }

        /* Add some breathing room */
        .section-card,
        .card {
            margin-bottom: 16px;
        }

        /* Survey card on left - hide or stack */
        .col-md-2 {
            margin-bottom: 20px;
        }

        .survey-card {
            max-width: 100%;
            width: 100%;
        }
    }

    /* Accordion Header Mobile Optimization */
    @@media (max-width: 767px) {
        /* Make accordion header more compact and stackable */
        .card-header.d-flex.align-items-center {
            flex-wrap: wrap;
            padding: 12px 8px !important;
            gap: 8px;
            align-items: flex-start !important;
        }

        /* Category name and remove button - first row */
        .card-header .btn-soft-danger {
            order: 1;
            padding: 4px 8px !important;
            min-width: 36px;
            flex-shrink: 0;
        }

        .card-header .me-2[style*="font-weight: bold"] {
            order: 2;
            flex: 1 1 auto;
            min-width: 0;
            max-width: calc(100% - 120px);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-right: 8px !important;
            font-size: 1rem;
        }

        /* Category info icon - next to name */
        .card-header > .bi-info-circle:first-of-type {
            order: 3;
            flex-shrink: 0;
            font-size: 1rem !important;
            padding: 8px;
            margin: -8px;
        }

        /* Show totals on mobile - make them compact and wrap to new line */
        .card-header .small.text-muted {
            display: inline-block !important;
            order: 4;
            font-size: 0.75rem !important;
            margin-left: 44px !important; /* Align with category name after button */
            margin-right: 8px !important;
            flex: 0 0 auto;
        }

        /* Stack totals if needed */
        .card-header .small.text-muted:first-of-type {
            margin-left: 44px !important;
        }

        .card-header .small.text-muted:last-of-type {
            margin-left: 8px !important;
        }

        /* Compact total labels for mobile */
        .card-header .small.text-muted {
            white-space: nowrap;
        }

        /* Move action buttons to new row */
        .card-header .ms-auto {
            order: 5;
            margin-left: 0 !important;
            flex: 1 1 100%;
            margin-top: 8px;
            justify-content: space-between;
        }

        /* Make "Add Item" button more prominent on mobile */
        .card-header .ms-auto .btn-success {
            flex: 1;
            max-width: calc(100% - 40px);
        }

        /* Info icons - ensure adequate touch target */
        .card-header .bi-info-circle {
            font-size: 1.1rem !important;
            padding: 8px;
            margin: -8px;
        }

        /* Collapse indicator - add visual cue */
        .card-header::after {
            content: '';
            position: absolute;
            right: 8px;
            top: 16px;
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 8px solid currentColor;
            opacity: 0.5;
            transition: transform 0.2s ease;
        }

        .card-header[aria-expanded="true"]::after {
            transform: rotate(180deg);
        }

        /* Increase tap target size for entire header */
        .card-header {
            min-height: 66px;
            position: relative;
        }

        /* Ensure buttons stay clickable despite header onclick */
        .card-header button,
        .card-header .bi-info-circle {
            position: relative;
            z-index: 2;
        }
    }

    /* Tablet - show some totals but keep compact */
    @@media (min-width: 768px) and (max-width: 991px) {
        .card-header .small.text-muted {
            font-size: 0.7rem !important;
        }

        .card-header .ms-auto .btn-success {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
        }
    }

    /* Tab Navigation Mobile Optimization */
    @@media (max-width: 767px) {
        /* Make tab container horizontally scrollable */
        .nav-tabs {
            flex-wrap: nowrap !important;
            overflow-x: auto;
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
            scrollbar-width: thin; /* Firefox */
            padding-bottom: 8px;
            margin-bottom: 8px !important;
        }

        /* Webkit scrollbar styling */
        .nav-tabs::-webkit-scrollbar {
            height: 4px;
        }

        .nav-tabs::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 2px;
        }

        .nav-tabs::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 2px;
        }

        .nav-tabs::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Prevent tabs from shrinking */
        .nav-tabs .nav-item {
            flex-shrink: 0;
            white-space: nowrap;
        }

        /* Make tab buttons more touch-friendly */
        .nav-tabs .nav-link {
            min-height: 44px;
            padding: 10px 16px !important;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
        }

        /* Info icon next to tab */
        .nav-item .bi-info-circle {
            font-size: 1rem !important;
            padding: 8px;
            margin: -8px 0 -8px 4px;
        }

        /* Add visual hint that tabs are scrollable */
        .nav-tabs::after {
            content: '→';
            position: sticky;
            right: 0;
            background: linear-gradient(to right, transparent, white 30%);
            padding: 0 12px 0 24px;
            pointer-events: none;
            font-size: 1.2rem;
            color: #6c757d;
            display: flex;
            align-items: center;
        }

        /* Hide scroll hint when at end */
        .nav-tabs.scrolled-to-end::after {
            content: '';
        }
    }

    /* Small mobile - even more compact tabs */
    @@media (max-width: 575px) {
        .nav-tabs .nav-link {
            padding: 8px 12px !important;
            font-size: 0.85rem;
        }
    }

    /* Font Size and Text Density Mobile Optimization */
    @@media (max-width: 767px) {
        /* Base font size - slightly larger for better readability */
        body {
            font-size: 16px; /* Prevents iOS auto-zoom on input focus */
        }

        /* Headings - proportionally scaled */
        h1 {
            font-size: 1.75rem !important;
            line-height: 1.2;
        }

        h2 {
            font-size: 1.5rem !important;
            line-height: 1.3;
        }

        h3 {
            font-size: 1.25rem !important;
            line-height: 1.3;
        }

        h4 {
            font-size: 1.1rem !important;
            line-height: 1.4;
        }

        h5, h6 {
            font-size: 1rem !important;
            line-height: 1.4;
        }

        /* Buttons - readable text */
        .btn {
            font-size: 0.9rem !important;
            line-height: 1.4;
        }

        .btn-sm {
            font-size: 0.85rem !important;
        }

        .btn-lg {
            font-size: 1rem !important;
        }

        /* Form labels and inputs */
        label {
            font-size: 0.95rem !important;
            margin-bottom: 6px;
        }

        input, select, textarea {
            font-size: 16px !important; /* Prevents iOS zoom */
            line-height: 1.5;
        }

        /* Small text - but not too small */
        .small, small {
            font-size: 0.85rem !important;
            line-height: 1.4;
        }

        /* Alert messages */
        .alert {
            font-size: 0.9rem !important;
            line-height: 1.5;
        }

        /* Card text */
        .card-body {
            font-size: 0.95rem;
            line-height: 1.5;
        }

        /* Expense card - readable amounts */
        .expense-card .expense-label {
            font-size: 0.9rem !important;
        }

        .expense-card .expense-value {
            font-size: 1rem !important;
            font-weight: 600;
        }

        .expense-card .expense-total {
            font-size: 1.1rem !important;
            font-weight: bold;
        }

        /* Table text in modals */
        .modal-body table {
            font-size: 0.85rem;
        }

        .modal-body th {
            font-size: 0.8rem;
            line-height: 1.3;
        }

        /* Totals strip - prominent numbers */
        .totals-box strong,
        .totals-box .fw-bold {
            font-size: 1.1rem !important;
        }

        .totals-box .small {
            font-size: 0.8rem !important;
        }

        /* Category header text */
        .card-header {
            font-size: 0.95rem;
            line-height: 1.4;
        }

        .card-header .small {
            font-size: 0.75rem !important;
        }

        /* Assumptions section */
        .section-card {
            font-size: 0.9rem;
        }

        .section-card .small {
            font-size: 0.8rem !important;
        }

        /* Info tooltips and help text */
        .text-muted {
            font-size: 0.85rem !important;
        }

        /* Badge and pills */
        .badge {
            font-size: 0.8rem !important;
            padding: 0.35em 0.65em;
        }

        /* Reduce line spacing for compact layouts */
        p {
            margin-bottom: 0.75rem;
        }

        /* List spacing */
        ul, ol {
            margin-bottom: 0.75rem;
        }

        li {
            margin-bottom: 0.25rem;
        }
    }

    /* Very small screens - tighten up further */
    @@media (max-width: 575px) {
        h1 {
            font-size: 1.5rem !important;
        }

        h2 {
            font-size: 1.35rem !important;
        }

        .card-header {
            font-size: 0.9rem;
        }

        .expense-card {
            font-size: 0.85rem;
        }
    }

    /* Improve readability with better spacing */
    @@media (max-width: 767px) {
        /* Add breathing room between sections */
        .section-card,
        .card {
            margin-bottom: 1rem;
        }

        /* Input spacing for better touch */
        .form-group,
        .mb-3 {
            margin-bottom: 1rem !important;
        }

        /* Button spacing */
        .btn {
            margin-bottom: 0.5rem;
        }

        /* Adequate padding in containers */
        .card-body {
            padding: 1rem !important;
        }

        .modal-body {
            padding: 1rem !important;
        }
    }

    /* Form Input Spacing for Mobile Keyboard Visibility */
    @@media (max-width: 767px) {
        /* Ensure modals with forms have proper spacing */
        .modal-body form,
        .modal-body .form-group {
            margin-bottom: 1.5rem !important;
        }

        /* Last form element needs extra bottom padding */
        .modal-body form > *:last-child,
        .modal-body .form-group:last-of-type {
            margin-bottom: 2rem !important;
        }

        /* Input fields - adequate height and spacing */
        .form-control,
        .form-select {
            min-height: 44px; /* Touch target minimum */
            padding: 0.5rem 0.75rem;
            margin-bottom: 0.75rem;
        }

        /* Labels above inputs need space */
        label {
            display: block;
            margin-bottom: 0.5rem;
        }

        /* Form groups need vertical space */
        .row > [class*="col-"] {
            margin-bottom: 1rem;
        }

        /* Modal footer buttons - ensure visibility above keyboard */
        .modal-footer {
            padding: 1rem !important;
            gap: 0.5rem;
            position: sticky;
            bottom: 0;
            background: white;
            border-top: 1px solid #dee2e6;
            z-index: 10;
        }

        /* Full-width footer buttons on mobile */
        .modal-footer .btn {
            flex: 1;
            min-width: 100px;
        }

        /* Stack footer buttons if too many */
        .modal-footer {
            flex-wrap: wrap;
        }

        /* Add extra padding at bottom of modal body */
        .modal-body {
            padding-bottom: 2rem !important;
        }

        /* Scrollable modal body with proper height */
        .modal-dialog-scrollable .modal-body {
            max-height: calc(100vh - 200px); /* Leave room for header/footer */
            overflow-y: auto;
        }

        /* Input groups - ensure components align properly */
        .input-group {
            margin-bottom: 1rem;
        }

        .input-group > .form-control,
        .input-group > .form-select {
            margin-bottom: 0;
        }

        /* Inline form elements need spacing */
        .form-inline .form-control,
        .form-inline .form-select {
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }

        /* Checkboxes and radios - better touch targets */
        .form-check {
            min-height: 44px;
            display: flex;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .form-check-input {
            width: 20px;
            height: 20px;
            margin-top: 0;
            margin-right: 0.5rem;
        }

        .form-check-label {
            margin-bottom: 0;
            padding-left: 0.25rem;
        }

        /* Help text below inputs */
        .form-text,
        .invalid-feedback,
        .valid-feedback {
            font-size: 0.85rem;
            margin-top: 0.25rem;
            margin-bottom: 0.5rem;
        }

        /* Ensure textarea has adequate height */
        textarea.form-control {
            min-height: 88px; /* At least 2 lines visible */
        }

        /* Number inputs - larger tap targets for +/- */
        input[type="number"] {
            -webkit-appearance: none;
            -moz-appearance: textfield;
        }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* Date/time inputs */
        input[type="date"],
        input[type="time"],
        input[type="datetime-local"] {
            min-height: 44px;
        }

        /* Validation states - visible indicators */
        .was-validated .form-control:invalid,
        .form-control.is-invalid {
            border-width: 2px;
            padding-right: calc(1.5em + 0.75rem);
        }

        .was-validated .form-control:valid,
        .form-control.is-valid {
            border-width: 2px;
            padding-right: calc(1.5em + 0.75rem);
        }
    }

    /* Handle forms in cards (not modals) */
    @@media (max-width: 767px) {
        .card-body form {
            padding: 0.5rem 0;
        }

        .card-body .form-group {
            margin-bottom: 1.25rem;
        }

        /* Assumptions form specifically */
        .section-card form .form-control,
        .section-card form .form-select {
            margin-bottom: 0.5rem;
        }
    }

    /* Prevent keyboard from hiding submit buttons */
    @@media (max-width: 767px) {
        /* When input is focused, ensure submit button is visible */
        .modal-footer {
            /* Sticky positioning keeps it visible */
            position: sticky;
            bottom: 0;
            background: white;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
        }

        /* Add safe area for iOS notch/home indicator */
        .modal-footer {
            padding-bottom: max(1rem, env(safe-area-inset-bottom)) !important;
        }

        .modal-body {
            padding-bottom: max(2rem, calc(2rem + env(safe-area-inset-bottom))) !important;
        }
    }

    /* Text Truncation with Ellipsis for Long Names */
    @@media (max-width: 767px) {
        /* Category names in accordion headers */
        .card-header span[style*="font-weight: bold"] {
            max-width: calc(100% - 100px); /* Leave room for buttons/icons */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: inline-block;
            vertical-align: middle;
        }

        /* Expense item names in cards */
        .expense-card .expense-label {
            max-width: 100%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: block;
        }

        /* Item names in mobile card layout */
        .mobile-card-layout .expense-name,
        .mobile-card-layout strong {
            max-width: 100%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: block;
        }

        /* Tab labels - truncate if very long */
        .nav-tabs .nav-link {
            max-width: 200px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Assumptions section labels */
        .section-card .form-label,
        .section-card label {
            max-width: 100%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Modal titles */
        .modal-title {
            max-width: calc(100% - 40px); /* Leave room for close button */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Table cell content in modals */
        .modal-body td,
        .modal-body th {
            max-width: 150px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Allow wrapping for certain columns if needed */
        .modal-body td:first-child,
        .modal-body th:first-child {
            max-width: 120px;
        }

        /* Totals strip labels */
        .totals-box .small {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        /* Button text - truncate if too long */
        .btn {
            max-width: 100%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Alert messages - allow wrapping but control long words */
        .alert {
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
        }

        /* Form control values */
        .form-control,
        .form-select {
            text-overflow: ellipsis;
        }

        /* Breadcrumbs if present */
        .breadcrumb-item {
            max-width: 150px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Badge content */
        .badge {
            max-width: 100%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: inline-block;
        }

        /* List items */
        li {
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        /* Links */
        a {
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        /* Code blocks or pre-formatted text */
        code, pre {
            max-width: 100%;
            overflow-x: auto;
            word-wrap: break-word;
            white-space: pre-wrap;
        }

        /* Prevent URLs from breaking layout */
        .form-text,
        .small,
        small {
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
    }

    /* Multi-line truncation for specific elements */
    @@media (max-width: 767px) {
        /* Allow 2-line truncation for descriptions */
        .expense-card .expense-description,
        .card-text {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            max-height: 3em; /* 2 lines at 1.5 line-height */
        }

        /* Info tooltips - allow 3 lines */
        .tooltip-inner {
            max-width: 280px;
            white-space: normal;
            text-align: left;
        }

        /* Popover content */
        .popover-body {
            max-width: 280px;
            word-wrap: break-word;
        }
    }

    /* Add title attribute for truncated text (accessibility) */
    @@media (max-width: 767px) {
        /* Ensure truncated elements show full text on long press/hover */
        [style*="text-overflow: ellipsis"],
        .text-truncate {
            cursor: help;
        }
    }

    /* Very small screens - tighter truncation */
    @@media (max-width: 575px) {
        .nav-tabs .nav-link {
            max-width: 150px;
        }

        .modal-body td,
        .modal-body th {
            max-width: 100px;
        }

        .breadcrumb-item {
            max-width: 100px;
        }

        .card-header span[style*="font-weight: bold"] {
            max-width: calc(100% - 80px);
        }
    }

    /* Additional Mobile Refinements - Polish & UX Enhancements */
    
    /* Touch Feedback & Visual Response */
    @@media (max-width: 767px) {
        /* Add active state feedback for touch */
        .btn:active,
        .nav-link:active,
        .card-header:active {
            transform: scale(0.98);
            transition: transform 0.1s ease;
        }

        /* Highlight tapped items */
        .list-group-item:active,
        .dropdown-item:active {
            background-color: rgba(0, 123, 255, 0.1);
        }

        /* Card interaction feedback */
        .card:active {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        /* Link tap highlight */
        a:active {
            opacity: 0.7;
        }

        /* Remove default tap highlight color */
        * {
            -webkit-tap-highlight-color: rgba(0, 123, 255, 0.1);
            -webkit-touch-callout: none;
        }

        /* Button ripple effect simulation */
        .btn-primary:active,
        .btn-success:active,
        .btn-danger:active {
            box-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.125);
        }
    }

    /* Dropdown Menu Optimizations */
    @@media (max-width: 767px) {
        /* Full-width dropdowns on mobile */
        .dropdown-menu {
            width: 100%;
            max-width: 100vw;
            left: 0 !important;
            right: 0 !important;
            border-radius: 0.25rem;
        }

        /* Larger dropdown items for touch */
        .dropdown-item {
            padding: 0.75rem 1rem;
            font-size: 0.95rem;
            min-height: 44px;
            display: flex;
            align-items: center;
        }

        /* Dropdown dividers more visible */
        .dropdown-divider {
            margin: 0.5rem 0;
            border-top-width: 2px;
        }

        /* Dropdown header styling */
        .dropdown-header {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
            font-weight: 600;
            color: #6c757d;
        }

        /* Scrollable dropdown if too many items */
        .dropdown-menu {
            max-height: 70vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
    }

    /* Sticky Positioning Adjustments */
    @@media (max-width: 767px) {
        /* Sticky totals strip */
        .totals-strip {
            position: sticky;
            top: 0;
            z-index: 100;
            background: white;
            padding: 0.75rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 1rem;
        }

        /* Sticky tab navigation */
        .nav-tabs {
            position: sticky;
            top: 0;
            z-index: 99;
            background: white;
            padding-top: 0.5rem;
            margin-top: -0.5rem;
        }

        /* Ensure sticky elements don't overlap */
        .sticky-top {
            z-index: 98;
        }

        /* Add subtle separator under sticky elements */
        .totals-strip::after,
        .nav-tabs::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(to right, transparent, #dee2e6 10%, #dee2e6 90%, transparent);
        }
    }

    /* Loading States & Animations */
    @@media (max-width: 767px) {
        /* Smooth transitions */
        .card,
        .modal,
        .alert {
            transition: all 0.2s ease-in-out;
        }

        /* Fade in animations */
        @@keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card,
        .expense-card {
            animation: fadeIn 0.3s ease-out;
        }

        /* Loading spinner size */
        .spinner-border,
        .spinner-grow {
            width: 2rem;
            height: 2rem;
        }

        .spinner-border-sm,
        .spinner-grow-sm {
            width: 1rem;
            height: 1rem;
        }

        /* Disabled state clarity */
        .btn:disabled,
        .btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Progress bars */
        .progress {
            height: 1.5rem;
            border-radius: 0.5rem;
        }
    }

    /* Accessibility Enhancements */
    @@media (max-width: 767px) {
        /* Focus indicators for keyboard navigation */
        *:focus-visible {
            outline: 3px solid #0d6efd;
            outline-offset: 2px;
        }

        /* Skip to content link */
        .skip-to-content {
            position: absolute;
            top: -40px;
            left: 0;
            background: #0d6efd;
            color: white;
            padding: 8px 16px;
            z-index: 9999;
        }

        .skip-to-content:focus {
            top: 0;
        }

        /* Screen reader only text */
        .sr-only,
        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* High contrast mode support */
        @@media (prefers-contrast: high) {
            .btn {
                border-width: 2px;
            }

            .card {
                border-width: 2px;
            }
        }

        /* Reduced motion support */
        @@media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    }

    /* Performance Optimizations */
    @@media (max-width: 767px) {
        /* Hardware acceleration for animations */
        .card,
        .modal,
        .btn,
        .nav-link {
            transform: translateZ(0);
            will-change: transform;
        }

        /* Optimize repaints */
        .card-header,
        .modal-header,
        .modal-footer {
            contain: layout style;
        }

        /* Lazy load images if present */
        img {
            loading: lazy;
        }
    }

    /* Safe Area & Notch Handling */
    @@media (max-width: 767px) {
        /* iOS safe areas */
        body {
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }

        /* Top safe area */
        .top-strip,
        .navbar {
            padding-top: max(0.5rem, env(safe-area-inset-top));
        }

        /* Bottom safe area for footers */
        footer,
        .bottom-nav {
            padding-bottom: env(safe-area-inset-bottom);
        }
    }

    /* Print Styles */
    @@media print {
        /* Hide navigation on print */
        .nav-tabs,
        .navbar,
        .btn,
        .modal {
            display: none !important;
        }

        /* Expand all accordions */
        .collapse {
            display: block !important;
        }

        /* Remove backgrounds */
        .card,
        .card-body {
            background: white !important;
            border: 1px solid #dee2e6 !important;
        }

        /* Better page breaks */
        .card,
        .expense-card {
            page-break-inside: avoid;
        }
    }

    /* Dark Mode Support (if implemented later) */
    @@media (prefers-color-scheme: dark) {
        /* Placeholder for future dark mode */
        /* .card {
            background: #1e1e1e;
            color: #ffffff;
        } */
    }

    /* Landscape Orientation Adjustments */
    @@media (max-width: 767px) and (orientation: landscape) {
        /* Reduce vertical spacing in landscape */
        .modal-body {
            padding: 0.75rem !important;
        }

        .form-group,
        .mb-3 {
            margin-bottom: 0.5rem !important;
        }

        /* Compact headers in landscape */
        .card-header {
            padding: 8px 6px !important;
            min-height: 48px;
        }

        /* Smaller modals in landscape */
        .modal-dialog {
            max-height: 90vh;
        }
    }
</style>

@* Replace the inline modal with the reusable component *@
@* Replace previous component invocation with explicit C# expressions so Blazor doesn't emit invalid attribute names *@
<EditAssumptionsModal Visible="@showAssumptionsModal"
                      YearsToRetirement="@YearsToRetirement"
                      InflationRate="@InflationRate"
                      OnSave="@(values => OnAssumptionsSaved(values))"
                      OnClose="@( () => CloseAssumptions() )" />




@* Add Item Modal (root level for correct binding) *@


@* Unified Item Modal (Add/Edit) *@

@* Unified Item Modal (Add/Edit) with info icons and inline tooltips *@

@* Unified Item Modal (Add/Edit) with info icons and inline tooltips + close (X) *@
@if (showAddItemModal)
{
    <div class="modal-backdrop fade show" style="z-index:1040"></div>
    <div class="modal d-block" tabindex="-1" role="dialog" style="z-index:1050;">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable modal-fullscreen-sm-down" role="document">
            <div class="modal-content shadow" style="border-top: 4px solid #1F6FEB; overflow: hidden;">
                <div class="modal-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="modal-title d-flex align-items-center mb-0">
                        <span class="bi @(isEditItemMode ? "bi-pencil-square" : "bi-plus-circle") me-2 text-primary"></span>
                        @if (isSimpleMode)
                        {
                            @(isEditItemMode ? "Edit Expense" : "Add New Expense")
                        }
                        else
                        {
                            @(isEditItemMode ? "Edit Item" : "Add New Item")
                        }
                        @if (!string.IsNullOrWhiteSpace(addItemCategory))
                        {
                            <small class="text-muted ms-2">in @addItemCategory</small>
                        }
                    </h5>

                    <div class="d-flex align-items-center gap-3">
                        <!-- Large Mode Toggle in Modal -->
                        <div class="modal-mode-toggle d-flex align-items-center gap-3">
                            <div class="text-center">
                                <div class="fw-bold text-primary mb-1">
                                    @(isSimpleMode ? "🎯 Simple Mode" : "⚙️ Advanced Mode")
                                </div>
                                <small class="text-muted">
                                    @(isSimpleMode ? "Easy & basic" : "All features")
                                </small>
                            </div>
                            <div class="form-check form-switch form-check-modal-lg">
                                <input class="form-check-input" type="checkbox" id="modalModeToggle"
                                       checked="@(!isSimpleMode)" @onchange="ToggleSimpleMode">
                                <label class="form-check-label" for="modalModeToggle" style="cursor: pointer;">
                                    @(isSimpleMode ? "Enable Advanced" : "Simplify")
                                </label>
                            </div>
                        </div>

                        <button type="button" class="btn-close" aria-label="Close" @onclick="CloseAddItemModal"></button>
                    </div>
                </div>

                <div class="modal-body py-4" style="background-color: #f8faff;">

                    @* Item Name *@
                    <div class="form-floating mb-3">
                        <input type="text"
                               class="form-control"
                               id="newItemName"
                               placeholder="@(isSimpleMode ? "Rent, Groceries, Gas, etc." : "e.g., Rent, Groceries, Utilities")"
                               @bind="NewItemName"
                               @bind:event="oninput"
                               @onkeydown="HandleAddItemKeyModal"
                               autofocus />
                        <label for="newItemName" class="d-flex align-items-center">
                            <span>@(isSimpleMode ? "What do you spend money on?" : "Item Name")</span>
                            <span class="bi bi-info-circle text-info ms-2 @(isSimpleMode ? "" : "")"
                                  style="font-size: 0.9rem; cursor: pointer; vertical-align: middle;"
                                  title="What is this?"
                                  @onclick="() => showTipItemName = !showTipItemName"></span>
                        </label>
                    </div>
                    @if (showTipItemName)
                    {
                        <div class="alert alert-info py-2 px-3 mb-3 small">
                            A short, descriptive name for the expense (e.g., Rent, Groceries). This appears as the row label.
                            <span class="float-end" style="cursor:pointer;" title="Close" @onclick="() => showTipItemName = false">
                                <span class="bi bi-x-lg"></span>
                            </span>
                        </div>
                    }

                    @if (isSimpleMode)
                    {
                        <!-- Simplified view for beginners -->
                        <div class="form-floating mb-3">
                            <input class="form-control"
                                   type="number"
                                   step="0.01"
                                   min="0"
                                   id="newItemAmountSimple"
                                   placeholder="0"
                                   @bind="NewItemAmount"
                                   @onkeydown="HandleAddItemKeyModal" />
                            <label for="newItemAmountSimple">How much per month? ($)</label>
                        </div>
                        <!-- Force monthly frequency in simple mode -->
                    }
                    else
                    {
                        <!-- Advanced view with frequency options -->
                        <div class="row g-3">
                            @* Frequency *@
                            <div class="col-12 col-md-6">
                                <label class="form-label d-flex align-items-center">
                                    <span>@(isSimpleMode ? "How often do you pay this?" : "Frequency")</span>
                                    @if (!isSimpleMode)
                                    {
                                        <span class="bi bi-info-circle text-info ms-2"
                                              style="font-size: 0.9rem; cursor: pointer; vertical-align: middle;"
                                              title="What is this?"
                                              @onclick="() => showTipFrequency = !showTipFrequency"></span>
                                    }
                                </label>
                                <select class="form-select" @bind="NewItemFrequency">
                                    <option value="Monthly">Monthly</option>
                                    <option value="Quarterly">Quarterly</option>
                                    <option value="Yearly">Yearly</option>
                                </select>
                                @if (showTipFrequency)
                                {
                                    <div class="alert alert-info py-2 px-3 mt-2 mb-0 small">
                                        How often you pay this amount. We convert it to a monthly equivalent for totals.
                                        <span class="float-end" style="cursor:pointer;" title="Close" @onclick="() => showTipFrequency = false">
                                            <span class="bi bi-x-lg"></span>
                                        </span>
                                    </div>
                                }
                            </div>

                            @* Amount *@
                            <div class="col-12 col-md-6">
                                <label class="form-label d-flex align-items-center">
                                    <span>Amount ($)</span>
                                    <span class="bi bi-info-circle text-info ms-2"
                                          style="font-size: 0.9rem; cursor: pointer; vertical-align: middle;"
                                          title="What is this?"
                                          @onclick="() => showTipAmount = !showTipAmount"></span>
                                </label>
                                <input class="form-control"
                                       type="number"
                                       step="0.01"
                                       min="0"
                                       @bind="NewItemAmount"
                                       @onkeydown="HandleAddItemKeyModal" />
                                @if (showTipAmount)
                                {
                                    <div class="alert alert-info py-2 px-3 mt-2 mb-0 small">
                                        Enter the amount in the selected frequency (e.g., a yearly premium if Frequency is Yearly).
                                        <span class="float-end" style="cursor:pointer;" title="Close" @onclick="() => showTipAmount = false">
                                            <span class="bi bi-x-lg"></span>
                                        </span>
                                    </div>
                                }
                            </div>
                        </div>
                    }

                    @* Include in Retirement *@
                    <div class="form-check mt-3">
                        <input class="form-check-input" type="checkbox" id="newItemInclude" @bind="NewItemIncludeInRetirement" />
                        <label class="form-check-label d-inline-flex align-items-center" for="newItemInclude">
                            <span>@(isSimpleMode ? "Will you still have this cost in retirement?" : "Include in Retirement")</span>
                            <span class="bi bi-info-circle text-info ms-2 @(isSimpleMode ? "" : "")"
                                  style="font-size: 0.9rem; cursor: pointer; vertical-align: middle;"
                                  title="What is this?"
                                  @onclick="() => showTipInclude = !showTipInclude"></span>
                        </label>
                    </div>
                    @if (showTipInclude)
                    {
                        <div class="alert alert-info py-2 px-3 mt-2 mb-0 small">
                            Toggle whether this cost should be included in your retirement projection.
                            <span class="float-end" style="cursor:pointer;" title="Close" @onclick="() => showTipInclude = false">
                                <span class="bi bi-x-lg"></span>
                            </span>
                        </div>
                    }

                    @* Exclusion Reason (shown only when NOT included) *@
                    @if (!NewItemIncludeInRetirement)
                    {
                        <div class="mt-3">
                            <label class="form-label d-flex align-items-center">
                                <span>Reason for exclusion</span>
                                <span class="bi bi-info-circle text-info ms-2"
                                      style="font-size: 0.9rem; cursor: pointer; vertical-align: middle;"
                                      title="Why exclude this?"
                                      @onclick="() => showTipExclusionReason = !showTipExclusionReason"></span>
                            </label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="exclusionReason" id="reasonNotNeeded" value="NotNeeded" @onchange="@(() => NewItemExclusionReason = "NotNeeded")" checked="@(NewItemExclusionReason == "NotNeeded")" />
                                <label class="btn btn-outline-secondary" for="reasonNotNeeded">Not needed</label>

                                <input type="radio" class="btn-check" name="exclusionReason" id="reasonPaidOff" value="PaidOff" @onchange="@(() => NewItemExclusionReason = "PaidOff")" checked="@(NewItemExclusionReason == "PaidOff")" />
                                <label class="btn btn-outline-secondary" for="reasonPaidOff">Paid off</label>

                                <input type="radio" class="btn-check" name="exclusionReason" id="reasonOther" value="Other" @onchange="@(() => NewItemExclusionReason = "Other")" checked="@(NewItemExclusionReason == "Other")" />
                                <label class="btn btn-outline-secondary" for="reasonOther">Other</label>
                            </div>
                            @if (showTipExclusionReason)
                            {
                                <div class="alert alert-info py-2 px-3 mt-2 mb-0 small">
                                    <strong>Not needed:</strong> Expenses that won't apply in retirement (e.g., childcare, work clothes).<br />
                                    <strong>Paid off:</strong> Debts that will be eliminated (e.g., mortgage, car loan).<br />
                                    <strong>Other:</strong> Any other reason for exclusion.
                                    <span class="float-end" style="cursor:pointer;" title="Close" @onclick="() => showTipExclusionReason = false">
                                        <span class="bi bi-x-lg"></span>
                                    </span>
                                </div>
                            }
                        </div>
                    }

                    @if (NewItemIncludeInRetirement)
                    {
                        @if (isSimpleMode)
                        {
                            <!-- Simple mode: Default to inflation adjustment -->
                            <div class="mt-3">
                                <div class="alert alert-light py-2 px-3 border">
                                    <small class="text-muted">
                                        <i class="bi bi-info-circle me-1"></i>
                                        This cost will grow with inflation (@InflationRate% per year) until retirement.
                                    </small>
                                </div>
                            </div>
                        }
                        else
                        {
                            @* Advanced mode: Full retirement adjustment options *@
                            <div class="mt-3">
                                <label class="form-label d-flex align-items-center">
                                    <span>Retirement Adjustment</span>
                                    <span class="bi bi-info-circle text-info ms-2"
                                          style="font-size: 0.9rem; cursor: pointer; vertical-align: middle;"
                                          title="What is this?"
                                          @onclick="() => showTipAdjust = !showTipAdjust"></span>
                                </label>
                                <select class="form-select" @bind="NewItemAdjustOption">
                                    <option value="Same">Same</option>
                                    <option value="CustomPercentage">Custom %</option>
                                    <option value="Manual">Manual</option>
                                    <option value="Inflation">Inflation</option>
                                </select>
                                @if (showTipAdjust)
                                {
                                    <div class="alert alert-info py-2 px-3 mt-2 mb-0 small">
                                        Choose how this item changes at retirement: keep the same, apply a custom percent,
                                        enter a manual retirement amount, or grow by inflation.
                                        <span class="float-end" style="cursor:pointer;" title="Close" @onclick="() => showTipAdjust = false">
                                            <span class="bi bi-x-lg"></span>
                                        </span>
                                    </div>
                                }
                            </div>
                        }

                        @* Custom % *@
                        @if (NewItemAdjustOption == "CustomPercentage")
                        {
                            <div class="mt-3">
                                <label class="form-label d-flex align-items-center">
                                    <span>Custom %</span>
                                    <span class="bi bi-info-circle text-info ms-2"
                                          style="font-size: 0.9rem; cursor: pointer; vertical-align: middle;"
                                          title="What is this?"
                                          @onclick="() => showTipCustomPercent = !showTipCustomPercent"></span>
                                </label>
                                <input class="form-control" type="number" step="1" min="0" @bind="NewItemCustomPercentage" />
                                @if (showTipCustomPercent)
                                {
                                    <div class="alert alert-info py-2 px-3 mt-2 mb-0 small">
                                        Percentage of the current monthly amount at retirement. 50% halves it; 200% doubles it.
                                        <span class="float-end" style="cursor:pointer;" title="Close" @onclick="() => showTipCustomPercent = false">
                                            <span class="bi bi-x-lg"></span>
                                        </span>
                                    </div>
                                }
                            </div>
                        }

                        @* Manual *@
                        @if (NewItemAdjustOption == "Manual")
                        {
                            <div class="mt-3">
                                <label class="form-label d-flex align-items-center">
                                    <span>Manual Retirement Value</span>
                                    <span class="bi bi-info-circle text-info ms-2"
                                          style="font-size: 0.9rem; cursor: pointer; vertical-align: middle;"
                                          title="What is this?"
                                          @onclick="() => showTipManualValue = !showTipManualValue"></span>
                                </label>
                                <input class="form-control" type="number" step="0.01" min="0" @bind="NewItemManualRetirementValueString" />
                                @if (showTipManualValue)
                                {
                                    <div class="alert alert-info py-2 px-3 mt-2 mb-0 small">
                                        A fixed monthly amount to use in retirement. Overrides other adjustments.
                                        <span class="float-end" style="cursor:pointer;" title="Close" @onclick="() => showTipManualValue = false">
                                            <span class="bi bi-x-lg"></span>
                                        </span>
                                    </div>
                                }
                            </div>
                        }

                        @* Inflation *@
                        @if (NewItemAdjustOption == "Inflation")
                        {
                            <div class="mt-3">
                                <label class="form-label d-flex align-items-center">
                                    <span>Inflation Source</span>
                                    <span class="bi bi-info-circle text-info ms-2"
                                          style="font-size: 0.9rem; cursor: pointer; vertical-align: middle;"
                                          title="What is this?"
                                          @onclick="() => showTipInflationSource = !showTipInflationSource"></span>
                                </label>
                                <select class="form-select" @bind="NewItemPerItemInflationSource">
                                    <option value="UseGlobal">Global</option>
                                    <option value="Custom">Custom</option>
                                </select>
                                @if (showTipInflationSource)
                                {
                                    <div class="alert alert-info py-2 px-3 mt-2 mb-0 small">
                                        Global uses the plan’s inflation rate. Custom lets you specify a per‑item inflation rate.
                                        <span class="float-end" style="cursor:pointer;" title="Close" @onclick="() => showTipInflationSource = false">
                                            <span class="bi bi-x-lg"></span>
                                        </span>
                                    </div>
                                }
                            </div>

                            @if (NewItemPerItemInflationSource == "Custom")
                            {
                                <div class="mt-3">
                                    <label class="form-label d-flex align-items-center">
                                        <span>Custom Inflation %</span>
                                        <span class="bi bi-info-circle text-info ms-2"
                                              style="font-size: 0.9rem; cursor: pointer; vertical-align: middle;"
                                              title="What is this?"
                                              @onclick="() => showTipCustomInflation = !showTipCustomInflation"></span>
                                    </label>
                                    <input class="form-control" type="number" step="0.1" min="0" @bind="NewItemPerItemInflationPercent" />
                                    @if (showTipCustomInflation)
                                    {
                                        <div class="alert alert-info py-2 px-3 mt-2 mb-0 small">
                                            Annual inflation rate for this item (e.g., 3 means 3% per year until retirement).
                                            <span class="float-end" style="cursor:pointer;" title="Close" @onclick="() => showTipCustomInflation = false">
                                                <span class="bi bi-x-lg"></span>
                                            </span>
                                        </div>
                                    }
                                </div>
                            }
                        }
                    }
                </div>

                <div class="modal-footer border-top-0 pt-0" style="background-color: #f8faff;">
                    <button class="btn btn-outline-secondary px-4" @onclick="CloseAddItemModal">Cancel</button>
                    <button class="btn btn-primary px-4 d-flex align-items-center gap-2"
                            @onclick="AddItemModalSave"
                            disabled="@(isSaving || IsAddItemDisabled)">
                        @if (isSaving)
                        {
                            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                        }
                        else
                        {
                            <span class="bi @(isEditItemMode ? "bi-check2" : "bi-plus-lg")"></span>
                        }
                        @(isEditItemMode ? "Save" : "Add Item")
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@if (showDetailsModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background:rgba(0,0,0,0.25); z-index:2000;" role="dialog">
        <div class="modal-dialog modal-lg modal-dialog-scrollable modal-fullscreen-sm-down" role="document">
            <div class="modal-content">
                <div class="modal-header d-flex justify-content-between align-items-center">
                    <h5 class="modal-title mb-0">@(isSimpleMode ? "Expense Details" : "Item Details")</h5>

                    <div class="d-flex align-items-center gap-3">
                        <!-- Large Mode Toggle in Edit Modal -->
                        <div class="modal-mode-toggle d-flex align-items-center gap-3">
                            <div class="text-center">
                                <div class="fw-bold text-primary mb-1">
                                    @(isSimpleMode ? "🎯 Simple Mode" : "⚙️ Advanced Mode")
                                </div>
                                <small class="text-muted">
                                    @(isSimpleMode ? "Easy & basic" : "All features")
                                </small>
                            </div>
                            <div class="form-check form-switch form-check-modal-lg">
                                <input class="form-check-input" type="checkbox" id="editModalModeToggle"
                                       checked="@(!isSimpleMode)" @onchange="ToggleSimpleMode">
                                <label class="form-check-label" for="editModalModeToggle" style="cursor: pointer;">
                                    @(isSimpleMode ? "Enable Advanced" : "Simplify")
                                </label>
                            </div>
                        </div>

                        <button type="button" class="btn-close" aria-label="Close" @onclick="CloseDetailsModal"></button>
                    </div>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Subcategory</label>
                        @if (detailsEditMode)
                        {
                            <input class="form-control" @bind="modalSubcategory" />
                        }
                        else
                        {
                            <div class="form-control-plaintext">@modalSubcategory</div>
                        }
                    </div>
                    <div class="mb-3">
                        <label class="form-label">@(isSimpleMode ? "How Often" : "Frequency")</label>
                        @if (detailsEditMode)
                        {
                            <select class="form-select" @bind="modalFrequency">
                                <option value="Monthly">Monthly</option>
                                <option value="Quarterly">Quarterly</option>
                                <option value="Yearly">Yearly</option>
                            </select>
                        }
                        else
                        {
                            <div class="form-control-plaintext">@modalFrequency</div>
                        }
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Current Value</label>
                        @if (detailsEditMode)
                        {
                            <input class="form-control" type="number" step="0.01" @bind="modalCurrentValue" />
                        }
                        else
                        {
                            <div class="form-control-plaintext">@FormatCurrency(modalCurrentValue)</div>
                        }
                    </div>
                    <div class="mb-3 form-check">
                        @if (detailsEditMode)
                        {
                            <input class="form-check-input" type="checkbox" id="modalIncludeInRetirement" @bind="modalIncludeInRetirement" />
                            <label class="form-check-label" for="modalIncludeInRetirement">Include in Retirement</label>
                        }
                        else
                        {
                            <label class="form-check-label">Include in Retirement:</label>
                            <span class="ms-2">@(modalIncludeInRetirement ? "Yes" : "No")</span>
                        }
                    </div>

                    <div class="mb-3">
                        @if (modalIncludeInRetirement)
                        {
                            @if (detailsEditMode)
                            {
                                <label class="form-label">Retirement Adjust</label>

                                <select class="form-select" @bind="modalAdjustOption">
                                    <option value="Same">Same</option>
                                    <option value="CustomPercentage">Custom %</option>
                                    <option value="Manual">Manual</option>
                                    <option value="Inflation">Adjust for Inflation</option>
                                </select>
                            }
                            else
                            {
                                <div class="form-control-plaintext">@modalAdjustOption</div>
                            }
                        }
                    </div>
                    @if (modalAdjustOption == "CustomPercentage" && modalIncludeInRetirement)
                    {
                        <div class="mb-3">
                            <label class="form-label">Custom %</label>
                            @if (detailsEditMode)
                            {
                                <input class="form-control" type="number" step="1" min="0" @bind="modalCustomPercentage" />
                            }
                            else
                            {
                                <div class="form-control-plaintext">@modalCustomPercentage %</div>
                            }
                        </div>
                    }
                    @if (modalAdjustOption == "Manual" && modalIncludeInRetirement)
                    {
                        <div class="mb-3">
                            <label class="form-label">Manual Retirement Value</label>
                            @if (detailsEditMode)
                            {
                                <input class="form-control" type="number" step="0.01" @bind="modalManualRetirementValue" />
                            }
                            else
                            {
                                <div class="form-control-plaintext">@FormatCurrency(modalManualRetirementValue ?? 0)</div>
                            }
                        </div>
                    }
                    @if (modalIncludeInRetirement)
                    {
                        @if (modalAdjustOption == "Inflation")
                        {
                            <div class="mb-3">
                                <label class="form-label">Inflation Source</label>
                                @if (detailsEditMode)
                                {
                                    <select class="form-select" @bind="modalPerItemInflationSource">
                                        <option value="UseGlobal">Global</option>
                                        <option value="Custom">Custom</option>
                                    </select>
                                }
                                else
                                {
                                    <div class="form-control-plaintext">@modalPerItemInflationSource</div>
                                }
                            </div>
                            @if (modalPerItemInflationSource == "Custom")
                            {
                                <div class="mb-3">
                                    <label class="form-label">Custom Inflation %</label>
                                    @if (detailsEditMode)
                                    {
                                        <input class="form-control" type="number" step="0.1" min="0" @bind="modalPerItemInflationPercent" />
                                    }
                                    else
                                    {
                                        <div class="form-control-plaintext">@modalPerItemInflationPercent %</div>
                                    }
                                </div>
                            }
                        }
                    }

                </div>
                <div class="modal-footer">
                    @if (detailsEditMode)
                    {
                        <button type="button" class="btn btn-secondary" @onclick="CloseDetailsModal">Cancel</button>
                        <button type="button" class="btn btn-primary" @onclick="SaveDetailsModal">Save</button>
                    }
                    else
                    {
                        <button type="button" class="btn btn-secondary" @onclick="CloseDetailsModal">Close</button>
                        <button type="button" class="btn btn-primary" @onclick="EnableDetailsEdit">Edit</button>
                    }
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show" style="z-index:1999;"></div>
}

<!-- Intro Modal - Moved outside blurred wrapper -->
@if (showIntroModal)
{
    <div class="modal-backdrop fade show" style="z-index: 1040;"></div>
    <div class="modal d-block" style="z-index: 1050;">
        <div class="modal-dialog modal-dialog-centered modal-lg modal-fullscreen-sm-down">
            <div class="modal-content" style="border-top: 4px solid #FFD600;">
                <div class="modal-header bg-light">
                    <h5 class="modal-title">
                        <i class="bi bi-star-fill text-warning me-2"></i>Welcome to Cost of Living Planning!
                    </h5>
                    <button type="button" class="btn-close" aria-label="Close" @onclick="CloseIntroModal"></button>
                </div>
                
                <div class="modal-body" style="background-color: #fffef7;">
                    <div class="text-center mb-4">
                        <div style="font-size: 3rem; margin-bottom: 12px;">📊</div>
                        <p class="text-muted mb-0">
                            Let's create your personalized cost of living projection
                        </p>
                    </div>

                    <!-- Single Key Assumption -->
                    <div class="card bg-white mb-4 border-primary">
                        <div class="card-body">
                            <h6 class="card-title text-center mb-3 text-primary">When do you plan to retire?</h6>

                            <div class="row justify-content-center">
                                <div class="col-md-6">
                                    <label class="form-label d-flex align-items-center justify-content-center">
                                        <span class="fw-bold">Years to Retirement</span>
                                        <span class="bi bi-info-circle text-info ms-2"
                                              style="font-size: 0.9rem; cursor: pointer;"
                                              @onclick="() => showToolTipYearsInfo = !showToolTipYearsInfo"
                                              title="Click for info"></span>
                                    </label>
                                    <input type="number" 
                                           class="form-control form-control-lg text-center fw-bold" 
                                           style="font-size: 1.5rem;"
                                           @bind="YearsToRetirement" 
                                           min="1" 
                                           max="50" />
                                    
                                    @if (showToolTipYearsInfo)
                                    {
                                        <div class="alert alert-info py-2 px-3 mt-2 mb-0 small">
                                            <strong>Years to Retirement:</strong> The number of years until you expect to retire. This helps us project your future costs.
                                            <button type="button" class="btn-close btn-close-sm float-end" @onclick="() => showToolTipYearsInfo = false"></button>
                                        </div>
                                    }
                                </div>
                            </div>

                            <div class="small text-muted text-center mt-3">
                                <i class="bi bi-info-circle me-1"></i>
                                We'll use a default inflation rate of @InflationRate% (you can adjust this later)
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="d-flex gap-3 justify-content-center mb-3">
                        <button class="btn btn-primary btn-lg px-5" @onclick="StartWithDefaults">
                            <i class="bi bi-lightning-fill me-2"></i>Start with Sample Data
                        </button>
                        <button class="btn btn-outline-primary btn-lg px-5" @onclick="StartFromScratch">
                            <i class="bi bi-pencil me-2"></i>Start from Scratch
                        </button>
                    </div>

                    <!-- Don't Show Again -->
                    <div class="text-center pt-3 border-top">
                        <div class="form-check d-inline-flex align-items-center">
                            <input class="form-check-input me-2" type="checkbox" 
                                   id="dontShowIntroAgainCheck" @onchange="OnDontShowIntroChanged" />
                            <label class="form-check-label small text-muted" for="dontShowIntroAgainCheck">
                                Don't show this welcome screen again
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

<!-- Removed left sidebar nav; content moved to main container -->

<!-- Main content - hide on mobile, blur on desktop when modal is open -->
<div class="@(showIntroModal ? "intro-modal-active" : "")">>
    <div class="container-fluid">
        <div class="row">
            <!-- Left column (2) - moved from previous left-sidebar nav -->
            <div class="col-12 col-md-2">
                @* <ul class="list-unstyled mb-0">
                    <li><a class="text-decoration-none d-block py-1" href="/"><i class="bi bi-house"></i> Home</a></li>
                </ul> *@
                <a href="/about-rewealthen" class="badge">About</a>
                <div class="card survey-card survey-card-narrow mb-2">
                    <div class="card-body text-center">
                        <i class="bi bi-chat-dots" style="font-size:2rem; color:#1F6FEB;"></i>
                        <div class="fw-bold mt-2 mb-1">Share Your Feedback</div>
                        <a href="/survey-future-cost-of-living" class="btn btn-primary btn-sm">
                            Take Living Cost  Survey
                        </a>
                    </div>
                </div>
                <!-- Ad container for long Adsterra banner in left column -->
                <div id="adsterra-left-long" class="fp-adsterra-container mt-3 text-center">
                    @((MarkupString)AdHtmlLeft)
                </div>
            </div>

            <!-- Center column (8) - main planner content -->
            <div class="col-12 col-md-8 @(isSimpleMode ? "simple-mode" : "")">>
            <p class="text-muted mb-3">@(isSimpleMode ? "List your monthly expenses to see how they'll grow by retirement." : "Enter your current breakdown of costs. Expand a category to view or edit its details. Future costs update automatically.")</p>

            @* <b>Multi-city and City tiered plan coming soon</b> *@
            <!-- Save status indicator -->
            <div class="d-flex align-items-center mb-2">
                @if (isSaving || (autosaveTimer != null && autosaveTimer.Enabled))
                {
                    <div class="spinner-border spinner-border-sm text-primary me-2" role="status" aria-hidden="true"></div>
                    <span class="small text-muted">Saving…</span>
                }
                else if (!string.IsNullOrEmpty(lastSaveMessage))
                {
                    <span class="small text-success">@lastSaveMessage</span>
                }
                else if (!string.IsNullOrEmpty(saveErrorMessage))
                {
                    <span class="small text-danger">Save error: @saveErrorMessage</span>
                }
            </div>

            <!-- City Template Selector -->
            @if (availableCities != null && availableCities.Any())
            {
                <div class="mb-3">
                    <div class="d-flex align-items-center gap-3">
                        @if (selectedCity != null)
                        {
                            <div class="alert alert-success mb-0 py-2 px-3 d-flex align-items-center gap-3">
                                <i class="bi bi-geo-alt-fill"></i>
                                <span><strong>@selectedCity.CityName</strong>, @selectedCity.Country</span>
                                @if (matchedProfile != null)
                                {
                                    <span class="badge bg-primary">Profile: @matchedProfile.ProfileName</span>
                                }
                                <button class="btn btn-sm btn-outline-primary" @onclick="ToggleCitySelector">
                                    Change City
                                </button>
                                @if (matchedProfile != null)
                                {
                                    <button class="btn btn-sm btn-success" @onclick="() => LoadExpensesFromProfile(matchedProfile)">
                                        <i class="bi bi-download"></i> Load Sample Expenses
                                    </button>
                                }
                            </div>
                        }
                        else
                        {
                            <button class="btn btn-outline-primary" @onclick="ToggleCitySelector">
                                <i class="bi bi-globe"></i> Select City Template
                            </button>
                        }
                    </div>
                    
                    @if (showCitySelector)
                    {
                        <div class="card mt-2">
                            <div class="card-body">
                                <h6>Available Cities</h6>
                                <div class="row g-2">
                                    @foreach (var city in availableCities.OrderBy(c => c.Country).ThenBy(c => c.CityName))
                                    {
                                        <div class="col-md-4">
                                            <button class="btn btn-outline-secondary w-100 text-start" 
                                                    @onclick="async () => { await SelectCity(city); showCitySelector = false; }">
                                                <strong>@city.CityName</strong><br />
                                                <small class="text-muted">@city.Country • @city.Currency</small>
                                            </button>
                                        </div>
                                    }
                                </div>
                                <button class="btn btn-sm btn-secondary mt-2" @onclick="ToggleCitySelector">
                                    Close
                                </button>
                            </div>
                        </div>
                    }
                </div>
            }

            @if (cityProfiles != null && cityProfiles.Any())
{
    <div class="card mt-3">
        <div class="card-header bg-primary text-white">
            <h6 class="mb-0">Select a Profile for @selectedCity.CityName</h6>
        </div>
        <div class="card-body">
            <div class="row g-2">
                @foreach (var profile in cityProfiles)
                {
                    <div class="col-md-6">
                        <div class="card mb-2">
                            <div class="card-body">
                                <strong>@profile.ProfileName</strong>
                                <div class="small text-muted">
                                    Age: @profile.AgeMin - @profile.AgeMax<br />
                                    Marital Status: @profile.MaritalStatus<br />
                                    Children: @profile.ChildrenCount
                                </div>
                                <button class="btn btn-sm btn-outline-success mt-2"
                                        @onclick="() => OnProfileSelected(profile)">
                                    Select Profile
                                </button>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
}

@code {
    // Called when user selects a profile
    private void OnProfileSelected(DemographicProfile profile)
    {
        matchedProfile = profile;
        matchedProfile.DeserializeFromDatabase(); // Ensure expenses are loaded
        StateHasChanged();
    }
}
            <!-- Tab Navigation -->
            <ul class="nav nav-tabs mb-1" role="tablist">
                @foreach (var t in Tabs)
                {
                    <li class="nav-item d-flex align-items-center me-1 @(activeTab == t ? "tab-item-active" : "")" role="presentation">
                        <button class="nav-link @(activeTab == t ? "tab-active-custom" : "")"
                                role="tab"
                                aria-selected="@(activeTab == t ? "true" : "false")"
                                tabindex="0"
                                disabled="false"
                                @onkeydown="(KeyboardEventArgs e) => HandleTabKey(e, t)"
                                @onclick="() => OnTabClick(t)">
                            @GetTabLabel(t)
                        </button>

                        @if (string.Equals(t, "Plan-A-City-A", StringComparison.OrdinalIgnoreCase))
                        {
                            <span class="bi bi-info-circle text-info ms-1"
                                  style="cursor:pointer; font-size:1rem;"
                                  title="About plans, cities and currencies"
                                  @onclick:stopPropagation="true"
                                  @onclick="TogglePlanATabInfo"></span>
                        }
                    </li>
                }
            </ul>

            @if (showTipPlanATab)
            {
                <div class="alert alert-info py-2 px-3 mb-2 small" style="max-width: 860px;">
                    Next release will allow multiple plans with different cities and currencies. You’ll be able to create and compare plans, each with its own assumptions and locale settings.
                    <span class="float-end" style="cursor:pointer;" title="Close" @onclick="() => showTipPlanATab = false">
                        <span class="bi bi-x-lg"></span>
                    </span>
                </div>
            }

            <!-- Insert this opening tag immediately after the closing </ul> of the tab list (the ul.nav.nav-tabs ... ) -->
            <div class="tab-panel-box position-relative">
                <!-- Mode Toggle positioned to the left of Show Intro button -->
                <div class="position-absolute" style="top: 10px; right: 280px; z-index: 1;">
                    <div style="
                        background: linear-gradient(90deg,#fffbe6,#fffde7);
                        border: 2px solid #FFD600;
                        border-radius: 14px;
                        box-shadow: 0 2px 12px rgba(255,214,0,0.08);
                        padding: 8px 18px;
                        display: inline-flex;
                        align-items: center;
                        gap: 12px;">
                        <div class="d-flex align-items-center gap-2">
                            <span style="font-size: 1rem;">@(isSimpleMode ? "🎯" : "⚙️")</span>
                            <span class="fw-bold small @(isSimpleMode ? "text-success" : "text-primary")">
                                @(isSimpleMode ? "Beginner" : "Advanced")
                            </span>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="compactModeToggle"
                                   checked="@(!isSimpleMode)" @onchange="ToggleSimpleMode">
                            <label class="form-check-label small fw-bold ms-1" for="compactModeToggle" style="cursor: pointer;">
                                @(isSimpleMode ? "Advanced" : "Simple")
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Buttons in top-right corner -->
                <div class="position-absolute d-flex gap-2" style="top: 10px; right: 10px; z-index: 1;">
                    <button class="btn btn-sm btn-warning"
                            @onclick="ShowIntroWithReset">
                        <i class="bi bi-info-circle me-1"></i> Show Intro
                    </button>

                    <button class="btn btn-sm btn-outline-danger"
                            @onclick="ClearDataAsync"
                            title="Clear all saved plan data">
                        <i class="bi bi-trash me-1"></i>
                        Clear Plan Data
                    </button>
                </div>

                <!-- Planner Controls Strip -->

                <div class="section-card">
                    <div>
                        <div style="display:flex; align-items:center; gap:8px; font-weight:700;">
                            <div>Assumptions:</div>
                        </div>

                        <div class="small-note" style="margin-top:8px;">
                            <div class="d-flex flex-wrap align-items-center">
                                <!-- Years to Retirement -->
                                <div class="me-4">
                                    <span class="bi bi-info-circle text-info"
                                          style="font-size: 1.1rem; cursor: pointer;"
                                          @onclick="() => showToolTipYearsInfo = !showToolTipYearsInfo"
                                          tabindex="0"
                                          title="Click for more info"></span>
                                    <span style="font-weight: 600; color: #495057;">Years to retire:</span>
                                    <b>@YearsToRetirement</b>
                                </div>

                                <!-- Inflation Rate -->
                                <div class="me-4">
                                    <span class="bi bi-info-circle text-info"
                                          style="font-size: 1.1rem; cursor: pointer;"
                                          @onclick="() => showToolTipInflationInfo = !showToolTipInflationInfo"
                                          tabindex="0"
                                          title="Click for more info"></span>
                                    <span style="font-weight: 600; color: #495057;">Annual Inflation rate:</span>
                                    <b>@InflationRate%</b>
                                </div>

                                <button class="btn-edit" @onclick="() => OpenWizard(1)">Edit</button>
                            </div>

                            <!-- Tooltips -->
                            @if (showToolTipYearsInfo)
                            {
                                <div class="alert alert-info py-2 px-3 mt-2 mb-0 small" style="max-width: 320px;">
                                    <strong>Years to Retirement:</strong> The number of years until you expect to retire. This is used to project your future costs.
                                    <span class="float-end" style="cursor:pointer;" @onclick="() => showToolTipYearsInfo = false" title="Close">
                                        <span class="bi bi-x-lg"></span>
                                    </span>
                                </div>
                            }

                            @if (showToolTipInflationInfo)
                            {
                                <div class="alert alert-info py-2 px-3 mt-2 mb-0 small" style="max-width: 320px;">
                                    <strong>Annual Inflation Rate:</strong> The yearly percentage increase in prices of goods and services. This rate is used to project how your costs will grow over time before retirement.
                                    <span class="float-end" style="cursor:pointer;" @onclick="() => showToolTipInflationInfo = false" title="Close">
                                        <span class="bi bi-x-lg"></span>
                                    </span>
                                </div>
                            }
                        </div>
                    </div>
                </div>
                <br />

                <br />



                <!-- Totals Strip: Current and Retirement side by side -->
                <div class="totals-strip d-flex align-items-center justify-content-center gap-4 mb-3">
                    <div class="totals-strip d-flex align-items-center justify-content-center gap-4 mb-2">
                        <div class="totals-box bg-primary bg-opacity-75 text-white px-4 py-3 d-flex flex-column align-items-center">
                            <span class="totals-label d-flex align-items-center">
                                Current Total
                                <span class="bi bi-info-circle text-warning ms-2"
                                      style="cursor: pointer; font-size: .95rem;"
                                      title="What is this?"
                                      @onclick="() => showTipCurrentTotal = !showTipCurrentTotal"></span>
                            </span>
                            <span class="totals-value">@FormatCurrency(TotalCurrentPerMonth)</span>
                        </div>
                        <div class="totals-box bg-success bg-opacity-75 text-white px-4 py-3 d-flex flex-column align-items-center">
                            <span class="totals-label d-flex align-items-center">
                                Retirement Total
                                <span class="bi bi-info-circle text-warning ms-2"
                                      style="cursor: pointer; font-size: .95rem;"
                                      title="What is this?"
                                      @onclick="() => showTipRetirementTotal = !showTipRetirementTotal"></span>
                            </span>
                            <span class="totals-value">@FormatCurrency(TotalRetirement)</span>
                        </div>
                    </div>

                    @if (showTipCurrentTotal)
                    {
                        <div class="alert alert-info py-2 px-3 mb-2 small text-center" style="max-width:640px; margin:0 auto;">
                            Current Total is the sum of all items converted to monthly values across categories.
                            <span class="float-end" style="cursor:pointer;" title="Close" @onclick="() => showTipCurrentTotal = false">
                                <span class="bi bi-x-lg"></span>
                            </span>
                        </div>
                    }
                    @if (showTipRetirementTotal)
                    {
                        <div class="alert alert-info py-2 px-3 mb-3 small text-center" style="max-width:640px; margin:0 auto;">
                            Retirement Total is the projected monthly amount at retirement using each item’s adjustment and inflation.
                            Years to retirement: <b>@YearsToRetirement</b>, Global inflation: <b>@InflationRate%</b>.
                            <span class="float-end" style="cursor:pointer;" title="Close" @onclick="() => showTipRetirementTotal = false">
                                <span class="bi bi-x-lg"></span>
                            </span>
                        </div>
                    }
                </div>
                <div class="d-flex justify-content-center mb-3">
                    <div class="d-flex justify-content-center align-items-center gap-2 mb-2">
                        <button class="btn btn-success btn-sm rounded-pill px-4 fw-semibold shadow-sm" style="height:32px; font-size:1.04rem;"
                                type="button" @onclick:stopPropagation="true" @onclick="OpenAddCategoryModal" disabled="@isSaving">
                            <span class="bi bi-plus-lg me-1"></span> Add Category
                        </button>
                        <span class="bi bi-info-circle text-info"
                              style="cursor: pointer; font-size: 1rem;"
                              title="What is this?"
                              @onclick="() => showTipAddCategory = !showTipAddCategory"></span>
                    </div>
                    @if (showTipAddCategory)
                    {
                        <div class="alert alert-info py-2 px-3 mb-3 small text-center" style="max-width:640px; margin:0 auto;">
                            Add a new category to group related items (e.g., Housing, Food). You can add items inside it afterwards.
                            <span class="float-end" style="cursor:pointer;" title="Close" @onclick="() => showTipAddCategory = false">
                                <span class="bi bi-x-lg"></span>
                            </span>
                        </div>
                    }
                </div>
                <div class="d-flex align-items-center mb-2" style="margin-left: 8px;">
                    <div class="d-flex align-items-center mb-2" style="margin-left: 8px;">
                        <button class="btn btn-outline-secondary btn-sm d-flex align-items-center gap-1"
                                title="@(AnyCategoryExpanded() ? "Collapse all categories" : "Expand all categories")"
                                @onclick="ToggleCollapseAllCategories">
                            <span class="bi @(AnyCategoryExpanded() ? "bi-chevron-up" : "bi-chevron-down")"></span>
                            <span>@(AnyCategoryExpanded() ? "Collapse All" : "Expand All")</span>
                        </button>
                        <span class="bi bi-info-circle text-info ms-2"
                              style="cursor: pointer; font-size: 1rem;"
                              title="What is this?"
                              @onclick="() => showTipCollapseAll = !showTipCollapseAll"></span>
                    </div>
                    @if (showTipCollapseAll)
                    {
                        <div class="alert alert-info py-2 px-3 mb-2 small" style="max-width:640px; margin-left:8px;">
                            @(AnyCategoryExpanded()
                                                    ? "Collapse all categories to condense the view."
                                                    : "Expand all categories to view every item at once.")
                        <span class="float-end" style="cursor:pointer;" title="Close" @onclick="() => showTipCollapseAll = false">
                            <span class="bi bi-x-lg"></span>
                        </span>
                    </div>
                                        }
                </div>


                <style>
                    .totals-strip {
                        width: 100%;
                        max-width: 600px;
                        margin-left: auto;
                        margin-right: auto;
                    }

                    .totals-box {
                        min-width: 180px;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
                        border: 1.5px solid #e3e3e3;
                        transition: box-shadow 0.2s;
                    }

                    .totals-label {
                        font-size: 1rem;
                        font-weight: 500;
                        opacity: 0.92;
                        letter-spacing: 0.01em;
                    }

                    .totals-value {
                        font-size: 1.08rem;
                        font-weight: 700;
                        letter-spacing: 0.01em;
                        margin-top: 2px;
                    }
                </style>


                <!-- Add Category Modal (root level for correct binding) -->
                @if (showAddCategoryModal)
                {
                    <div class="modal-backdrop fade show" style="z-index:1040"></div>
                    <div class="modal d-block" tabindex="-1" role="dialog" style="z-index:1050;">
                        <div class="modal-dialog modal-dialog-centered modal-fullscreen-sm-down" role="document">
                            <div class="modal-content shadow" style="border-top: 4px solid #1F6FEB; overflow: hidden;">
                                <div class="modal-header bg-light">
                                    <h5 class="modal-title d-flex align-items-center">
                                        <span class="bi bi-folder-plus me-2 text-primary"></span>
                                        Add New Category
                                    </h5>
                                    <button type="button" class="btn-close" aria-label="Close" @onclick="CloseAddCategoryModal"></button>
                                </div>
                                <div class="modal-body py-4" style="background-color: #f8faff;">
                                    <p class="text-muted small mb-3">
                                        Categories help organize your expenses. Enter a descriptive name for your category.
                                    </p>
                                    <div class="form-floating">
                                        <input type="text"
                                               class="form-control form-control-lg"
                                               id="newCategoryName"
                                               @bind="NewCategoryName"
                                               @bind:event="oninput"
                                               @onkeydown="HandleAddCategoryKeyModal"
                                               autofocus />
                                        <label for="newCategoryName">Category Name</label>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mt-3">
                                        <small class="text-muted">@(string.IsNullOrWhiteSpace(NewCategoryName) ? "Example: Housing, Food, Transportation" : $"Adding: {NewCategoryName}")</small>
                                        <small class="@(IsAddCategoryDisabled ? "text-danger" : "text-success")">
                                            @(IsAddCategoryDisabled ? "" : "Ready to add")
                                        </small>
                                    </div>
                                </div>
                                <div class="modal-footer border-top-0 pt-0" style="background-color: #f8faff;">
                                    <button class="btn btn-outline-secondary px-4" @onclick="CloseAddCategoryModal">
                                        Cancel
                                    </button>
                                    <button class="btn btn-primary px-4 d-flex align-items-center gap-2"
                                            @onclick="AddCategoryModal"
                                            disabled="@(isSaving || IsAddCategoryDisabled)">
                                        @if (isSaving)
                                        {
                                            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                        }
                                        else
                                        {
                                            <span class="bi bi-plus-lg"></span>
                                        }
                                        Add Category
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                }

                <div class="accordion" id="costCategoryAccordion">
                    @{
                        // Compute groups safely even if Items is null
                        var groups = (Items ?? new List<CostItem>()).GroupBy(i => i.Category ?? string.Empty).OrderBy(g => g.Key ?? string.Empty);
                        int catIdx = 0;
                    }
                    @foreach (var group in groups)
                    {
                        var groupKey = group.Key ?? string.Empty;
                        var groupCurrentTotal = group.Sum(i => i.GetMonthlyEquivalent);
                        var groupRetirementTotal = group.Sum(i => i.GetRetirementValue(YearsToRetirement, InflationRate));
                        var expanded = !IsCollapsed(groupKey);
                        var collapseId = $"catCollapse_{catIdx}";
                        <div class="card mb-2">
                            <div class="card-header d-flex align-items-center" style="cursor:pointer;" @onclick="() => ToggleCollapse(groupKey)" title="@(expanded ? "Click to collapse" : "Click to expand")">
                                <button class="btn btn-sm btn-soft-danger me-2" title="Remove category" aria-label="Remove category" @onclick:stopPropagation="true" @onclick="() => ConfirmRemoveCategory(groupKey)" disabled="@isSaving">
                                    <span class="bi bi-trash-fill icon-muted" aria-hidden="true"></span>
                                </button>
                                <span class="me-2" style="font-weight: bold !important;">@groupKey</span>
                                <span class="bi bi-info-circle text-info me-2 @(isSimpleMode ? "" : "")"
                                      style="cursor: pointer; font-size: .95rem;"
                                      title="What is this?"
                                      @onclick:stopPropagation="true"
                                      @onclick="() => ToggleCatInfo(groupKey)"></span>
                                <span class="small text-muted d-none d-md-inline" title="@(isSimpleMode ? "Current monthly total" : "Current total")">
                                    @(isSimpleMode ? "Monthly" : "Current"): @FormatCurrency(groupCurrentTotal)
                                </span>
                                <span class="small text-muted ms-2 d-none d-md-inline" title="@(isSimpleMode ? "Future monthly total" : "Retirement total")">
                                    @(isSimpleMode ? "Future" : "Retirement"): @FormatCurrency(groupRetirementTotal)
                                </span>

                                <div class="ms-auto d-flex gap-2 align-items-center">
                                    <button class="btn btn-success btn-sm" title="@(isSimpleMode ? "Add expense" : "Add item")" @onclick:stopPropagation="true" @onclick="() => OpenAddItemModal(groupKey)">
                                        <span class="bi bi-plus"></span> @(isSimpleMode ? "Add Expense" : "Add Item")
                                    </button>
                                    <span class="bi bi-info-circle text-info @(isSimpleMode ? "" : "")"
                                          style="cursor: pointer; font-size: .95rem;"
                                          title="What is this?"
                                          @onclick:stopPropagation="true"
                                          @onclick="() => ToggleAddItemInfo(groupKey)"></span>
                                </div>
                            </div>
                            <div class="collapse @(expanded ? "show" : "")" id="@collapseId">
                                <div class="card-body p-2 grid-yellow-bg rounded-4">
                                    @if (IsCatInfoOpen(groupKey))
                                    {
                                        <div class="alert alert-info py-2 px-3 mb-2 small">
                                            This category groups related items. Click the header to expand/collapse.
                                            Use the trash icon to remove the category.
                                            <span class="float-end" style="cursor:pointer;" title="Close" @onclick="() => ToggleCatInfo(groupKey)">
                                                <span class="bi bi-x-lg"></span>
                                            </span>
                                        </div>
                                    }
                                    @if (IsAddItemInfoOpen(groupKey))
                                    {
                                        <div class="alert alert-info py-2 px-3 mb-2 small">
                                            Add a new item under this category. You can set name, frequency, amount, and retirement adjustment.
                                            <span class="float-end" style="cursor:pointer;" title="Close" @onclick="() => ToggleAddItemInfo(groupKey)">
                                                <span class="bi bi-x-lg"></span>
                                            </span>
                                        </div>
                                    }
                                    
                                    <!-- DESKTOP TABLE VIEW -->
                                    <table class="table table-sm mb-0 mobile-hide-table">
                                        <thead>
                                            <tr>
                                                <th class="fw-bold text-left align-middle" style="width:40px; font-weight: bold !important;">&nbsp;</th>
                                                <th class="fw-bold text-center align-middle" style="width:140px; font-weight: bold !important;">
                                                    @(isSimpleMode ? "Expense" : "Item")
                                                </th>
                                                <th class="fw-bold text-center align-middle complex-column" style="width:120px; font-weight: bold !important;">@(isSimpleMode ? "How Often" : "Frequency")<br /><span class="small">@(isSimpleMode ? "" : "(Units)")</span></th>
                                                <th class="fw-bold text-end align-middle complex-column" style="width:140px; font-weight: bold !important;">@(isSimpleMode ? "Amount" : "Per Unit")<br /><span class="small">($)</span></th>
                                                <th class="fw-bold text-end align-middle" style="width:140px; font-weight: bold !important;">
                                                    @(isSimpleMode ? "Monthly Cost" : "Per Month")<br /><span class="small">($)</span>
                                                </th>
                                                <th class="fw-bold text-center align-middle" style="width:120px; font-weight: bold !important;">
                                                    @(isSimpleMode ? "Retirement?" : "Include In")<br /><span class="small">@(isSimpleMode ? "" : "Retirement")</span>
                                                </th>
                                                <th class="fw-bold text-center align-middle complex-column" style="width:320px; font-weight: bold !important;">Retirement<br /><span class="small">Adjustment</span></th>
                                                <th class="fw-bold text-center align-middle complex-column" style="width:160px; font-weight: bold !important;">Inflation<br /><span class="small">Rate (%)</span></th>
                                                <th class="fw-bold text-end align-middle" style="width:180px; font-weight: bold !important;">
                                                    @(isSimpleMode ? "Future Cost" : "Retirement")<br /><span class="small">@(isSimpleMode ? "($)" : "Value")</span>
                                                </th>
                                            </tr>
                                        </thead>

                                        <tbody>
                                            @foreach (var item in group.OrderBy(i => i.Subcategory ?? string.Empty))
                                            {
                                                var idx = Items?.IndexOf(item) ?? -1;
                                                <tr>
                                                    <td style="width:40px; vertical-align:middle;">
                                                        <div class="d-flex flex-column gap-1">
                                                            <button style="background: none; border: none; padding: 2px 4px; color: rgba(220, 53, 69, 0.8); font-size: 0.8rem;" title="Remove item" aria-label="Remove item" @onclick="() => ConfirmRemoveItem(idx)" disabled="@isSaving">
                                                                <span class="bi bi-trash-fill" aria-hidden="true"></span>
                                                            </button>
                                                        </div>
                                                    </td>
                                                    <td class="text-left align-middle">@item.Subcategory</td>
                                                    <td class="text-center align-middle complex-column" style="width:120px;">@item.Frequency</td>

                                                    <td class="text-end align-middle complex-column" style="width:140px;">@FormatCurrency(item.CurrentValue)</td>
                                                    <td class="text-end align-middle" style="width:140px;">
                                                        <span class="fw-bold">@FormatCurrency(item.GetMonthlyEquivalent)</span>
                                                    </td>
                                                    <td class="text-center align-middle" style="width:60px;">
                                                        @if (item.IncludeInRetirement)
                                                        {
                                                            @if (isSimpleMode)
                                                            {
                                                                <span class="badge bg-success">Yes</span>
                                                            }
                                                            else
                                                            {
                                                                <i class="bi bi-check-lg text-success" title="Included in retirement"></i>
                                                            }
                                                        }
                                                        else
                                                        {
                                                            @if (isSimpleMode)
                                                            {
                                                                <span class="badge bg-secondary">No</span>
                                                            }
                                                            else
                                                            {
                                                                <i class="bi bi-x-lg text-danger" title="Not included in retirement"></i>
                                                            }
                                                        }
                                                    </td>
                                                    <td class="text-center align-middle complex-column" style="width:320px;">
                                                        @if (item.IncludeInRetirement)
                                                        {
                                                            @if (item.AdjustOption == RetirementAdjustOption.CustomPercentage)
                                                            {
                                                                <span>@item.CustomPercentage%</span>
                                                            }
                                                            else if (item.AdjustOption == RetirementAdjustOption.Manual)
                                                            {
                                                                <span>@FormatCurrency(item.ManualRetirementValue ?? 0)</span>
                                                            }
                                                            else if (item.AdjustOption == RetirementAdjustOption.Same)
                                                            {
                                                                <span>No change</span>
                                                            }
                                                            else if (item.AdjustOption == RetirementAdjustOption.Inflation)
                                                            {
                                                                <span>Inflation</span>
                                                            }
                                                        }
                                                    </td>
                                                    <td class="text-center align-middle complex-column" style="width:160px;">
                                                        @if (item.IncludeInRetirement && item.AdjustOption == RetirementAdjustOption.Inflation)
                                                        {
                                                            @if (@item.PerItemInflationSource == InflationSource.UseGlobal)
                                                            {
                                                                <span>@InflationRate%</span>

                                                            }
                                                            else if (item.PerItemInflationSource == InflationSource.Custom)
                                                            {
                                                                <span>@item.PerItemInflationPercent%</span>
                                                            }
                                                        }
                                                    </td>

                                                    <td class="text-end align-middle" style="width:180px;">
                                                        <span class="fw-bold">@FormatCurrency(item.GetRetirementValue(YearsToRetirement, InflationRate))</span>
                                                    </td>
                                                    <td style="width:120px; vertical-align:middle;">
                                                        <div class="d-flex align-items-center gap-2 justify-content-end">
                                                            <button class="btn btn-sm btn-outline-primary px-2 py-1"
                                                                    style="font-size:0.92rem; white-space:nowrap;"
                                                                    title="@(isSimpleMode ? "Edit this expense" : "View or edit this item")"
                                                                    @onclick="() => OpenEditItemModal(idx)">
                                                                <i class="bi bi-pencil-square me-1"></i>
                                                                <span class="d-none d-md-inline">@(isSimpleMode ? "Edit" : "View/Edit")</span>
                                                            </button>
                                                            <span class="bi bi-info-circle text-info @(isSimpleMode ? "" : "")"
                                                                  style="cursor: pointer; font-size: .95rem;"
                                                                  title="What is this?"
                                                                  @onclick="() => ToggleViewEditInfo(idx)"></span>
                                                        </div>
                                                    </td>
                                                </tr>
                                                @if (IsViewEditInfoOpen(idx))
                                                {
                                                    <tr>
                                                        <td colspan="10" class="p-0">
                                                            <div class="alert alert-info py-2 px-3 mb-2 small m-0">
                                                                View/Edit opens the item modal to update name, frequency, amount, and retirement adjustments
                                                                (Same, Custom %, Manual, Inflation). Changes auto‑save.
                                                                <span class="float-end" style="cursor:pointer;" title="Close" @onclick="() => ToggleViewEditInfo(idx)">
                                                                    <span class="bi bi-x-lg"></span>
                                                                </span>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                }
                                            }
                                        </tbody>
                                    </table>

                                    <!-- MOBILE CARD VIEW -->
                                    <div class="mobile-card-layout" style="display: none;">
                                        @foreach (var item in group.OrderBy(i => i.Subcategory ?? string.Empty))
                                        {
                                            var idx = Items?.IndexOf(item) ?? -1;
                                            <div class="expense-card">
                                                <!-- Card Header: Name + Actions -->
                                                <div class="expense-card-header">
                                                    <div class="expense-card-title">@item.Subcategory</div>
                                                    <div class="expense-card-actions">
                                                        <button class="btn btn-sm btn-outline-primary expense-card-btn"
                                                                title="Edit"
                                                                @onclick="() => OpenEditItemModal(idx)">
                                                            <i class="bi bi-pencil-square"></i>
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-danger expense-card-btn"
                                                                title="Remove"
                                                                @onclick="() => ConfirmRemoveItem(idx)"
                                                                disabled="@isSaving">
                                                            <i class="bi bi-trash-fill"></i>
                                                        </button>
                                                    </div>
                                                </div>

                                                <!-- Card Body: Key Info in Grid -->
                                                <div class="expense-card-body">
                                                    <!-- Now: Monthly Cost -->
                                                    <div class="expense-card-field expense-card-field-full">
                                                        <div class="expense-card-label">Now</div>
                                                        <div class="expense-card-value-large" style="color: #0d6efd; font-weight: 600;">
                                                            @FormatCurrency(item.GetMonthlyEquivalent)/mo
                                                        </div>
                                                    </div>

                                                    <!-- Retirement: Smart Display -->
                                                    <div class="expense-card-field expense-card-field-full">
                                                        <div class="expense-card-label">Retirement</div>
                                                        <div class="expense-card-value-large" style="color: #198754; font-weight: 600;">
                                                            @if (item.IncludeInRetirement)
                                                            {
                                                                var retValue = item.GetRetirementValue(YearsToRetirement, InflationRate);
                                                                var adjustment = "";
                                                                
                                                                if (item.AdjustOption == RetirementAdjustOption.Inflation)
                                                                {
                                                                    adjustment = $" (+inflation)";
                                                                }
                                                                else if (item.AdjustOption == RetirementAdjustOption.CustomPercentage)
                                                                {
                                                                    adjustment = $" ({item.CustomPercentage}%)";
                                                                }
                                                                else if (item.AdjustOption == RetirementAdjustOption.Manual)
                                                                {
                                                                    adjustment = " (manual)";
                                                                }
                                                                
                                                                <span>@FormatCurrency(retValue)/mo@adjustment</span>
                                                            }
                                                            else
                                                            {
                                                                var reason = item.RetirementExclusionReason switch
                                                                {
                                                                    ExclusionReason.NotNeeded => "Not needed",
                                                                    ExclusionReason.PaidOff => "Paid off",
                                                                    ExclusionReason.Other => "Not included",
                                                                    _ => "Not included"
                                                                };
                                                                <span style="color: #6c757d; font-style: italic;">@reason</span>
                                                            }
                                                        </div>
                                                    </div>

                                                    <!-- Frequency & Amount side by side (Advanced mode only) -->
                                                    @if (!isSimpleMode)
                                                    {
                                                        <div class="expense-card-field">
                                                            <div class="expense-card-label">Frequency</div>
                                                            <div class="expense-card-value">@item.Frequency</div>
                                                        </div>
                                                        <div class="expense-card-field">
                                                            <div class="expense-card-label">Amount</div>
                                                            <div class="expense-card-value">@FormatCurrency(item.CurrentValue)</div>
                                                        </div>
                                                    }
                                                </div>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                        catIdx++;
                    }
                </div>

                </div>


                @* Loading overlay shown while initial API calls are in progress *@
                @if (isLoading)
                {
                    <div class="blazor-loading-modal">
                        <div class="blazor-loading-content">
                            <div class="spinner-border text-primary" role="status"></div>
                            <div class="mt-2 fw-bold">Loading...</div>
                        </div>
                    </div>
                }

                @* Undo toast for recent removals *@
                @if (showUndoToast)
                {
                    <div style="position:fixed; right:16px; bottom:16px; z-index:1060;">
                        <div class="card shadow-sm" style="min-width:220px;">
                            <div class="card-body p-2 d-flex align-items-center justify-content-between">
                                <div class="small text-truncate me-2">Item removed</div>
                                <div>
                                    <button class="btn btn-sm btn-link" @onclick="UndoRemove">Undo</button>
                                </div>
                            </div>
                        </div>
                    </div>
                }

                @* Timeout / retry modal *@
                @if (showTimeoutModal)
                {
                    <div class="modal-backdrop fade show" style="z-index:1040"></div>
                    <div class="modal d-block" tabindex="-1" role="dialog" style="z-index:1050;">
                        <div class="modal-dialog modal-sm" role="document">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Request timed out</h5>
                                    <button type="button" class="btn-close" aria-label="Close" @onclick="DismissTimeoutModal"></button>
                                </div>
                                <div class="modal-body">
                                    <p class="small">@timeoutMessage</p>
                                </div>
                                <div class="modal-footer">
                                    <button class="btn btn-secondary btn-sm" @onclick="DismissTimeoutModal">Dismiss</button>
                                    <button class="btn btn-primary btn-sm" @onclick="RetryOperation">Retry</button>
                                </div>
                            </div>
                        </div>
                    </div>
                }
                @if (showCreateTabModal)
                {
                    <div class="modal fade show d-block" tabindex="-1" style="background:rgba(0,0,0,0.25); z-index:2000;" role="dialog">
                        <div class="modal-dialog" role="document">
                            <div class="modal-content">
                                <div class="modal-header bg-warning-subtle">
                                    <h5 class="modal-title">Create New Plan</h5>
                                    <button type="button" class="btn-close" aria-label="Close" @onclick="CancelCreateTab"></button>
                                </div>
                                <div class="modal-body">
                                    <p>Would you like to create <strong>@GetTabLabel(pendingGhostTab ?? string.Empty)</strong>?</p>
                                </div>
                                <div class="modal-footer">
                                    <button class="btn btn-secondary" @onclick="CancelCreateTab">Cancel</button>
                                    <button class="btn btn-primary" @onclick="ConfirmCreateTab">Create Plan</button>
                                </div>
                            </div>
                        </div>
                    </div>
                }

                <div class="d-flex align-items-center mb-2" style="margin-left: 8px;">
                    <div class="d-flex align-items-center mb-2" style="margin-left: 8px;">
                        <button class="btn btn-outline-secondary btn-sm d-flex align-items-center gap-1"
                                title="@(AnyCategoryExpanded() ? "Collapse all categories" : "Expand all categories")"
                                @onclick="ToggleCollapseAllCategories">
                            <span class="bi @(AnyCategoryExpanded() ? "bi-chevron-up" : "bi-chevron-down")"></span>
                            <span>@(AnyCategoryExpanded() ? "Collapse All" : "Expand All")</span>
                        </button>
                        <span class="bi bi-info-circle text-info ms-2"
                              style="cursor: pointer; font-size: 1rem;"
                              title="What is this?"
                              @onclick="() => showTipCollapseAll = !showTipCollapseAll"></span>
                    </div>
                    @if (showTipCollapseAll)
                    {
                        <div class="alert alert-info py-2 px-3 mb-2 small" style="max-width:640px; margin-left:8px;">
                            @(AnyCategoryExpanded()
                                                    ? "Collapse all categories to condense the view."
                                                    : "Expand all categories to view every item at once.")
                        <span class="float-end" style="cursor:pointer;" title="Close" @onclick="() => showTipCollapseAll = false">
                            <span class="bi bi-x-lg"></span>
                        </span>
                    </div>
                                        }
                </div>
            </div>
        </div>
    </div>
    <!-- Important Disclaimers -->
    <div class="mt-4 p-3" style="background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px;">
        <div style="display: flex; align-items: flex-start; gap: 8px;">
            <div style="color: #856404; margin-top: 2px;">
                <i class="bi bi-exclamation-triangle" style="font-size: 1.1rem;"></i>
            </div>
            <div>
                <div style="font-weight: 600; color: #856404; margin-bottom: 8px;">Important Disclaimers</div>
                <div style="font-size: 0.9rem; color: #856404; line-height: 1.4;">
                    <p style="margin-bottom: 8px;"><strong>Not Financial Advice:</strong> This tool is for educational and planning purposes only. Results are projections based on your inputs and assumptions. This is not personalized financial, tax, or investment advice.</p>

                    <p style="margin-bottom: 8px;"><strong>Inflation Assumptions:</strong> Actual inflation rates vary significantly over time and by category. Real-world cost changes for housing, healthcare, food, and other expenses may differ substantially from the uniform inflation rates used in this calculator.</p>

                    <p style="margin-bottom: 8px;"><strong>Life Changes:</strong> Job transitions, family changes, health issues, geographic moves, and lifestyle adjustments are not modeled but can materially impact your actual cost of living in retirement.</p>

                    <p style="margin-bottom: 8px;"><strong>Economic Factors:</strong> Economic conditions, policy changes, technological advances, and other external factors may significantly alter future costs in ways not captured by simple inflation projections.</p>

                    <p style="margin-bottom: 0;"><strong>Professional Guidance:</strong> Consider consulting with qualified financial advisors, tax professionals, and retirement planning specialists who can provide personalized advice for your complete financial situation and retirement planning needs.</p>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    // Simple Mode Toggle
    private bool isSimpleMode = true; // Start in beginner mode by default

    private void ToggleSimpleMode()
    {
        isSimpleMode = !isSimpleMode;
        StateHasChanged();
    }

    // Add this method to your @code section
    // Add this method to your @code section
    private async Task ClearDataAsync()
    {
        try
        {
            // Confirm with user before deleting
            var confirm = await JSRuntime.InvokeAsync<bool>("confirm",
                "Are you sure you want to clear all saved cost of living data? This action cannot be undone.");

            if (!confirm) return;

            var apiBaseUrl = GetApiBaseUrl();

            // Create request body for POST method instead of query parameters
            var deleteRequest = new
            {
                UserGuid = userGuid,
                CalculatorType = calculatorType
            };

            var json = System.Text.Json.JsonSerializer.Serialize(deleteRequest);
            using var content = new StringContent(json, System.Text.Encoding.UTF8, "application/json");

            var client = HttpCustomClientService.CreateRetryClient(HttpClientFactory);
            // Use POST to clear endpoint instead of DELETE with query parameters
            var response = await client.PostAsync($"{apiBaseUrl}/api/FinPlan/remove", content);

            if (response.IsSuccessStatusCode || response.StatusCode == System.Net.HttpStatusCode.NotFound)
            {
                // Clear the "don't show intro again" localStorage setting
                await JSRuntime.InvokeVoidAsync("localStorage.removeItem", "finplan-cost-of-living-income-planner-hide-intro");

                Log("Plan data cleared successfully.");

                // Reload the page to reflect the cleared state
                Navigation.NavigateTo(Navigation.Uri, forceLoad: true);
            }
            else
            {
                LogError($"Failed to clear data: {response.StatusCode}");
                await JSRuntime.InvokeVoidAsync("alert", $"Failed to clear data: {response.StatusCode}");
            }
        }
        catch (Exception ex)
        {
            LogError($"Error clearing data: {ex.Message}");
            await JSRuntime.InvokeVoidAsync("alert", $"Error clearing data: {ex.Message}");
        }
    }

    // Ghost tab creation modal state

    // Returns true if the Add Category button should be disabled
    private bool IsAddCategoryDisabled => false;//string.IsNullOrWhiteSpace(NewCategoryName?.Trim());

    private bool showCreateTabModal = false;
    private string? pendingGhostTab = null;

    private void PromptCreateTab(string ghostTab)
    {
        pendingGhostTab = ghostTab;
        showCreateTabModal = true;
    }

    private async Task ConfirmCreateTab()
    {
        showCreateTabModal = false;
        pendingGhostTab = null;
        await AddNewTab();
    }

    private void CancelCreateTab()
    {
        showCreateTabModal = false;
        pendingGhostTab = null;
    }

    // Edit Item Modal state
    // Details Modal State
    private bool showDetailsModal = false;
    private bool detailsEditMode = false;
    private int detailsItemIndex = -1;
    private string modalSubcategory = string.Empty;
    private string modalFrequency = "Monthly";
    private decimal modalCurrentValue = 0m;
    private string modalAdjustOption = "Same";
    private decimal modalCustomPercentage = 0m;
    private decimal? modalManualRetirementValue = null;
    private string modalPerItemInflationSource = "UseGlobal";
    private decimal modalPerItemInflationPercent = 0m;
    private bool modalIncludeInRetirement = true;

    private void OpenViewModal(int idx)
    {
        if (idx >= 0 && idx < Items.Count)
        {
            detailsItemIndex = idx;
            // Copy values to modal fields
            modalSubcategory = Items[idx].Subcategory ?? string.Empty;
            modalFrequency = Items[idx].Frequency.ToString();
            modalCurrentValue = Items[idx].CurrentValue;
            modalAdjustOption = Items[idx].AdjustOption.ToString();
            modalCustomPercentage = Items[idx].CustomPercentage;
            modalManualRetirementValue = Items[idx].ManualRetirementValue;
            modalPerItemInflationSource = Items[idx].PerItemInflationSource.ToString();
            modalPerItemInflationPercent = Items[idx].PerItemInflationPercent ?? 0;
            modalIncludeInRetirement = Items[idx].IncludeInRetirement;
            showDetailsModal = true;
            detailsEditMode = true; // Always open in edit mode
        }
    }

    private async Task HandleIntroModal()
    {
        showIntroModal = false;

        // Only show intro modal if model is empty and user hasn't opted out
        if (Items == null || !Items.Any())
        {
            try
            {
                var hideIntro = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "finplan-cost-of-living-income-planner-hide-intro");
                showIntroModal = string.IsNullOrEmpty(hideIntro) || !hideIntro.Equals("true", StringComparison.OrdinalIgnoreCase);
            }
            catch
            {
                // Ignore errors and show modal
                showIntroModal = false;
            }
        }
    }

    private async Task OnDontShowIntroChanged(ChangeEventArgs e)
    {
        bool checkedState = e?.Value is bool b && b;
        string key = "finplan-cost-of-living-income-planner-hide-intro";

        if (checkedState)
        {
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", key, "true");
        }
        else
        {
            await JSRuntime.InvokeVoidAsync("localStorage.removeItem", key);
        }
    }

    // Add these new methods
    private void CloseIntroModal()
    {
        showIntroModal = false;
        StateHasChanged();
    }

    // Onboarding Methods for Simple Mode
    private async Task StartWithCommonExpenses()
    {
        // Load preset common expense categories
        Items = GetCommonExpensePreset();
        RecalculateAll(save: true);
        await InvokeAsync(StateHasChanged);
    }

    private async Task StartFromScratch()
    {
        // Clear any existing items and let user build from scratch
        Items = new List<CostItem>();
        showIntroModal = false; // Add this line to close the modal

        RecalculateAll(save: true);
        await InvokeAsync(StateHasChanged);
    }

    private List<CostItem> GetCommonExpensePreset()
    {
        return new List<CostItem>
        {
            // Housing
            new CostItem { Category = "Housing", Subcategory = "Rent/Mortgage", Frequency = FinPlan.Shared.Models.LivingCosts.Frequency.Monthly, CurrentValue = 2000, IncludeInRetirement = true, AdjustOption = RetirementAdjustOption.Same },
            new CostItem { Category = "Housing", Subcategory = "Utilities", Frequency = FinPlan.Shared.Models.LivingCosts.Frequency.Monthly, CurrentValue = 200, IncludeInRetirement = true, AdjustOption = RetirementAdjustOption.Same },

            // Food
            new CostItem { Category = "Food", Subcategory = "Groceries", Frequency = FinPlan.Shared.Models.LivingCosts.Frequency.Monthly, CurrentValue = 600, IncludeInRetirement = true, AdjustOption = RetirementAdjustOption.Same },
            new CostItem { Category = "Food", Subcategory = "Dining Out", Frequency = FinPlan.Shared.Models.LivingCosts.Frequency.Monthly, CurrentValue = 300, IncludeInRetirement = true, AdjustOption = RetirementAdjustOption.CustomPercentage, CustomPercentage = 75 },

            // Transportation
            new CostItem { Category = "Transportation", Subcategory = "Car Payment", Frequency = FinPlan.Shared.Models.LivingCosts.Frequency.Monthly, CurrentValue = 400, IncludeInRetirement = false },
            new CostItem { Category = "Transportation", Subcategory = "Gas & Maintenance", Frequency = FinPlan.Shared.Models.LivingCosts.Frequency.Monthly, CurrentValue = 200, IncludeInRetirement = true, AdjustOption = RetirementAdjustOption.CustomPercentage, CustomPercentage = 50 },

            // Healthcare
            new CostItem { Category = "Healthcare", Subcategory = "Insurance Premiums", Frequency = FinPlan.Shared.Models.LivingCosts.Frequency.Monthly, CurrentValue = 300, IncludeInRetirement = true, AdjustOption = RetirementAdjustOption.Inflation, PerItemInflationSource = InflationSource.Custom, PerItemInflationPercent = 4 },

            // Personal
            new CostItem { Category = "Personal", Subcategory = "Entertainment", Frequency = FinPlan.Shared.Models.LivingCosts.Frequency.Monthly, CurrentValue = 200, IncludeInRetirement = true, AdjustOption = RetirementAdjustOption.Same },
            new CostItem { Category = "Personal", Subcategory = "Clothing", Frequency = FinPlan.Shared.Models.LivingCosts.Frequency.Monthly, CurrentValue = 100, IncludeInRetirement = true, AdjustOption = RetirementAdjustOption.CustomPercentage, CustomPercentage = 75 }
        };
    }


    private void CloseDetailsModal()
    {
        showDetailsModal = false;
        detailsEditMode = false;
        detailsItemIndex = -1;
    }

    private void EnableDetailsEdit()
    {
        detailsEditMode = true;
    }

    private void SaveDetailsModal()
    {
        if (detailsItemIndex >= 0 && detailsItemIndex < Items.Count)
        {
            var item = Items[detailsItemIndex];
            item.Subcategory = modalSubcategory;
            if (Enum.TryParse<FinPlan.Shared.Models.LivingCosts.Frequency>(modalFrequency, out var freq))
                item.Frequency = freq;
            item.CurrentValue = modalCurrentValue;
            if (Enum.TryParse<RetirementAdjustOption>(modalAdjustOption, out var adj))
                item.AdjustOption = adj;
            item.CustomPercentage = modalCustomPercentage;
            item.ManualRetirementValue = modalManualRetirementValue;
            if (Enum.TryParse<InflationSource>(modalPerItemInflationSource, out var infl))
                item.PerItemInflationSource = infl;
            item.PerItemInflationPercent = modalPerItemInflationPercent;
            item.IncludeInRetirement = modalIncludeInRetirement;
            StateHasChanged();
            ScheduleAutosave();
        }
        CloseDetailsModal();
    }
    private List<CostItem> Items { get; set; } = new List<CostItem>(); // = StandardCostCategories.GetDefaults();

    // City Template properties
    private List<CityTemplate>? availableCities;
    private CityTemplate? selectedCity;
    private List<DemographicProfile>? cityProfiles;
    private DemographicProfile? matchedProfile;
    private bool showCitySelector = false;
    private UserDemographics? userDemographics;

    private int YearsToRetirement { get; set; } = 20;
    // Backing field and property so changes trigger recalculation and autosave
    private decimal _inflationRate = 2.5m;
    private decimal InflationRate
    {
        get => _inflationRate;
        set
        {
            if (_inflationRate != value)
            {
                _inflationRate = value;
                RecalculateAll(save: true);
            }
        }
    }

    private bool isLoading = false;

    // Saving state for UI
    private bool isSaving = false;
    private string lastSaveMessage = string.Empty;
    private string saveErrorMessage = string.Empty;

    // Only dynamic tabs; start with a single default plan (plan-a)
    private string activeTab = "Plan-A-City-A"; // Track active tab for UI highlighting

    private List<string> dynamicTabs = new List<string>();
    // Always include the built-in "plan-a" tab first so UI shows a default tab when no dynamic tabs exist.
    private IEnumerable<string> Tabs
    {
        get
        {
            // Ensure TabHeaders has default for built-in tab
            if (!TabHeaders.ContainsKey("Plan-A-City-A")) TabHeaders["Plan-A-City-A"] = "Plan - A";

            // Return plan-a first, then any dynamic tabs (excluding duplicates)
            var result = new List<string> { "Plan-A-City-A" };
            foreach (var t in dynamicTabs)
            {
                if (!string.Equals(t, "Plan-A-City-A", StringComparison.OrdinalIgnoreCase) && !result.Contains(t)) result.Add(t);
            }
            return result;
        }
    }

    private Dictionary<string, string> TabHeaders = new Dictionary<string, string>();

    // Lightweight fpDebug helpers - non-blocking
    private void Log(string message)
    {
        try { _ = JSRuntime.InvokeVoidAsync("fpDebug.log", $"CostOfLiving: {message}"); } catch { }
    }
    private void LogError(string message)
    {
        try { _ = JSRuntime.InvokeVoidAsync("fpDebug.error", $"CostOfLiving ERROR: {message}"); } catch { }
    }

    private string GetTabLabel(string tab)
    {
        if (TabHeaders.ContainsKey(tab) && !string.IsNullOrWhiteSpace(TabHeaders[tab])) return TabHeaders[tab];
        // fallback: convert id to nicer label
        if (string.Equals(tab, "Plan-A-City-A", StringComparison.OrdinalIgnoreCase)) return "Plan-A-City-A";
        return tab;
    }

    private HashSet<string> editingTabs = new HashSet<string>(StringComparer.OrdinalIgnoreCase);

    private bool IsEditing(string tab) => editingTabs.Contains(tab);
    private void ToggleEdit(string tab)
    {
        if (editingTabs.Contains(tab)) editingTabs.Remove(tab);
        else
        {
            if (!TabHeaders.ContainsKey(tab)) TabHeaders[tab] = GetTabLabel(tab);
            editingTabs.Add(tab);
        }
    }

    private void CancelEdit(string tab)
    {
        if (TabHeaders.ContainsKey(tab) == false)
            TabHeaders[tab] = GetTabLabel(tab);
        editingTabs.Remove(tab);
    }

    private void HandleHeaderKey(KeyboardEventArgs e, string tab)
    {
        if (e.Key == "Enter")
        {
            _ = SaveTabHeader(tab);
        }
        else if (e.Key == "Escape")
        {
            CancelEdit(tab);
        }
    }

    private void HandleTabKey(KeyboardEventArgs e, string tab)
    {
        if (e == null) return;

        if (e.Key == "ArrowLeft" || e.Key == "ArrowRight")
        {
            var list = Tabs.ToList();
            if (list.Count <= 1) return;
            var idx = list.IndexOf(tab);
            if (idx < 0) idx = 0;
            idx = e.Key == "ArrowLeft" ? (idx - 1 + list.Count) % list.Count : (idx + 1) % list.Count;
            var next = list[idx];
            // navigate visually and load data
            _ = OnTabClick(next);
        }
        else if (e.Key == "Enter" || e.Key == " ")
        {
            _ = OnTabClick(tab);
        }
    }

    private string MapTabToCalculatorType(string tab)
    {
        // All tabs map to CostOfLiving-{tabId}
        return $"CostOfLiving-{tab}";
    }

    private async Task SaveTabHeader(string tab)
    {
        Log($"SaveTabHeader start: {tab}");
        // Load existing data so we don't overwrite items when updating header
        try
        {
            var calcType = MapTabToCalculatorType(tab);
            var apiBaseUrl = GetApiBaseUrl();
            var client = HttpCustomClientService.CreateRetryClient(HttpClientFactory);
            var loadUrl = $"{apiBaseUrl}/api/CostOfLiving/load?userGuid={Uri.EscapeDataString(userGuid)}&calculatorType={Uri.EscapeDataString(calcType)}";
            CostOfLivingData? data = null;

            try
            {
                var resp = await client.GetAsync(loadUrl);
                Log($"SaveTabHeader: load call returned {(int)resp.StatusCode}");
                if (resp.IsSuccessStatusCode)
                {
                    var j = await resp.Content.ReadAsStringAsync();
                    data = System.Text.Json.JsonSerializer.Deserialize<CostOfLivingData>(j, new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true });
                }
            }
            catch (Exception exLoad)
            {
                LogError($"SaveTabHeader load error: {exLoad.Message}");
            }

            if (data == null)
            {
                // No existing saved data - use defaults
                data = new CostOfLivingData
                {
                    Items = StandardCostCategories.GetDefaults(),
                    YearsToRetirement = YearsToRetirement,
                    InflationRate = InflationRate,
                    CollapsedCategories = collapsed.ToList()
                };
            }

            data.Header = TabHeaders.ContainsKey(tab) ? TabHeaders[tab] : GetTabLabel(tab);

            var dto = new PersistCostOfLivingRequest
            {
                UserGuid = userGuid,
                CalculatorType = calcType,
                Data = data
            };

            var json = System.Text.Json.JsonSerializer.Serialize(dto);
            var content = new StringContent(json, System.Text.Encoding.UTF8, "application/json");
            var saveUrl = $"{apiBaseUrl}/api/CostOfLiving/save";
            var saveResp = await client.PostAsync(saveUrl, content);
            Log($"SaveTabHeader: save returned {(int)saveResp.StatusCode}");
            if (saveResp.IsSuccessStatusCode)
            {
                editingTabs.Remove(tab);
                await LoadTabsAsync();
                StateHasChanged();
                Log($"SaveTabHeader success: {tab}");
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("console.error", $"Save header failed: {saveResp.StatusCode}");
                LogError($"SaveTabHeader failed status: {saveResp.StatusCode}");
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("console.error", $"Error saving header: {ex.Message}");
            LogError($"SaveTabHeader exception: {ex.Message}");
        }
    }

    private bool isAddingTab = false;
    private bool isDeletingPlans = false;

    // Confirm deletion of all saved dynamic plans for the user
    private async Task ConfirmDeleteAll()
    {
        try
        {
            var ok = await JSRuntime.InvokeAsync<bool>("confirm", "Delete ALL saved plans for this user? This cannot be undone.");
            if (!ok) return;
            await DeleteAllPlans();
        }
        catch (Exception ex)
        {
            LogError($"ConfirmDeleteAll exception: {ex.Message}");
        }
    }

    // Delete each dynamic tab for the current user by calling the existing DeleteTab API endpoint
    private async Task DeleteAllPlans()
    {
        Log("DeleteAllPlans start");
        if (isDeletingPlans) return;
        isDeletingPlans = true;
        isSaving = true; // show saving indicator to user while deleting
        await InvokeAsync(StateHasChanged);

        try
        {
            var apiBaseUrl = GetApiBaseUrl();
            var client = HttpCustomClientService.CreateRetryClient(HttpClientFactory);

            // Make a copy of dynamicTabs to avoid mutation during enumeration
            var tabsToDelete = dynamicTabs.ToList();
            foreach (var tab in tabsToDelete)
            {
                try
                {
                    var calcType = MapTabToCalculatorType(tab);
                    var url = $"{apiBaseUrl}/api/CostOfLiving/tabs?userGuid={Uri.EscapeDataString(userGuid)}&calculatorType={Uri.EscapeDataString(calcType)}";
                    var resp = await client.DeleteAsync(url);
                    Log($"DeleteAllPlans: delete {tab} returned {(int)resp.StatusCode}");
                }
                catch (Exception ex)
                {
                    LogError($"DeleteAllPlans delete error for {tab}: {ex.Message}");
                }
            }

            // Clear local state for dynamic tabs and headers
            foreach (var t in tabsToDelete)
            {
                dynamicTabs.Remove(t);
                if (TabHeaders.ContainsKey(t)) TabHeaders.Remove(t);
            }

            // Reload tabs and select default
            await LoadTabsAsync();
            activeTab = Tabs.FirstOrDefault() ?? "Plan-A-City-A";
            calculatorType = MapTabToCalculatorType(activeTab);
            await LoadFromApi();

            Log("DeleteAllPlans completed");
        }
        catch (Exception ex)
        {
            LogError($"DeleteAllPlans exception: {ex.Message}");
        }
        finally
        {
            isDeletingPlans = false;
            isSaving = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private static string NumberToLetters(int number)
    {
        // Convert 1 -> A, 26 -> Z, 27 -> AA, etc.
        var sb = new System.Text.StringBuilder();
        while (number > 0)
        {
            number--; // 1-based
            int rem = number % 26;
            sb.Insert(0, (char)('A' + rem));
            number = number / 26;
        }
        return sb.ToString();
    }

   private async Task AddNewTab()
{
    Log("AddNewTab start");
    if (isAddingTab) return; // guard re-entrancy
    isAddingTab = true;
    try
    {
        int totalTabs = Tabs.Count();
        int candidateIndex = totalTabs + 1;
        if (!TabHeaders.ContainsKey("Plan-A-City-A")) TabHeaders["Plan-A-City-A"] = "Plan-A-City-A";
        var existingNames = new HashSet<string>(TabHeaders.Values, StringComparer.OrdinalIgnoreCase);

        string headerName;
        do
        {
            var letters = NumberToLetters(candidateIndex);
            headerName = selectedCity != null
                ? $"Plan-{letters}-{selectedCity.CityName}"
                : $"Plan-{letters}-City-{letters}";
            candidateIndex++;
        } while (existingNames.Contains(headerName));

        var newTab = $"tab-{DateTime.Now:yyMMddHHmmss}";

        // Use city template if selected and matchedProfile exists
        List<CostItem> initialItems;
        if (selectedCity != null && matchedProfile != null && matchedProfile.SampleExpenses != null && matchedProfile.SampleExpenses.Any())
        {
            initialItems = matchedProfile.SampleExpenses.Select(e => new CostItem
            {
                Category = e.Category,
                Subcategory = e.Subcategory,
                CurrentValue = e.CurrentValue,
                Frequency = e.Frequency,
                AdjustOption = e.AdjustOption,
                PerItemInflationPercent = e.PerItemInflationPercent,
                PerItemInflationSource = e.PerItemInflationSource,
                CustomPercentage = e.CustomPercentage,
                ManualRetirementValue = e.ManualRetirementValue,
                IncludeInRetirement = e.IncludeInRetirement,
                RetirementExclusionReason = e.RetirementExclusionReason
            }).ToList();
        }
        else
        {
            initialItems = StandardCostCategories.GetDefaults();
        }

        var initialData = new CostOfLivingData
        {
            Header = headerName,
            Items = initialItems,
            YearsToRetirement = YearsToRetirement,
            InflationRate = InflationRate,
            CollapsedCategories = collapsed.ToList()
        };

        var dto = new PersistCostOfLivingRequest
        {
            UserGuid = userGuid,
            CalculatorType = $"CostOfLiving-{newTab}",
            Data = initialData
        };

        var apiBaseUrl = GetApiBaseUrl();
        var client = HttpCustomClientService.CreateRetryClient(HttpClientFactory);
        var json = System.Text.Json.JsonSerializer.Serialize(dto);
        var content = new StringContent(json, System.Text.Encoding.UTF8, "application/json");
        var saveUrl = $"{apiBaseUrl}/api/CostOfLiving/save";
        var resp = await client.PostAsync(saveUrl, content);
        Log($"AddNewTab: save returned {(int)resp.StatusCode}");
        if (resp.IsSuccessStatusCode)
        {
            await LoadTabsAsync();
            TabHeaders[newTab] = headerName;
            if (!dynamicTabs.Contains(newTab)) dynamicTabs.Add(newTab);
            await OnTabClick(newTab);
            StateHasChanged();
            Log($"AddNewTab success: {newTab} / {headerName}");
        }
        else
        {
            await JSRuntime.InvokeVoidAsync("console.error", $"Create tab failed: {resp.StatusCode}");
            LogError($"AddNewTab failed status: {resp.StatusCode}");
        }
    }
    catch (Exception ex)
    {
        await JSRuntime.InvokeVoidAsync("console.error", $"Error creating tab: {ex.Message}");
        LogError($"AddNewTab exception: {ex.Message}");
    }
    finally
    {
        isAddingTab = false;
    }
}

    private async Task ConfirmDeleteTab(string tab)
    {
        try
        {
            var header = TabHeaders.ContainsKey(tab) ? TabHeaders[tab] : tab;
            var ok = await JSRuntime.InvokeAsync<bool>("confirm", $"Delete tab '{header}'? This will remove saved data.");
            if (ok) await DeleteTab(tab);
        }
        catch (Exception ex)
        {
            LogError($"ConfirmDeleteTab exception: {ex.Message}");
        }
    }

    private async Task DeleteTab(string tab)
    {
        Log($"DeleteTab start: {tab}");
        try
        {
            var calcType = MapTabToCalculatorType(tab);
            var apiBaseUrl = GetApiBaseUrl();
            var url = $"{apiBaseUrl}/api/CostOfLiving/tabs?userGuid={Uri.EscapeDataString(userGuid)}&calculatorType={Uri.EscapeDataString(calcType)}";
            var client = HttpCustomClientService.CreateRetryClient(HttpClientFactory);
            var response = await client.DeleteAsync(url);
            Log($"DeleteTab: delete returned {(int)response.StatusCode}");
            if (response.IsSuccessStatusCode)
            {
                // remove locally
                dynamicTabs.Remove(tab);
                if (TabHeaders.ContainsKey(tab)) TabHeaders.Remove(tab);

                // reload tabs
                await LoadTabsAsync();

                // if deleted tab was active, switch to first available
                if (activeTab == tab)
                {
                    activeTab = Tabs.FirstOrDefault() ?? "Plan-A-City-A";
                    calculatorType = MapTabToCalculatorType(activeTab);
                    await LoadFromApi();
                }

                StateHasChanged();
                Log($"DeleteTab success: {tab}");
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("console.error", $"Delete failed: {response.StatusCode}");
                LogError($"DeleteTab failed status: {response.StatusCode}");
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("console.error", $"Error deleting tab: {ex.Message}");
            LogError($"DeleteTab exception: {ex.Message}");
        }
    }

    private async Task LoadTabsAsync()
    {
        Log("LoadTabsAsync start");
        try
        {
            var apiBaseUrl = GetApiBaseUrl();
            var url = $"{apiBaseUrl}/api/CostOfLiving/tabs?userGuid={Uri.EscapeDataString(userGuid)}";
            var client = HttpCustomClientService.CreateRetryClient(HttpClientFactory);
            // reduce timeout for this non-critical call so UI can proceed if API is slow
            try { client.Timeout = TimeSpan.FromSeconds(10); } catch { }
            var response = await client.GetAsync(url);
            Log($"LoadTabsAsync: tabs call returned {(int)response.StatusCode}");
            if (response.IsSuccessStatusCode)
            {
                var json = await response.Content.ReadAsStringAsync();
                var list = System.Text.Json.JsonSerializer.Deserialize<List<string>>(json, new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true });
                if (list != null)
                {
                    dynamicTabs = list.Select(s => s.StartsWith("CostOfLiving-") ? s.Substring("CostOfLiving-".Length) : s).ToList();

                    // ensure headers dictionary has defaults for built-in tabs
                    if (!TabHeaders.ContainsKey("Plan-A-City-A")) TabHeaders["Plan-A-City-A"] = "Plan-A-City-A";

                    // load headers for each dynamic tab
                    foreach (var t in dynamicTabs)
                    {
                        var dataUrl = $"{apiBaseUrl}/api/CostOfLiving/load?userGuid={Uri.EscapeDataString(userGuid)}&calculatorType={Uri.EscapeDataString($"CostOfLiving-{t}")}";
                        var resp = await client.GetAsync(dataUrl);
                        Log($"LoadTabsAsync: load header for {t} returned {(int)resp.StatusCode}");
                        if (resp.IsSuccessStatusCode)
                        {
                            var j = await resp.Content.ReadAsStringAsync();
                            try
                            {
                                var d = System.Text.Json.JsonSerializer.Deserialize<CostOfLivingData>(j, new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true });
                                if (d != null) TabHeaders[t] = d.Header ?? t;
                            }
                            catch (Exception ex)
                            {
                                TabHeaders[t] = t;
                                LogError($"LoadTabsAsync header parse failed for {t}: {ex.Message}");
                            }
                        }
                        else
                        {
                            TabHeaders[t] = t;
                        }
                    }

                    Log($"LoadTabsAsync success: {dynamicTabs.Count} tabs");
                }
            }
        }
        catch (OperationCanceledException oce)
        {
            // Timeout or cancellation - continue with defaults
            LogError($"LoadTabsAsync timeout/cancelled: {oce.Message}");
            dynamicTabs = new List<string>();
            if (!TabHeaders.ContainsKey("Plan-A-City-A")) TabHeaders["Plan-A-City-A"] = "Plan-A-City-A";
            // Show modal to allow retry
            ShowTimeout(OperationType.LoadTabs, "Loading tabs timed out. You can retry.");
        }
        catch (Exception ex)
        {
            LogError($"LoadTabsAsync exception: {ex.Message}");
            // ensure we have at least the default tab so UI remains usable
            dynamicTabs = new List<string>();
            if (!TabHeaders.ContainsKey("Plan-A-City-A")) TabHeaders["Plan-A-City-A"] = "Plan-A-City-A";
            ShowTimeout(OperationType.LoadTabs, $"Loading tabs failed: {ex.Message}");
        }
    }

    // when loading tab data, pick up header if present
    private async Task LoadFromApi()
    {
        Log($"LoadFromApi start: {calculatorType}");
        var apiBaseUrl = GetApiBaseUrl();
        var url = $"{apiBaseUrl}/api/CostOfLiving/load?userGuid={Uri.EscapeDataString(userGuid)}&calculatorType={Uri.EscapeDataString(calculatorType)}";

        try
        {
            var client = HttpCustomClientService.CreateRetryClient(HttpClientFactory);
            // shorter timeout to avoid long blocking during initial render
            try { client.Timeout = TimeSpan.FromSeconds(12); } catch { }
            var response = await client.GetAsync(url);
            Log($"LoadFromApi: call returned {(int)response.StatusCode}");
            if (response.IsSuccessStatusCode)
            {
                var json = await response.Content.ReadAsStringAsync();
                try
                {
                    var data = System.Text.Json.JsonSerializer.Deserialize<CostOfLivingData>(json, new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true });
                    if (data != null)
                    {
                        // restore top-level settings
                        YearsToRetirement = data.YearsToRetirement;
                        InflationRate = data.InflationRate;
                        collapsed = new HashSet<string>(data.CollapsedCategories ?? new List<string>());

                        Items = data.Items ?? new List<CostItem>();

                        // set header mapping for current activeTab
                        if (!string.IsNullOrWhiteSpace(activeTab))
                        {
                            TabHeaders[activeTab] = data.Header ?? GetTabLabel(activeTab);
                        }

                        StateHasChanged();
                        Log($"LoadFromApi success: items={Items.Count}");
                        return;
                    }
                }
                catch (Exception ex)
                {
                    LogError($"LoadFromApi parse error: {ex.Message}");
                }

                // Fallback: try deserialize into raw list of items
                var loaded = System.Text.Json.JsonSerializer.Deserialize<List<CostItem>>(json, new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true });
                if (loaded != null)
                {
                    Items = loaded;
                    StateHasChanged();
                    Log($"LoadFromApi fallback list loaded: items={Items.Count}");
                }
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.NotFound)
            {
                // no saved data, load defaults
                //Items = StandardCostCategories.GetDefaults();
                //StateHasChanged();
                //Log("LoadFromApi: not found - using defaults");
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("console.error", $"Load failed: {response.StatusCode}");
                LogError($"LoadFromApi failed status: {response.StatusCode}");
            }
        }
        catch (OperationCanceledException oce)
        {
            LogError($"LoadFromApi timeout/cancelled: {oce.Message}");
            // fallback to defaults so UI remains usable
            Items = StandardCostCategories.GetDefaults();
            StateHasChanged();
            ShowTimeout(OperationType.LoadFromApi, "Loading calculator data timed out. You can retry.");
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("console.error", $"Error loading: {ex.Message}");
            LogError($"LoadFromApi exception: {ex.Message}");
            ShowTimeout(OperationType.LoadFromApi, $"Loading data failed: {ex.Message}");
        }
    }

    private void UpdateGroupCategory(string oldCategory, string newCategory)
    {
        if (oldCategory == newCategory) return;

        foreach (var it in Items.Where(i => (i.Category ?? string.Empty) == (oldCategory ?? string.Empty)))
        {
            it.Category = newCategory;
        }
    }

    private HashSet<string> collapsed = new HashSet<string>();

    private string GenerateNewItemName(string category)
    {
        var catKey = string.IsNullOrWhiteSpace(category) ? "Uncategorized" : category;
        var existingCount = Items.Count(i => string.Equals(i.Category ?? string.Empty, category ?? string.Empty, StringComparison.OrdinalIgnoreCase));
        return $"{catKey} Item {existingCount + 1}";
    }

    private void AddItemToCategory(string category)
    {
        Log($"AddItemToCategory: {category}");
        var cat = category ?? string.Empty;
        var newItem = new CostItem
        {
            Category = cat,
            Subcategory = GenerateNewItemName(cat),
            CurrentValue = 0m,
            AdjustOption = RetirementAdjustOption.Inflation,
            IncludeInRetirement = true
        };

        // insert at end of that category's block (just add; rendering sorts by Subcategory)
        Items.Add(newItem);

        // Open the same view/edit modal used for existing items so the user can edit the new item
        var idx = Items.IndexOf(newItem);
        if (idx >= 0)
        {
            OpenViewModal(idx);
        }

        StateHasChanged();
        ScheduleAutosave();
    }

    private void ToggleCollapse(string category)
    {
        var key = category ?? string.Empty;
        if (collapsed.Contains(key)) collapsed.Remove(key);
        else collapsed.Add(key);
    }

    private bool IsCollapsed(string category)
    {
        return collapsed.Contains(category ?? string.Empty);
    }

    private decimal TotalCurrent => Math.Round(Items.Sum(i => i.CurrentValue), 2);

    private decimal TotalCurrentPerMonth => Math.Round(Items.Sum(i => i.GetMonthlyEquivalent), 2);

    private decimal TotalRetirement => Math.Round(Items.Sum(i => i.GetRetirementValue(YearsToRetirement, InflationRate)), 2);

    private static string FormatCurrency(decimal value)
    {
        return string.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C0}", value);
    }

    private string FormatDecimal(decimal value)
    {
        return value.ToString("0.0", System.Globalization.CultureInfo.CurrentCulture);
    }

    // Missing fields and helper methods restored
    private string NewCategorySentinel { get; } = "__new__";
    private string SelectedAddCategory { get; set; } = string.Empty;
    private string NewCategoryName { get; set; } = string.Empty;
    private bool showAddCategoryModal = false;

    private List<string> Categories => Items.Select(i => i.Category ?? string.Empty).Distinct().OrderBy(c => c).ToList();

    private void RefreshCategories()
    {
        InvokeAsync(StateHasChanged);
    }

    private void OpenAddCategoryModal()
    {
        NewCategoryName = string.Empty;
        showAddCategoryModal = true;
    }

    private void CloseAddCategoryModal()
    {
        showAddCategoryModal = false;
        NewCategoryName = string.Empty;
    }

    private void AddCategoryModal()
    {
        var newCat = (NewCategoryName ?? string.Empty).Trim();
        if (string.IsNullOrWhiteSpace(newCat)) return;
        if (Categories.Contains(newCat))
        {
            SelectedAddCategory = newCat;
            CloseAddCategoryModal();
            return;
        }

        var newItem = new CostItem
        {
            Category = newCat,
            Subcategory = GenerateNewItemName(newCat),
            CurrentValue = 0m,
            AdjustOption = RetirementAdjustOption.Inflation,
            IncludeInRetirement = true
        };

        Items.Add(newItem);
        RefreshCategories();
        SelectedAddCategory = newCat;
        StateHasChanged();
        ScheduleAutosave();
        CloseAddCategoryModal();
    }

    private void HandleAddCategoryKeyModal(KeyboardEventArgs e)
    {
        if (e.Key == "Enter") AddCategoryModal();
    }

    private void AddRow()
    {
        var category = SelectedAddCategory == NewCategorySentinel ? (string.IsNullOrWhiteSpace(NewCategoryName) ? "Uncategorized" : NewCategoryName) : SelectedAddCategory;
        var newItem = new CostItem { Category = category, Subcategory = GenerateNewItemName(category), CurrentValue = 0m, AdjustOption = RetirementAdjustOption.Inflation, IncludeInRetirement = true };
        Items.Add(newItem);
        if (SelectedAddCategory == NewCategorySentinel && !string.IsNullOrWhiteSpace(NewCategoryName))
        {
            RefreshCategories();
            SelectedAddCategory = NewCategoryName;
            NewCategoryName = string.Empty;
        }
        ScheduleAutosave();
    }

    // remove with undo support
    private CostItem? lastRemovedItem = null;
    private int lastRemovedIndex = -1;
    private System.Timers.Timer? undoTimer;
    private bool showUndoToast = false;

    private void RemoveItem(int index)
    {
        if (index >= 0 && index < Items.Count)
        {
            lastRemovedIndex = index;
            lastRemovedItem = Items[index];
            Items.RemoveAt(index);

            showUndoToast = true;
            StateHasChanged();

            // start undo timer; if expires, finalize by saving
            if (undoTimer == null)
            {
                undoTimer = new System.Timers.Timer(5000);
                undoTimer.AutoReset = false;
                undoTimer.Elapsed += async (_, __) =>
                {
                    try
                    {
                        showUndoToast = false;
                        await InvokeAsync(async () => await SaveToApi());
                        lastRemovedItem = null;
                        lastRemovedIndex = -1;
                        StateHasChanged();
                    }
                    catch (Exception ex)
                    {
                        LogError($"undoTimer elapsed exception: {ex.Message}");
                    }
                };
            }
            else
            {
                undoTimer.Stop();
                undoTimer.Interval = 5000;
            }
            undoTimer.Start();
        }
    }

    private void UndoRemove()
    {
        if (lastRemovedItem != null)
        {
            var insertIndex = Math.Min(Math.Max(0, lastRemovedIndex), Items.Count);
            Items.Insert(insertIndex, lastRemovedItem);
            lastRemovedItem = null;
            lastRemovedIndex = -1;
            showUndoToast = false;
            if (undoTimer != null)
            {
                try { undoTimer.Stop(); undoTimer.Dispose(); } catch { }
                undoTimer = null;
            }
        }
    }

    private void RemoveCategory(string category)
    {
        if (string.IsNullOrEmpty(category)) return;
        Items.RemoveAll(i => (i.Category ?? string.Empty) == category);
        ScheduleAutosave();
    }

    // user & calculatorType fields and API helpers
    private string userGuid = Guid.NewGuid().ToString();
    private string calculatorType = "CostOfLiving_Your";

    private string GetApiBaseUrl()
    {
#if DEBUG
                        return Configuration["FinPlanSettings:ApiBaseUrlLocal"] ?? "https://localhost:7330";
#else
        return Configuration["FinPlanSettings:ApiBaseUrlCloud"] ?? "api-money-amperespark-bnbva5h5g6gme6fm.eastus2-01.azurewebsites.net";
#endif
    }

    private async Task SaveToApi()
    {
        Log("SaveToApi start");
        isSaving = true;
        saveErrorMessage = string.Empty;
        lastSaveMessage = string.Empty;
        await InvokeAsync(StateHasChanged);

        var apiBaseUrl = GetApiBaseUrl();
        var url = $"{apiBaseUrl}/api/CostOfLiving/save";

        try
        {
            string headerToSave = string.Empty;
            const string prefix = "CostOfLiving-";
            if (!string.IsNullOrEmpty(calculatorType) && calculatorType.StartsWith(prefix, StringComparison.OrdinalIgnoreCase))
            {
                var tabId = calculatorType.Substring(prefix.Length);
                if (TabHeaders != null && TabHeaders.ContainsKey(tabId)) headerToSave = TabHeaders[tabId];
            }

            var dto = new PersistCostOfLivingRequest
            {
                UserGuid = userGuid,
                CalculatorType = calculatorType,
                Data = new CostOfLivingData
                {
                    Header = headerToSave,
                    Items = Items.Select(i => new CostItem
                    {
                        Category = i.Category,
                        Subcategory = i.Subcategory,
                        CurrentValue = i.CurrentValue,
                        Frequency = i.Frequency,
                        AdjustOption = i.AdjustOption,
                        PerItemInflationPercent = i.PerItemInflationPercent,
                        PerItemInflationSource = i.PerItemInflationSource,
                        CustomPercentage = i.CustomPercentage,
                        ManualRetirementValue = i.ManualRetirementValue,
                        IncludeInRetirement = i.IncludeInRetirement
                    }).ToList(),
                    CollapsedCategories = collapsed.ToList(),
                    YearsToRetirement = YearsToRetirement,
                    InflationRate = InflationRate
                }
            };

            var json = System.Text.Json.JsonSerializer.Serialize(dto);
            var content = new StringContent(json, System.Text.Encoding.UTF8, "application/json");
            var client = HttpCustomClientService.CreateRetryClient(HttpClientFactory);
            var response = await client.PostAsync(url, content);
            Log($"SaveToApi: save returned {(int)response.StatusCode}");
            if (response.IsSuccessStatusCode)
            {
                await JSRuntime.InvokeVoidAsync("console.log", "Saved Cost of Living");
                Log("SaveToApi success");
                //lastSaveMessage = $"Saved {DateTime.Now:T}";
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("console.error", $"Save failed: {response.StatusCode}");
                LogError($"SaveToApi failed status: {response.StatusCode}");
                saveErrorMessage = $"{response.StatusCode}";
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("console.error", $"Error saving: {ex.Message}");
            LogError($"SaveToApi exception: {ex.Message}");
            saveErrorMessage = ex.Message;
        }
        finally
        {
            isSaving = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    protected override void OnInitialized()
    {
        base.OnInitialized();
        SelectedAddCategory = Categories.FirstOrDefault() ?? NewCategorySentinel;
        Log("OnInitialized");
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            Log("OnAfterRenderAsync firstRender start");

            // Check if user has opted out of seeing the intro modal
            try
            {
                var hideIntro = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "finplan-cost-of-living-hide-intro");
                if (hideIntro == "true")
                {
                    showIntroModal = false;
                }
            }
            catch (Exception ex)
            {
                LogError($"Error checking intro modal preference: {ex.Message}");
            }

            // show loading indicator while we fetch user data and tabs
            isLoading = true;
            StateHasChanged();
            await HandleIntroModal();

            try
            {
                try
                {
                    userGuid = await UserGuidService.GetOrCreateUserGuidAsync();
                    Log($"OnAfterRenderAsync got userGuid: {userGuid}");
                }
                catch (Exception exGet) { LogError($"UserGuidService.GetOrCreateUserGuidAsync failed: {exGet.Message}"); }

                await LoadTabsAsync();

                if (!Tabs.Contains(activeTab))
                {
                    // If there are no dynamic tabs returned, keep the existing activeTab (default "plan-a").
                    // Otherwise select the first available tab safely.
                    activeTab = Tabs.FirstOrDefault() ?? activeTab ?? "Plan-A-City-A";
                }

                calculatorType = MapTabToCalculatorType(activeTab);

                await LoadFromApi();
                
                // Load city templates and user demographics
                await LoadAvailableCities();
                await LoadUserDemographics();
            }
            finally
            {
                isLoading = false;
                StateHasChanged();
                Log("OnAfterRenderAsync firstRender end");
            }
        }
    }

    private System.Timers.Timer? autosaveTimer;
    private readonly object autosaveLock = new object();
    private int autosaveDelayMs = 800; // debounce

    // Recalculate derived UI values and optionally schedule autosave.
    private void RecalculateAll(bool save = false)
    {
        try
        {
            // Totals are computed properties (TotalCurrent/TotalRetirement) so just refresh UI.
            InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            LogError($"RecalculateAll error: {ex.Message}");
        }

        if (save)
        {
            ScheduleAutosave();
        }
    }

    private void ScheduleAutosave()
    {
        Log("ScheduleAutosave called");

        lock (autosaveLock)
        {
            if (autosaveTimer == null)
            {
                autosaveTimer = new System.Timers.Timer(autosaveDelayMs);
                autosaveTimer.AutoReset = false;
                autosaveTimer.Elapsed += async (_, __) =>
                {
                    try
                    {
                        await InvokeAsync(async () => await SaveToApi());
                    }
                    catch (Exception ex)
                    {
                        LogError($"autosave timer handler exception: {ex.Message}");
                    }
                };
            }
            else
            {
                autosaveTimer.Stop();
                autosaveTimer.Interval = autosaveDelayMs;
            }

            autosaveTimer.Start();
        }
    }

    public void Dispose()
    {
        if (autosaveTimer != null)
        {
            try { autosaveTimer.Dispose(); } catch { }
            autosaveTimer = null;
        }

        if (undoTimer != null)
        {
            try { undoTimer.Dispose(); } catch { }
            undoTimer = null;
        }
    }

    private void HandleAddCategoryKey(KeyboardEventArgs e)
    {
        if (e.Key == "Enter") OpenAddCategoryModal();
    }

    private void HandleNumericKey(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            ScheduleAutosave();
        }
    }

    private async Task OnTabClick(string tab)
    {
        if (activeTab == tab) return;
        Log($"OnTabClick: switching to {tab}");
        activeTab = tab;
        calculatorType = MapTabToCalculatorType(tab);
        await LoadFromApi();
    }

    private enum OperationType { None, LoadTabs, LoadFromApi }
    private bool showTimeoutModal = false;
    private string timeoutMessage = string.Empty;
    private OperationType failedOperation = OperationType.None;

    private void ShowTimeout(OperationType op, string message)
    {
        failedOperation = op;
        timeoutMessage = message;
        showTimeoutModal = true;
        InvokeAsync(StateHasChanged);
    }

    private void DismissTimeoutModal()
    {
        showTimeoutModal = false;
        failedOperation = OperationType.None;
        timeoutMessage = string.Empty;
        InvokeAsync(StateHasChanged);
    }

    private async Task RetryOperation()
    {
        showTimeoutModal = false;
        var op = failedOperation;
        failedOperation = OperationType.None;
        timeoutMessage = string.Empty;
        // Refresh UI
        StateHasChanged();

        try
        {
            if (op == OperationType.LoadTabs)
            {
                Log("User triggered retry: LoadTabsAsync");
                await LoadTabsAsync();
                // if tabs loaded and activeTab missing, ensure selection
                if (!Tabs.Contains(activeTab)) activeTab = Tabs.FirstOrDefault() ?? "Plan-A-City-A";
                calculatorType = MapTabToCalculatorType(activeTab);
                // After reloading tabs, try loading data for the active tab
                await LoadFromApi();
            }
            else if (op == OperationType.LoadFromApi)
            {
                Log("User triggered retry: LoadFromApi");
                await LoadFromApi();
            }
        }
        catch (Exception ex)
        {
            LogError($"RetryOperation failed: {ex.Message}");
            // Show modal again with updated message
            ShowTimeout(op, $"Retry failed: {ex.Message}");
        }
    }

    private async Task ConfirmRemoveItem(int idx)
    {
        var ok = await JSRuntime.InvokeAsync<bool>("confirm", $"Remove this item? This action cannot be undone.");
        if (ok) RemoveItem(idx);
    }

    private async Task ConfirmRemoveCategory(string category)
    {
        var ok = await JSRuntime.InvokeAsync<bool>("confirm", $"Remove this category and all its items? This action cannot be undone.");
        if (ok) RemoveCategory(category);
    }

    private void CollapseAllCategories()
    {
        collapsed = new HashSet<string>(Items.Select(i => i.Category).Where(c => !string.IsNullOrEmpty(c)).Distinct());
    }

    private void ToggleCollapseAllCategories()
    {
        if (AnyCategoryExpanded())
        {
            // Collapse all
            collapsed = new HashSet<string>(Items.Select(i => i.Category).Where(c => !string.IsNullOrEmpty(c)).Distinct());
        }
        else
        {
            // Expand all
            collapsed.Clear();
        }
    }
    private bool AnyCategoryExpanded()
    {
        var allCategories = Items.Select(i => i.Category).Where(c => !string.IsNullOrEmpty(c)).Distinct();
        return allCategories.Any(c => !collapsed.Contains(c));
    }

    // Add inside the existing @code { ... } block of CostOfLivingPlannerNew.razor

    // Modal visibility
    private bool showAssumptionsModal = false;

    // Called when user saves from the modal. Receives (Years, Inflation).
    private async Task OnAssumptionsSaved((int Years, decimal Inflation) values)
    {
        // apply values
        YearsToRetirement = values.Years;
        InflationRate = values.Inflation;

        // recalc and persist
        RecalculateAll(save: true);
        ScheduleAutosave();

        // close modal and update UI
        showAssumptionsModal = false;
        await InvokeAsync(StateHasChanged);
    }

    private async Task CloseAssumptions()
    {
        showAssumptionsModal = false;
        await InvokeAsync(StateHasChanged);
    }

    // Open the modal from UI
    private void OpenWizard(int section)
    {
        // reuse same modal for quick assumptions edits
        // copy current values into modal via component parameters (component reads YearsToRetirement/InflationRate)
        showAssumptionsModal = true;
    }

    // New state variables for multi-step flow
    private bool showPlanningTypeModal = true; // Start with this instead of overlay
    private bool showAssumptionsSetupModal = false;
    private bool useSampleData = false;

    private void SelectPlanningType(bool useSample)
    {
        useSampleData = useSample;
        showPlanningTypeModal = false;
        showAssumptionsSetupModal = true;
    }

    private void GoBackToPlanningType()
    {
        showAssumptionsSetupModal = false;
        showPlanningTypeModal = true;
    }

    private Task StartPlanning()
    {
        showAssumptionsSetupModal = false;

        if (useSampleData)
        {
            // Load sample data with the user's assumptions
            Items = StandardCostCategories.GetDefaults();
        }
        else
        {
            // Start with empty list
            Items = new List<CostItem>();
        }

        // Save the assumptions
        ScheduleAutosave();
        StateHasChanged();
        return Task.CompletedTask;
    }

    private async Task ShowIntroWithReset()
    {
        // Remove the localStorage setting that hides the intro
        await JSRuntime.InvokeVoidAsync("localStorage.removeItem", "finplan-cost-of-living-income-planner-hide-intro");

        // Show the intro modal
        showIntroModal = true;

        // Update the UI
        StateHasChanged();
    }

    private void StartWithDefaults()
    {
        Items = StandardCostCategories.GetDefaults();
        showIntroModal = false; // Add this line to close the modal

        ScheduleAutosave();
        StateHasChanged();
    }

    private bool showIntroModal = true; // Show by default unless user has opted out
    private bool dontShowIntroAgain = false;





    private bool showToolTipYearsInfo = false;
    private bool showToolTipInflationInfo = false;

    // Add Item modal state
    private bool showAddItemModal = false;
    private string addItemCategory = string.Empty;

    // New item fields
    private string NewItemName = string.Empty;
    private string NewItemFrequency = "Monthly"; // parsed to enum on save
    private decimal NewItemAmount = 0m;
    private bool NewItemIncludeInRetirement = true;
    private string NewItemExclusionReason = "NotNeeded"; // NotNeeded | PaidOff | Other

    // Retirement fields
    private string NewItemAdjustOption = "Inflation"; // Same | CustomPercentage | Manual | Inflation
    private string NewItemPerItemInflationSource = "UseGlobal"; // UseGlobal | Custom
    private decimal NewItemPerItemInflationPercent = 0m;
    private decimal NewItemCustomPercentage = 0m;

    // Manual entry as string to allow empty -> null parsing
    private string? NewItemManualRetirementValueString = null;

    // Validation
    private bool IsAddItemDisabled
        => string.IsNullOrWhiteSpace(NewItemName?.Trim());

    // Open/close
    private void OpenAddItemModal(string category)
    {
        isEditItemMode = false;
        editItemIndex = -1;

        addItemCategory = category ?? string.Empty;

        NewItemName = string.Empty;
        NewItemFrequency = "Monthly";
        NewItemAmount = 0m;
        NewItemIncludeInRetirement = true;
        NewItemExclusionReason = "NotNeeded";

        NewItemAdjustOption = "Inflation";
        NewItemPerItemInflationSource = "UseGlobal";
        NewItemPerItemInflationPercent = 0m;
        NewItemCustomPercentage = 0m;
        NewItemManualRetirementValueString = null;

        showAddItemModal = true;
    }

    private void CloseAddItemModal()
    {
        showAddItemModal = false;
        isEditItemMode = false;
        editItemIndex = -1;
        NewItemName = string.Empty;
    }

    // Save
    private void AddItemModalSave()
    {
        if (IsAddItemDisabled) return;

        // Set defaults for simple mode
        if (isSimpleMode)
        {
            // Use sensible defaults for beginners
            if (string.IsNullOrEmpty(NewItemFrequency))
            {
                NewItemFrequency = "Monthly";
            }
            if (string.IsNullOrEmpty(NewItemAdjustOption))
            {
                NewItemAdjustOption = "Inflation";
            }
            if (string.IsNullOrEmpty(NewItemPerItemInflationSource))
            {
                NewItemPerItemInflationSource = "UseGlobal";
            }
        }

        if (!Enum.TryParse<Frequency>(NewItemFrequency, out var freq))
            freq = Frequency.Monthly;

        if (!Enum.TryParse<RetirementAdjustOption>(NewItemAdjustOption, out var adjust))
            adjust = RetirementAdjustOption.Inflation;

        if (!Enum.TryParse<InflationSource>(NewItemPerItemInflationSource, out var inflSrc))
            inflSrc = InflationSource.UseGlobal;

        // Parse exclusion reason
        ExclusionReason? exclusionReason = null;
        if (!NewItemIncludeInRetirement && Enum.TryParse<ExclusionReason>(NewItemExclusionReason, out var exReason))
        {
            exclusionReason = exReason;
        }

        decimal? manualValue = null;
        if (!string.IsNullOrWhiteSpace(NewItemManualRetirementValueString) &&
            decimal.TryParse(NewItemManualRetirementValueString, System.Globalization.NumberStyles.Number, System.Globalization.CultureInfo.CurrentCulture, out var mv) &&
            mv >= 0)
        {
            manualValue = mv;
        }

        if (isEditItemMode && editItemIndex >= 0 && editItemIndex < Items.Count)
        {
            // Update existing item
            var item = Items[editItemIndex];
            item.Subcategory = NewItemName.Trim();
            item.Frequency = freq;
            item.CurrentValue = NewItemAmount;
            item.IncludeInRetirement = NewItemIncludeInRetirement;
            item.RetirementExclusionReason = exclusionReason;
            item.AdjustOption = adjust;
            item.PerItemInflationSource = inflSrc;
            item.PerItemInflationPercent = inflSrc == InflationSource.Custom ? NewItemPerItemInflationPercent : null;
            item.CustomPercentage = NewItemAdjustOption == "CustomPercentage" ? NewItemCustomPercentage : 0m;
            item.ManualRetirementValue = NewItemAdjustOption == "Manual" ? manualValue : null;
        }
        else
        {
            // Add new item
            var newItem = new CostItem
            {
                Category = addItemCategory,
                Subcategory = NewItemName.Trim(),
                CurrentValue = NewItemAmount,
                Frequency = freq,
                IncludeInRetirement = NewItemIncludeInRetirement,
                RetirementExclusionReason = exclusionReason,
                AdjustOption = adjust,
                PerItemInflationSource = inflSrc,
                PerItemInflationPercent = inflSrc == InflationSource.Custom ? NewItemPerItemInflationPercent : null,
                CustomPercentage = NewItemAdjustOption == "CustomPercentage" ? NewItemCustomPercentage : 0m,
                ManualRetirementValue = NewItemAdjustOption == "Manual" ? manualValue : null
            };
            Items.Add(newItem);
            collapsed.Remove(addItemCategory ?? string.Empty); // ensure visible
        }

        // Close and persist
        showAddItemModal = false;
        isEditItemMode = false;
        editItemIndex = -1;

        StateHasChanged();
        ScheduleAutosave();
    }

    // Keyboard: allow Enter to submit from key fields
    private void HandleAddItemKeyModal(KeyboardEventArgs e)
    {
        if (e?.Key == "Enter")
            AddItemModalSave();
    }

    // Unified Item modal mode state
    private bool isEditItemMode = false;
    private int editItemIndex = -1;

    private void OpenEditItemModal(int idx)
    {
        if (idx < 0 || idx >= Items.Count) return;

        isEditItemMode = true;
        editItemIndex = idx;

        var it = Items[idx];
        addItemCategory = it.Category ?? string.Empty;
        NewItemName = it.Subcategory ?? string.Empty;
        NewItemFrequency = it.Frequency.ToString();
        NewItemAmount = it.CurrentValue;
        NewItemIncludeInRetirement = it.IncludeInRetirement;
        NewItemExclusionReason = it.RetirementExclusionReason?.ToString() ?? "NotNeeded";

        NewItemAdjustOption = it.AdjustOption.ToString(); // "Same" | "Inflation" | "CustomPercentage" | "Manual"
        NewItemPerItemInflationSource = it.PerItemInflationSource.ToString(); // "UseGlobal" | "Custom"
        NewItemPerItemInflationPercent = it.PerItemInflationPercent ?? 0m;
        NewItemCustomPercentage = it.CustomPercentage;
        NewItemManualRetirementValueString = it.ManualRetirementValue?.ToString(System.Globalization.CultureInfo.CurrentCulture) ?? null;

        showAddItemModal = true;
    }

    // Add/Edit Item modal inline tooltip flags
    private bool showTipItemName = false;
    private bool showTipFrequency = false;
    private bool showTipAmount = false;
    private bool showTipInclude = false;
    private bool showTipExclusionReason = false;
    private bool showTipAdjust = false;
    private bool showTipCustomPercent = false;
    private bool showTipManualValue = false;
    private bool showTipInflationSource = false;
    private bool showTipCustomInflation = false;

    // Info link state (top-level)
    private bool showTipCurrentTotal = false;
    private bool showTipRetirementTotal = false;
    private bool showTipAddCategory = false;
    private bool showTipCollapseAll = false;

    // Per-category info states
    private HashSet<string> catInfoOpen = new(StringComparer.OrdinalIgnoreCase);
    private HashSet<string> addItemInfoOpen = new(StringComparer.OrdinalIgnoreCase);

    private bool IsCatInfoOpen(string? key) => !string.IsNullOrWhiteSpace(key) && catInfoOpen.Contains(key);
    private void ToggleCatInfo(string? key)
    {
        var k = key ?? string.Empty;
        if (catInfoOpen.Contains(k)) catInfoOpen.Remove(k); else catInfoOpen.Add(k);
    }

    private bool IsAddItemInfoOpen(string? key) => !string.IsNullOrWhiteSpace(key) && addItemInfoOpen.Contains(key);
    private void ToggleAddItemInfo(string? key)
    {
        var k = key ?? string.Empty;
        if (addItemInfoOpen.Contains(k)) addItemInfoOpen.Remove(k); else addItemInfoOpen.Add(k);
    }
    // Per-row View/Edit info state
    private HashSet<int> viewEditInfoOpen = new();

    private bool IsViewEditInfoOpen(int idx) => viewEditInfoOpen.Contains(idx);

    private void ToggleViewEditInfo(int idx)
    {
        if (viewEditInfoOpen.Contains(idx)) viewEditInfoOpen.Remove(idx);
        else viewEditInfoOpen.Add(idx);
    }

    // Plan‑A tab info tip
    private bool showTipPlanATab = false;
    private void TogglePlanATabInfo() => showTipPlanATab = !showTipPlanATab;

    // ============================================
    // City Template Methods
    // ============================================
    
    private async Task LoadAvailableCities()
    {
        try
        {
            var client = HttpCustomClientService.CreateRetryClient(HttpClientFactory);
            var apiBaseUrl = GetApiBaseUrl();
            availableCities = await client.GetFromJsonAsync<List<CityTemplate>>($"{apiBaseUrl}/api/citytemplate");
            Log($"Loaded {availableCities?.Count ?? 0} city templates");
        }
        catch (Exception ex)
        {
            LogError($"Error loading city templates: {ex.Message}");
        }
    }

    private async Task LoadUserDemographics()
    {
        try
        {
            var client = HttpCustomClientService.CreateRetryClient(HttpClientFactory);
            var apiBaseUrl = GetApiBaseUrl();
            
            try
            {
                userDemographics = await client.GetFromJsonAsync<UserDemographics>($"{apiBaseUrl}/api/userdemographics/{userGuid}");
                Log($"Loaded user demographics for {userGuid}");
            }
            catch (HttpRequestException)
            {
                // User demographics not found - this is expected for new users
                Log($"No demographics found for user {userGuid}");
            }
        }
        catch (Exception ex)
        {
            LogError($"Error loading user demographics: {ex.Message}");
        }
    }

    private async Task SelectCity(CityTemplate city)
    {
        try
        {
            selectedCity = city;
            
            // Load profiles for this city
            var client = HttpCustomClientService.CreateRetryClient(HttpClientFactory);
            var apiBaseUrl = GetApiBaseUrl();
            cityProfiles = await client.GetFromJsonAsync<List<DemographicProfile>>($"{apiBaseUrl}/api/citytemplate/{city.CityId}/profiles");
            
            // Try to match a profile if we have user demographics
            if (userDemographics != null && cityProfiles?.Any() == true)
            {
                await MatchBestProfile(city.CityId);
            }
            
            Log($"Selected city: {city.CityName}, loaded {cityProfiles?.Count ?? 0} profiles");
            StateHasChanged();
        }
        catch (Exception ex)
        {
            LogError($"Error selecting city: {ex.Message}");
        }
    }

    private async Task MatchBestProfile(string cityId)
    {
        try
        {
            if (userDemographics == null) return;
            
            var client = HttpCustomClientService.CreateRetryClient(HttpClientFactory);
            var apiBaseUrl = GetApiBaseUrl();
            
            var url = $"{apiBaseUrl}/api/citytemplate/match?" +
                      $"cityId={Uri.EscapeDataString(cityId)}" +
                      $"&age={userDemographics.Age}" +
                      $"&maritalStatus={userDemographics.MaritalStatus}" +
                      $"&childrenCount={userDemographics.ChildrenAges?.Count ?? 0}";
            
            matchedProfile = await client.GetFromJsonAsync<DemographicProfile>(url);
            
            if (matchedProfile != null)
            {
                Log($"Matched profile: {matchedProfile.ProfileName}");
            }
        }
        catch (Exception ex)
        {
            LogError($"Error matching profile: {ex.Message}");
        }
    }

    private async Task LoadExpensesFromProfile(DemographicProfile profile)
    {
        try
        {
            if (profile.SampleExpenses != null && profile.SampleExpenses.Any())
            {
                // Ask for confirmation before replacing expenses
                var confirmed = await JSRuntime.InvokeAsync<bool>("confirm",
                    $"Load sample expenses from '{profile.ProfileName}'? This will replace your current expenses.");
                
                if (!confirmed) return;
                
                // Clear existing items
                Items.Clear();
                
                // Add expenses from profile
                foreach (var expense in profile.SampleExpenses)
                {
                    Items.Add(new CostItem
                    {
                        Category = expense.Category,
                        Subcategory = expense.Subcategory,
                        CurrentValue = expense.CurrentValue,
                        IncludeInRetirement = expense.IncludeInRetirement,
                        RetirementExclusionReason = expense.RetirementExclusionReason
                    });
                }
                
                RecalculateAll(save: true);
                StateHasChanged();
                
                Log($"Loaded {profile.SampleExpenses.Count} expenses from profile: {profile.ProfileName}");
            }
        }
        catch (Exception ex)
        {
            LogError($"Error loading expenses from profile: {ex.Message}");
        }
    }

    private async Task SaveUserDemographics(int age, MaritalStatus maritalStatus, List<int> childrenAges)
    {
        try
        {
            var client = HttpCustomClientService.CreateRetryClient(HttpClientFactory);
            var apiBaseUrl = GetApiBaseUrl();
            
            var demographics = new UserDemographics
            {
                UserGuid = userGuid,
                Age = age,
                MaritalStatus = maritalStatus,
                ChildrenAges = childrenAges,
                PreferredCurrency = selectedCity?.Currency ?? "USD",
                SelectedCityId = selectedCity?.CityId ?? string.Empty,
                CreatedAt = DateTime.UtcNow,
                UpdatedAt = DateTime.UtcNow
            };
            
            HttpResponseMessage response;
            if (userDemographics == null)
            {
                // Create new
                response = await client.PostAsJsonAsync($"{apiBaseUrl}/api/userdemographics", demographics);
            }
            else
            {
                // Update existing
                response = await client.PutAsJsonAsync($"{apiBaseUrl}/api/userdemographics/{userGuid}", demographics);
            }
            
            response.EnsureSuccessStatusCode();
            userDemographics = demographics;
            
            Log("User demographics saved successfully");
        }
        catch (Exception ex)
        {
            LogError($"Error saving user demographics: {ex.Message}");
        }
    }

    private void ToggleCitySelector()
    {
        showCitySelector = !showCitySelector;
        StateHasChanged();
    }

    // Ad HTML for left column — paste your Adsterra long banner snippet here or store in config and load on init.
    private string AdHtmlLeft = "<!-- Adsterra long banner snippet goes here -->";
}
