@namespace FinPlan.Web.Components.Pages

@page "/savings-wealth-building"

@using FinPlan.Shared.Models.Savings
@using FinPlan.Shared.Models.Spending
@using FinPlan.Shared.Services
@using FinPlan.Web.Services
@using Microsoft.JSInterop
@using FinPlan.Web.Pages.Savings.Components
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Web


@inject IJSRuntime JSRuntime
@inject IHttpClientFactory HttpClientFactory
@inject IConfiguration Configuration
@inject DebugMessageService DebugService
@inject UserGuidService UserGuidService
@inject NavigationManager Navigation
@inject FinPlan.Web.Services.ApiUrlProvider ApiUrlProvider

<style>
    body {
    }

    /* Add missing CSS variable */
    :root {
        --brand-yellow: #FFD600;
    }

    .summary-cards-row {
        display: flex;
        gap: 12px;
        margin-bottom: 12px;
        flex-wrap: wrap;
        justify-content: center;
    }

    .savings-card {
        background: #fff;
        color: #222;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(31,111,235,0.08);
        min-width: 132px;
        max-width: 132px;
        min-height: 132px;
        max-height: 132px;
        width: 132px;
        height: 132px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 12px 10px;
        font-size: 1rem;
    }

    .savings-card-yellow {
        background: #FFD600;
        color: #222;
    }

    .savings-card-teal {
        background: #38B2AC;
        color: #fff;
    }

    .savings-card-purple {
        background: #6D5DFC;
        color: #fff;
    }

    .savings-card-red {
        background: #F56565;
        color: #fff;
    }

    .savings-card .bi {
        font-size: 1.4rem;
        margin-bottom: 4px;
        color: inherit;
    }

    .savings-card .card-label {
        font-weight: 600;
        font-size: 0.95rem;
        margin-bottom: 2px;
        color: inherit;
        text-align: center;
    }

    .savings-card .card-value {
        font-size: 1.05rem;
        font-weight: 700;
        color: inherit;
        text-align: center;
        margin-top: 2px;
    }

    .survey-card {
        border-right: 8px solid #1F6FEB !important;
        border-top: 1px solid #e9ecef;
        border-bottom: 1px solid #e9ecef;
        border-left: 1px solid #e9ecef;
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(31,111,235,0.08);
        background: #fff;
    }

    .survey-card-narrow {
        width: 75%;
        min-width: 180px;
        max-width: 320px;
        margin-left: 0;
        margin-right: auto;
        align-self: flex-start;
    }

    /* CSS Variables - convert to actual values for better compatibility */
    .container-wire {
        padding: 14px;
    }

    /* Header info icon helpers (Option A + B) */
    .th-info {
        position: relative;
        padding-right: 18px;
    }
    /* reserve right edge */
    .th-info-icon {
        position: absolute;
        top: 6px;
        right: 6px;
        font-size: .9rem;
        cursor: pointer;
        opacity: .65;
        transition: opacity .15s ease-in-out;
    }
    /* Show icon only on header hover */
    .th-info .th-info-icon {
        opacity: 0;
    }

    thead th:hover .th-info .th-info-icon {
        opacity: .9;
    }
    /* Optional: hide on phones to keep headers tight */
    @@media (max-width: 768px) {
        .th-info-icon {
            display: none;
        }
    }

    .missing-badge {
        background-color: rgba(220, 53, 69, 0.1);
        color: #dc3545;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 0.7rem;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
    }

    .incomplete-section {
        border: 1px solid rgba(220, 53, 69, 0.3);
        box-shadow: 0 2px 8px rgba(220, 53, 69, 0.1);
    }

    tab-panel-box {
        border: 2px solid #C79A00; /* dark yellow border */
        border-radius: 8px;
        padding: var(--tab-panel-padding-top) 18px 20px 18px;
        margin-top: 0;
        top: var(--tab-panel-top-offset);
        position: relative;
        background: #ffffff;
        box-shadow: 0 4px 12px rgba(0,0,0,0.04);
        z-index: 10;
        overflow: visible;
    }

    .tab-active-custom {
        background-color: #FFD600 !important;
        color: #222 !important;
        font-weight: 600;
        border: 1px solid #FFD600 !important;
        border-bottom: none !important;
        border-radius: 8px 8px 0 0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.07);
        transition: background 0.2s, color 0.2s;
    }

    .tab-item-active {
        background: #FFD600;
        border-radius: 8px 8px 0 0;
        padding: 4px 6px;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    /* Mobile tab navigation improvements */
    @@media (max-width: 767px) {
        .nav-tabs {
            flex-wrap: nowrap;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            display: flex;
            gap: 6px;
            border-bottom: none;
        }

            .nav-tabs .nav-item {
                min-width: 140px;
                flex: 0 0 auto;
            }

            .nav-tabs .nav-link,
            .tab-item-active {
                font-size: 1rem;
                padding: 12px 10px;
                min-height: 44px;
            }
        /* Section cards - stack vertically on mobile */
        .section-card {
            width: 100% !important;
            margin-bottom: 12px;
        }
            /* Buttons in section cards - full width and larger tap targets */
            .section-card .actions {
                flex-direction: column;
                gap: 10px;
            }

            .section-card .btn-edit,
            .section-card .btn-ghost {
                width: 100%;
                min-height: 44px;
                padding: 12px;
                font-size: 1rem;
            }
        /* Summary cards - stack vertically on mobile */
        .summary-cards-row {
            flex-direction: column;
            gap: 10px;
            align-items: stretch;
        }

        .savings-card {
            min-width: 100%;
            max-width: 100%;
            width: 100%;
            min-height: 80px;
            max-height: 80px;
            height: 80px;
            flex-direction: row;
            justify-content: space-between;
            padding: 12px 16px;
            font-size: 0.9rem;
        }

            .savings-card .card-label {
                text-align: left;
                font-size: 0.85rem;
            }

            .savings-card .card-value {
                font-size: 1.2rem;
                font-weight: 700;
            }
        /* Table projection - enable horizontal scrolling */
        .grid {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            border-radius: 4px;
        }

        table {
            min-width: 900px;
            font-size: 0.85rem;
        }

        thead th {
            padding: 8px 6px;
            font-size: 0.8rem;
            white-space: nowrap;
        }

        tbody td {
            padding: 6px 6px;
            font-size: 0.85rem;
        }

        .money-cell {
            font-size: 0.8rem;
        }
        /* Grid header adjustments */
        .grid-header {
            flex-wrap: wrap;
            gap: 8px;
        }

        .legend {
            width: 100%;
            margin-left: 0;
            justify-content: flex-start;
            font-size: 0.8rem;
        }
        /* Tooltips - better positioning and sizing for mobile */
        .info-tooltip, .first-row-tooltip {
            position: fixed;
            left: 10px !important;
            right: 10px !important;
            top: 50% !important;
            transform: translateY(-50%) !important;
            max-width: calc(100vw - 20px);
            min-width: auto;
            width: calc(100vw - 20px);
            font-size: 0.9rem;
            padding: 20px;
            z-index: 10000;
        }

            .info-tooltip::before, .first-row-tooltip::before {
                display: none;
            }

            .info-tooltip .float-end, .first-row-tooltip .close-btn {
                font-size: 1.5rem !important;
                width: 32px;
                height: 32px;
                top: 10px;
                right: 10px;
            }

        .info-icon {
            font-size: 1.1rem;
            padding: 4px;
            min-width: 28px;
            min-height: 28px;
        }
        /* Plan sections grid - convert to accordion-style vertical list on mobile */
        .plan-sections-grid {
            display: flex !important;
            flex-direction: column !important;
            gap: 0 !important;
        }

        .section-card {
            width: 100% !important;
            border-radius: 0 !important;
            border-bottom: 1px solid #dee2e6 !important;
            margin-bottom: 0 !important;
        }

            .section-card:first-child {
                border-radius: 8px 8px 0 0 !important;
            }

            .section-card:last-child {
                border-radius: 0 0 8px 8px !important;
                border-bottom: none !important;
            }
        /* General button improvements for mobile */
        .btn, .btn-primary, .btn-outline-danger {
            min-height: 44px;
            padding: 10px 16px;
            font-size: 0.95rem;
        }
        /* Header buttons - stack on mobile */
        div[style*="justify-content: flex-end"] {
            flex-direction: column !important;
            gap: 10px !important;
            align-items: stretch !important;
        }

            div[style*="justify-content: flex-end"] button {
                width: 100% !important;
                min-height: 44px !important;
                padding: 10px 16px !important;
            }
        /* Ensure header section stacks properly */
        div[style*="justify-content: space-between"] {
            flex-direction: column !important;
            gap: 12px !important;
        }

            div[style*="justify-content: space-between"] h5 {
                position: static !important;
                transform: none !important;
                text-align: center !important;
            }
        /* Intro modal - fullscreen on mobile */
        .start-planning-overlay {
            padding: 10px;
        }

            .start-planning-overlay .empty-state {
                max-width: 100% !important;
                margin: 0 !important;
                padding: 20px !important;
            }

            .start-planning-overlay h4 {
                font-size: 1.3rem;
            }

            .start-planning-overlay p {
                font-size: 0.9rem;
            }

            .start-planning-overlay .btn {
                width: 100%;
                margin-bottom: 8px;
            }

            .start-planning-overlay div[style*="display: flex"] {
                flex-direction: column !important;
            }
        /* General padding and margin reductions for mobile */
        .container-wire {
            padding: 8px !important;
        }

        .panel {
            padding: 10px !important;
        }

        .section-panel {
            padding: 10px !important;
        }

        .page-header h3 {
            font-size: 1.3rem;
        }
        /* Survey card - full width on mobile */
        .survey-card-narrow {
            width: 100% !important;
            max-width: 100% !important;
            margin-bottom: 12px;
        }
        /* Alert boxes - reduce padding */
        .alert {
            padding: 10px !important;
            font-size: 0.85rem !important;
        }
        /* Small note text */
        .small-note {
            font-size: 0.8rem !important;
        }
    }

    .col-taxable, th.col-taxable {
        background-color: rgba(31,111,235,0.06);
    }

    th.col-taxable {
        color: #1F6FEB;
        font-weight: 700;
    }

    .col-traditional, th.col-traditional {
        background-color: rgba(56,178,172,0.06);
    }

    .col-roth, th.col-roth {
        background-color: rgba(109,93,252,0.06);
    }

    th.col-roth {
        color: #6D5DFC;
        font-weight: 700;
    }

    .col-totals, th.col-totals {
        background-color: rgba(255,214,0,0.06);
    }

    th.col-totals {
        color: #FFD600;
        font-weight: 700;
    }

    th.col-traditional {
        color: #38B2AC;
        font-weight: 700;
    }

    /* small touch to keep numeric alignment and readability */
    .table td.col-taxable,
    .table td.col-traditional,
    .table td.col-roth,
    .table td.col-totals {
        font-variant-numeric: tabular-nums;
    }

    .page-header {
        text-align: center;
        font-weight: 700;
        font-size: 1.45rem;
        margin-bottom: 12px;
        color: #111;
    }

    .top-area {
        position: relative;
    }

    .panel {
        background: #ffffff;
        border-radius: 10px;
        box-shadow: 0 6px 18px rgba(22,28,36,0.06);
        padding: 12px;
        border: 1px solid rgba(0,0,0,0.03);
        display: flex;
        flex-direction: column;
        flex: 1 1 0%;
    }

    /* Section card variant used inside the Plan Sections grid */
    .section-card {
        border: 1px solid rgba(16,24,36,0.12);
        padding: 10px;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        min-height: 92px;
        background: #fff;
    }

        .section-card .actions {
            margin-top: auto;
            display: flex;
            justify-content: flex-start;
            gap: 8px;
            padding-top: 16px; /* Increased from 6px to 16px for more space */
        }

    /* .section-card .actions {
                                margin-top: auto;
                                display: flex;
                                justify-content: flex-start;
                                gap: 8px;
                                padding-top: 6px;
                            } */

    .btn-edit {
        background: #1F6FEB;
        color: #ffffff;
        border: 0;
        padding: 7px 12px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
    }

    .btn-ghost {
        background: transparent;
        border: 1px solid #e6e9ee;
        color: #333;
        padding: 4px 6px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.8rem;
    }

    /* Highlighted rectangular panel with yellow border and subtle shadow */
    .section-panel {
        border: 3px solid #FFD600;
        border-radius: 10px;
        box-shadow: 0 12px 30px rgba(13,38,76,0.06), 0 4px 18px rgba(255,214,0,0.08);
        padding: 14px;
        background: linear-gradient(180deg, #fff, #fff);
    }

    .step-badge {
        width: 36px;
        height: 36px;
        min-width: 36px;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: var(--brand-yellow);
        color: #111;
        font-weight: 800;
        font-size: 1rem;
        box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        margin-right: 8px;
        margin-bottom: 12px; /* Added margin-bottom for spacing */
        flex-shrink: 0;
    }

    /* .step-badge {
                            width: 36px;
                            height: 36px;
                            min-width: 36px;
                            border-radius: 50%;
                            display: inline-flex;
                            align-items: center;
                            justify-content: center;
                            background: #FFD600;
                            color: #111;
                            font-weight: 800;
                            font-size: 1rem;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
                            margin-right: 8px;
                            flex-shrink: 0;
                        } */

    .small-note {
        font-size: 0.9rem;
        color: #6c757d;
        margin-top: 4px;
    }

    .badge {
        display: inline-block;
        padding: 6px 8px;
        border-radius: 999px;
        font-size: 0.85rem;
        background: #f1f3f5;
        color: #222;
        margin-right: 6px;
        text-decoration: none;
    }

        .badge:hover {
            background: #e9ecef;
            text-decoration: none;
        }

    .summary-money {
        font-size: 1.5rem;
        font-weight: 800;
        line-height: 1.05;
        font-variant-numeric: tabular-nums;
    }

    .grid-panel {
        margin-top: 12px;
    }

    .grid-header {
        display: flex;
        gap: 12px;
        align-items: center;
        margin-bottom: 8px;
    }

    .grid {
        width: 100%;
        border-radius: 8px;
        overflow: auto;
        background: #fff;
        border: 1px solid #e9ecef;
        box-shadow: 0 8px 24px rgba(12,18,30,0.04);
    }

    table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.98rem;
        min-width: 900px;
    }

    thead th {
        position: sticky;
        top: 0;
        background: #fff;
        padding: 10px 12px;
        border-bottom: 1px solid #eef2f6;
        text-align: left;
        font-weight: 700;
        color: #333;
    }

    tbody td {
        padding: 8px 12px;
        border-bottom: 1px solid #f2f4f7;
        vertical-align: middle;
    }

    .money-cell {
        text-align: right;
        font-variant-numeric: tabular-nums;
    }

    .legend {
        margin-left: auto;
        display: flex;
        gap: 8px;
        align-items: center;
        font-size: 0.95rem;
        color: #6c757d;
    }

        .legend .swatch {
            width: 14px;
            height: 14px;
            border-radius: 4px;
            display: inline-block;
        }

    /* Add missing empty-state styles */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 10px;
    }

    .start-planning-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(255, 255, 255, 0.4);
        backdrop-filter: blur(1px);
        z-index: 10;
    }

        .start-planning-overlay .empty-state {
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid var(--brand-yellow);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            margin: 20px;
        }

    @@media (max-width:1024px) {
        .top-area .row {
            gap: 12px;
        }
    }

    /* Tooltip: light blue background and black foreground, rectangle, bigger X */
    .info-tooltip, .first-row-tooltip {
        position: absolute;
        background: #e6f2ff !important; /* Light blue */
        color: #111 !important; /* Black text */
        border: 1px solid #b6d4fe;
        border-radius: 8px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.15), 0 4px 12px rgba(0,0,0,0.08);
        padding: 16px 20px;
        z-index: 9999;
        max-width: 320px;
        min-width: 220px;
        font-size: 0.95rem;
        line-height: 1.5;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        margin-top: 8px;
        animation: tooltipFadeIn 0.2s ease-out;
    }

    @@keyframes tooltipFadeIn {
        from {
            opacity: 0;
            transform: translateX(-50%) translateY(-4px);
        }

        to {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
    }

    .info-tooltip strong, .first-row-tooltip strong {
        color: #000 !important;
        font-weight: 600;
        display: block;
        margin-bottom: 8px;
    }

    .info-tooltip .float-end, .first-row-tooltip .close-btn {
        position: absolute;
        top: 12px;
        right: 12px;
        cursor: pointer;
        color: #111 !important;
        font-size: 1.25rem !important; /* Bigger X */
        font-weight: 700;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        transition: all 0.15s ease;
        line-height: 1;
    }

        .info-tooltip .float-end:hover, .first-row-tooltip .close-btn:hover {
            color: #0056b3 !important;
            background-color: #d0e7ff !important;
        }

    .info-tooltip::before, .first-row-tooltip::before {
        content: '';
        position: absolute;
        top: -8px;
        left: 50%;
        transform: translateX(-50%);
        width: 0;
        height: 0;
        border-left: 8px solid transparent;
        border-right: 8px solid transparent;
        border-bottom: 8px solid #e6f2ff !important;
        filter: drop-shadow(0 -2px 2px rgba(0,0,0,0.05));
    }

    /* Large Mode Toggle Styles - Same as Cost of Living */
    .form-switch .form-check-input {
        transition: all 0.2s ease;
    }

        .form-switch .form-check-input:checked {
            background-color: #0d6efd;
            border-color: #0d6efd;
        }

        .form-switch .form-check-input:focus {
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.2);
        }

    /* Large form switch for prominent toggle */
    .form-switch-lg .form-check-input {
        width: 3rem !important;
        height: 1.5rem !important;
        background-color: #6c757d;
        border: none;
        transition: all 0.3s ease;
    }

        .form-switch-lg .form-check-input:checked {
            background-color: #0d6efd;
            box-shadow: 0 0 8px rgba(13, 110, 253, 0.3);
        }

        .form-switch-lg .form-check-input:focus {
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }

    .mode-toggle-header {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-bottom: 2px solid #dee2e6;
        transition: all 0.3s ease;
        border-radius: 12px;
        padding: 1rem 1.5rem;
        margin-bottom: 1rem;
    }

    .simple-mode .mode-toggle-header {
        background: linear-gradient(135deg, #d1e7dd 0%, #a3cfbb 100%);
        border-bottom: 2px solid #75b798;
    }

    /* Modal backdrop and blur effect */
    .intro-modal-active {
        /* Mobile: completely hide content */
        display: none;
    }

    /* Desktop/Laptop: show but blur */
    @@media (min-width: 992px) {
        .intro-modal-active {
            display: block;
            filter: blur(8px);
            pointer-events: none;
            user-select: none;
            opacity: 0.6;
        }
    }

    /* Ensure modal backdrop is solid on mobile */
    @@media (max-width: 991px) {
        .modal-backdrop {
            opacity: 1 !important;
            background-color: #fff !important;
        }
    }

    /* Make sure modal stays on top and centered */
    .modal.d-block {
        display: flex !important;
        align-items: center;
        justify-content: center;
    }

</style>

<PageTitle>Savings & Wealth Building</PageTitle>


<SavingsInputWizard Model="@SavingsModel"
                    RetirementModel="@RetirementModel"
                    Visible="@showWizard"
                    VisibleChanged="@(v => showWizard = v)"
                    OnFinished="HandleWizardFinished"
                    OnSave="SaveAsync"
                    ActiveTab=activeTab
                    InitialStep="@wizardOpenStep" />

<SetupSavingsSampleData Visible="@showSampleDataModal"
                        OnClose="@(() => showSampleDataModal = false)"
                        OnSampleDataSelected="HandleSampleDataSelected" />

<!-- Intro Modal - Moved outside blurred wrapper -->
@if (showIntroModal)
{
    <div class="modal-backdrop fade show" style="z-index: 1040;"></div>
    <div class="modal d-block" style="z-index: 1050;">
        <div class="modal-dialog modal-dialog-centered modal-lg modal-fullscreen-sm-down">
            <div class="modal-content" style="border-top: 4px solid #FFD600;">
                <div class="d-block d-md-none"><br><br /></div>

                <div class="modal-header bg-light">
                    <h5 class="modal-title">
                        <i class="bi bi-piggy-bank-fill text-warning me-2"></i>Welcome to Savings Planning!
                    </h5>
                    <button type="button" class="btn-close" aria-label="Close" @onclick="CloseIntroModal"></button>
                </div>

                <div class="modal-body" style="background-color: #fffef7;">
                    <div class="text-center mb-4">
                        <div style="font-size: 3rem; margin-bottom: 12px;">ðŸŽ¯</div>
                        <p class="text-muted mb-0">
                            Let's create your personalized retirement savings plan. We'll walk you through the setup in just a few quick steps.
                        </p>
                    </div>

                    <!-- Action Buttons -->
                    <div class="d-flex gap-3 justify-content-center mb-3 flex-wrap">
                        <button class="btn btn-primary btn-lg px-4" @onclick="() => { OpenWizard(1); CloseIntroModal(); }">
                            <i class="bi bi-play-circle me-2"></i>Start Planning
                        </button>
                        <button class="btn btn-outline-primary btn-lg px-4"
                                @onclick="() => { showSampleDataModal = true; CloseIntroModal(); }">
                            <i class="bi bi-clipboard-data me-2"></i>Try Sample Data
                        </button>
                    </div>

                    <!-- Don't Show Again -->
                    <style>
                        /* Highlighted checkbox block for intro modal */
                        .intro-dont-show {
                            background: linear-gradient(90deg, rgba(255,246,205,0.95), rgba(255,254,247,0.98));
                            border-left: 6px solid var(--brand-yellow);
                            padding: 12px 18px;
                            border-radius: 10px;
                            display: flex;
                            align-items: center;
                            gap: 12px;
                            margin-top: 16px;
                        }

                        .intro-dont-show .form-check-input {
                            width: 22px;
                            height: 22px;
                            margin-top: 0.1rem;
                        }

                        .intro-dont-show .label-main {
                            font-size: 1.02rem;
                            font-weight: 700;
                            color: #111;
                            margin-bottom: 2px;
                        }

                        .intro-dont-show .label-sub {
                            font-size: 0.85rem;
                            color: #6c757d;
                            margin: 0;
                        }

                        /* Make the entire area clickable on mobile */
                        .intro-dont-show .form-check {
                            cursor: pointer;
                        }
                    </style>

                    <div class="intro-dont-show" role="region" aria-label="Intro preference">
                        <div class="form-check d-flex align-items-start mb-0">
                            <input class="form-check-input me-3" type="checkbox"
                                   id="dontShowIntroAgainCheck" @onchange="OnDontShowIntroChanged" />
                        </div>

                        <label class="form-check-label mb-0" for="dontShowIntroAgainCheck" style="max-width:720px;">
                            <div class="label-main">
                                <i class="bi bi-eye-slash-fill text-warning me-2" aria-hidden="true"></i>
                                Don't show this welcome screen again
                            </div>
                            <div class="label-sub">
                                Hide this welcome screen on future visits. You can re-enable it later in settings.
                            </div>
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

<!-- Main content - hide on mobile, blur on desktop when modal is open -->
<div class="@(showIntroModal ? "intro-modal-active" : "")">
    <div class="container-wire">
        <div class="page-header">
            <h3>Savings & Wealth Building</h3>
        </div>


        <div class="top-area">
            <div class="container-fluid">
                <div class="row g-3">
                    <div class="col-12 col-md-2">
                        @* <ul class="list-unstyled mb-0">
                        <li><a class="text-decoration-none d-block py-1" href="/"><i class="bi bi-house"></i> Home</a></li>
                    </ul> *@
                       @*  @if (showSurvey)
                        {
                            <div class="card survey-card survey-card-narrow mb-2">
                                <div class="card-body text-center">
                                    <i class="bi bi-chat-dots" style="font-size:2rem; color:#1F6FEB;"></i>
                                    <div class="fw-bold mt-2 mb-1">Share Your Feedback</div>
                                    <a href="/survey-savings-wealth-building" class="btn btn-primary btn-sm">
                                        Take Living Cost Survey
                                    </a>
                                </div>
                            </div>
                        } *@
                        <!-- Ad container for long Adsterra banner in left column -->

                    </div>

                    <div class="col-12 col-md-8">
                        <!-- Tab Navigation -->
                        <ul class="nav nav-tabs">
                            <li class="nav-item d-flex align-items-center me-1 @(activeTab == "your" ? "tab-item-active" : "")" role="presentation">
                                <button class="nav-link @(activeTab == "your" ? "tab-active-custom" : "")" role="tab" aria-selected="@(activeTab == "your" ? "true" : "false")" tabindex="0" @onclick="YourTabClick">
                                    Your  Savings
                                </button>
                            </li>
                            <li class="nav-item d-flex align-items-center me-1 @(activeTab == "partner" ? "tab-item-active" : "")" role="presentation">
                                <button class="nav-link @(activeTab == "partner" ? "tab-active-custom" : "")" role="tab" aria-selected="@(activeTab == "partner" ? "true" : "false")" tabindex="0" @onclick="PartnerTabClick">
                                    Partner  Savings
                                </button>
                            </li>
                        </ul>
                        <!-- Yellow border section panel that touches the tabs -->
                        <div class="section-panel" style="margin-top: -1px; border-top-left-radius: 0; border-top-right-radius: 0;">

                            @if (results != null && !SavingsModel.IsModelEmpty())
                            {
                                <div class="summary-cards-row">
                                    <div class="summary-card savings-card savings-card-teal">
                                        <span class="bi bi-piggy-bank"></span>
                                        <div class="card-label">Final Savings</div>
                                        <div class="card-value">@results.FinalAmount.ToString("C0")</div>
                                    </div>
                                    <div class="summary-card savings-card savings-card-yellow">
                                        <span class="bi bi-arrow-up-circle"></span>
                                        <div class="card-label">Total Contributions</div>
                                        <div class="card-value">@results.TotalContributions.ToString("C0")</div>
                                    </div>
                                    <div class="summary-card savings-card savings-card-purple">
                                        <span class="bi bi-graph-up"></span>
                                        <div class="card-label">Total Growth</div>
                                        <div class="card-value">@results.TotalInterestEarned.ToString("C0")</div>
                                    </div>
                                    <div class="summary-card savings-card savings-card-red">
                                        <span class="bi bi-receipt"></span>
                                        <div class="card-label">Taxes Paid</div>
                                        <div class="card-value">@results.TotalTaxesPaid.ToString("C0")</div>
                                    </div>
                                </div>

                                <!-- Simple Progress Indicator for General Public -->
                                @if (results != null && results.FinalAmount > 0)
                                {
                                    <div class="alert" style="margin: 16px 0; padding: 12px; border-radius: 8px;
                                                                @(GetSavingsProgressMessage().isGood ? "background-color: #d4edda; border-color: #c3e6cb; color: #155724;" : "background-color: #f8d7da; border-color: #f5c6cb; color: #721c24;")">
                                        <div style="display: flex; align-items: center, flex-direction: row; gap: 8px;">
                                            <i class="bi @(GetSavingsProgressMessage().isGood ? "bi-check-circle" : "bi-exclamation-triangle")" style="font-size: 1.2rem;"></i>
                                            <div>
                                                <strong>@GetSavingsProgressMessage().title</strong>
                                                <div style="font-size: 0.9rem; margin-top: 4px;">@GetSavingsProgressMessage().message</div>
                                            </div>
                                        </div>
                                    </div>
                                }
                            }
                        
                            <!-- Enhanced header with large mode toggle - Same as Cost of Living -->
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; position: relative; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 12px; padding: 1rem 1.5rem;">
                                <div style="flex: 1;"></div>
                                <h5>
                                    Savings & Wealth Building - Inputs
                                </h5>
                                <div style="display: flex; gap: 16px; flex: 1; justify-content: flex-end; align-items: center;">
                                    <button class="btn btn-primary" style="padding: 8px 16px; font-size: 0.9rem;" @onclick="() => OpenWizard(1)">
                                        <i class="bi bi-gear me-2"></i>
                                        Update Plan
                                    </button>
                                    <button class="btn btn-outline-danger" style="padding: 8px 16px; font-size: 0.9rem;" @onclick="ClearDataAsync" title="Clear saved plan data for current calculator">
                                        <i class="bi bi-trash me-1"></i>
                                        Clear Plan Data
                                    </button>
                                </div>
                            </div>

                            <SavingsPlanSections Model="@SavingsModel"
                                                 ShowAdvancedSections="@showAdvancedSetup"
                                                 OnOpenWizard="@HandleOpenWizard" />

                     @*        <SavingsPlanSections Model="@calculatorModel" 
                     ShowAdvancedSections="@showAdvancedSetup"
                     OnOpenWizard="OpenWizard" /> *@

                          @*   <div class="plan-sections-grid" style="display:grid; grid-template-columns: repeat(3, 1fr); gap:12px;">
                            </div> *@
                        </div>
                    </div>

                    <!-- Right column-->
                    <div class="col-12 col-md-2">
                        <div class="panel" style="z-index: 1002;">
                            <div style="font-weight:700; margin-bottom:8px;">Quick Links</div>
                            <div style="display:flex; flex-direction:column; gap:6px;">
                                <a href="/" class="badge">Home</a>
                                <a href="/about-rewealthen" class="badge">About</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid-panel panel mt-3">
            <div class="grid-header">
                <div style="font-weight:800; font-size:1rem;">Yearly Projection</div>
@*                 <div style="display: flex; gap: 12px, align-items: center;">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="simpleViewToggle" @onchange="ToggleSimpleView" checked="@showSimpleView">
                        <label class="form-check-label" for="simpleViewToggle" style="font-size: 0.9rem;">Simple View</label>
                    </div>
                    <span class="bi bi-info-circle info-icon" @onclick="() => showToolTipMethodology = !showToolTipMethodology" tabindex="0" title="Click for calculation methodology"></span>
                </div> *@
                @if (showToolTipMethodology)
                {
                    <div class="info-tooltip" style="max-width: 400px;">
                        <strong>Calculation Methodology:</strong>
                        <br>â€¢ Contributions added monthly at month beginning
                        <br>â€¢ Annual growth applied to average account balance
                        <br>â€¢ Taxes calculated on taxable account growth only
                        <br>â€¢ No consideration of market volatility or timing
                        <br>â€¢ Tax rates held constant throughout projection period
                        <br>â€¢ No inflation adjustments to contribution amounts

                        <span class="float-end" style="cursor:pointer;" @onclick="() => showToolTipMethodology = false" title="Close">
                            <span class="bi bi-x-lg"></span>
                        </span>
                    </div>
                }
            </div>

            @if (SavingsModel.IsModelEmpty())
            {
                <div style="text-align: center; padding: 60px 20px; color: #6c757d;">
                    <div style="font-size: 2.5rem; margin-bottom: 16px;">ðŸ“Š</div>
                    <h5 style="color: #495057; margin-bottom: 12px;">No Projection Available</h5>
                    <p style="margin-bottom: 20px;">Complete your savings plan setup to see projections.</p>
                    <button class="btn btn-primary" @onclick="() => OpenWizard(1)">Get Started</button>
                </div>
            }
            else if (HasProjection)
            {

                <SavingsSummaryGrid Model = "@SavingsModel" Rows = "@yearlyBreakdown" StartCalendarYear = "@DateTime.Now.Year" />

                <SavingsYearlyGrid Model="@SavingsModel" Rows="@yearlyBreakdown" />

                
            }
        </div>

        <div class="mt-3 p-3" style="background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px;">
            <div style="display: flex; align-items: flex-start; gap: 8px;">
                <div style="color: #856404; margin-top: 2px;">
                    <i class="bi bi-exclamation-triangle" style="font-size: 1.1rem;"></i>
                </div>
                <div>
                    <div style="font-weight: 600; color: #856404; margin-bottom: 8px;">Important Disclaimers & Assumptions</div>
                    <div style="font-size: 0.9rem; color: #856404; line-height: 1.4;">
                        <p style="margin-bottom: 8px;"><strong>Not Financial Advice:</strong> This tool is for educational purposes only. Results are projections based on your inputs and simplified assumptions.</p>

                        <p style="margin-bottom: 8px;"><strong>Key Assumptions:</strong> Calculations assume steady annual growth, constant tax rates, monthly contributions at month start, and no market volatility, emergencies, or changing life circumstances.</p>

                        <p style="margin-bottom: 8px;"><strong>Limitations:</strong> This calculator does not include state taxes, inflation effects on contributions, changing tax laws, market crashes, or personal financial emergencies. It does not model withdrawals or distributions before retirement, required minimum distributions (RMDs), early withdrawal penalties, or inflation on contributions. Results assume no market volatility, job loss, or other unexpected events.</p>

                        <p style="margin-bottom: 0;"><strong>Professional Guidance:</strong> Consider consulting with qualified financial advisors who can provide personalized advice for your complete financial situation and account for factors not modeled here.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Close intro-modal-active wrapper -->
@code {
    private bool showWizard = false;
    private int wizardOpenStep = 1;
    private bool showSampleDataModal = false;
    private bool showRightDebug = false;

    public SavingsCalculatorModel SavingsModel { get; set; } = new();
    public CalendarSpendingModel RetirementModel { get; set; } = new();
    private SavingsResults? results;
    private List<YearlyBreakdown> yearlyBreakdown = new();
    private string userGuid = string.Empty;
    private const string calculatorTypeYours = "savings_yours";
    private const string calculatorTypePartners = "savings_partners";
    private string calculatorType = calculatorTypeYours;
    private bool showIntroModal = true; // Show by default unless user has opted out
    private bool dontShowIntroAgain = false;

    // Tooltip visibility flags
    private bool showToolTipCurrentAge = false;
    private bool showToolTipRetirementAge = false;
    private bool showToolTipYearsUntilRetirement = false;

    private bool showToolTipTaxableBalance = false;
    private bool showToolTipTraditionalBalance = false;
    private bool showToolTipRothBalance = false;

    private bool showToolTipTaxableContribution = false;
    private bool showToolTipTraditionalContribution = false;
    private bool showToolTipRothContribution = false;

    private bool showToolTipTaxableGrowth = false;
    private bool showToolTipTraditionalGrowth = false;
    private bool showToolTipRothGrowth = false;

    private bool showToolTipIncomeType = false;
    private bool showToolTipTaxBracket = false;
    private bool showToolTipMethodology = false;

    // UX Enhancement toggles
    private bool showSimpleView = true;
    private bool showAdvancedSetup = true;

    private bool showSurvey = false;


    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                userGuid = await UserGuidService.GetOrCreateUserGuidAsync();
                // Track page view once per first render
                _ = TrackPageViewAsync();

                await LoadAsync();
                // New: seed savings ages from retirement backend when savings ages are empty
                await ApplyRetirementAgesIfEmptyAsync();

                Calculate();

                await HandleIntroModal();

                // New: update survey visibility (desktop: always show; mobile handling removed because localStorage eliminated)
                await UpdateSurveyVisibilityAsync();

                StateHasChanged();
            }
            catch (Exception ex)
            {
                DebugService.AddMessage($"Init error: {ex.Message}");
            }
        }
    }

    // Try to read ages persisted by the savings/retirement wizards and apply when model ages are empty (best-effort)
   

   
    private async Task ApplyRetirementAgesIfEmptyAsync()
    {
        try
        {
            if (SavingsModel == null) SavingsModel = new SavingsCalculatorModel();

            // // If savings already has ages, nothing to do
            // var savingsHasAges =
            //     (SavingsModel.CurrentAge > 0 && SavingsModel.RetirementAge > 0);

            // if (savingsHasAges)
            //     return;

            // load retirement model from backend
            var apiBaseUrl = this.ApiUrlProvider.GetApiBaseUrl();
            var client = HttpCustomClientService.CreateRetryClient(HttpClientFactory);
            var userGuidLocal = await UserGuidService.GetOrCreateUserGuidAsync();

            try
            {
                var url = $"{apiBaseUrl}/api/FinPlan/load?userGuid={userGuidLocal}&calculatorType=retirement_planner";
                RetirementModel = await client.GetFromJsonAsync<CalendarSpendingModel>(url) ?? new();
            }
            catch
            {
                RetirementModel = new();
            }

            if (RetirementModel == null) return;

            var changed = false;

            // If current calculator is "your" or activeTab is "your" => map from retirement's "You" fields.
            if (calculatorType == calculatorTypeYours || string.Equals(activeTab, "your", StringComparison.OrdinalIgnoreCase))
            {
                if (SavingsModel.CurrentAge <= 0 && RetirementModel.CurrentAgeYou > 0)
                {
                    SavingsModel.CurrentAge = RetirementModel.CurrentAgeYou;
                    changed = true;
                }

                if (SavingsModel.RetirementAge <= 0 && RetirementModel.RetirementAgeYou > 0)
                {
                    SavingsModel.RetirementAge = RetirementModel.RetirementAgeYou;
                    changed = true;
                }
            }
            else // partner savings calculator -> use partner fields
            {
                if (SavingsModel.CurrentAge <= 0 && RetirementModel.CurrentAgePartner > 0)
                {
                    SavingsModel.CurrentAge = RetirementModel.CurrentAgePartner;
                    changed = true;
                }

                if (SavingsModel.RetirementAge <= 0 && RetirementModel.RetirementAgePartner > 0)
                {
                    SavingsModel.RetirementAge = RetirementModel.RetirementAgePartner;
                    changed = true;
                }
            }

            if (changed)
            {
                // Persist the seeded savings model to backend so savings becomes canonical
                await SaveAsync();

                // Recalculate and update UI
                Calculate();
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            DebugService.AddMessage($"Seed from retirement failed: {ex.Message}");
        }
    }
    private async Task TrackPageViewAsync()
    {
        try
        {
            var apiBaseUrl = this.ApiUrlProvider.GetApiBaseUrl();
            var client = HttpCustomClientService.CreateRetryClient(HttpClientFactory);
            var route = Navigation.ToBaseRelativePath(Navigation.Uri);

            // Get UA via JS (server-side requests may not include the browser UA reliably)
            string? ua = null;
            try { ua = await JSRuntime.InvokeAsync<string>("eval", "navigator.userAgent"); } catch { }

            var dto = new { Page = "Savings", Route = route, UserGuid = userGuid, UserAgent = ua };
            var json = System.Text.Json.JsonSerializer.Serialize(dto);
            using var content = new StringContent(json, System.Text.Encoding.UTF8, "application/json");
            await client.PostAsync($"{apiBaseUrl}/api/Tracking/pageview", content);
        }
        catch { }
    }

    private async Task UpdateSurveyVisibilityAsync()
    {
        try
        {
            // Detect mobile via matchMedia (<= 767px)
            var isMobile = await JSRuntime.InvokeAsync<bool>("eval", "window.matchMedia && window.matchMedia('(max-width: 767px)').matches");

            if (!isMobile)
            {
                // Desktop -> always show
                showSurvey = true;
                return;
            }

            // Mobile -> show only after ~5 page loads (per device/localStorage)
            string key = calculatorType == calculatorTypeYours
                ? "finplan-your-savings-mobile-loads"
                : "finplan-partner-savings-mobile-loads";

            var raw = await JSRuntime.InvokeAsync<string>("localStorage.getItem", key);
            int count = 0;
            if (!string.IsNullOrEmpty(raw) && int.TryParse(raw, out var parsed)) count = parsed;

            count++;
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", key, count.ToString());

            showSurvey = count >= 5;
        }
        catch (Exception ex)
        {
            DebugService.AddMessage($"Survey visibility check failed: {ex.Message}");
            // fallback: hide on error to avoid surprising mobile UX
            showSurvey = false;
        }
        finally
        {
            StateHasChanged();
        }
    }

    private async Task HandleIntroModal()
    {
        // Check for showIntro query parameter
        var uri = new Uri(Navigation.Uri);
        var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
        var showIntroParam = query["showIntro"];

        if (!string.IsNullOrEmpty(showIntroParam) && showIntroParam.Equals("false", StringComparison.OrdinalIgnoreCase))
        {
            // Query parameter explicitly says to hide intro
            showIntroModal = false;
            return;
        }

        showIntroModal = false;

        if (!SavingsModel.HasRealData)
        {
            // Check localStorage for intro modal preference
            string key = calculatorType == calculatorTypeYours
                ? "finplan-your-savings-wealth-building-hide-intro"
                : "finplan-partner-savings-wealth-building-hide-intro";
            var hideIntro = await JSRuntime.InvokeAsync<string>("localStorage.getItem", key);
            if (!string.IsNullOrEmpty(hideIntro) && hideIntro.Equals("true", StringComparison.OrdinalIgnoreCase))
            {
                showIntroModal = false;
            }
            else
            {
                showIntroModal = true;
            }
        }
    }

    private async Task OnDontShowIntroChanged(ChangeEventArgs e)
    {
        bool checkedState = e?.Value is bool b && b;
        string key = calculatorType == calculatorTypeYours
            ? "finplan-your-savings-wealth-building-hide-intro"
            : "finplan-partner-savings-wealth-building-hide-intro";

        if (checkedState)
        {
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", key, "true");
        }
        else
        {
            await JSRuntime.InvokeVoidAsync("localStorage.removeItem", key);
        }
    }

    // Add these new methods
    private void CloseIntroModal()
    {
        showIntroModal = false;
        StateHasChanged();
    }

    private void Calculate()
    {
        try
        {
            var calculator = new SavingsCalculationEngine();
            results = calculator.Calculate(SavingsModel);
            yearlyBreakdown = calculator.GetYearlyBreakdown(SavingsModel);
        }
        catch (Exception ex)
        {
            DebugService.AddMessage($"Calc error: {ex.Message}");
        }
    }

    private async Task LoadAsync()
    {
        try
        {
            var apiBaseUrl = this.ApiUrlProvider.GetApiBaseUrl();
            var url = $"{apiBaseUrl}/api/FinPlan/load?userGuid={userGuid}&calculatorType={calculatorType}";
            var client = HttpCustomClientService.CreateRetryClient(HttpClientFactory);
            var response = await client.GetAsync(url);
            if (response.IsSuccessStatusCode)
            {
                var json = await response.Content.ReadAsStringAsync();
                var loadedModel = System.Text.Json.JsonSerializer.Deserialize<SavingsCalculatorModel>(json,
                    new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true });
                if (loadedModel != null)
                {
                    SavingsModel = loadedModel;
                }
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.NotFound)
            {
                //Does not exist, create an empty one
                SavingsModel = new SavingsCalculatorModel();
            }
        }
        catch (Exception ex)
        {
            DebugService.AddMessage($"Load error: {ex.Message}");
        }
    }

    private bool HasProjection => yearlyBreakdown?.Any() == true;


    private async Task SaveAsync()
    {
        try
        {
            if (string.IsNullOrWhiteSpace(userGuid))
            {
                userGuid = await UserGuidService.GetOrCreateUserGuidAsync();
            }

            SavingsModel.LastUpdateDate = DateTime.UtcNow;
            var saveRequest = new PersistSavingsRequest
            {
                UserGuid = userGuid,
                CalculatorType = calculatorType,
                Data = SavingsModel
            };
            var json = System.Text.Json.JsonSerializer.Serialize(saveRequest);
            using var content = new StringContent(json, System.Text.Encoding.UTF8, "application/json");
            var client = HttpCustomClientService.CreateRetryClient(HttpClientFactory);
            var response = await client.PostAsync($"{this.ApiUrlProvider.GetApiBaseUrl()}/api/FinPlan/save", content);
            if (!response.IsSuccessStatusCode)
            {
                DebugService.AddMessage($"Save failed: {response.StatusCode}");
            }

            // Always recalc so the grid becomes visible immediately after changes
            Calculate();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            DebugService.AddMessage($"Save error: {ex.Message}");
        }
    }
    private async Task HandleWizardFinished()
    {
        try
        {
            await SaveAsync();
            Calculate();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            DebugService.AddMessage($"Wizard finish error: {ex.Message}");
        }
    }
    private async Task HandleWizardFinished1((int AgeYou, int AgePartner) ages)
    {
        try
        {
            if (ages.AgeYou > 0) SavingsModel.RetirementAge = ages.AgeYou;
            await SaveAsync();
            Calculate();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            DebugService.AddMessage($"Wizard finish error: {ex.Message}");
        }
    }

    private async Task HandleSampleDataSelected(SavingsCalculatorModel sampleModel)
    {
        SavingsModel = sampleModel;
        await SaveAsync();
        Calculate();
        StateHasChanged();
    }

    private void OpenWizard(int step)
    {
        wizardOpenStep = step;
        showWizard = true;
    }

    private void ToggleRightDebug()
    {
        showRightDebug = !showRightDebug;
        StateHasChanged();
    }

    private string FormatMoneySafe(decimal? v) => v.HasValue ? v.Value.ToString("C0") : "-";


    private string FormatMoney(decimal? value) => value?.ToString("C0") ?? "-";


    string activeTab = "your";

    private async Task YourTabClick()
    {
        calculatorType = calculatorTypeYours;
        SetActiveTab("your");
        await LoadAsync();
        Calculate();
        await HandleIntroModal();
        StateHasChanged();
    }

    private async Task PartnerTabClick()
    {
        calculatorType = calculatorTypePartners;
        SetActiveTab("partner");
        await LoadAsync();
        Calculate();
        await HandleIntroModal();
        StateHasChanged();
    }
    private void SetActiveTab(string tab)
    {
        activeTab = tab;
    }
    private bool IsMonthlyContributionsSectionComplete()
    {
        return SavingsModel.MonthlyTaxableContribution > 0 ||
               SavingsModel.MonthlyTraditionalContribution > 0 ||
               SavingsModel.MonthlyRothContribution > 0;
    }
    private bool IsMilestonesSectionComplete()
    {
        return SavingsModel.CurrentAge > 0 && SavingsModel.RetirementAge > 0;
    }
    private bool IsStartingBalancesSectionComplete()
    {
        return SavingsModel.InitialTaxableAmount > 0 ||
               SavingsModel.InitialTraditionalAmount > 0 ||
               SavingsModel.InitialRothAmount > 0;
    }


    private bool showToolTipTableHeaderTaxableYearBegin = false;
    private bool showToolTipTableHeaderTaxableContribution = false;
    private bool showToolTipTableHeaderTaxableGrowth = false;
    private bool showToolTipTableHeaderTaxableTaxPaid = false;
    private bool showToolTipTableHeaderTaxableYearEnd = false;

    private bool showToolTipTableHeaderTraditionalYearBegin = false;
    private bool showToolTipTableHeaderTraditionalContribution = false;
    private bool showToolTipTableHeaderTraditionalGrowth = false;
    private bool showToolTipTableHeaderTraditionalYearEnd = false;

    private bool showToolTipTableHeaderRothYearBegin = false;
    private bool showToolTipTableHeaderRothContribution = false;
    private bool showToolTipTableHeaderRothGrowth = false;
    private bool showToolTipTableHeaderRothYearEnd = false;

    private bool showToolTipTableHeaderTotalContributions = false;
    private bool showToolTipTableHeaderTotalGrowth = false;
    private bool showToolTipTableHeaderTotalYearEnd = false;

    private bool showToolTipTableHeaderTaxableCategory = false;
    private bool showToolTipTableHeaderTraditionalCategory = false;
    private bool showToolTipTableHeaderRothCategory = false;

    private bool showToolTipTableHeaderYear = false;
    private bool showToolTipTableHeaderAge = false;
    private bool showToolTipTableHeaderTotalsCategory = false;

//     private string GetApiBaseUrl()
//     {
// #if DEBUG
//             return Configuration["FinPlanSettings:ApiBaseUrlLocal"] ?? "https://localhost:7330";
// #else
//         return Configuration["FinPlanSettings:ApiBaseUrlCloud"] ?? "api-money-amperespark-bnbva5h5g6gme6fm.eastus2-01.azurewebsites.net";
// #endif
//     }
    // Add this method to your @code section
    // Add this method to your @code section
    private async Task ClearDataAsync()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("console.log", "ClearDataAsync: Starting clear operation");
            await JSRuntime.InvokeVoidAsync("console.log", $"ClearDataAsync: Calculator type = {calculatorType}");

            // Confirm with user before deleting
            var confirm = await JSRuntime.InvokeAsync<bool>("confirm",
                $"Are you sure you want to clear all saved data for {(calculatorType == calculatorTypeYours ? "Your" : "Partners")} savings plan? This action cannot be undone.");

            await JSRuntime.InvokeVoidAsync("console.log", $"ClearDataAsync: User confirmation = {confirm}");

            if (!confirm)
            {
                await JSRuntime.InvokeVoidAsync("console.log", "ClearDataAsync: User cancelled operation");
                return;
            }

            if (string.IsNullOrWhiteSpace(userGuid))
            {
                await JSRuntime.InvokeVoidAsync("console.log", "ClearDataAsync: Getting user GUID");
                userGuid = await UserGuidService.GetOrCreateUserGuidAsync();
            }

            await JSRuntime.InvokeVoidAsync("console.log", $"ClearDataAsync: Using user GUID = {userGuid}");

            var apiBaseUrl = this.ApiUrlProvider.GetApiBaseUrl();
            await JSRuntime.InvokeVoidAsync("console.log", $"ClearDataAsync: API base URL = {apiBaseUrl}");

            // Create request body for POST instead of query parameters for DELETE
            var deleteRequest = new
            {
                UserGuid = userGuid,
                CalculatorType = calculatorType
            };

            var json = System.Text.Json.JsonSerializer.Serialize(deleteRequest);
            await JSRuntime.InvokeVoidAsync("console.log", $"ClearDataAsync: Request payload = {json}");

            using var content = new StringContent(json, System.Text.Encoding.UTF8, "application/json");

            var client = HttpCustomClientService.CreateRetryClient(HttpClientFactory);
            var endpoint = $"{apiBaseUrl}/api/FinPlan/remove";
            await JSRuntime.InvokeVoidAsync("console.log", $"ClearDataAsync: Making POST request to {endpoint}");

            // Use POST to delete endpoint instead of DELETE with query parameters
            var response = await client.PostAsync(endpoint, content);

            await JSRuntime.InvokeVoidAsync("console.log", $"ClearDataAsync: Response status = {response.StatusCode}");
            await JSRuntime.InvokeVoidAsync("console.log", $"ClearDataAsync: Response success = {response.IsSuccessStatusCode}");

            if (response.IsSuccessStatusCode || response.StatusCode == System.Net.HttpStatusCode.NotFound)
            {
                await JSRuntime.InvokeVoidAsync("console.log", "ClearDataAsync: Clear operation succeeded");
                DebugService.AddMessage("Plan data cleared successfully.");

                // Remove the intro modal hide localStorage key
                string key = calculatorType == calculatorTypeYours
                    ? "finplan-your-savings-wealth-building-hide-intro"
                    : "finplan-partner-savings-wealth-building-hide-intro";

                await JSRuntime.InvokeVoidAsync("console.log", $"ClearDataAsync: Removing localStorage key = {key}");
                await JSRuntime.InvokeVoidAsync("localStorage.removeItem", key);

                // Reset the model to empty so IsModelEmpty() returns true on reload
                await JSRuntime.InvokeVoidAsync("console.log", "ClearDataAsync: Resetting calculator model to empty state");
                SavingsModel = new SavingsCalculatorModel();

                // Reload the page to reflect the cleared state
                await JSRuntime.InvokeVoidAsync("console.log", $"ClearDataAsync: Reloading page to {Navigation.Uri}");
                Navigation.NavigateTo(Navigation.Uri, forceLoad: true);
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("console.error", $"ClearDataAsync: Failed to clear data - Status: {response.StatusCode}");
                DebugService.AddMessage($"Failed to clear data: {response.StatusCode}");

                // Log response content for debugging
                var responseContent = await response.Content.ReadAsStringAsync();
                await JSRuntime.InvokeVoidAsync("console.error", $"ClearDataAsync: Response content = {responseContent}");
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("console.error", $"ClearDataAsync: Exception occurred - {ex.Message}");
            await JSRuntime.InvokeVoidAsync("console.error", $"ClearDataAsync: Stack trace = {ex.StackTrace}");
            DebugService.AddMessage($"Error clearing data: {ex.Message}");
        }
    }


    // UX Enhancement Methods
    private void ToggleSimpleView(ChangeEventArgs e)
    {
        showSimpleView = e.Value?.ToString()?.ToLower() == "true";
        StateHasChanged();
    }

    private void ToggleAdvancedSetup(ChangeEventArgs e)
    {
        showAdvancedSetup = e.Value?.ToString()?.ToLower() == "true";
        StateHasChanged();
    }
    private void HandleOpenWizard(int step)
    {
        OpenWizard(step);
    }
    private (string title, string message, bool isGood) GetSavingsProgressMessage()
    {
        if (results == null || SavingsModel == null) return ("", "", true);

        var monthlyContributions = SavingsModel.MonthlyTaxableContribution +
                                  SavingsModel.MonthlyTraditionalContribution +
                                  SavingsModel.MonthlyRothContribution;
        var annualContributions = monthlyContributions * 12;
        var yearsToRetirement = SavingsModel.RetirementAge - SavingsModel.CurrentAge;
        var finalSavings = results.FinalAmount;

        // Simple rule of thumb: 10-15% of income saved, or $1M+ by retirement
        if (finalSavings >= 1_000_000)
        {
            return ("Great job! ðŸŽ‰", $"You're projected to have {finalSavings:C0} by retirement. You're on track for a comfortable retirement!", true);
        }
        else if (finalSavings >= 500_000)
        {
            return ("Good progress! ðŸ‘", $"You're projected to have {finalSavings:C0} by retirement. Consider increasing contributions if possible.", true);
        }
        else if (annualContributions < 10_000)
        {
            return ("Consider saving more ðŸ’¡", $"You're currently saving {annualContributions:C0}/year. Financial experts suggest saving 10-15% of income for retirement.", false);
        }
        else
        {
            return ("Keep it up! ðŸ’ª", $"You're saving {annualContributions:C0}/year. Your projected {finalSavings:C0} is a good start - consider increasing when possible.", true);
        }
    }
}