@using Microsoft.AspNetCore.Components.Authorization
@inherits LayoutComponentBase
@inject NavigationManager Navigation
@using System.Security.Claims
@inject AuthenticationStateProvider AuthStateProvider

<style>
    /* Top strip: primary navigation shortcuts */
    .top-strip {
        background: #FFD600; /* yellow background */
        color: #222;
        border-bottom: 1px solid rgba(0,0,0,0.06);
        padding: 6px 0;
        box-shadow: 0 1px 2px rgba(0,0,0,0.03);
        z-index: 1030;
    }

        .top-strip .menu-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .top-strip .menu-link {
            color: #222;
            font-weight: 600;
            padding: 6px 10px;
            border-radius: 6px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

            /* make links more legible on yellow background on hover */
            .top-strip .menu-link:hover {
                background: rgba(0,0,0,0.04);
                text-decoration: none;
            }

        .top-strip .menu-actions {
            margin-left: auto;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        /* separator + auth box */
        .top-sep {
            width: 1px;
            height: 28px;
            background: rgba(0,0,0,0.08);
            margin-left: 12px;
            margin-right: 8px;
            align-self: center;
        }

        .auth-box {
            display: inline-flex;
            gap: 8px;
            align-items: center;
            padding-left: 6px;
        }

        .auth-name {
            font-weight: 600;
            color: #222;
            margin-right: 6px;
        }

        .auth-btn { min-width: 74px; }

    @@media (max-width: 768px) {
        .top-strip .menu-container {
            gap: 8px;
        }

        .top-strip .menu-link {
            padding: 6px 8px;
            font-size: .92rem;
        }
    }
</style>

<div class="top-strip"> 
    <div class="container menu-container">
        <NavLink class="menu-link" href="/wealth-journey"> <span class="bi bi-calculator"></span> Wealth Building</NavLink>
        <NavLink class="menu-link d-none d-md-inline" href="/howmuch-to-save-per-month"> <span class="bi bi-piggy-bank"></span> Goal Savings</NavLink>
        <NavLink class="menu-link" href="/living-cost"> <span class="bi bi-list-ul"></span> Living Cost</NavLink>
        <NavLink class="menu-link" href="/retirement-fire"> <span class="bi bi-wallet2"></span> Retirement Drawdown</NavLink>


        <div class="menu-actions">
            <div class="top-sep" aria-hidden="true"></div>

            @if (isAuthLoaded)
            {
                if (isAuthenticated && currentUser != null)
                {
                    var first = currentUser.FindFirst("given_name")?.Value ?? string.Empty;
                    var last = currentUser.FindFirst("family_name")?.Value ?? string.Empty;
                    var display = (!string.IsNullOrWhiteSpace(first) || !string.IsNullOrWhiteSpace(last)) ? $"{first} {last}".Trim() : (currentUser.FindFirst("name")?.Value ?? currentUser.Identity?.Name ?? "User");
                    <div class="auth-box" role="region" aria-label="User account">
                        <span class="auth-name">@display</span>
                        <button class="btn btn-sm btn-outline-secondary auth-btn" @onclick="SignOutClicked" aria-label="Sign out">Sign out</button>
                    </div>
                }
                else
                {
                    <div class="auth-box" role="region" aria-label="Authentication">
                        <a class="btn btn-sm btn-primary auth-btn" href="/signin-google-challenge" aria-label="Sign in with Google">Sign in</a>
                        <a class="btn btn-sm btn-outline-secondary d-none d-md-inline auth-btn" href="/signin-google-challenge" aria-label="Sign up with Google">Sign up</a>
                    </div>
                }
            }
            else
            {
                <div class="auth-box" role="region" aria-label="Authentication">
                    <div class="spinner-border spinner-border-sm text-dark" role="status" aria-hidden="true"></div>
                </div>
            }
         </div>
     </div>
 </div>
   

@* <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <a class="navbar-brand" href="">Home</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavDropdown">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNavDropdown">
        <ul class="navbar-nav">
            <!-- Savings Dropdown -->
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#" id="savingsDropdown" role="button"
                   data-bs-toggle="dropdown" aria-expanded="false">
                    Wealth Building
                </a>
                <ul class="dropdown-menu" aria-labelledby="savingsDropdown">
                    <li><NavLink class="dropdown-item" href="/wealth-journey">Project future value</NavLink></li>
                    <li><NavLink class="dropdown-item" href="/howmuch-to-save-per-month">Goal-Based Savings</NavLink></li>
                </ul>
            </li>
            <!-- Spending Dropdown -->
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#" id="spendingDropdown" role="button"
                   data-bs-toggle="dropdown" aria-expanded="false">
                    Retire Early
                </a>
                <ul class="dropdown-menu" aria-labelledby="spendingDropdown">
                    <li><NavLink class="dropdown-item" href="/retirement-fire">Retirement Drawdown</NavLink></li>
                    <li><NavLink class="dropdown-item" href="/living-cost">Living Cost Estimator</NavLink></li>
                </ul>
            </li>
            <!-- About Dropdown -->
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#" id="aboutDropdown" role="button"
                   data-bs-toggle="dropdown" aria-expanded="false">
                    About
                </a>
                <ul class="dropdown-menu" aria-labelledby="aboutDropdown">
                    <li><NavLink class="dropdown-item" href="/team">Team</NavLink></li>
                    <li><NavLink class="dropdown-item" href="/disclaimer">Disclaimer</NavLink></li>
                    <li><NavLink class="dropdown-item" href="/terms-of-use">Terms of Use</NavLink></li>
                    <li><NavLink class="dropdown-item" href="/contact">Contact Us</NavLink></li>
                    <li><NavLink class="dropdown-item" href="/privacy-policy">Privacy Policy</NavLink></li>
                </ul>
            </li>
        </ul>
    </div>
</nav> *@

<main>
    <div class="content-rail d-flex">
        <article class="content px-4">
            @Body
        </article>
    </div>
</main>

<!-- Consent banner -->
<div id="consent-banner" style="display:none; position:fixed; right:16px; bottom:16px; z-index:1050; max-width:420px;">
    <div class="card shadow">
        <div class="card-body">
            <h6 class="card-title">Cookies & Consent</h6>
            <p class="small">We use cookies to improve calculators and personalize ads. Manage consent:</p>
            <div class="d-flex align-items-center mb-2">
                <div class="form-check me-2">
                    <input class="form-check-input" type="checkbox" id="consent-analytics" />
                    <label class="form-check-label small" for="consent-analytics">Analytics</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="consent-ads" />
                    <label class="form-check-label small" for="consent-ads">Ads personalization</label>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <button class="btn btn-link btn-sm me-2" id="consent-decline">Decline all</button>
                <button class="btn btn-primary btn-sm" id="consent-accept">Save</button>
            </div>
        </div>
    </div>
</div>

<div id="blazor-error-ui">
    An unhandled error has occurred.
    <a href="" class="reload">Reload</a>
    <a class="dismiss">🗙</a>
</div>

<script src="/js/adLoader.js"></script>
<script>
    // Consent logic: show banner if no consent cookie exists
    (function(){
        const consentKey = 'finplan_consent_v1';

        function showBanner() {
            const el = document.getElementById('consent-banner');
            if (!el) return;
            el.style.display = 'block';
            // initialise checkbox states from stored consent
            const existing = window.cookieHandlerExtension.GetConsentObject(consentKey);
            if (existing) {
                const a = document.getElementById('consent-analytics');
                const p = document.getElementById('consent-ads');
                if (a) a.checked = !!existing.analytics;
                if (p) p.checked = !!existing.personalizedAds;
            } else {
                const a = document.getElementById('consent-analytics');
                const p = document.getElementById('consent-ads');
                if (a) a.checked = true; // default analytics allowed
                if (p) p.checked = false; // default ads off
            }
        }

        function saveConsent() {
            const aEl = document.getElementById('consent-analytics');
            const pEl = document.getElementById('consent-ads');
            const obj = {
                analytics: !!(aEl && aEl.checked),
                personalizedAds: !!(pEl && pEl.checked),
                timestamp: new Date().toISOString()
            };
            window.cookieHandlerExtension.SetConsentObject(consentKey, obj, 365);
            window.cookieHandlerExtension.ApplyConsentToWindow(consentKey);
            const el = document.getElementById('consent-banner'); if (el) el.style.display = 'none';

            // Initialize ads now that consent stored
            if (window.adLoader && typeof window.adLoader.init === 'function') window.adLoader.init({ consentKey: consentKey });
        }

        function declineAll() {
            const obj = { analytics: false, personalizedAds: false, timestamp: new Date().toISOString() };
            window.cookieHandlerExtension.SetConsentObject(consentKey, obj, 365);
            window.cookieHandlerExtension.ApplyConsentToWindow(consentKey);
            const el = document.getElementById('consent-banner'); if (el) el.style.display = 'none';

            // Still init adLoader so non-personalized placeholders load
            if (window.adLoader && typeof window.adLoader.init === 'function') window.adLoader.init({ consentKey: consentKey });
        }

        // Wait for the layout DOM to be available (handles Blazor render replacing DOM)
        function initWhenReady() {
            let attempts = 0;
            const maxAttempts = 50; // ~5s
            const interval = setInterval(() => {
                attempts++;
                const banner = document.getElementById('consent-banner');
                const accept = document.getElementById('consent-accept');
                const decline = document.getElementById('consent-decline');
                if (banner && accept && decline) {
                    clearInterval(interval);

                    // Attach listeners (avoid duplicate attachments)
                    try {
                        if (accept && typeof accept.addEventListener === 'function') {
                            try { accept.removeEventListener('click', saveConsent); } catch(e) { /* ignore */ }
                            accept.addEventListener('click', saveConsent);
                        }
                        if (decline && typeof decline.addEventListener === 'function') {
                            try { decline.removeEventListener('click', declineAll); } catch(e) { /* ignore */ }
                            decline.addEventListener('click', declineAll);
                        }
                    } catch (handlerEx) { console.error('Consent handlers attach failed', handlerEx); }

                    // wire blazor error UI controls safely
                    try {
                        const reloadLink = document.querySelector('#blazor-error-ui .reload');
                        const dismissLink = document.querySelector('#blazor-error-ui .dismiss');
                        if (reloadLink && typeof reloadLink.addEventListener === 'function') {
                            reloadLink.removeEventListener('click', window.__fp_reload_handler__);
                            window.__fp_reload_handler__ = function(ev) { ev.preventDefault(); try { window.location.reload(); } catch(e) { console.error(e); } };
                            reloadLink.addEventListener('click', window.__fp_reload_handler__);
                        }
                        if (dismissLink && typeof dismissLink.addEventListener === 'function') {
                            dismissLink.removeEventListener('click', window.__fp_dismiss_handler__);
                            window.__fp_dismiss_handler__ = function(ev) { ev.preventDefault(); var ui = document.getElementById('blazor-error-ui'); if (ui) ui.style.display = 'none'; };
                            dismissLink.addEventListener('click', window.__fp_dismiss_handler__);
                        }
                    } catch (e) { console.error('blazor-error-ui handlers', e); }

                    // Apply stored consent to window flags
                    try { window.cookieHandlerExtension.ApplyConsentToWindow(consentKey); } catch(e) { console.error(e); }

                    const has = window.cookieHandlerExtension.GetConsentObject(consentKey);
                    if (!has) {
                        // slight delay so layout paint is visible and it doesn't flash due to re-render
                        setTimeout(() => showBanner(), 80);
                    } else {
                        // If consent already present, initialize ad loader immediately
                        if (window.adLoader && typeof window.adLoader.init === 'function') window.adLoader.init({ consentKey: consentKey });
                    }
                }

                if (attempts >= maxAttempts) {
                    clearInterval(interval);
                }
            }, 100);
        }

        // Start init after a short tick to allow Blazor to render
        setTimeout(initWhenReady, 50);

    })();
</script>

<!-- Global JS error capture to help troubleshooting -->
<script>
    (function(){
        if (!window.fpDebug) window.fpDebug = {};

        window.addEventListener('error', function (e) {
            try {
                console.error('Global error:', e.message, e.filename + ':' + e.lineno, e.error ? e.error.stack : null);
            } catch (ex) { /* ignore */ }
        });

        window.addEventListener('unhandledrejection', function (e) {
            try {
                console.error('Unhandled Promise rejection:', e.reason);
            } catch (ex) { /* ignore */ }
        });

        // helper to log from C# via JSRuntime
        window.fpDebug.log = function () {
            try { console.log.apply(console, arguments); } catch (e) { }
        };
        window.fpDebug.error = function () {
            try { console.error.apply(console, arguments); } catch (e) { }
        };
    })();
</script>

@code {
    private ClaimsPrincipal? currentUser;
    private bool isAuthenticated = false;
    private bool isAuthLoaded = false;
    
    private void SignOutClicked()
    {
        // Force full navigation so the server signout endpoint runs and cookies are cleared
        Navigation.NavigateTo("/signout", forceLoad: true);
    }

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        await LoadAuthStateAsync();
    }

    private async Task LoadAuthStateAsync()
    {
        try
        {
            var state = await AuthStateProvider.GetAuthenticationStateAsync();
            currentUser = state.User;
            isAuthenticated = currentUser?.Identity?.IsAuthenticated ?? false;
        }
        catch
        {
            currentUser = null;
            isAuthenticated = false;
        }
        isAuthLoaded = true;
        StateHasChanged();
    }
}