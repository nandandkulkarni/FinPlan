@inherits LayoutComponentBase

<div class="page">
    <div class="sidebar">
        <NavMenu />
    </div>

    <main>
        <div class="top-row px-4">
            <a href="https://learn.microsoft.com/aspnet/core/" target="_blank">About</a>
        </div>

        <article class="content px-4">
            @Body
        </article>
    </main>
</div>

<!-- Consent banner -->
<div id="consent-banner" style="display:none; position:fixed; right:16px; bottom:16px; z-index:1050; max-width:420px;">
    <div class="card shadow">
        <div class="card-body">
            <h6 class="card-title">Cookies & Consent</h6>
            <p class="small">We use cookies to improve calculators and personalize ads. Manage consent:</p>
            <div class="d-flex align-items-center mb-2">
                <div class="form-check me-2">
                    <input class="form-check-input" type="checkbox" id="consent-analytics" />
                    <label class="form-check-label small" for="consent-analytics">Analytics</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="consent-ads" />
                    <label class="form-check-label small" for="consent-ads">Ads personalization</label>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <button class="btn btn-link btn-sm me-2" id="consent-decline">Decline all</button>
                <button class="btn btn-primary btn-sm" id="consent-accept">Save</button>
            </div>
        </div>
    </div>
</div>

<div id="blazor-error-ui">
    An unhandled error has occurred.
    <a href="" class="reload">Reload</a>
    <a class="dismiss">🗙</a>
</div>

<script>
    // Consent logic: show banner if no consent cookie exists
    (function(){
        const consentKey = 'finplan_consent_v1';
        function showBanner() {
            document.getElementById('consent-banner').style.display = 'block';
            // initialise checkbox states from stored consent
            const existing = window.cookieHandlerExtension.GetConsentObject(consentKey);
            if (existing) {
                document.getElementById('consent-analytics').checked = !!existing.analytics;
                document.getElementById('consent-ads').checked = !!existing.personalizedAds;
            } else {
                // default: analytics allowed, ads personalization off
                document.getElementById('consent-analytics').checked = true;
                document.getElementById('consent-ads').checked = false;
            }
        }

        function saveConsent() {
            const obj = {
                analytics: document.getElementById('consent-analytics').checked,
                personalizedAds: document.getElementById('consent-ads').checked,
                timestamp: new Date().toISOString()
            };
            window.cookieHandlerExtension.SetConsentObject(consentKey, obj, 365);
            window.cookieHandlerExtension.ApplyConsentToWindow(consentKey);
            document.getElementById('consent-banner').style.display = 'none';
        }

        function declineAll() {
            const obj = { analytics: false, personalizedAds: false, timestamp: new Date().toISOString() };
            window.cookieHandlerExtension.SetConsentObject(consentKey, obj, 365);
            window.cookieHandlerExtension.ApplyConsentToWindow(consentKey);
            document.getElementById('consent-banner').style.display = 'none';
        }

        // When DOM ready, check consent cookie
        document.addEventListener('DOMContentLoaded', function(){
            try {
                window.cookieHandlerExtension.ApplyConsentToWindow(consentKey);
                const has = window.cookieHandlerExtension.GetConsentObject(consentKey);
                if (!has) showBanner();
            } catch (e) { console.error(e); }

            document.getElementById('consent-accept').addEventListener('click', saveConsent);
            document.getElementById('consent-decline').addEventListener('click', declineAll);
        });

    })();
</script>
