@page "/wealth-building"
@using System.ComponentModel.DataAnnotations
@using FinPlan.Shared
@using FinPlan.Shared.Enums
@using FinPlan.Shared.Models
@using FinPlan.Shared.Models.Savings
@using FinPlan.Shared.Services
@using FinPlan.Web.Components.Shared
@using FinPlan.Web.Services
@using Microsoft.AspNetCore.Components.Forms
@inject IJSRuntime JSRuntime
@inject IHttpClientFactory HttpClientFactory
@inject IConfiguration Configuration
@inject FinPlan.Web.Services.DebugMessageService DebugService
@inject FinPlan.Web.Services.UserGuidService UserGuidService
@namespace FinPlan.Web.Components.Pages

<PageTitle>Savings - Wealth Journey</PageTitle>

<!-- Savings quick setup wizard (one page per section) -->
<SavingsInputWizard Model="@calculatorModel" Visible="@showWizard" VisibleChanged="@(v => showWizard = v)" OnFinished="HandleWizardFinished" OnSave="SaveUserSavingsAsync" InitialStep="@wizardOpenStep" />

<style>
    :root {
        --brand-yellow: #FFD600;
        --muted: #6c757d;
        --bg: #f8f9fa;
        --card-bg: #ffffff;
        --card-radius: 10px;
        --accent: #6D5DFC;
        --danger: #F56565;
        --success: #38B2AC;
        --info: #4FD1C5;
    }

    .container-wire {
        padding: 14px;
    }

    .page-header {
        text-align: center;
        font-weight: 700;
        font-size: 1.45rem;
        margin-bottom: 12px;
        color: #111;
    }

    .page-header {
        text-align: center;
        font-weight: 700,700;
        font-size: 1.45rem;
        margin-bottom: 12px;
        color: #111;
    }

    .top-area {
        position: relative;
    }

    .panel {
        background: var(--card-bg);
        border-radius: var(--card-radius);
        box-shadow: 0 6px 18px rgba(22,28,36,0.06);
        padding: 12px;
        border: 1px solid rgba(0,0,0,0.03);
        display: flex;
        flex-direction: column;
        flex: 1 1 0%;
    }

    /* Section card variant used inside the Plan Sections grid */
    .section-card {
        /* darker border for stronger separation from the background */
        border: 1px solid rgba(16,24,36,0.12);
        padding: 10px;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        min-height: 92px;
        background: #fff;
    }

        .section-card .actions {
            margin-top: auto; /* push to bottom of the card */
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

    .btn-edit {
        background: #1F6FEB; /* professional blue */
        color: #ffffff;
        border: 0;
        padding: 7px 12px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
    }

    /* Highlighted rectangular panel with yellow border and subtle shadow */
    .section-panel {
        border: 3px solid var(--brand-yellow);
        border-radius: 10px;
        box-shadow: 0 12px 30px rgba(13,38,76,0.06), 0 4px 18px rgba(255,214,0,0.08);
        padding: 14px;
        background: linear-gradient(180deg, #fff, #fff);
    }

    .step-badge {
        width: 36px;
        height: 36px;
        min-width: 36px;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        /* match retirement page: yellow circular fill with dark text for contrast */
        background: var(--brand-yellow);
        color: #111;
        font-weight: 800;
        font-size: 1rem;
        box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        margin-right: 8px;
        flex-shrink: 0;
    }

    .small-note {
        font-size: 0.9rem;
        color: var(--muted);
        margin-top: 4px;
    }

    .grid-panel {
        margin-top: 12px;
    }

    .grid-header {
        display: flex;
        gap: 12px;
        align-items: center;
        margin-bottom: 8px;
    }

    .grid {
        width: 100%;
        border-radius: 8px;
        overflow: auto;
        background: #fff;
        border: 1px solid #e9ecef;
        box-shadow: 0 8px 24px rgba(12,18,30,0.04);
    }

    table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.98rem;
        min-width: 900px;
    }

    thead th {
        position: sticky;
        top: 0;
        background: #fff;
        padding: 10px 12px;
        border-bottom: 1px solid #eef2f6;
        text-align: left;
        font-weight: 700;
        color: #333;
    }

    tbody td {
        padding: 8px 12px;
        border-bottom: 1px solid #f2f4f7;
        vertical-align: middle;
    }

    .money-cell {
        text-align: right;
        font-variant-numeric: tabular-nums;
    }

    .legend {
        margin-left: auto;
        display: flex;
        gap: 8px;
        align-items: center;
        font-size: 0.95rem;
        color: var(--muted);
    }

    @@media (max-width:1024px) {
        .top-area .row {
            gap: 12px;
        }
    }
</style>

<div class="container-wire">
    <div class="page-header">
        <h3>Wealth Building</h3>
    </div>

    <div class="top-area">
        <div class="container-fluid">
            <div class="row g-3">
                <!-- Left column (2) -->
                <div class="col-12 col-md-2">
                    <div class="panel">
                        <div style="font-weight:700; margin-bottom:8px;">Quick Links</div>
                        <div style="display:flex; flex-direction:column; gap:6px;">
                            <a href="/" class="badge">Home</a>
                            <a href="/guides/how-to-use-wealth-journey-calculator" class="badge">How to</a>
                            <a href="/contact" class="badge">Contact</a>
                        </div>
                        <div style="margin-top:10px; font-size:0.85rem; color:var(--muted);">Mini summary</div>
                        <div style="margin-top:6px; background:#f8fafc; padding:8px; border-radius:6px;">Post-Tax <br /><strong>@(results?.TaxableBalance.ToString("C0") ?? "-")</strong></div>
                    </div>
                </div>

                <!-- Center combined column (8) -->
                <div class="col-12 col-md-8">
                    <div class="panel section-panel">
                        <h4>Plan Sections</h4>

                        <div style="display:grid; grid-template-columns: repeat(2, 1fr); gap:12px;">
                            <div class="section-card">
                                <div>
                                    <div style="display:flex; align-items:center; gap:8px; font-weight:700;">
                                        <span class="step-badge">1</span>
                                        <div>Milestones</div>
                                    </div>

                                    <div class="small-note" style="margin-top:8px;">Current Age: @calculatorModel.CurrentAge</div>
                                    <div class="small-note" style="margin-top:8px;">Planned Retirement Age: @calculatorModel.RetirementAge</div>
                                    <div class="small-note" style="margin-top:8px;">Years until Retirement: @calculatorModel.Years</div>
                                </div>
                                <div class="actions">
                                    <button class="btn-edit" @onclick="() => OpenWizard(1)">Edit</button>
                                </div>
                            </div>

                            <div class="section-card">
                                <div>
                                    <div style="display:flex; align-items:center; gap:8px; font-weight:700;">
                                        <span class="step-badge">2</span>
                                        <div>Starting Balances</div>
                                    </div>

                                    <div class="small-note" style="margin-top:8px;">Taxable: @FormatMoneySafe(calculatorModel.InitialTaxableAmount)</div>
                                    <div class="small-note" style="margin-top:8px;">Traditional: @FormatMoneySafe(calculatorModel.InitialTraditionalAmount)</div>
                                    <div class="small-note" style="margin-top:8px;">Roth: @FormatMoneySafe(calculatorModel.InitialRothAmount)</div>

                                </div>
                                <div class="actions">
                                    <button class="btn-edit" @onclick="() => OpenWizard(2)">Edit</button>
                                </div>
                            </div>

                            <div class="section-card">
                                <div>
                                    <div style="display:flex; align-items:center; gap:8px; font-weight:700;">
                                        <span class="step-badge">3</span>
                                        <div>Monthly Contributions</div>
                                    </div>
                                    <div class="small-note" style="margin-top:8px;">Taxable: @calculatorModel.MonthlyTaxableContribution.ToString("C0")</div>
                                    <div class="small-note" style="margin-top:8px;">Taxable: @calculatorModel.MonthlyTraditionalContribution.ToString("C0")</div>
                                    <div class="small-note" style="margin-top:8px;">Taxable: @calculatorModel.MonthlyRothContribution.ToString("C0")</div>
                                </div>
                                <div class="actions">
                                    <button class="btn-edit" @onclick="() => OpenWizard(3)">Edit</button>
                                </div>
                            </div>
                            <div class="section-card">
                                <div>
                                    <div style="display:flex; align-items:center; gap:8px; font-weight:700;">
                                        <span class="step-badge">4</span>
                                        <div>Estimated Growth Rate</div>
                                    </div>
                                    <div class="small-note">Taxable: @string.Format("{0:F1}%", calculatorModel.AnnualGrowthRateTaxable)</div>
                                    <div class="small-note">Traditional: @string.Format("{0:F1}%", calculatorModel.AnnualGrowthRateTraditional)</div>
                                    <div class="small-note">Roth: @string.Format("{0:F1}%", calculatorModel.AnnualGrowthRateRoth)</div>
                                </div>
                                <div class="actions">
                                    <button class="btn-edit" @onclick="() => OpenWizard(4)">Edit</button>
                                </div>
                            </div>


                            <div class="section-card">
                                <div>
                                    <div style="display:flex; align-items:center; gap:8px; font-weight:700;">
                                        <span class="step-badge">5</span>
                                        <div>Tax Treatment</div>
                                    </div>
                                    <div class="small-note" style="margin-top:8px;">Taxable IncomeType: @calculatorModel.TaxableIncomeType</div>
                                    <div class="small-note" style="margin-top:8px;">Tax Bracket: @calculatorModel.TaxBracket</div>
                                </div>
                                <div class="actions">
                                    <button class="btn-edit" @onclick="() => OpenWizard(5)">Edit</button>
                                </div>
                            </div>
                        </div>

                        <div style="margin-top:12px; display:flex; gap:8px; justify-content:flex-end;">
                            <button class="btn btn-primary" @onclick="SaveAndClose">Save & Close</button>
                        </div>

                        @if (results != null)
                        {
                            <div class="mt-3">
                                <div class="row mb-3">
                                    <div class="col-md-3"><div class="card bg-light"><div class="card-body text-center"><h4 class="text-primary summary-money">@results.FinalAmount.ToString("C0")</h4><p class="mb-0">Final Amount</p></div></div></div>
                                    <div class="col-md-3"><div class="card bg-light"><div class="card-body text-center"><h4 class="text-success summary-money">@results.TotalInterestEarned.ToString("C0")</h4><p class="mb-0">Growth</p></div></div></div>
                                    <div class="col-md-3"><div class="card bg-light"><div class="card-body text-center"><h4 class="text-info summary-money">@results.TotalContributions.ToString("C0")</h4><p class="mb-0">Total Contributions</p></div></div></div>
                                    <div class="col-md-3"><div class="card bg-light"><div class="card-body text-center"><h4 class="text-warning summary-money">@string.Format("{0:F1}%/{1:F1}%/{2:F1}%,", calculatorModel.AnnualGrowthRateTaxable, calculatorModel.AnnualGrowthRateTraditional, calculatorModel.AnnualGrowthRateRoth)</h4><p class="mb-0">Growth (Taxable/Traditional/Roth)</p></div></div></div>
                                </div>
                            </div>
                        }
                    </div>
                </div>

                <!-- Right column (2) -->
                <div class="col-12 col-md-2">
                    <div class="panel">
                        <div style="font-weight:700; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center;">
                            <div>Debug</div>
                            <div>
                                <button class="btn-ghost" style="padding:4px 6px; font-size:0.8rem;" @onclick="ToggleRightDebug">Toggle</button>
                            </div>
                        </div>
                        <div style="font-size:0.85rem; color:var(--muted);">Toggle messages</div>
                        @if (showRightDebug)
                        {
                            <div style="margin-top:8px; background:#fbfbfb; padding:8px; border-radius:6px; max-height:200px; overflow:auto;">
                                @foreach (var msg in DebugService.Messages.OrderByDescending(m => m.MessageTime))
                                {
                                    <div style="margin-bottom:6px;"><small style="color:var(--muted);">@msg.MessageTime.ToString("HH:mm:ss")</small><div>@msg.MessageText</div></div>
                                }
                            </div>
                        }
                        else
                        {
                            <div style="margin-top:8px; background:#fbfbfb; padding:8px; border-radius:6px; max-height:120px; overflow:auto;">No messages</div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>

    @* Yearly Projection grid - uses same bootstrap/table styling as retirement page *@
    <div class="grid-panel panel mt-3">
        <div class="grid-header">
            <div style="font-weight:800; font-size:1rem;">Yearly Projection</div>
            <div class="legend">
                <div style="display:flex; gap:8px; align-items:center;"><span class="swatch" style="background:var(--brand-yellow)"></span><small> Milestone</small></div>
                <div style="display:flex; gap:8px; align-items:center;"><span class="swatch" style="background:#38B2AC"></span><small> Growth</small></div>
            </div>
        </div>

        <div class="grid">
            <table class="table table-sm table-bordered" aria-label="Yearly projection">
                <thead class="table-light">
                    <tr>
                        <th>Year</th>
                        <th>Age</th>
                        <th>Taxable BOY</th>
                        <th>Taxable Growth</th>
                        <th>Taxes</th>
                        <th>Taxable EOY</th>
                        <th>Traditional BOY</th>
                        <th>Traditional Growth</th>
                        <th>Traditional EOY</th>
                        <th>Roth BOY</th>
                        <th>Roth Growth</th>
                        <th>Roth EOY</th>
                        <th class="text-end">Total Contributions</th>
                        <th class="text-end">Total Growth</th>
                        <th class="text-end">Total EOY</th>
                    </tr>
                </thead>
                <tbody>
                    @if (yearlyBreakdown == null || !yearlyBreakdown.Any())
                    {
                        <tr><td colspan="15" class="text-center text-muted">No projection rows available. Run Calculate to generate projections.</td></tr>
                    }
                    else
                    {
                        foreach (var r in yearlyBreakdown)
                        {
                            var age = calculatorModel.CurrentAge + r.Year; // approximate
                                                                           <tr>
                                                                               <td>@r.Year</td>
                                                                               <td>@age</td>
                                                                               <td class="text-end">@FormatMoneySafe(r.TaxableBOYBalance)</td>
                                                                               <td class="text-end">@FormatMoneySafe(r.TaxableInterest)</td>
                                                                               <td class="text-end">@FormatMoneySafe(r.TaxesPaid)</td>
                                                                               <td class="text-end">@FormatMoneySafe(r.TaxableEOYBalance)</td>
                                                                               <td class="text-end">@FormatMoneySafe(r.TraditionalBOYBalance)</td>
                                                                               <td class="text-end">@FormatMoneySafe(r.Traditionalnterest)</td>
                                                                               <td class="text-end">@FormatMoneySafe(r.TraditionalEOYBalance)</td>
                                                                               <td class="text-end">@FormatMoneySafe(r.RothBOYBalance)</td>
                                                                               <td class="text-end">@FormatMoneySafe(r.RothInterest)</td>
                                                                               <td class="text-end">@FormatMoneySafe(r.RothEOYBalance)</td>
                                                                               <td class="text-end">@FormatMoneySafe(r.TotalContributions)</td>
                                                                               <td class="text-end">@FormatMoneySafe(r.TotalGrowth)</td>
                                                                               <td class="text-end">@FormatMoneySafe(r.TotalEOYBalance)</td>
                                                                           </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>

</div>

@code {
    // Wizard control
    private bool showWizard = false;
    private int wizardOpenStep = 1;

    // State copied from WealthJourmeyPlanner
    [SupplyParameterFromForm]
    public SavingsCalculatorModel calculatorModel { get; set; } = new();
    private SavingsResults? results;
    private FinPlan.Shared.Models.Savings.SavingsResults? youResults;
    private FinPlan.Shared.Models.Savings.SavingsResults? partnerResults;
    private List<YearlyBreakdown> yearlyBreakdown = new();
    private List<IntervalSummary> intervalSummaries = new();
    private bool showRightDebug = false;
    private string calculatorType = "TestSavings_yours";
    private string userGuid = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        // noop
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try { userGuid = await UserGuidService.GetOrCreateUserGuidAsync(); } catch { }
            await LoadUserSavingsAsync();
            Calculate();
            await LoadMiniSummariesAsync();
            StateHasChanged();
        }
    }

    private void Calculate()
    {
        try
        {
            var calculator = new SavingsCalculationEngine();
            results = calculator.Calculate(calculatorModel);
            yearlyBreakdown = calculator.GetYearlyBreakdown(calculatorModel);
        }
        catch (Exception ex)
        {
            DebugService.AddMessage($"Calc error: {ex.Message}");
        }
    }

    private string GetApiBaseUrl()
    {
#if DEBUG
            return Configuration["FinPlanSettings:ApiBaseUrlLocal"] ?? "https://localhost:7330";
#else
        return Configuration["FinPlanSettings:ApiBaseUrlCloud"] ?? "https://api.finplan.example";
#endif
    }

    private async Task LoadUserSavingsAsync()
    {
        try
        {
            var apiBaseUrl = GetApiBaseUrl();
            var url = $"{apiBaseUrl}/api/FinPlan/load?userGuid={userGuid}&calculatorType={calculatorType}";
            var client = HttpCustomClientService.CreateRetryClient(HttpClientFactory);
            var response = await client.GetAsync(url);
            if (!response.IsSuccessStatusCode) return;
            var json = await response.Content.ReadAsStringAsync();
            var loadedModel = System.Text.Json.JsonSerializer.Deserialize<SavingsCalculatorModel>(json, new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true });
            if (loadedModel != null)
            {
                calculatorModel = loadedModel;
            }
        }
        catch (Exception ex)
        {
            DebugService.AddMessage($"Load failed: {ex.Message}");
        }
    }

    private async Task LoadMiniSummariesAsync()
    {
        try
        {
            var apiBaseUrl = GetApiBaseUrl();
            var client = HttpCustomClientService.CreateRetryClient(HttpClientFactory);
            async Task<FinPlan.Shared.Models.Savings.SavingsResults?> LoadFor(string calcType)
            {
                try
                {
                    var url = $"{apiBaseUrl}/api/FinPlan/load?userGuid={userGuid}&calculatorType={calcType}";
                    var response = await client.GetAsync(url);
                    if (!response.IsSuccessStatusCode) return null;
                    var json = await response.Content.ReadAsStringAsync();
                    var loadedModel = System.Text.Json.JsonSerializer.Deserialize<SavingsCalculatorModel>(json, new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true });
                    if (loadedModel == null) return null;
                    var calc = new FinPlan.Shared.Services.SavingsCalculationEngine();
                    return calc.Calculate(loadedModel);
                }
                catch { return null; }
            }

            var yourTask = LoadFor("TestSavings_yours");
            var partnerTask = LoadFor("TestSavings_partners");
            await Task.WhenAll(yourTask, partnerTask);
            youResults = await yourTask;
            partnerResults = await partnerTask;
        }
        catch (Exception ex)
        {
            DebugService.AddMessage($"Mini summaries load failed: {ex.Message}");
        }
    }

    private async Task SaveUserSavingsAsync()
    {
        try
        {
            calculatorModel.LastUpdateDate = DateTime.UtcNow;
            var saveRequest = new PersistSavingsRequest { UserGuid = userGuid, CalculatorType = calculatorType, Data = calculatorModel };
            var json = System.Text.Json.JsonSerializer.Serialize(saveRequest);
            using var content = new StringContent(json, System.Text.Encoding.UTF8, "application/json");
            var client = HttpCustomClientService.CreateRetryClient(HttpClientFactory);
            var response = await client.PostAsync($"{GetApiBaseUrl()}/api/FinPlan/save", content);
            if (!response.IsSuccessStatusCode)
            {
                DebugService.AddMessage($"Save failed: {response.StatusCode}");
            }
        }
        catch (Exception ex)
        {
            DebugService.AddMessage($"Save error: {ex.Message}");
        }
    }

    private async Task HandleWizardFinished((int AgeYou, int AgePartner) ages)
    {
        // map retirement age to model if present
        try
        {
            if (ages.AgeYou > 0) calculatorModel.RetirementAge = ages.AgeYou;
            // Save and recalc
            await SaveUserSavingsAsync();
            Calculate();
            StateHasChanged();
        }
        catch { }
    }

    private async Task HandleSection1Valid()
    {
        // Save and recalc after section 1 validation
        await SaveUserSavingsAsync();
        Calculate();
        StateHasChanged();
    }

    private void ToggleRightDebug() { showRightDebug = !showRightDebug; StateHasChanged(); }

    private string FormatMoneySafe(decimal? v) => v.HasValue ? v.Value.ToString("C0") : "-";

    private void OpenWizard(int step)
    {
        wizardOpenStep = step;
        showWizard = true;
    }

    private async Task SaveAndClose()
    {
        await SaveUserSavingsAsync();
        // Optionally, close any open wizards or perform additional actions
        showWizard = false;
    }

    private async Task OnUseTaxAdvantagedChanged(ChangeEventArgs e)
    {
        if (bool.TryParse(e.Value?.ToString(), out bool isChecked))
        {
            calculatorModel.UseTaxAdvantaged = isChecked;
            await SaveUserSavingsAsync();
        }
    }

    private async Task OnTaxableIncomeTypeChanged(ChangeEventArgs e)
    {
        if (Enum.TryParse(typeof(IncomeType), e.Value?.ToString(), out var selectedValue))
        {
            calculatorModel.TaxableIncomeType = (IncomeType)selectedValue;
            await SaveUserSavingsAsync();
        }
    }

    private async Task OnTaxBracketChanged(ChangeEventArgs e)
    {
        if (Enum.TryParse(typeof(TaxBracket), e.Value?.ToString(), out var selectedValue))
        {
            calculatorModel.TaxBracket = (TaxBracket)selectedValue;
            await SaveUserSavingsAsync();
        }
    }
}
