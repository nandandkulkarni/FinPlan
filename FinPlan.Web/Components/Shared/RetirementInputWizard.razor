@using FinPlan.Shared.Models
@using FinPlan.Shared.Models.Spending
@using Microsoft.AspNetCore.Components
@using System.Reflection

<style>
    .wizard-step-bubble {
        width: 38px;
        height: 38px;
        border-radius: 50%;
        background: #6D5DFC; /* accent color used elsewhere */
        color: #fff;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-weight: 800;
        font-size: 1rem;
        box-shadow: 0 4px 12px rgba(109,93,252,0.18);
    }

    .wizard-header-row {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .wizard-step-text {
        color: var(--muted);
        font-size: 0.9rem;
    }

    .small-note {
        font-size: 0.85rem;
        color: var(--muted);
        margin-top: 4px;
    }

    .info-icon {
        font-size: 0.85rem;
        color: #1F6FEB;
        cursor: pointer;
        margin-left: 0.25rem;
        transition: transform 0.2s ease, color 0.2s ease;
    }

        .info-icon:hover {
            transform: scale(1.1);
            color: #0E62DA;
        }

    .info-tooltip {
        background-color: #EBF5FF;
        border: 1px solid #BEDAFF;
        border-radius: 6px;
        padding: 0.5rem 1rem;
        margin-top: 0.25rem;
        margin-bottom: 0.5rem;
        font-size: 0.85rem;
        position: relative;
        line-height: 1.4;
    }
    /* In RetirementInputWizard.razor, find the step badge styling */
    .wizard-step-badge {
        /* Other properties remain the same */
        background: var(--brand-yellow); /* Change from var(--accent) or the hardcoded #6D5DFC to var(--brand-yellow) */
        color: #111;
        /* Other properties remain the same */
    }
</style>

@if (Visible)
{
    <div class="modal-backdrop fade show"></div>
    <div class="modal d-block" tabindex="-1" role="dialog" style="z-index:1055;">
        <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="wizard-header-row">
                        <span class="step-badge">@wizardStep</span>
                        <div>
                            <h5 class="modal-title" style="margin:0;">Retirement Plan Inputs</h5>
                            <div class="wizard-step-text">Step @wizardStep of 6</div>
                        </div>
                    </div>
                    <button type="button" class="btn-close" aria-label="Save & Close" @onclick="CloseClicked"></button>
                </div>
                <div class="modal-body" style="min-height:360px; max-height:520px; overflow:auto;">
                    @if (wizardStep == 1)
                    {
                        <label class="form-label mb-3">Retirement Ages & Life Expectancy</label>
                        <div class="row mb-3">
                            <!-- Your Retirement Card -->
                            <div class="col-md-6 mb-3">
                                <div class="card account-card" style="border-top: 4px solid #2563EB;">
                                    <div class="card-body">
                                        <div class="account-header">
                                            <i class="bi bi-person-check" style="color: #2563EB;"></i>
                                            <h5 class="card-title mb-3">Your Retirement</h5>
                                            <span class="bi bi-info-circle info-icon" @onclick="() => showToolTipRetirementAgeYou = !showToolTipRetirementAgeYou" tabindex="0" title="Click for more info"></span>
                                        </div>
                                        @if (showToolTipRetirementAgeYou)
                                        {
                                            <div class="info-tooltip">
                                                <strong>Your Retirement Age:</strong> The age at which you plan to stop working and begin your retirement. This affects how long your portfolio needs to last and when you'll start drawing from retirement accounts.
                                                <span class="float-end" style="cursor:pointer;" @onclick="() => showToolTipRetirementAgeYou = false" title="Close">
                                                    <span class="bi bi-x-lg"></span>
                                                </span>
                                            </div>
                                        }
                                        <div class="mb-3">
                                            <label class="form-label">Retirement Age</label>
                                            <div class="d-flex align-items-center">
                                                <input class="form-control currency-input me-2" type="number" value="@(Model?.RetirementAgeYou ?? 0)" min="40" max="100" style="border-width: 2px; border-color: #ccc;" @onchange="e => OnInputChanged(nameof(Model.RetirementAgeYou), e.Value!)" />
                                                <span class="fs-6 text-muted">years</span>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Life Expectancy</label>
                                            <div class="d-flex align-items-center">
                                                <input class="form-control currency-input me-2" type="number" value="@LifeExpectancyAgeYou" min="55" max="120" style="border-width: 2px; border-color: #ccc;" 
                                                @onchange="e => OnInputChanged(nameof(Model.LifeExpectancyYou), e.Value!)" />
                                                <span class="fs-6 text-muted">years</span>
                                            </div>
                                        </div>
                                       @*  <div class="retirement-timeline" style="background-color: #f8fafc; border-radius: 8px; padding: 10px; margin-top: 10px;">
                                            <div class="small text-center mb-1">Retirement Timeline</div>
                                            <div class="timeline-bar position-relative" style="height: 10px; background-color: #e2e8f0; border-radius: 5px;">
                                                <div class="working-period" style="position: absolute; left: 0; top: 0; height: 10px; background-color: #2563EB; border-radius: 5px 0 0 5px; width: @(LifeExpectancyAgeYou > Model!.CurrentAgeYou ? (Model!.RetirementAgeYou - Model!.CurrentAgeYou) * 100 / (LifeExpectancyAgeYou - Model!.CurrentAgeYou) : 0)%;">
                                                </div>
                                                <div class="retirement-period" style="position: absolute; left: @(LifeExpectancyAgeYou > Model!.CurrentAgeYou ? (Model!.RetirementAgeYou - Model!.CurrentAgeYou) * 100 / (LifeExpectancyAgeYou - Model!.CurrentAgeYou) : 0)%; top: 0; height: 10px; background-color: #34D399; border-radius: 0 5px 5px 0; width: @(LifeExpectancyAgeYou > Model!.CurrentAgeYou ? (LifeExpectancyAgeYou - Model!.RetirementAgeYou) * 100 / (LifeExpectancyAgeYou - Model!.CurrentAgeYou) : 0)%;">
                                                </div>
                                            </div>
                                            <div class="d-flex justify-content-between mt-1">
                                                <span class="small">@Model!.CurrentAgeYou</span>
                                                <span class="small">@Model!.RetirementAgeYou</span>
                                                <span class="small">@LifeExpectancyAgeYou</span>
                                            </div>
                                            <div class="text-muted small mt-2 text-center">
                                                Approx. @(Model!.RetirementAgeYou - Model!.CurrentAgeYou) years until retirement,
                                                @(LifeExpectancyAgeYou - Model!.RetirementAgeYou) years in retirement
                                            </div>
                                        </div> *@
                                    </div>
                                </div>
                            </div>

                            <!-- Partner Retirement Card -->
                            <div class="col-md-6 mb-3">
                                <div class="card account-card" style="border-top: 4px solid #8B5CF6;">
                                    <div class="card-body">
                                        <div class="account-header">
                                            <i class="bi bi-people" style="color: #8B5CF6;"></i>
                                            <h5 class="card-title mb-3">Partner's Retirement</h5>
                                            <span class="bi bi-info-circle info-icon" @onclick="() => showToolTipRetirementAgePartner = !showToolTipRetirementAgePartner" tabindex="0" title="Click for more info"></span>
                                        </div>
                                        @if (showToolTipRetirementAgePartner)
                                        {
                                            <div class="info-tooltip">
                                                <strong>Partner's Retirement Age:</strong> The age at which your partner plans to retire. Different retirement ages between partners can affect income timing and withdrawal strategies.
                                                <span class="float-end" style="cursor:pointer;" @onclick="() => showToolTipRetirementAgePartner = false" title="Close">
                                                    <span class="bi bi-x-lg"></span>
                                                </span>
                                            </div>
                                        }
                                        <div class="mb-3">
                                            <label class="form-label">Retirement Age</label>
                                            <div class="d-flex align-items-center">
                                                <input class="form-control currency-input me-2" type="number" value="@(Model?.RetirementAgePartner ?? 0)" min="40" max="100" style="border-width: 2px; border-color: #ccc;" @onchange="e => OnInputChanged(nameof(Model.RetirementAgePartner), e.Value!)" />
                                                <span class="fs-6 text-muted">years</span>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Life Expectancy</label>
                                            <div class="d-flex align-items-center">
                                                <input class="form-control currency-input me-2" type="number" value="@LifeExpectancyAgePartner" min="55" max="120" style="border-width: 2px; border-color: #ccc;" @onchange="e => OnInputChanged(nameof(Model.LifeExpectancyPartner), e.Value!)" />
                                                <span class="fs-6 text-muted">years</span>
                                            </div>
                                            <div class="small-note">Leave as 0 if no partner or to use your life expectancy</div>
                                        </div>

                                    @*     <div class="retirement-timeline" style="background-color: #f8fafc; border-radius: 8px; padding: 10px; margin-top: 10px;">
                                            @if (Model!.CurrentAgePartner > 0 && Model!.RetirementAgePartner > Model!.CurrentAgePartner)
                                            {
                                                <div class="small text-center mb-1">Retirement Timeline</div>
                                                <div class="timeline-bar position-relative" style="height: 10px; background-color: #e2e8f0; border-radius: 5px;">
                                                    <div class="working-period" style="position: absolute; left: 0; top: 0; height: 10px; background-color: #8B5CF6; border-radius: 5px 0 0 5px; width: @((Model!.RetirementAgePartner - Model!.CurrentAgePartner) * 100 / (LifeExpectancyAgePartner > 0 ? LifeExpectancyAgePartner - Model!.CurrentAgePartner : LifeExpectancyAgeYou - Model!.CurrentAgePartner))%;"></div>
                                                    <div class="retirement-period" style="position: absolute; left: @((Model!.RetirementAgePartner - Model!.CurrentAgePartner) * 100 / (LifeExpectancyAgePartner > 0 ? LifeExpectancyAgePartner - Model!.CurrentAgePartner : LifeExpectancyAgeYou - Model!.CurrentAgePartner))%; top: 0; height: 10px; background-color: #F472B6; border-radius: 0 5px 5px 0; width: @(100 - ((Model!.RetirementAgePartner - Model!.CurrentAgePartner) * 100 / (LifeExpectancyAgePartner > 0 ? LifeExpectancyAgePartner - Model!.CurrentAgePartner : LifeExpectancyAgeYou - Model!.CurrentAgePartner)))%;"></div>
                                                </div>
                                                <div class="d-flex justify-content-between mt-1">
                                                    <span class="small">@Model!.CurrentAgePartner</span>
                                                    <span class="small">@Model!.RetirementAgePartner</span>
                                                    <span class="small">@(LifeExpectancyAgePartner > 0 ? LifeExpectancyAgePartner : LifeExpectancyAgeYou)</span>
                                                </div>
                                                <div class="text-muted small mt-2 text-center">
                                                    Approx. @(Model!.RetirementAgePartner - Model!.CurrentAgePartner) years until retirement,
                                                    @((LifeExpectancyAgePartner > 0 ? LifeExpectancyAgePartner : LifeExpectancyAgeYou) - Model!.RetirementAgePartner) years in retirement
                                                </div>
                                            }
                                            else
                                            {
                                                <div class="text-muted text-center">
                                                    <i class="bi bi-person-dash"></i> No partner data entered
                                                </div>
                                            } 
                                        </div>*@
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Overlay timeline showing retirement overlap -->
@*                         

 *@                    }
                    else if (wizardStep == 2)
                    {
                        <label class="form-label mb-3">Starting Balances & Expected Returns</label>

                        <!-- Account Balances Section -->
                        <div class="row mb-3">
                            <!-- Taxable Account Card -->
                            <div class="col-md-4 mb-3">
                                <div class="card account-card" style="border-top: 4px solid #4299E1;">
                                    <div class="card-body">
                                        <div class="account-header">
                                            <i class="bi bi-wallet2" style="color: #4299E1;"></i>
                                            <h5 class="card-title mb-3">Taxable Accounts</h5>
                                            <span class="bi bi-info-circle info-icon" @onclick="() => showToolTipTaxableBalance = !showToolTipTaxableBalance" tabindex="0" title="Click for more info"></span>
                                        </div>
                                        @if (showToolTipTaxableBalance)
                                        {
                                            <div class="info-tooltip">
                                                <strong>Taxable Accounts:</strong> Non-retirement investment accounts that are subject to annual taxes on dividends, interest, and capital gains. These provide flexibility but without tax advantages of retirement accounts.
                                                <span class="float-end" style="cursor:pointer;" @onclick="() => showToolTipTaxableBalance = false" title="Close">
                                                    <span class="bi bi-x-lg"></span>
                                                </span>
                                            </div>
                                        }
                                        <div class="input-group mb-2">
                                            <span class="input-group-text">$</span>
                                            <input class="form-control currency-input" type="number" value="@(Model?.TaxableBalance ?? 0m)" step="1000" min="0" style="border-width: 2px; border-color: #ccc;" @onchange="e => OnInputChanged(nameof(Model.TaxableBalance), e.Value!)" />
                                        </div>
                                        <div class="account-footer text-muted">
                                            <small>Subject to annual taxes on earnings</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Traditional Account Card -->
                            <div class="col-md-4 mb-3">
                                <div class="card account-card" style="border-top: 4px solid #48BB78;">
                                    <div class="card-body">
                                        <div class="account-header">
                                            <i class="bi bi-piggy-bank" style="color: #48BB78;"></i>
                                            <h5 class="card-title mb-3">Traditional Accounts</h5>
                                            <span class="bi bi-info-circle info-icon" @onclick="() => showToolTipTraditionalBalance = !showToolTipTraditionalBalance" tabindex="0" title="Click for more info"></span>
                                        </div>
                                        @if (showToolTipTraditionalBalance)
                                        {
                                            <div class="info-tooltip">
                                                <strong>Traditional Accounts:</strong> Tax-deferred retirement accounts like 401(k)s and Traditional IRAs. Contributions were tax-deductible, but withdrawals in retirement are taxed as ordinary income.
                                                <span class="float-end" style="cursor:pointer;" @onclick="() => showToolTipTraditionalBalance = false" title="Close">
                                                    <span class="bi bi-x-lg"></span>
                                                </span>
                                            </div>
                                        }
                                        <div class="input-group mb-2">
                                            <span class="input-group-text">$</span>
                                            <input class="form-control currency-input" type="number" value="@(Model?.TraditionalBalance ?? 0m)" step="1000" min="0" style="border-width: 2px; border-color: #ccc;" @onchange="e => OnInputChanged(nameof(Model.TraditionalBalance), e.Value!)" />
                                        </div>
                                        <div class="account-footer text-muted">
                                            <small>Tax-deferred until withdrawal</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Roth Account Card -->
                            <div class="col-md-4 mb-3">
                                <div class="card account-card" style="border-top: 4px solid #805AD5;">
                                    <div class="card-body">
                                        <div class="account-header">
                                            <i class="bi bi-safe" style="color: #805AD5;"></i>
                                            <h5 class="card-title mb-3">Roth Accounts</h5>
                                            <span class="bi bi-info-circle info-icon" @onclick="() => showToolTipRothBalance = !showToolTipRothBalance" tabindex="0" title="Click for more info"></span>
                                        </div>
                                        @if (showToolTipRothBalance)
                                        {
                                            <div class="info-tooltip">
                                                <strong>Roth Accounts:</strong> Tax-free growth retirement accounts like Roth IRAs and Roth 401(k)s. Contributions were made with after-tax dollars, so qualified withdrawals in retirement are tax-free.
                                                <span class="float-end" style="cursor:pointer;" @onclick="() => showToolTipRothBalance = false" title="Close">
                                                    <span class="bi bi-x-lg"></span>
                                                </span>
                                            </div>
                                        }
                                        <div class="input-group mb-2">
                                            <span class="input-group-text">$</span>
                                            <input class="form-control currency-input" type="number" value="@(Model?.RothBalance ?? 0m)" step="1000" min="0" style="border-width: 2px; border-color: #ccc;" @onchange="e => OnInputChanged(nameof(Model.RothBalance), e.Value!)" />
                                        </div>
                                        <div class="account-footer text-muted">
                                            <small>Tax-free growth and withdrawals</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Portfolio Summary Card -->
                        <div class="card mb-4" style="border-top: 4px solid #FFD700;">
                            <div class="card-body">
                                <div class="d-flex align-items-center mb-3">
                                    <i class="bi bi-pie-chart-fill me-2" style="color: #FFD700; font-size: 1.25rem;"></i>
                                    <h5 class="card-title mb-0">Portfolio Allocation</h5>
                                </div>

                                @{
                                    decimal total = TotalStarting;
                                    decimal taxablePct = total > 0 ? Math.Round((Model!.TaxableBalance / total) * 100, 1) : 0;
                                    decimal traditionalPct = total > 0 ? Math.Round((Model!.TraditionalBalance / total) * 100, 1) : 0;
                                    decimal rothPct = total > 0 ? Math.Round((Model!.RothBalance / total) * 100, 1) : 0;
                                }

                                <div class="d-flex align-items-center justify-content-between mb-3">
                                    <h5 class="mb-0">Total Balance:</h5>
                                    <h4 class="mb-0" style="font-variant-numeric: tabular-nums;">@TotalStarting.ToString("C0")</h4>
                                </div>
                            </div>
                        </div>

                        <!-- Growth Rates Section -->

                    }
else if (wizardStep == 3)
{
    <label class="form-label mb-3">Social Security Benefits</label>

    <div class="row mb-3">
        <!-- Your Claiming Age Card -->
        <div class="col-md-6 mb-3">
            <div class="card" style="border-top: 4px solid #2563EB;">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-2">
                        <i class="bi bi-calendar-check me-2" style="color: #2563EB;"></i>
                        <h6 class="card-title mb-0">Your Claiming Age</h6>
                        <span class="bi bi-info-circle info-icon ms-auto" @onclick="() => showToolTipSSStartAgeYou = !showToolTipSSStartAgeYou" tabindex="0" title="Click for more info"></span>
                    </div>
                    @if (showToolTipSSStartAgeYou)
                    {
                        <div class="info-tooltip">
                            <strong>Your SS Start Age:</strong> The age you plan to claim Social Security. Benefits can start as early as 62 (reduced amount), at full retirement age (66-67) for 100%, or delayed until 70 for maximum benefit.
                            <span class="float-end" style="cursor:pointer;" @onclick="() => showToolTipSSStartAgeYou = false" title="Close">
                                <span class="bi bi-x-lg"></span>
                            </span>
                        </div>
                    }

                    <div class="input-group">
                        <input class="form-control" type="number" value="@(Model!.SSStartAgeYou)" 
                               min="62" max="70" style="border-width: 2px;"
                               @onchange="e => OnInputChanged(nameof(Model.SSStartAgeYou), e.Value!)" />
                        <span class="input-group-text">years</span>
                    </div>
                    <div class="text-muted small mt-1">
                        Age 62: Early (reduced) | 67: Full | 70: Maximum
                    </div>
                </div>
            </div>
        </div>

        <!-- Your Monthly Benefit Card -->
        <div class="col-md-6 mb-3">
            <div class="card" style="border-top: 4px solid #2563EB;">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-2">
                        <i class="bi bi-currency-dollar me-2" style="color: #2563EB;"></i>
                        <h6 class="card-title mb-0">Your Monthly Benefit</h6>
                        <span class="bi bi-info-circle info-icon ms-auto" @onclick="() => showToolTipSocialSecurityYou = !showToolTipSocialSecurityYou" tabindex="0" title="Click for more info"></span>
                    </div>
                    @if (showToolTipSocialSecurityYou)
                    {
                        <div class="info-tooltip">
                            <strong>Your Social Security Benefit:</strong> Your expected monthly Social Security payment. You can estimate this amount from your earnings record at ssa.gov. The average benefit in 2023 is around $1,800/month.
                            <span class="float-end" style="cursor:pointer;" @onclick="() => showToolTipSocialSecurityYou = false" title="Close">
                                <span class="bi bi-x-lg"></span>
                            </span>
                        </div>
                    }
                    <div class="input-group">
                        <span class="input-group-text">$</span>
                        <input class="form-control" type="number" value="@(Model?.SocialSecurityMonthlyYou ?? 0m)"
                               step="100" min="0" style="border-width: 2px;"
                               @onchange="e => OnInputChanged(nameof(Model.SocialSecurityMonthlyYou), e.Value!)" />
                    </div>
                    <div class="text-center text-muted small mt-1">
                        $@((Model!.SocialSecurityMonthlyYou * 12).ToString("N0")) annually
                    </div>
                </div>
            </div>
        </div>

        @if (Model.CurrentAgePartner > 0)
        {
            <!-- Partner Claiming Age Card -->
            <div class="col-md-6 mb-3">
                <div class="card" style="border-top: 4px solid #8B5CF6;">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-2">
                            <i class="bi bi-calendar-check me-2" style="color: #8B5CF6;"></i>
                            <h6 class="card-title mb-0">Partner's Claiming Age</h6>
                            <span class="bi bi-info-circle info-icon ms-auto" @onclick="() => showToolTipSSStartAgePartner = !showToolTipSSStartAgePartner" tabindex="0" title="Click for more info"></span>
                        </div>
                        @if (showToolTipSSStartAgePartner)
                        {
                            <div class="info-tooltip">
                                <strong>Partner's SS Start Age:</strong> The age your partner plans to claim Social Security. Couples often coordinate claiming strategies to maximize lifetime benefits.
                                <span class="float-end" style="cursor:pointer;" @onclick="() => showToolTipSSStartAgePartner = false" title="Close">
                                    <span class="bi bi-x-lg"></span>
                                </span>
                            </div>
                        }

                        <div class="input-group">
                            <input class="form-control" type="number" value="@(Model!.SSStartAgePartner)" 
                                   min="62" max="70" style="border-width: 2px;"
                                   @onchange="e => OnInputChanged(nameof(Model.SSStartAgePartner), e.Value!)" />
                            <span class="input-group-text">years</span>
                        </div>
                        <div class="text-muted small mt-1">
                            Age 62: Early (reduced) | 67: Full | 70: Maximum
                        </div>
                    </div>
                </div>
            </div>

            <!-- Partner Monthly Benefit Card -->
            <div class="col-md-6 mb-3">
                <div class="card" style="border-top: 4px solid #8B5CF6;">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-2">
                            <i class="bi bi-currency-dollar me-2" style="color: #8B5CF6;"></i>
                            <h6 class="card-title mb-0">Partner's Monthly Benefit</h6>
                            <span class="bi bi-info-circle info-icon ms-auto" @onclick="() => showToolTipSocialSecurityPartner = !showToolTipSocialSecurityPartner" tabindex="0" title="Click for more info"></span>
                        </div>
                        @if (showToolTipSocialSecurityPartner)
                        {
                            <div class="info-tooltip">
                                <strong>Partner's Social Security Benefit:</strong> Your partner's expected monthly Social Security payment. If they didn't work enough to qualify, they may still be eligible for spousal benefits.
                                <span class="float-end" style="cursor:pointer;" @onclick="() => showToolTipSocialSecurityPartner = false" title="Close">
                                    <span class="bi bi-x-lg"></span>
                                </span>
                            </div>
                        }
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input class="form-control" type="number" value="@(Model?.SocialSecurityMonthlyPartner ?? 0m)"
                                   step="100" min="0" style="border-width: 2px;"
                                   @onchange="e => OnInputChanged(nameof(Model.SocialSecurityMonthlyPartner), e.Value!)" />
                        </div>
                        <div class="text-center text-muted small mt-1">
                            $@((Model!.SocialSecurityMonthlyPartner * 12).ToString("N0")) annually
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>

    <!-- Summary Card -->
    <div class="card mb-3" style="border-top: 4px solid #059669;">
        <div class="card-body">
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <h6 class="mb-0">
                        <i class="bi bi-calculator me-2" style="color: #059669;"></i>
                        Total Annual Social Security
                    </h6>
                    <div class="text-muted small mt-1">
                        @if (Model.CurrentAgePartner > 0)
                        {
                            <span>Combined for both of you</span>
                        }
                        else
                        {
                            <span>Your annual benefit at age @Model!.SSStartAgeYou</span>
                        }
                    </div>
                </div>
                <div class="text-end">
                    <div class="fs-3 fw-bold" style="color: #059669;">
                        $@(((Model!.SocialSecurityMonthlyYou + Model!.SocialSecurityMonthlyPartner) * 12).ToString("N0"))
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="alert alert-info">
        <i class="bi bi-info-circle-fill me-2"></i>
        <strong>Social Security Claiming Tips:</strong>
        <ul class="mb-0 mt-1">
            <li>Claiming early (age 62) provides reduced benefits but for a longer period</li>
            <li>Waiting until Full Retirement Age (66-67) provides 100% of your earned benefit</li>
            <li>Delaying until 70 increases your benefit by approximately 8% per year past FRA</li>
            <li>For married couples, coordinating your claiming strategies can maximize lifetime benefits</li>
        </ul>
    </div>
}                    else if (wizardStep == 35)
                    {
                        <label class="form-label mb-3">Social Security Benefits</label>

                        <!-- Your Social Security Card -->
                        <div class="card mb-4" style="border-top: 4px solid #2563EB;">
                            <div class="card-body">
                                <div class="d-flex align-items-center mb-3">
                                    <i class="bi bi-person-badge me-2" style="color: #2563EB; font-size: 1.25rem;"></i>
                                    <h5 class="card-title mb-0">Your Social Security</h5>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">
                                                Claiming Age
                                                <span class="bi bi-info-circle info-icon" @onclick="() => showToolTipSSStartAgeYou = !showToolTipSSStartAgeYou" tabindex="0" title="Click for more info"></span>
                                            </label>
                                            @if (showToolTipSSStartAgeYou)
                                            {
                                                <div class="info-tooltip">
                                                    <strong>Your SS Start Age:</strong> The age you plan to claim Social Security. Benefits can start as early as 62 (reduced amount), at full retirement age (66-67 depending on birth year) for 100%, or delayed until 70 for maximum benefit (about 8% increase per year of delay).
                                                    <span class="float-end" style="cursor:pointer;" @onclick="() => showToolTipSSStartAgeYou = false" title="Close">
                                                        <span class="bi bi-x-lg"></span>
                                                    </span>
                                                </div>
                                            }

                                            <div class="d-flex align-items-center">
                                                <input type="range" class="form-range" min="62" max="70" step="1"
                                                       value="@(Model!.SSStartAgeYou)"
                                                       @oninput="(e => Model.SSStartAgeYou = Convert.ToInt32(e.Value))" />
                                            </div>
                                            <div class="d-flex justify-content-between small">
                                                <span class="text-danger">Early: 62</span>
                                                <span class="text-success">Full: 67</span>
                                                <span class="text-primary">Max: 70</span>
                                            </div>
                                            <div class="d-flex justify-content-center">
                                                <div class="badge bg-primary mt-2 fs-6">Selected Age: @Model!.SSStartAgeYou</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">
                                                Monthly Benefit
                                                <span class="bi bi-info-circle info-icon" @onclick="() => showToolTipSocialSecurityYou = !showToolTipSocialSecurityYou" tabindex="0" title="Click for more info"></span>
                                            </label>
                                            @if (showToolTipSocialSecurityYou)
                                            {
                                                <div class="info-tooltip">
                                                    <strong>Your Social Security Benefit:</strong> Your expected monthly Social Security payment. You can estimate this amount from your earnings record at ssa.gov or from annual statements. The average benefit in 2023 is around $1,800 per month.
                                                    <span class="float-end" style="cursor:pointer;" @onclick="() => showToolTipSocialSecurityYou = false" title="Close">
                                                        <span class="bi bi-x-lg"></span>
                                                    </span>
                                                </div>
                                            }
                                            <div class="input-group mb-3">
                                                <span class="input-group-text">$</span>
                                                <input class="form-control currency-input" type="number" value="@(Model?.SocialSecurityMonthlyYou ?? 0m)" step="100" min="0" style="border-width: 2px; border-color: #ccc;" @onchange="e => OnInputChanged(nameof(Model.SocialSecurityMonthlyYou), e.Value!)" />
                                                <span class="input-group-text">/month</span>
                                            </div>
                                            <div class="text-center text-muted small">
                                                Approximately $@((Model!.SocialSecurityMonthlyYou * 12).ToString("N0")) per year
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="p-3 rounded" style="background-color: #f0f9ff;">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <div class="text-muted small">Claiming at age @Model!.SSStartAgeYou</div>
                                            <div>Starting in year @(Model.SimulationStartYear + (Model.SSStartAgeYou - Model.CurrentAgeYou))</div>
                                        </div>
                                        <div class="text-end">
                                            <div class="text-muted small">Total annual Social Security</div>
                                            <div class="fs-4 fw-bold" style="color: #2563EB;">$@((Model.SocialSecurityMonthlyYou * 12).ToString("N0"))</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        @if (Model.CurrentAgePartner >= 0)
                        {
                            <!-- Partner Social Security Card -->
                            <div class="card mb-4" style="border-top: 4px solid #8B5CF6;">
                                <div class="card-body">
                                    <div class="d-flex align-items-center mb-3">
                                        <i class="bi bi-people me-2" style="color: #8B5CF6; font-size: 1.25rem;"></i>
                                        <h5 class="card-title mb-0">Partner's Social Security</h5>
                                    </div>

                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">
                                                    Claiming Age
                                                    <span class="bi bi-info-circle info-icon" @onclick="() => showToolTipSSStartAgePartner = !showToolTipSSStartAgePartner" tabindex="0" title="Click for more info"></span>
                                                </label>
                                                @if (showToolTipSSStartAgePartner)
                                                {
                                                    <div class="info-tooltip">
                                                        <strong>Partner's SS Start Age:</strong> The age your partner plans to claim Social Security. Couples often coordinate claiming strategies to maximize lifetime benefits, especially if there's a significant age or income difference.
                                                        <span class="float-end" style="cursor:pointer;" @onclick="() => showToolTipSSStartAgePartner = false" title="Close">
                                                            <span class="bi bi-x-lg"></span>
                                                        </span>
                                                    </div>
                                                }

                                                <div class="d-flex align-items-center">
                                                    <input type="range" class="form-range" min="62" max="70" step="1"
                                                           value="@(Model!.SSStartAgePartner)"
                                                           @oninput="(e => Model.SSStartAgePartner = Convert.ToInt32(e.Value))" />
                                                </div>
                                                <div class="d-flex justify-content-between small">
                                                    <span class="text-danger">Early: 62</span>
                                                    <span class="text-success">Full: 67</span>
                                                    <span class="text-primary">Max: 70</span>
                                                </div>
                                                <div class="d-flex justify-content-center">
                                                    <div class="badge" style="background-color: #8B5CF6; margin-top: 0.5rem; font-size: 1rem;">Selected Age: @Model!.SSStartAgePartner</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">
                                                    Monthly Benefit
                                                    <span class="bi bi-info-circle info-icon" @onclick="() => showToolTipSocialSecurityPartner = !showToolTipSocialSecurityPartner" tabindex="0" title="Click for more info"></span>
                                                </label>
                                                @if (showToolTipSocialSecurityPartner)
                                                {
                                                    <div class="info-tooltip">
                                                        <strong>Partner's Social Security Benefit:</strong> Your partner's expected monthly Social Security payment. If your partner didn't work enough to qualify, they may still be eligible for spousal benefits (typically 50% of your benefit).
                                                        <span class="float-end" style="cursor:pointer;" @onclick="() => showToolTipSocialSecurityPartner = false" title="Close">
                                                            <span class="bi bi-x-lg"></span>
                                                        </span>
                                                    </div>
                                                }
                                                <div class="input-group mb-3">
                                                    <span class="input-group-text">$</span>
                                                    <input class="form-control currency-input" type="number" value="@(Model?.SocialSecurityMonthlyPartner ?? 0m)" step="100" min="0" style="border-width: 2px; border-color: #ccc;" @onchange="e => OnInputChanged(nameof(Model.SocialSecurityMonthlyPartner), e.Value!)" />
                                                    <span class="input-group-text">/month</span>
                                                </div>
                                                <div class="text-center text-muted small">
                                                    Approximately $@((Model!.SocialSecurityMonthlyPartner * 12).ToString("N0")) per year
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="p-3 rounded" style="background-color: #faf5ff;">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <div class="text-muted small">Claiming at age @Model!.SSStartAgePartner</div>
                                                <div>Starting in year @(Model.SimulationStartYear + (Model.SSStartAgePartner - Model.CurrentAgePartner))</div>
                                            </div>
                                            <div class="text-end">
                                                <div class="text-muted small">Total annual Social Security</div>
                                                <div class="fs-4 fw-bold" style="color: #8B5CF6;">$@((Model.SocialSecurityMonthlyPartner * 12).ToString("N0"))</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Combined Social Security Income -->
                            <div class="card" style="border-top: 4px solid #059669;">
                                <div class="card-body">
                                    <div class="d-flex align-items-center mb-3">
                                        <i class="bi bi-cash-stack me-2" style="color: #059669; font-size: 1.25rem;"></i>
                                        <h5 class="card-title mb-0">Combined Social Security Income</h5>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Your monthly benefit:</span>
                                                <strong>$@Model!.SocialSecurityMonthlyYou.ToString("N0")</strong>
                                            </div>
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Partner's monthly benefit:</span>
                                                <strong>$@Model!.SocialSecurityMonthlyPartner.ToString("N0")</strong>
                                            </div>
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Combined monthly:</span>
                                                <strong>$@((Model.SocialSecurityMonthlyYou + Model.SocialSecurityMonthlyPartner).ToString("N0"))</strong>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="text-center p-3 rounded" style="background-color: #ecfdf5;">
                                                <div class="text-muted">Combined Annual Social Security</div>
                                                <div class="fs-3 fw-bold" style="color: #059669;">$@(((Model!.SocialSecurityMonthlyYou + Model!.SocialSecurityMonthlyPartner) * 12).ToString("N0"))</div>
                                            </div>
                                        </div>
                                    </div>

                                    @{
                                        decimal ssPercentage = TotalStarting > 0 ?
                                        Math.Min(100, Math.Round((((Model.SocialSecurityMonthlyYou + Model.SocialSecurityMonthlyPartner) * 12) / (Model.AnnualWithdrawalBoth > 0 ? Model.AnnualWithdrawalBoth : 50000)) * 100, 1)) : 0;
                                    }

                                    @if (Model!.AnnualWithdrawalBoth > 0)
                                    {
                                        <div class="mt-3">
                                            <div class="d-flex justify-content-between mb-1">
                                                <span class="small">Social Security vs. Total Income Needs</span>
                                                <span class="small">@ssPercentage.ToString("0.0")%</span>
                                            </div>
                                            <div class="progress" style="height: 20px;">
                                                <div class="progress-bar bg-success" role="progressbar" style="width: @ssPercentage%;"
                                                     aria-valuenow="@ssPercentage" aria-valuemin="0" aria-valuemax="100">
                                                    @if (ssPercentage >= 20)
                                                    {
                                                        <span>Social Security</span>
                                                    }
                                                </div>
                                            </div>
                                            <div class="small text-muted mt-1">
                                                Social Security will cover approximately @ssPercentage.ToString("0.0")% of your annual retirement income needs
                                                ($@(((Model.SocialSecurityMonthlyYou + Model.SocialSecurityMonthlyPartner) * 12).ToString("N0")) of $@(Model.AnnualWithdrawalBoth.ToString("N0")))
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                        else
                        {
                            <!-- Single Person Social Security Summary -->
                            <div class="card" style="border-top: 4px solid #059669;">
                                <div class="card-body">
                                    <div class="d-flex align-items-center mb-3">
                                        <i class="bi bi-cash-stack me-2" style="color: #059669; font-size: 1.25rem;"></i>
                                        <h5 class="card-title mb-0">Social Security Summary</h5>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Monthly benefit at age @Model!.SSStartAgeYou:</span>
                                                <strong>$@Model!.SocialSecurityMonthlyYou.ToString("N0")</strong>
                                            </div>
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Annual benefit:</span>
                                                <strong>$@((Model.SocialSecurityMonthlyYou * 12).ToString("N0"))</strong>
                                            </div>
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Starts in year:</span>
                                                <strong>@(Model.SimulationStartYear + (Model.SSStartAgeYou - Model.CurrentAgeYou))</strong>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="text-center p-3 rounded" style="background-color: #ecfdf5;">
                                                <div class="text-muted">Annual Social Security</div>
                                                <div class="fs-3 fw-bold" style="color: #059669;">$@((Model.SocialSecurityMonthlyYou * 12).ToString("N0"))</div>
                                            </div>
                                        </div>
                                    </div>

                                    @{
                                        decimal ssPercentage = Model.AnnualWithdrawalBoth > 0 ?
                                        Math.Min(100, Math.Round(((Model.SocialSecurityMonthlyYou * 12) / Model.AnnualWithdrawalBoth) * 100, 1)) : 0;
                                    }

                                    @if (Model.AnnualWithdrawalBoth > 0)
                                    {
                                        <div class="mt-3">
                                            <div class="d-flex justify-content-between mb-1">
                                                <span class="small">Social Security vs. Total Income Needs</span>
                                                <span class="small">@ssPercentage.ToString("0.0")%</span>
                                            </div>
                                            <div class="progress" style="height: 20px;">
                                                <div class="progress-bar bg-success" role="progressbar" style="width: @ssPercentage%;"
                                                     aria-valuenow="@ssPercentage" aria-valuemin="0" aria-valuemax="100">
                                                    @if (ssPercentage >= 20)
                                                    {
                                                        <span>Social Security</span>
                                                    }
                                                </div>
                                            </div>
                                            <div class="small text-muted mt-1">
                                                Social Security will cover approximately @ssPercentage.ToString("0.0")% of your annual retirement income needs
                                                ($@((Model.SocialSecurityMonthlyYou * 12).ToString("N0")) of $@(Model.AnnualWithdrawalBoth.ToString("N0")))
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>
                        }

                        <div class="alert alert-info mt-3">
                            <i class="bi bi-info-circle-fill me-2"></i>
                            <strong>Social Security Claiming Tips:</strong>
                            <ul class="mb-0 mt-1">
                                <li>Claiming early (age 62) provides reduced benefits but for a longer period</li>
                                <li>Waiting until Full Retirement Age (66-67) provides 100% of your earned benefit</li>
                                <li>Delaying until 70 increases your benefit by approximately 8% per year past FRA</li>
                                <li>For married couples, coordinating your claiming strategies can maximize lifetime benefits</li>
                            </ul>
                        </div>
                    }

                        else if (wizardStep == 4)
                        {
                            <label class="form-label mb-3">Reverse Mortgage</label>

                            <div class="card mb-4" style="border-top: 4px solid #F59E0B;">
                                <div class="card-body">
                                    <div class="d-flex align-items-center mb-3">
                                        <i class="bi bi-house-heart-fill me-2" style="color: #F59E0B; font-size: 1.25rem;"></i>
                                        <h5 class="card-title mb-0">Reverse Mortgage Option</h5>
                                    </div>

                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="rmEnabled"
                                               checked="@ReverseMortgageEnabled"
                                               style="width: 3em; height: 1.5em;"
                                               @onchange="e => OnInputChanged(nameof(Model.ReverseMortgageStartAge), (bool)(e.Value ?? false) ? (object)(Math.Max(62, Model?.CurrentAgeYou ?? 62)) : 0)" />
                                        <label class="form-check-label ms-2 fs-5" for="rmEnabled">Enable reverse mortgage</label>
                                    </div>

                                    <div class="text-muted mb-4">
                                        <i class="bi bi-info-circle me-1"></i>
                                        A reverse mortgage allows homeowners 62+ to convert home equity into monthly income while continuing to live in their home.
                                    </div>

                                    @if (ReverseMortgageEnabled)
                                    {
                                        <div class="row mb-3">
                                            <div class="col-md-6 mb-3">
                                                <div class="card" style="border-top: 4px solid #F59E0B;">
                                                    <div class="card-body">
                                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                                            <label class="form-label mb-0">
                                                                Start Age
                                                                <span class="bi bi-info-circle info-icon" @onclick="() => showToolTipReverseMortgageStartAge = !showToolTipReverseMortgageStartAge" tabindex="0" title="Click for more info"></span>
                                                            </label>
                                                            @if (showToolTipReverseMortgageStartAge)
                                                            {
                                                                <div class="info-tooltip">
                                                                    <strong>Reverse Mortgage Start Age:</strong> The age when you plan to begin receiving payments from a reverse mortgage. This income source allows homeowners 62+ to convert home equity into tax-free income while continuing to live in their home.
                                                                    <span class="float-end" style="cursor:pointer;" @onclick="() => showToolTipReverseMortgageStartAge = false" title="Close">
                                                                        <span class="bi bi-x-lg"></span>
                                                                    </span>
                                                                </div>
                                                            }
                                                        </div>

                                                        <div class="input-group">
                                                            <input class="form-control" type="number" value="@(Model!.ReverseMortgageStartAge)"
                                                                   min="62" max="85" style="border-width: 2px;"
                                                                   @onchange="e => OnInputChanged(nameof(Model.ReverseMortgageStartAge), e.Value!)" />
                                                            <span class="input-group-text">years</span>
                                                        </div>
                                                        <div class="text-muted small mt-1">
                                                            Must be age 62 or older
                                                        </div>

                                                        <div class="mt-3 p-2" style="background-color: #fef3c7; border-radius: 6px;">
                                                            <div class="d-flex align-items-center">
                                                                <i class="bi bi-calendar-event me-2" style="color: #F59E0B;"></i>
                                                                <div>
                                                                    <div class="small text-muted">Start Year</div>
                                                                    <div class="fw-bold">@(Model.SimulationStartYear + (Model.ReverseMortgageStartAge - Model.CurrentAgeYou))</div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="col-md-6 mb-3">
                                                <div class="card" style="border-top: 4px solid #10B981;">
                                                    <div class="card-body">
                                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                                            <label class="form-label mb-0">
                                                                Monthly Income
                                                                <span class="bi bi-info-circle info-icon" @onclick="() => showToolTipReverseMortgageMonthly = !showToolTipReverseMortgageMonthly" tabindex="0" title="Click for more info"></span>
                                                            </label>
                                                            @if (showToolTipReverseMortgageMonthly)
                                                            {
                                                                <div class="info-tooltip">
                                                                    <strong>Monthly Reverse Mortgage Payment:</strong> The estimated monthly income you expect to receive from your reverse mortgage. The amount depends on your home value, interest rates, your age, and the specific payment plan you choose.
                                                                    <span class="float-end" style="cursor:pointer;" @onclick="() => showToolTipReverseMortgageMonthly = false" title="Close">
                                                                        <span class="bi bi-x-lg"></span>
                                                                    </span>
                                                                </div>
                                                            }
                                                        </div>

                                                        <div class="input-group mb-3">
                                                            <span class="input-group-text">$</span>
                                                            <input class="form-control currency-input" type="number" value="@(Model?.ReverseMortgageMonthly ?? 0m)" step="100" min="0" style="border-width: 2px; border-color: #ccc;" @onchange="e => OnInputChanged(nameof(Model.ReverseMortgageMonthly), e.Value!)" />
                                                            <span class="input-group-text">/month</span>
                                                        </div>

                                                        <div class="mt-3 p-2" style="background-color: #d1fae5; border-radius: 6px;">
                                                            <div class="text-center">
                                                                <div class="small text-muted">Annual Income</div>
                                                                <div class="fs-4 fw-bold" style="color: #10B981;">
                                                                    $@((Model!.ReverseMortgageMonthly * 12).ToString("N0"))
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="alert alert-light text-center">
                                            <i class="bi bi-house-slash me-2"></i> Reverse mortgage option is disabled
                                        </div>
                                    }
                                </div>
                            </div>

                            <div class="alert alert-info">
                                <i class="bi bi-info-circle-fill me-2"></i>
                                <strong>About Reverse Mortgages:</strong>
                                <ul class="mb-0 mt-1">
                                    <li>Available to homeowners age 62 and older</li>
                                    <li>Converts home equity into tax-free income while you continue living in your home</li>
                                    <li>No monthly payments required – the loan is repaid when you sell the home, move out, or pass away</li>
                                    <li>Income can be received as a lump sum, monthly payment, or line of credit</li>
                                </ul>
                            </div>
                        }
                        else if (wizardStep == 5)
                        {

                            <label class="form-label mb-3">Withdrawal Strategy</label>

                        <div class="card mb-4" style="border-top: 4px solid #3B82F6;">
                            <div class="card-body">
                                <div class="d-flex align-items-center mb-3">
                                    <i class="bi bi-cash-stack me-2" style="color: #3B82F6; font-size: 1.25rem;"></i>
                                    <h5 class="card-title mb-0">Annual Withdrawal Needs</h5>
                                </div>

                                <div class="row mb-4">
                                    <!-- One Person Retired -->
                                    <div class="col-md-6 mb-3">
                                        <div class="card" style="border-top: 4px solid #4F46E5;">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <h6 class="mb-0">
                                                        One Person Retired
                                                        <span class="bi bi-info-circle info-icon" @onclick="() => showToolTipWithdrawalOne = !showToolTipWithdrawalOne" tabindex="0" title="Click for more info"></span>
                                                    </h6>
                                                </div>
                                                @if (showToolTipWithdrawalOne)
                                                {
                                                    <div class="info-tooltip">
                                                        <strong>Annual Withdrawal (One Retired):</strong> The amount you plan to withdraw annually from your portfolio when only one of you is retired. This is typically less than when both partners are retired since one person is still earning income.
                                                        <span class="float-end" style="cursor:pointer;" @onclick="() => showToolTipWithdrawalOne = false" title="Close">
                                                            <span class="bi bi-x-lg"></span>
                                                        </span>
                                                    </div>
                                                }

                                                <div class="input-group mt-3 mb-3">
                                                    <span class="input-group-text">$</span>
                               <input class="form-control currency-input" type="number"
                                   value="@(Model?.AnnualWithdrawalOne ?? 0m)" @onchange="e => OnInputChanged(nameof(Model.AnnualWithdrawalOne), e.Value!)" step="1000" min="0"
                                   style="border-width: 2px; border-color: #ccc;" />
                                                    <span class="input-group-text">/year</span>
                                                </div>

                                                <div class="text-center text-muted">
                                                    $@((Model!.AnnualWithdrawalOne / 12).ToString("N0")) per month
                                                </div>

                                                <div class="d-flex align-items-center mt-3 p-2" style="background-color: #f0f7ff; border-radius: 6px;">
                                                    <i class="bi bi-person-fill me-2" style="font-size: 1.25rem; color: #4F46E5;"></i>
                                                    <div>
                                                        <div class="small">One person retired, one working</div>
                                                        <div class="small text-muted">
                                                            @if (Model.CurrentAgePartner > 0 && Model.RetirementAgeYou != Model.RetirementAgePartner)
                                                            {
                                                                <span>
                                                                    @(Math.Abs(Model.RetirementAgeYou - Model.RetirementAgePartner)) years with only one person retired
                                                                </span>
                                                            }
                                                            else
                                                            {
                                                                <span>Both will retire simultaneously</span>
                                                            }
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Both Retired -->
                                    <div class="col-md-6 mb-3">
                                        <div class="card" style="border-top: 4px solid #10B981;">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <h6 class="mb-0">
                                                        Both Retired
                                                        <span class="bi bi-info-circle info-icon" @onclick="() => showToolTipWithdrawalBoth = !showToolTipWithdrawalBoth" tabindex="0" title="Click for more info"></span>
                                                    </h6>
                                                </div>
                                                @if (showToolTipWithdrawalBoth)
                                                {
                                                    <div class="info-tooltip">
                                                        <strong>Annual Withdrawal (Both Retired):</strong> The amount you plan to withdraw annually from your portfolio when both of you are retired. This often needs to be higher than when one person is retired since you'll be relying entirely on portfolio income and Social Security.
                                                        <span class="float-end" style="cursor:pointer;" @onclick="() => showToolTipWithdrawalBoth = false" title="Close">
                                                            <span class="bi bi-x-lg"></span>
                                                        </span>
                                                    </div>
                                                }

                                                <div class="input-group mt-3 mb-3">
                                                    <span class="input-group-text">$</span>
                               <input class="form-control currency-input" type="number"
                                   value="@(Model?.AnnualWithdrawalBoth ?? 0m)" @onchange="e => OnInputChanged(nameof(Model.AnnualWithdrawalBoth), e.Value!)" step="1000" min="0"
                                   style="border-width: 2px; border-color: #ccc;" />
                                                    <span class="input-group-text">/year</span>
                                                </div>

                                                <div class="text-center text-muted">
                                                    $@((Model!.AnnualWithdrawalBoth / 12).ToString("N0")) per month
                                                </div>

                                                <div class="d-flex align-items-center mt-3 p-2" style="background-color: #ecfdf5; border-radius: 6px;">
                                                    <i class="bi bi-people-fill me-2" style="font-size: 1.25rem; color: #10B981;"></i>
                                                    <div>
                                                        <div class="small">Full retirement for both</div>
                                                        <div class="small text-muted">
                                                            @if (GetOverlapYears() > 0)
                                                            {
                                                                <span>Approximately @GetOverlapYears() years together in retirement</span>
                                                            }
                                                            else
                                                            {
                                                                <span>No overlap in retirement years</span>
                                                            }
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Income Sources -->
                                <div class="card" style="border: none; background-color: #f8f9fa;">
                                    <div class="card-body">
                                        <h6 class="mb-3">Potential Income Sources in Retirement</h6>

                                        @{
                                            decimal totalAnnualIncome = (Model.SocialSecurityMonthlyYou + Model.SocialSecurityMonthlyPartner) * 12;
                                            totalAnnualIncome += Model.ReverseMortgageMonthly * 12;

                                            decimal ssPercent = Model.AnnualWithdrawalBoth > 0 ?
                                            Math.Min(100, ((Model.SocialSecurityMonthlyYou + Model.SocialSecurityMonthlyPartner) * 12 / Model.AnnualWithdrawalBoth) * 100) : 0;

                                            decimal rmPercent = Model.AnnualWithdrawalBoth > 0 ?
                                            Math.Min(100, (Model.ReverseMortgageMonthly * 12 / Model.AnnualWithdrawalBoth) * 100) : 0;

                                            decimal portPercent = Math.Max(0, 100 - ssPercent - rmPercent);
                                        }

                                        <div class="progress" style="height: 24px; margin-bottom: 1rem;">
                                            <div class="progress-bar bg-primary" role="progressbar" style="width: @ssPercent%;"
                                                 aria-valuenow="@ssPercent" aria-valuemin="0" aria-valuemax="100" title="Social Security">
                                                @if (ssPercent >= 15)
                                                {
                                                    <span>Social Security</span>
                                                }
                                            </div>
                                            @if (Model.ReverseMortgageStartAge > 0 && Model.ReverseMortgageMonthly > 0)
                                            {
                                                <div class="progress-bar bg-warning text-dark" role="progressbar" style="width: @rmPercent%;"
                                                     aria-valuenow="@rmPercent" aria-valuemin="0" aria-valuemax="100" title="Reverse Mortgage">
                                                    @if (rmPercent >= 15)
                                                    {
                                                        <span>RM</span>
                                                    }
                                                </div>
                                            }
                                            <div class="progress-bar bg-success" role="progressbar" style="width: @portPercent%;"
                                                 aria-valuenow="@portPercent" aria-valuemin="0" aria-valuemax="100" title="Portfolio Withdrawals">
                                                @if (portPercent >= 15)
                                                {
                                                    <span>Portfolio</span>
                                                }
                                            </div>
                                        </div>

                                        <div class="row text-center">
                                            <div class="col">
                                                <div class="d-flex align-items-center justify-content-center">
                                                    <div style="width: 12px; height: 12px; background-color: #3B82F6; margin-right: 5px;"></div>
                                                    <span>Social Security: @ssPercent.ToString("0")%</span>
                                                </div>
                                            </div>
                                            @if (Model.ReverseMortgageStartAge > 0 && Model.ReverseMortgageMonthly > 0)
                                            {
                                                <div class="col">
                                                    <div class="d-flex align-items-center justify-content-center">
                                                        <div style="width: 12px; height: 12px; background-color: #F59E0B; margin-right: 5px;"></div>
                                                        <span>Reverse Mortgage: @rmPercent.ToString("0")%</span>
                                                    </div>
                                                </div>
                                            }
                                            <div class="col">
                                                <div class="d-flex align-items-center justify-content-center">
                                                    <div style="width: 12px; height: 12px; background-color: #10B981; margin-right: 5px;"></div>
                                                    <span>Portfolio: @portPercent.ToString("0")%</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-info">
                            <i class="bi bi-lightbulb-fill me-2"></i>
                            <strong>Withdrawal Strategy Tips:</strong>
                            <ul class="mb-0 mt-1">
                                <li>The 4% rule suggests withdrawing 4% of your portfolio in the first year of retirement, then adjusting for inflation in subsequent years</li>
                                <li>With a $1,000,000 portfolio, that would be $40,000 in the first year</li>
                                <li>Consider your tax situation when determining which accounts to withdraw from (taxable, traditional, or Roth)</li>
                                <li>Required Minimum Distributions (RMDs) from traditional accounts begin at age 73</li>
                            </ul>
                        </div>
                    }
                    else if (wizardStep == 6)
                    {
                        <label class="form-label mb-3">Current Ages & Simulation Settings</label>

                        <div class="card mb-4" style="border-top: 4px solid #8B5CF6;">
                            <div class="card-body">
                                <div class="d-flex align-items-center mb-3">
                                    <i class="bi bi-person-vcard me-2" style="color: #8B5CF6; font-size: 1.25rem;"></i>
                                    <h5 class="card-title mb-0">Current Ages</h5>
                                </div>

                                <div class="row mb-4">
                                    <!-- Your Current Age -->
                                    <div class="col-md-6 mb-3">
                                        <div class="card" style="border-top: 4px solid #2563EB;">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-center mb-3">
                                                    <label class="form-label mb-0">
                                                        Your Current Age
                                                        <span class="bi bi-info-circle info-icon" @onclick="() => showToolTipCurrentAgeYou = !showToolTipCurrentAgeYou" tabindex="0" title="Click for more info"></span>
                                                    </label>
                                                    @if (showToolTipCurrentAgeYou)
                                                    {
                                                        <div class="info-tooltip">
                                                            <strong>Your Current Age:</strong> Your age today. This is the starting point for all retirement calculations and determines how many years you have to prepare before retirement.
                                                            <span class="float-end" style="cursor:pointer;" @onclick="() => showToolTipCurrentAgeYou = false" title="Close">
                                                                <span class="bi bi-x-lg"></span>
                                                            </span>
                                                        </div>
                                                    }
                                                </div>

                                                <div class="input-group mb-3">
                                                    <input class="form-control currency-input" type="number" value="@(Model?.CurrentAgeYou ?? 0)" min="18" max="100" style="border-width: 2px; border-color: #ccc;" @onchange="e => OnInputChanged(nameof(Model.CurrentAgeYou), e.Value!)" />
                                                    <span class="input-group-text">years</span>
                                                </div>

                                          @*       <div class="text-center p-2 mt-2" style="background-color: #f0f7ff; border-radius: 6px;">
                                                    <div>Years until retirement:</div>
                                                    <strong class="fs-4 text-primary">@(Model!.RetirementAgeYou - Model!.CurrentAgeYou)</strong>
                                                </div> *@
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Partner's Current Age -->
                                    <div class="col-md-6 mb-3">
                                        <div class="card" style="border-top: 4px solid #8B5CF6;">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-center mb-3">
                                                    <label class="form-label mb-0">
                                                        Partner's Current Age
                                                        <span class="bi bi-info-circle info-icon" @onclick="() => showToolTipCurrentAgePartner = !showToolTipCurrentAgePartner" tabindex="0" title="Click for more info"></span>
                                                    </label>
                                                    @if (showToolTipCurrentAgePartner)
                                                    {
                                                        <div class="info-tooltip">
                                                            <strong>Partner's Current Age:</strong> Your partner's age today. Enter 0 if you're planning for yourself only. This affects joint retirement planning, especially with age differences.
                                                            <span class="float-end" style="cursor:pointer;" @onclick="() => showToolTipCurrentAgePartner = false" title="Close">
                                                                <span class="bi bi-x-lg"></span>
                                                            </span>
                                                        </div>
                                                    }
                                                </div>

                                                <div class="input-group mb-3">
                                                    <input class="form-control currency-input" type="number" value="@(Model?.CurrentAgePartner ?? 0)" min="0" max="100" style="border-width: 2px; border-color: #ccc;" @onchange="e => OnInputChanged(nameof(Model.CurrentAgePartner), e.Value!)" />
                                                    <span class="input-group-text">years</span>
                                                </div>

                                                <div class="small-note">Leave as 0 if no partner</div>

                                                @if (Model!.CurrentAgePartner > 0)
                                                {
                                                    <div class="text-center p-2 mt-2" style="background-color: #faf5ff; border-radius: 6px;">
                                                        <div>Partner's years until retirement:</div>
                                                        <strong class="fs-4" style="color: #8B5CF6;">@(Model.RetirementAgePartner - Model.CurrentAgePartner)</strong>
                                                    </div>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card mb-4" style="border-top: 4px solid #0EA5E9;">
                            <div class="card-body">
                                <div class="d-flex align-items-center mb-3">
                                    <i class="bi bi-calendar3 me-2" style="color: #0EA5E9; font-size: 1.25rem;"></i>
                                    <h5 class="card-title mb-0">Simulation Settings</h5>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="card" style="border-top: 4px solid #0EA5E9;">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-center mb-3">
                                                    <label class="form-label mb-0">
                                                        Projection Start Year
                                                        <span class="bi bi-info-circle info-icon" @onclick="() => showToolTipSimulationStartYear = !showToolTipSimulationStartYear" tabindex="0" title="Click for more info"></span>
                                                    </label>
                                                    @if (showToolTipSimulationStartYear)
                                                    {
                                                        <div class="info-tooltip">
                                                            <strong>Projection Start Year:</strong> The calendar year when this retirement analysis begins (typically the current year). All timeline projections, including retirement dates and Social Security benefits, are calculated from this starting point.
                                                            <span class="float-end" style="cursor:pointer;" @onclick="() => showToolTipSimulationStartYear = false" title="Close">
                                                                <span class="bi bi-x-lg"></span>
                                                            </span>
                                                        </div>
                                                    }
                                                </div>

                                                <div class="input-group mb-3">
                                                    <input class="form-control currency-input"
                                                           type="number"
                                                           value="@(Model!.SimulationStartYear)"
                                                           min="2025" max="2100"
                                                           style="border-width: 2px; border-color: #ccc;"
                                                           @onchange="e => OnInputChanged(nameof(Model.SimulationStartYear), e.Value!)" />
                                                </div>

                                                <div class="small-note">Year to begin the retirement simulation</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                @* <!-- Key Dates Summary -->
                                <div class="mt-4">
                                    <h6 class="mb-3">Key Dates in Your Retirement Journey</h6>
                                    <div class="table-responsive">
                                        <table class="table table-bordered">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Milestone</th>
                                                    <th>Your Age</th>
                                                    <th>Year</th>
                                                    @if (Model.CurrentAgePartner > 0)
                                                    {
                                                        <th>Partner's Age</th>
                                                    }
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td><i class="bi bi-play-circle me-1 text-primary"></i> Simulation Start</td>
                                                    <td>@Model!.CurrentAgeYou</td>
                                                    <td>@Model!.SimulationStartYear</td>
                                                    @if (Model.CurrentAgePartner > 0)
                                                    {
                                                        <td>@Model!.CurrentAgePartner</td>
                                                    }
                                                </tr>
                                                <tr>
                                                    <td><i class="bi bi-person-check me-1 text-success"></i> Your Retirement</td>
                                                    <td>@Model!.RetirementAgeYou</td>
                                                    <td>@(Model.SimulationStartYear + (Model.RetirementAgeYou - Model.CurrentAgeYou))</td>
                                                    @if (Model.CurrentAgePartner > 0)
                                                    {
                                                        <td>@(Model.CurrentAgePartner + (Model.RetirementAgeYou - Model.CurrentAgeYou))</td>
                                                    }
                                                </tr>
                                                @if (Model.CurrentAgePartner > 0)
                                                {
                                                    <tr>
                                                        <td><i class="bi bi-people me-1" style="color: #8B5CF6;"></i> Partner's Retirement</td>
                                                        <td>@(Model.CurrentAgeYou + (Model.RetirementAgePartner - Model.CurrentAgePartner))</td>
                                                        <td>@(Model.SimulationStartYear + (Model.RetirementAgePartner - Model.CurrentAgePartner))</td>
                                                        <td>@Model!.RetirementAgePartner</td>
                                                    </tr>
                                                }
                                                <tr>
                                                    <td><i class="bi bi-piggy-bank me-1 text-primary"></i> Your Social Security</td>
                                                    <td>@Model!.SSStartAgeYou</td>
                                                    <td>@(Model.SimulationStartYear + (Model.SSStartAgeYou - Model.CurrentAgeYou))</td>
                                                    @if (Model.CurrentAgePartner > 0)
                                                    {
                                                        <td>@(Model.CurrentAgePartner + (Model.SSStartAgeYou - Model.CurrentAgeYou))</td>
                                                    }
                                                </tr>
                                                @if (Model.CurrentAgePartner > 0)
                                                {
                                                    <tr>
                                                        <td><i class="bi bi-piggy-bank me-1" style="color: #8B5CF6;"></i> Partner's Social Security</td>
                                                        <td>@(Model.CurrentAgeYou + (Model.SSStartAgePartner - Model.CurrentAgePartner))</td>
                                                        <td>@(Model.SimulationStartYear + (Model.SSStartAgePartner - Model.CurrentAgePartner))</td>
                                                        <td>@Model!.SSStartAgePartner</td>
                                                    </tr>
                                                }
                                                @if (Model.ReverseMortgageStartAge > 0)
                                                {
                                                    <tr>
                                                        <td><i class="bi bi-house-heart me-1 text-warning"></i> Reverse Mortgage</td>
                                                        <td>@Model!.ReverseMortgageStartAge</td>
                                                        <td>@(Model.SimulationStartYear + (Model.ReverseMortgageStartAge - Model.CurrentAgeYou))</td>
                                                        @if (Model.CurrentAgePartner > 0)
                                                        {
                                                            <td>@(Model.CurrentAgePartner + (Model.ReverseMortgageStartAge - Model.CurrentAgeYou))</td>
                                                        }
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                </div> *@
                            </div>
                        </div>

                        <div class="alert alert-success">
                            <i class="bi bi-check-circle-fill me-2"></i>
                            <strong>You're all set!</strong> Click "Save & Finish" below to complete your retirement plan setup.
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" aria-label="Save & Close" @onclick="CloseClicked">Save & Close</button>
                    <button type="button" class="btn btn-primary" @onclick="PrevwizardStep" disabled="@(wizardStep == 1)">Previous</button>
                    <button type="button" class="btn btn-primary" @onclick="NextOrSubmit">@(wizardStep == 6 ? "Save & Finish" : "Save & Next")</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public CalendarSpendingModel? Model { get; set; }

    [Parameter]
    public bool Visible { get; set; }

    [Parameter]
    public EventCallback<bool> VisibleChanged { get; set; }

    [Parameter]
    public EventCallback<(int AgeYou, int AgePartner)> OnFinished { get; set; }

    [Parameter]
    public EventCallback OnSave { get; set; }

    [Parameter]
    public int InitialStep { get; set; } = 1;

    private int wizardStep = 1;
    private bool _wasVisible = false;
    private int _lastInitialStep = 1;

    // Tooltip visibility flags
    private bool showToolTipRetirementAgeYou = false;
    private bool showToolTipRetirementAgePartner = false;
    private bool showToolTipLifeExpectancyYou = false;
    private bool showToolTipLifeExpectancyPartner = false;
    private bool showToolTipTaxableBalance = false;
    private bool showToolTipTraditionalBalance = false;
    private bool showToolTipRothBalance = false;
    private bool showToolTipInvestmentReturn = false;
    private bool showToolTipInflationRate = false;
    private bool showToolTipSocialSecurityYou = false;
    private bool showToolTipSocialSecurityPartner = false;
    private bool showToolTipSSStartAgeYou = false;
    private bool showToolTipSSStartAgePartner = false;
    private bool showToolTipReverseMortgageStartAge = false;
    private bool showToolTipReverseMortgageMonthly = false;
    private bool showToolTipWithdrawalOne = false;
    private bool showToolTipWithdrawalBoth = false;
    private bool showToolTipCurrentAgeYou = false;
    private bool showToolTipCurrentAgePartner = false;
    private bool showToolTipSimulationStartYear = false;

    private decimal TotalStarting => (Model?.TaxableBalance ?? 0) + (Model?.TraditionalBalance ?? 0) + (Model?.RothBalance ?? 0);

    private async Task OnInputChanged(string propertyName, object value)
    {
        if (Model == null) return;

        var prop = Model.GetType().GetProperty(propertyName, BindingFlags.Public | BindingFlags.Instance);
        if (prop != null && prop.CanWrite)
        {
            // Convert value to the correct type
            var targetType = Nullable.GetUnderlyingType(prop.PropertyType) ?? prop.PropertyType;
            var safeValue = Convert.ChangeType(value, targetType);
            prop.SetValue(Model, safeValue);
            TrySyncModel();
            await InvokeOnSaveSafe();
        }
    }
    private int GetOverlapYears()
    {
        if (Model == null || Model.CurrentAgePartner <= 0 || Model.RetirementAgePartner <= 0) return 0;

        int yourRemainingYears = LifeExpectancyAgeYou - Model.RetirementAgeYou;
        int partnerRemainingYears = (LifeExpectancyAgePartner > 0 ? LifeExpectancyAgePartner : LifeExpectancyAgeYou) - Model.RetirementAgePartner;
        int lateRetiree = Math.Max(Model.RetirementAgeYou, Model.RetirementAgePartner);
        int earlyDeceased = Math.Min(LifeExpectancyAgeYou, (LifeExpectancyAgePartner > 0 ? LifeExpectancyAgePartner : LifeExpectancyAgeYou));

        return Math.Max(0, earlyDeceased - lateRetiree);
    }

    private double GetTimelinePercentage(int currentAge, int targetAge)
    {
        int maxAge = Math.Max(
            LifeExpectancyAgeYou,
            LifeExpectancyAgePartner > 0 ? LifeExpectancyAgePartner : LifeExpectancyAgeYou
        );
    int minAge = Math.Min(Model?.CurrentAgeYou ?? 0, (Model?.CurrentAgePartner ?? 0) > 0 ? (Model?.CurrentAgePartner ?? 0) : (Model?.CurrentAgeYou ?? 0));
        double totalSpan = maxAge - minAge;

        return Math.Min(100, Math.Max(0, ((targetAge - minAge) / totalSpan) * 100));
    }


    protected override void OnParametersSet()
    {
        if (Model == null)
        {
            Model = new CalendarSpendingModel();
        }

        if (Visible)
        {
            if (!_wasVisible)
            {
                if (InitialStep >= 1 && InitialStep <= 6)
                {
                    wizardStep = InitialStep;
                }
                _lastInitialStep = InitialStep;
            }
            else if (InitialStep != _lastInitialStep)
            {
                if (InitialStep >= 1 && InitialStep <= 6)
                {
                    wizardStep = InitialStep;
                }
                _lastInitialStep = InitialStep;
            }
        }

        _wasVisible = Visible;
    }

    private async Task PrevwizardStep()
    {
        if (wizardStep > 1)
        {
            TrySyncModel();
            await InvokeOnSaveSafe();
            wizardStep--;
            StateHasChanged();
        }
    }

    private async Task NextOrSubmit()
    {
        if (wizardStep < 6)
        {
            // minimal validation for step 1
            if (wizardStep == 1 && (Model?.RetirementAgeYou ?? 0) <= 0) return;

            TrySyncModel();
            await InvokeOnSaveSafe();

            wizardStep++;
            StateHasChanged();
            return;
        }

        // final step: sync, save, and close
        TrySyncModel();

        if (OnSave.HasDelegate)
        {
            await OnSave.InvokeAsync();
        }
        if (OnFinished.HasDelegate && Model != null)
        {
            await OnFinished.InvokeAsync((Model.RetirementAgeYou, Model.RetirementAgePartner));
        }

        Visible = false;
        await VisibleChanged.InvokeAsync(false);
        wizardStep = 1;
    }

    private async Task CloseClicked()
    {
        TrySyncModel();
        await InvokeOnSaveSafe();

        Visible = false;
        await VisibleChanged.InvokeAsync(false);
        wizardStep = 1;
    }

    private void TrySyncModel()
    {
        try
        {
            Model?.SyncRetirementYearsFromAges();
        }
        catch { }
    }

    private async Task InvokeOnSaveSafe()
    {
        try
        {
            if (OnSave.HasDelegate)
            {
                await OnSave.InvokeAsync();
            }
        }
        catch { }
    }

    // Conversion helpers for life expectancy (age vs year)
    private int LifeExpectancyAgeYou
    {
        get
        {
            if (Model == null) return 100;
            var v = Model.LifeExpectancyYou;
            if (v > 1900)
            {
                var currentAge = Model.CurrentAgeYou > 0 ? Model.CurrentAgeYou : 0;
                return currentAge > 0 ? currentAge + (v - DateTime.Now.Year) : v - DateTime.Now.Year;
            }
            return v;
        }
        set
        {
            if (Model == null) return;
            if (Model.LifeExpectancyYou > 1900)
            {
                var baseAge = Model.CurrentAgeYou > 0 ? Model.CurrentAgeYou : 0;
                Model.LifeExpectancyYou = DateTime.Now.Year + (value - baseAge);
            }
            else
            {
                Model.LifeExpectancyYou = value;
            }
        }
    }

    private int LifeExpectancyAgePartner
    {
        get
        {
            if (Model == null) return 100;
            var v = Model.LifeExpectancyPartner;
            if (v > 1900)
            {
                var currentAge = Model.CurrentAgePartner > 0 ? Model.CurrentAgePartner : 0;
                return currentAge > 0 ? currentAge + (v - DateTime.Now.Year) : v - DateTime.Now.Year;
            }
            return v;
        }
        set
        {
            if (Model == null) return;
            if (Model.LifeExpectancyPartner > 1900)
            {
                var baseAge = Model.CurrentAgePartner > 0 ? Model.CurrentAgePartner : 0;
                Model.LifeExpectancyPartner = DateTime.Now.Year + (value - baseAge);
            }
            else
            {
                Model.LifeExpectancyPartner = value;
            }
        }
    }

    private bool ReverseMortgageEnabled
    {
        get => Model != null && Model.ReverseMortgageStartAge > 0;
        set
        {
            if (Model == null) return;
            if (value)
            {
                if (Model.ReverseMortgageStartAge == 0) Model.ReverseMortgageStartAge = Math.Max(60, Model.CurrentAgeYou);
            }
            else
            {
                Model.ReverseMortgageStartAge = 0;
            }
        }
    }

    private decimal CalculateProjectedAmount(decimal principal, decimal rate, int years)
    {
        return principal * (decimal)Math.Pow((double)(1 + rate / 100), years);
    }

    private decimal CalculateInflationAdjusted(decimal amount, decimal inflationRate, int years)
    {
        return amount * (decimal)Math.Pow((double)(1 + inflationRate / 100), years);
    }
}