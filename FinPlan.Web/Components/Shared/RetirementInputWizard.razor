@using FinPlan.Shared.Models
@using FinPlan.Shared.Models.Spending
@using Microsoft.AspNetCore.Components
@using System.Reflection

<style>
    .wizard-step-bubble {
        width: 38px;
        height: 38px;
        border-radius: 50%;
        background: #6D5DFC; /* accent color used elsewhere */
        color: #fff;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-weight: 800;
        font-size: 1rem;
        box-shadow: 0 4px 12px rgba(109,93,252,0.18);
    }

    .wizard-header-row {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .wizard-step-text {
        color: var(--muted);
        font-size: 0.9rem;
    }
</style>

@if (Visible)
{
    <div class="modal-backdrop fade show"></div>
    <div class="modal d-block" tabindex="-1" role="dialog" style="z-index:1055;">
        <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="wizard-header-row">
                        <div class="wizard-step-bubble">@wizardStep</div>
                        <div>
                            <h5 class="modal-title" style="margin:0;">Quick setup</h5>
                            <div class="wizard-step-text">Step @wizardStep of 6</div>
                        </div>
                    </div>
                    <button type="button" class="btn-close" aria-label="Close" @onclick="CloseClicked"></button>
                </div>
                <div class="modal-body" style="min-height:360px; max-height:520px; overflow:auto;">
                    @if (wizardStep == 1)
                    {
                        <label class="form-label">When do you plan to retire? (age)</label>
                        <div class="row g-2 mt-3">
                            <div class="col-md-6">
                                <label class="form-label">Retirement age (You)</label>
                                <input class="form-control" type="number" @bind="Model.RetirementAgeYou" min="40" max="120" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Retirement age (Partner)</label>
                                <input class="form-control" type="number" @bind="Model.RetirementAgePartner" min="40" max="120" />
                            </div>
                        </div>

                        <div class="row g-2 mt-3">
                            <div class="col-md-6">
                                <label class="form-label">Life expectancy (age, optional)</label>
                                <input class="form-control" type="number" @bind="LifeExpectancyAgeYou" min="55" max="120" />
                                <div class="small-note">Default is computed from model. This controls simulation end age for you.</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Partner life expectancy (age, optional)</label>
                                <input class="form-control" type="number" @bind="LifeExpectancyAgePartner" min="55" max="120" />
                                <div class="small-note">Leave blank (0) to use same life expectancy as you.</div>
                            </div>
                        </div>
                    }
                    else if (wizardStep == 2)
                    {
                        <label class="form-label">Starting Balances & Expected return</label>
                        <div class="row mb-2">
                            <div class="col-md-6">
                                <label class="form-label">Post-Tax Balance ($)</label>
                                <input class="form-control" type="number" @bind="Model.TaxableBalance" step="1000" min="0" />
                            </div>
                        </div>

                        <div class="row mb-2">
                            <div class="col-md-6">
                                <label class="form-label">Traditional Balance ($)</label>
                                <input class="form-control" type="number" @bind="Model.TraditionalBalance" step="1000" min="0" />
                            </div>

                        </div>

                        <div class="row mb-2">
                            <div class="col-md-6">
                                <label class="form-label">Roth Balance ($)</label>
                                <input class="form-control" type="number" @bind="Model.RothBalance" step="1000" min="0" />
                            </div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-md-6">
                                <label class="form-label">Average Expected Return (%)</label>
                                <input class="form-control" type="number" @bind="Model.InvestmentReturn" step="0.1" min="-50" max="50" />
                            </div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-md-6">
                                <label class="form-label">Average Expected Inflation (%)</label>
                                <input class="form-control" type="number" @bind="Model.InflationRate" step="0.1" min="-50" max="50" />
                            </div>
                        </div>
         
                    }
                    else if (wizardStep == 3)
                    {
                        <label class="form-label">Social Security</label>
                        <div class="row">
                            <div class="col-md-6 mb-2">
                                <label class="form-label">SS Start Age (You)</label>
                                <input class="form-control" type="number" @bind="Model.SSStartAgeYou" min="50" max="100" />
                            </div>
                            <div class="col-md-6 mb-2">
                                <label class="form-label">Expected SS monthly (You)</label>
                                <input class="form-control" type="number" @bind="Model.SocialSecurityMonthlyYou" step="100" min="0" />
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-2">
                                <label class="form-label">SS Start Age (Partner)</label>
                                <input class="form-control" type="number" @bind="Model.SSStartAgePartner" min="50" max="100" />
                            </div>
                            <div class="col-md-6 mb-2">
                                <label class="form-label">Expected SS monthly (Partner)</label>
                                <input class="form-control" type="number" @bind="Model.SocialSecurityMonthlyPartner" step="100" min="0" />
                            </div>
                        </div>

                    }
                    else if (wizardStep == 4)
                    {
                        <label class="form-label">Reverse mortgage & withdrawals</label>
                        <div class="mb-2 form-check">
                            <input class="form-check-input" type="checkbox" id="rmEnabled" @bind="ReverseMortgageEnabled" />
                            <label class="form-check-label" for="rmEnabled">Enable reverse mortgage</label>
                            <div class="small-note">If enabled, reverse mortgage income will begin at the age below for the primary person.</div>
                        </div>

                        @if (ReverseMortgageEnabled)
                        {
                            <div class="row mb-2">
                                <div class="col-md-6">
                                    <label class="form-label">Reverse mortgage start age (you)</label>
                                    <input class="form-control" type="number" @bind="Model.ReverseMortgageStartAge" min="60" max="120" />
                                    <div class="small-note">Age when primary person starts receiving reverse mortgage proceeds.</div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Reverse mortgage monthly ($)</label>
                                    <input class="form-control" type="number" @bind="Model.ReverseMortgageMonthly" step="1" min="0" />
                                </div>
                            </div>
                        }
                    }
                    else if (wizardStep == 5)
                    {
                        <div class="row mb-2">
                            <div class="col-md-6">
                                <label class="form-label">Planned Annual Withdrawal: One Retired</label>
                                <input class="form-control" type="number" @bind="Model.AnnualWithdrawalOne" step="1" min="0" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Planned Annual Withdrawal: Both Retired</label>
                                <input class="form-control" type="number" @bind="Model.AnnualWithdrawalBoth" step="1" min="0" />
                            </div>
                        </div>
                    }
                    else if (wizardStep == 6)
                    {

                        <label class="form-label">Current Age / Simulation</label>

                        <div class="row mb-2">
                            <div class="col-md-6">
                                <div class="row g-2">
                                    <div class="col-md-6">
                                        <input class="form-control" type="number" @bind="Model.CurrentAgeYou" min="40" />
                                        <div class="small-note">Your current age.</div>
                                    </div>
                                    <div class="col-md-6">
                                        <input class="form-control" type="number" @bind="Model.CurrentAgePartner" min="0" />
                                        <div class="small-note">Partner current age (optional).</div>
                                    </div>
                                </div>
                                <label class="form-label">Projection start year</label>
                                <input class="form-control" type="number" @bind="Model.SimulationStartYear" />
                                <div class="small-note">Optional — enter start year for the simulation.</div>
                            </div>
                            @* <div class="col-md-6">
                                <label class="form-label">Auto calculate simulation start</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="autoCalc" @bind="Model.AutoCalculate" />
                                    <label class="form-check-label" for="autoCalc">Auto calculate start year</label>
                                </div>
                            </div> *@
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="PrevwizardStep" disabled="@(wizardStep == 1)">Previous</button>
                    <button type="button" class="btn btn-primary" @onclick="NextOrSubmit">@(wizardStep == 6 ? "Finish" : "Next")</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public CalendarSpendingModel? Model { get; set; }

    [Parameter]
    public bool Visible { get; set; }

    [Parameter]
    public EventCallback<bool> VisibleChanged { get; set; }

    [Parameter]
    public EventCallback<(int AgeYou, int AgePartner)> OnFinished { get; set; }

    // New callback to request parent save when stepping between tabs
    [Parameter]
    public EventCallback OnSave { get; set; }

    // Optional: initial step to open the wizard at
    [Parameter]
    public int InitialStep { get; set; } = 1;

    private int wizardStep = 1;
    private bool _wasVisible = false;
    private int _lastInitialStep = 1;

    protected override void OnParametersSet()
    {
        // ensure we have a concrete model to bind to
        if (Model == null)
        {
            Model = new CalendarSpendingModel();
        }

        // Only set wizardStep when the modal becomes visible or when InitialStep changes explicitly.
        if (Visible)
        {
            if (!_wasVisible)
            {
                // modal just opened - initialize to requested initial step
                if (InitialStep >= 1 && InitialStep <= 6)
                {
                    wizardStep = InitialStep;
                }
                _lastInitialStep = InitialStep;
            }
            else if (InitialStep != _lastInitialStep)
            {
                // parent explicitly changed the initial step while modal is open
                if (InitialStep >= 1 && InitialStep <= 6)
                {
                    wizardStep = InitialStep;
                }
                _lastInitialStep = InitialStep;
            }
        }

        _wasVisible = Visible;
    }

    private void PrevwizardStep()
    {
        if (wizardStep > 1) wizardStep--;
        // persist sync after change (model is already updated by bindings)
        TrySyncModel();
        _ = InvokeOnSaveSafe();
    }

    private async Task NextOrSubmit()
    {
        if (wizardStep < 6)
        {
            // minimal validation for step 1
            if (wizardStep == 1 && (Model?.RetirementAgeYou ?? 0) <= 0) return;

            // model already updated through bindings; ensure derived fields synced
            TrySyncModel();

            // Await parent save so callers can run Calculate after save completes
            await InvokeOnSaveSafe();

            wizardStep++;
            StateHasChanged();
            return;
        }

        // final step: ensure model sync and notify parent then close
        TrySyncModel();

        if (OnSave.HasDelegate)
        {
            await OnSave.InvokeAsync();
        }
        if (OnFinished.HasDelegate && Model != null)
        {
            await OnFinished.InvokeAsync((Model.RetirementAgeYou, Model.RetirementAgePartner));
        }

        Visible = false;
        await VisibleChanged.InvokeAsync(false);
        wizardStep = 1;
    }

    private void TrySyncModel()
    {
        try
        {
            Model?.SyncRetirementYearsFromAges();
        }
        catch { }
    }

    private async Task InvokeOnSaveSafe()
    {
        try
        {
            if (OnSave.HasDelegate)
            {
                await OnSave.InvokeAsync();
            }
        }
        catch { }
    }

    // conversion helpers to keep the UX showing "age" for life expectancy while the model stores either an age or a year
    private int LifeExpectancyAgeYou
    {
        get
        {
            if (Model == null) return 100;
            var v = Model.LifeExpectancyYou;
            if (v > 1900)
            {
                var currentAge = Model.CurrentAgeYou > 0 ? Model.CurrentAgeYou : 0;
                return currentAge > 0 ? currentAge + (v - DateTime.Now.Year) : v - DateTime.Now.Year;
            }
            return v;
        }
        set
        {
            if (Model == null) return;
            // if model currently stores a year (>1900) convert age back to year using current age
            if (Model.LifeExpectancyYou > 1900)
            {
                var baseAge = Model.CurrentAgeYou > 0 ? Model.CurrentAgeYou : 0;
                Model.LifeExpectancyYou = DateTime.Now.Year + (value - baseAge);
            }
            else
            {
                Model.LifeExpectancyYou = value;
            }
        }
    }

    private int LifeExpectancyAgePartner
    {
        get
        {
            if (Model == null) return 100;
            var v = Model.LifeExpectancyPartner;
            if (v > 1900)
            {
                var currentAge = Model.CurrentAgePartner > 0 ? Model.CurrentAgePartner : 0;
                return currentAge > 0 ? currentAge + (v - DateTime.Now.Year) : v - DateTime.Now.Year;
            }
            return v;
        }
        set
        {
            if (Model == null) return;
            if (Model.LifeExpectancyPartner > 1900)
            {
                var baseAge = Model.CurrentAgePartner > 0 ? Model.CurrentAgePartner : 0;
                Model.LifeExpectancyPartner = DateTime.Now.Year + (value - baseAge);
            }
            else
            {
                Model.LifeExpectancyPartner = value;
            }
        }
    }

    private bool ReverseMortgageEnabled
    {
        get => Model != null && Model.ReverseMortgageStartAge > 0;
        set
        {
            if (Model == null) return;
            if (value)
            {
                if (Model.ReverseMortgageStartAge == 0) Model.ReverseMortgageStartAge = Math.Max(60, Model.CurrentAgeYou);
            }
            else
            {
                Model.ReverseMortgageStartAge = 0;
            }
        }
    }

    private async Task CloseClicked()
    {
        // simply hide modal without saving
        Visible = false;
        await VisibleChanged.InvokeAsync(false);
        wizardStep = 1;
    }

    private string GetBreakdownText()
    {
        if (Model == null) return "No starting savings entered.";
        var t = Model.TaxableBalance + Model.TraditionalBalance + Model.RothBalance;
        if (t <= 0) return "No starting savings entered.";
        var pt = Model.TaxableBalance / t * 100;
        var tr = Model.TraditionalBalance / t * 100;
        var ro = Model.RothBalance / t * 100;
        return $"Post-Tax {pt:F0}% • Traditional {tr:F0}% • Roth {ro:F0}%";
    }
}