@using FinPlan.Shared.Models
@using Microsoft.AspNetCore.Components
@using System.Reflection

<style>
    .wizard-step-bubble {
        width: 38px;
        height: 38px;
        border-radius: 50%;
        background: #6D5DFC; /* accent color used elsewhere */
        color: #fff;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-weight: 800;
        font-size: 1rem;
        box-shadow: 0 4px 12px rgba(109,93,252,0.18);
    }

    .wizard-header-row {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .wizard-step-text {
        color: var(--muted);
        font-size: 0.9rem;
    }
</style>

@if (Visible)
{
    <div class="modal-backdrop fade show"></div>
    <div class="modal d-block" tabindex="-1" role="dialog" style="z-index:1055;">
        <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="wizard-header-row">
                        <div class="wizard-step-bubble">@wizardStep</div>
                        <div>
                            <h5 class="modal-title" style="margin:0;">Quick setup</h5>
                            <div class="wizard-step-text">Step @wizardStep of 6</div>
                        </div>
                    </div>
                    <button type="button" class="btn-close" aria-label="Close" @onclick="CloseClicked"></button>
                </div>
                <div class="modal-body" style="min-height:360px; max-height:420px; overflow:auto;">
                    @if (wizardStep == 1)
                    {
                        <label class="form-label">When do you plan to retire? (age)</label>
                        <div class="row g-2">
                            <div class="col-md-6">
                                <input class="form-control" type="number" @bind="modalRetirementAgeYou" min="40" max="80" />
                                <div class="small-note">Your planned retirement age.</div>
                            </div>
                            <div class="col-md-6">
                                <input class="form-control" type="number" @bind="modalRetirementAgePartner" min="40" max="80" />
                                <div class="small-note">Partner planned retirement age (optional).</div>
                            </div>
                        </div>

                        <div class="row g-2 mt-3">
                            <div class="col-md-6">
                                <label class="form-label">Life expectancy (age)</label>
                                <input class="form-control" type="number" @bind="modalLifeExpectancyYou" min="55" max="120" />
                                <div class="small-note">Default is 100. This is the age used to stop the simulation for you.</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Partner life expectancy (age, optional)</label>
                                <input class="form-control" type="number" @bind="modalLifeExpectancyPartner" min="55" max="120" />
                                <div class="small-note">Optional — leave blank to use same life expectancy as you.</div>
                            </div>
                        </div>

                        <div class="small-note mt-2">Typical retirement ages: 60–67. Enter the age you expect to stop working.</div>
                    }
                    else if (wizardStep == 2)
                    {
                        <label class="form-label">Starting Balances & expected return</label>
                        <div class="row mb-2">
                            <div class="col-md-6">
                                <label class="form-label">Post-Tax Balance ($)</label>
                                <input class="form-control" type="number" @bind="modalTaxable" step="1" min="0" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Expected Return (%)</label>
                                <input class="form-control" type="number" @bind="modalTaxableReturn" step="0.1" min="-50" max="50" />
                            </div>
                        </div>

                        <div class="row mb-2">
                            <div class="col-md-6">
                                <label class="form-label">Traditional Balance ($)</label>
                                <input class="form-control" type="number" @bind="modalTraditional" step="1" min="0" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Expected Return (%)</label>
                                <input class="form-control" type="number" @bind="modalTraditionalReturn" step="0.1" min="-50" max="50" />
                            </div>
                        </div>

                        <div class="row mb-2">
                            <div class="col-md-6">
                                <label class="form-label">Roth Balance ($)</label>
                                <input class="form-control" type="number" @bind="modalRoth" step="1" min="0" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Expected Return (%)</label>
                                <input class="form-control" type="number" @bind="modalRothReturn" step="0.1" min="-50" max="50" />
                            </div>
                        </div>

                        <div class="mt-3 p-2" style="background:#f8f9fa; border-radius:6px;">
                            <strong>Total starting savings:</strong> @TotalSavings.ToString("C0")
                            <div class="small-note">Breakdown: @GetBreakdownText()</div>
                            <div class="small-note mt-1">Tip: Returns vary by asset mix; enter conservative estimates.</div>
                        </div>
                    }
                    else if (wizardStep == 3)
                    {
                        <label class="form-label">Social Security</label>
                        <div class="row">
                            <div class="col-md-6 mb-2">
                                <label class="form-label">SS Start Age (You) <span title="Age you expect to begin receiving Social Security benefits." style="cursor:help">🛈</span></label>
                                <input class="form-control" type="number" @bind="modalSSStartAgeYou" min="50" max="100" />
                            </div>
                            <div class="col-md-6 mb-2">
                                <label class="form-label">Expected SS monthly (You) <span title="Estimated monthly Social Security benefit for you." style="cursor:help">🛈</span></label>
                                <input class="form-control" type="number" @bind="modalSSMonthlyYou" step="1" min="0" />
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-2">
                                <label class="form-label">SS Start Age (Partner) <span title="Age partner expects to begin receiving Social Security benefits." style="cursor:help">🛈</span></label>
                                <input class="form-control" type="number" @bind="modalSSStartAgePartner" min="50" max="100" />
                            </div>
                            <div class="col-md-6 mb-2">
                                <label class="form-label">Expected SS monthly (Partner) <span title="Estimated monthly Social Security benefit for partner." style="cursor:help">🛈</span></label>
                                <input class="form-control" type="number" @bind="modalSSMonthlyPartner" step="1" min="0" />
                            </div>
                        </div>

                        <div class="mt-3 p-2" style="background:#f8f9fa; border-radius:6px;">
                            <strong>Estimate:</strong>
                            <div class="small-note">Combined SS monthly: @((modalSSMonthlyYou + modalSSMonthlyPartner).ToString("C0")) — consider delaying SS to increase benefit if you can cover expenses from savings.</div>
                        </div>
                    }
                    else if (wizardStep == 4)
                    {
                        <label class="form-label">Reverse mortgage & withdrawals</label>
                        <div class="mb-2 form-check">
                            <input class="form-check-input" type="checkbox" id="rmEnabled" @bind="modalReverseMortgageEnabled" />
                            <label class="form-check-label" for="rmEnabled">Enable reverse mortgage</label>
                            <div class="small-note">If enabled, reverse mortgage income will begin at the age below for the primary person.</div>
                        </div>

                        @if (modalReverseMortgageEnabled)
                        {
                            <div class="row mb-2">
                                <div class="col-md-6">
                                    <label class="form-label">Reverse mortgage start age (you)</label>
                                    <input class="form-control" type="number" @bind="modalReverseMortgageStartAge" min="60" max="120" />
                                    <div class="small-note">Age when primary person starts receiving reverse mortgage proceeds.</div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Reverse mortgage monthly ($)</label>
                                    <input class="form-control" type="number" @bind="modalReverseMortgageMonthly" step="1" min="0" />
                                </div>
                            </div>
                        }
                    }
                    else if (wizardStep == 5)
                    {
                        <div class="row mb-2">
                            <div class="col-md-6">
                                <label class="form-label">Planned Annual Withdrawal: One Retired</label>
                                <input class="form-control" type="number" @bind="modalAnnualWithdrawalOne" step="1" min="0" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Planned Annual Withdrawal: Both Retired</label>
                                <input class="form-control" type="number" @bind="modalAnnualWithdrawalBoth" step="1" min="0" />
                            </div>
                        </div>
                    }
                    else if (wizardStep == 6)
                    {

                        <label class="form-label">Current Age</label>

                        <div class="row mb-2">
                            <div class="col-md-6">
                                <label class="form-label">Your current age (OPTIONAL)</label>
                                <input class="form-control" type="number" @bind="modalAgeYou" min="0" />
                                <div class="small-note">Optional — enter current age to display calendar year in the simulation.</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Partner current age (OPTIONAL)</label>
                                <input class="form-control" type="number" @bind="modalAgePartner" min="0" />
                                <div class="small-note">Optional — enter current age to display calendar year in the simulation.</div>
                            </div>
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="PrevwizardStep" disabled="@(wizardStep == 1)">Previous</button>
                    <button class="btn btn-primary" @onclick="NextOrSubmitAge">@(wizardStep == 6 ? "Finish" : "Next")</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public object? Model { get; set; }

    [Parameter]
    public bool Visible { get; set; }

    [Parameter]
    public EventCallback<bool> VisibleChanged { get; set; }

    [Parameter]
    public EventCallback<(int AgeYou, int AgePartner)> OnFinished { get; set; }

    // New callback to request parent save when stepping between tabs
    [Parameter]
    public EventCallback OnSave { get; set; }

    // Optional: initial step to open the wizard at
    [Parameter]
    public int InitialStep { get; set; } = 1;

    private int wizardStep = 1;
    private int modalRetirementAgeYou = 0;
    private int modalRetirementAgePartner = 0;
    private int modalAgeYou = 0;
    private int modalAgePartner = 0;
    private int modalLifeExpectancyYou = 100;
    private int modalLifeExpectancyPartner = 100;

    // balances
    private decimal modalTaxable = 0m;
    private decimal modalTraditional = 0m;
    private decimal modalRoth = 0m;

    // per-account returns
    private decimal modalTaxableReturn = 5.0m;
    private decimal modalTraditionalReturn = 5.0m;
    private decimal modalRothReturn = 5.0m;

    // social security
    private int modalSSStartAgeYou = 67;
    private int modalSSStartAgePartner = 67;
    private decimal modalSSMonthlyYou = 0m;
    private decimal modalSSMonthlyPartner = 0m;

    // reverse mortgage
    private bool modalReverseMortgageEnabled = false;
    private int modalReverseMortgageStartAge = 0;
    private decimal modalReverseMortgageMonthly = 0m;

    // annual withdrawals
    private decimal modalAnnualWithdrawalOne = 0m;
    private decimal modalAnnualWithdrawalBoth = 0m;

    // assumptions
    private decimal modalInflation = 2.5m;
    private decimal modalTraditionalTaxRate = 22m;
    private string modalWithdrawalStrategy = "InflationAdjusted";
    private string modalPriorityStrategy = "TaxOptimized";

    private decimal TotalSavings => modalTaxable + modalTraditional + modalRoth;

    protected override void OnParametersSet()
    {
        // If modal just became visible, open at InitialStep when provided
        if (Visible && InitialStep >= 1 && InitialStep <= 6)
        {
            wizardStep = InitialStep;
        }

        // If a model was passed and has sensible values, prefill inputs (best-effort)
        if (Model != null)
        {
            try
            {
                var t = Model.GetType();

                // Retirement age prefilling
                var pRetireYou = t.GetProperty("RetirementAgeYou") ?? t.GetProperty("RetirementAge");
                if (pRetireYou != null)
                {
                    var v = pRetireYou.GetValue(Model);
                    if (v is int ri) modalRetirementAgeYou = ri;
                }

                var pRetirePartner = t.GetProperty("RetirementAgePartner") ?? t.GetProperty("RetirementAge2");
                if (pRetirePartner != null)
                {
                    var v = pRetirePartner.GetValue(Model);
                    if (v is int rp) modalRetirementAgePartner = rp;
                }

                var propYou = t.GetProperty("CurrentAgeYou") ?? t.GetProperty("CurrentAge");
                if (propYou != null)
                {
                    var val = propYou.GetValue(Model);
                    if (val is int y && y > 0) modalAgeYou = y;
                }

                var propPartner = t.GetProperty("CurrentAgePartner") ?? t.GetProperty("PartnerCurrentAge");
                if (propPartner != null)
                {
                    var val = propPartner.GetValue(Model);
                    if (val is int p && p > 0) modalAgePartner = p;
                }

                // Prefill life expectancy defaults from model where possible
                var pLife = t.GetProperty("LifeExpectancy");
                if (pLife != null)
                {
                    var v = pLife.GetValue(Model);
                    if (v is int le) modalLifeExpectancyYou = le;
                }

                var pLifeYou = t.GetProperty("LifeExpectancyYou");
                if (pLifeYou != null)
                {
                    var v = pLifeYou.GetValue(Model);
                    if (v is int ly)
                    {
                        // If model stores a year (e.g. 2090), convert to age when possible
                        if (ly > 1900)
                        {
                            var currentAge = modalAgeYou > 0 ? modalAgeYou : 0;
                            modalLifeExpectancyYou = currentAge > 0 ? currentAge + (ly - DateTime.Now.Year) : 100;
                        }
                        else
                        {
                            modalLifeExpectancyYou = ly;
                        }
                    }
                }

                var pLifePartner = t.GetProperty("LifeExpectancyPartner");
                if (pLifePartner != null)
                {
                    var v = pLifePartner.GetValue(Model);
                    if (v is int lp)
                    {
                        if (lp > 1900)
                        {
                            var currentAgeP = modalAgePartner > 0 ? modalAgePartner : 0;
                            modalLifeExpectancyPartner = currentAgeP > 0 ? currentAgeP + (lp - DateTime.Now.Year) : 100;
                        }
                        else
                        {
                            modalLifeExpectancyPartner = lp;
                        }
                    }
                }

                // Try to prefill balances if properties exist
                var pTax = t.GetProperty("TaxableBalance");
                if (pTax != null)
                {
                    var v = pTax.GetValue(Model);
                    if (v is decimal d) modalTaxable = d;
                    else if (v is double db) modalTaxable = (decimal)db;
                    else if (v is int iv) modalTaxable = iv;
                }
                var pTrad = t.GetProperty("TraditionalBalance");
                if (pTrad != null)
                {
                    var v = pTrad.GetValue(Model);
                    if (v is decimal d) modalTraditional = d;
                    else if (v is double db) modalTraditional = (decimal)db;
                    else if (v is int iv) modalTraditional = iv;
                }
                var pRoth = t.GetProperty("RothBalance");
                if (pRoth != null)
                {
                    var v = pRoth.GetValue(Model);
                    if (v is decimal d) modalRoth = d;
                    else if (v is double db) modalRoth = (decimal)db;
                    else if (v is int iv) modalRoth = iv;
                }

                // Try to prefill per-account returns if available
                var pTaxReturn = t.GetProperty("TaxableReturn") ?? t.GetProperty("TaxableExpectedReturn");
                if (pTaxReturn != null)
                {
                    var v = pTaxReturn.GetValue(Model);
                    if (v is decimal d) modalTaxableReturn = d;
                    else if (v is double db) modalTaxableReturn = (decimal)db;
                }
                var pTradReturn = t.GetProperty("TraditionalReturn") ?? t.GetProperty("TraditionalExpectedReturn");
                if (pTradReturn != null)
                {
                    var v = pTradReturn.GetValue(Model);
                    if (v is decimal d) modalTraditionalReturn = d;
                    else if (v is double db) modalTraditionalReturn = (decimal)db;
                }
                var pRothReturn = t.GetProperty("RothReturn") ?? t.GetProperty("RothExpectedReturn");
                if (pRothReturn != null)
                {
                    var v = pRothReturn.GetValue(Model);
                    if (v is decimal d) modalRothReturn = d;
                    else if (v is double db) modalRothReturn = (decimal)db;
                }

                // Social security
                var pSSStartYou = t.GetProperty("SocialSecurityStartAgeYour") ?? t.GetProperty("SSStartAgeYou") ?? t.GetProperty("SSStartAge");
                if (pSSStartYou != null)
                {
                    var v = pSSStartYou.GetValue(Model);
                    if (v is int si) modalSSStartAgeYou = si;
                }
                var pSSStartPartner = t.GetProperty("SocialSecurityStartAgePartner") ?? t.GetProperty("SSStartAgePartner");
                if (pSSStartPartner != null)
                {
                    var v = pSSStartPartner.GetValue(Model);
                    if (v is int sp) modalSSStartAgePartner = sp;
                }
                var pSSMonthlyYou = t.GetProperty("SocialSecurityMonthlyYour") ?? t.GetProperty("SocialSecurityMonthly");
                if (pSSMonthlyYou != null)
                {
                    var v = pSSMonthlyYou.GetValue(Model);
                    if (v is decimal d) modalSSMonthlyYou = d;
                    else if (v is double db) modalSSMonthlyYou = (decimal)db;
                    else if (v is int iv) modalSSMonthlyYou = iv;
                }
                var pSSMonthlyPartner = t.GetProperty("SocialSecurityMonthlyPartner");
                if (pSSMonthlyPartner != null)
                {
                    var v = pSSMonthlyPartner.GetValue(Model);
                    if (v is decimal d) modalSSMonthlyPartner = d;
                    else if (v is double db) modalSSMonthlyPartner = (decimal)db;
                    else if (v is int iv) modalSSMonthlyPartner = iv;
                }

                // Reverse mortgage and withdrawals
                var pReverseAge = t.GetProperty("ReverseMortgageStartAge");
                if (pReverseAge != null)
                {
                    var v = pReverseAge.GetValue(Model);
                    if (v is int ra) modalReverseMortgageStartAge = ra;
                }
                var pReverseMonthly = t.GetProperty("ReverseMortgageMonthly");
                if (pReverseMonthly != null)
                {
                    var v = pReverseMonthly.GetValue(Model);
                    if (v is decimal dm) modalReverseMortgageMonthly = dm;
                    else if (v is double db) modalReverseMortgageMonthly = (decimal)db;
                }
                var pAnnualOne = t.GetProperty("AnnualWithdrawalOne");
                if (pAnnualOne != null)
                {
                    var v = pAnnualOne.GetValue(Model);
                    if (v is decimal a1) modalAnnualWithdrawalOne = a1;
                    else if (v is double db) modalAnnualWithdrawalOne = (decimal)db;
                }
                var pAnnualBoth = t.GetProperty("AnnualWithdrawalBoth");
                if (pAnnualBoth != null)
                {
                    var v = pAnnualBoth.GetValue(Model);
                    if (v is decimal a2) modalAnnualWithdrawalBoth = a2;
                    else if (v is double db) modalAnnualWithdrawalBoth = (decimal)db;
                }

                // assumptions
                var pInfl = t.GetProperty("InflationRate");
                if (pInfl != null)
                {
                    var v = pInfl.GetValue(Model);
                    if (v is decimal d) modalInflation = d;
                    else if (v is double db) modalInflation = (decimal)db;
                }
                var pTaxRate = t.GetProperty("TraditionalTaxRate");
                if (pTaxRate != null)
                {
                    var v = pTaxRate.GetValue(Model);
                    if (v is decimal d) modalTraditionalTaxRate = d;
                    else if (v is double db) modalTraditionalTaxRate = (decimal)db;
                }
                var pStrategy = t.GetProperty("Strategy") ?? t.GetProperty("WithdrawalStrategy");
                if (pStrategy != null)
                {
                    var v = pStrategy.GetValue(Model);
                    if (v != null) modalWithdrawalStrategy = v.ToString() ?? modalWithdrawalStrategy;
                }
                var pPriority = t.GetProperty("PriorityStrategy") ?? t.GetProperty("WithdrawalPriorityStrategy") ?? t.GetProperty("Priority");
                if (pPriority != null)
                {
                    var v = pPriority.GetValue(Model);
                    if (v != null) modalPriorityStrategy = v.ToString() ?? modalPriorityStrategy;
                }
            }
            catch
            {
                // ignore reflection errors
            }
        }
    }

    private void PrevwizardStep()
    {
        if (wizardStep > 1) wizardStep--;
    }

    private async Task NextOrSubmitAge()
    {
        if (wizardStep < 6)
        {
            // validation: ensure retirement age (step 1) is set
            if (wizardStep == 1 && modalRetirementAgeYou <= 0) return;

            // apply interim value for this step to the Model so parent Save will persist it
            ApplyStepToModel(wizardStep);

            // request parent to save this partial data
            if (OnSave.HasDelegate)
            {
                await OnSave.InvokeAsync();
            }

            wizardStep++;
            return;
        }

        // last step finish -> apply data to Model if possible, notify parent ages, then close
        if (Model != null)
        {
            try
            {
                var t = Model.GetType();
                void SetIfExists(string propName, object value)
                {
                    var prop = t.GetProperty(propName, BindingFlags.Public | BindingFlags.Instance);
                    if (prop != null && prop.CanWrite)
                    {
                        try
                        {
                            if (prop.PropertyType.IsEnum)
                            {
                                var enumVal = Enum.Parse(prop.PropertyType, value.ToString() ?? string.Empty);
                                prop.SetValue(Model, enumVal);
                            }
                            else
                            {
                                prop.SetValue(Model, Convert.ChangeType(value, prop.PropertyType));
                            }
                        }
                        catch { }
                    }
                }

                // finalize values
                SetIfExists("RetirementAgeYou", modalRetirementAgeYou);
                SetIfExists("RetirementAgePartner", modalRetirementAgePartner);
                SetIfExists("CurrentAgeYou", modalAgeYou);
                SetIfExists("CurrentAgePartner", modalAgePartner);

                // Life expectancy: write both generic and per-person where supported
                SetIfExists("LifeExpectancy", modalLifeExpectancyYou);

                // if model exposes per-person life expectancy as an age, set that too
                var p = t.GetProperty("LifeExpectancyYou");
                if (p != null && p.CanWrite)
                {
                    try
                    {
                        // if the model stores a year (value > 1900) convert age to year using available current age
                        var existing = p.GetValue(Model);
                        if (existing is int ex && ex > 1900)
                        {
                            var baseAge = modalAgeYou > 0 ? modalAgeYou : (int?)null;
                            var year = DateTime.Now.Year + (modalLifeExpectancyYou - (baseAge ?? modalLifeExpectancyYou));
                            p.SetValue(Model, year);
                        }
                        else
                        {
                            p.SetValue(Model, modalLifeExpectancyYou);
                        }
                    }
                    catch { }
                }

                var pp = t.GetProperty("LifeExpectancyPartner");
                if (pp != null && pp.CanWrite)
                {
                    try
                    {
                        var existing = pp.GetValue(Model);
                        if (existing is int ex && ex > 1900)
                        {
                            var baseAgeP = modalAgePartner > 0 ? modalAgePartner : (int?)null;
                            var year = DateTime.Now.Year + (modalLifeExpectancyPartner - (baseAgeP ?? modalLifeExpectancyPartner));
                            pp.SetValue(Model, year);
                        }
                        else
                        {
                            pp.SetValue(Model, modalLifeExpectancyPartner);
                        }
                    }
                    catch { }
                }

                // Reverse mortgage persistence
                if (modalReverseMortgageEnabled)
                {
                    SetIfExists("ReverseMortgageStartAge", modalReverseMortgageStartAge);
                    SetIfExists("ReverseMortgageMonthly", modalReverseMortgageMonthly);
                }
                else
                {
                    SetIfExists("ReverseMortgageStartAge", 0);
                    SetIfExists("ReverseMortgageMonthly", 0m);
                }

                // Annual withdrawals
                SetIfExists("AnnualWithdrawalOne", modalAnnualWithdrawalOne);
                SetIfExists("AnnualWithdrawalBoth", modalAnnualWithdrawalBoth);

                SetIfExists("TaxableBalance", modalTaxable);
                SetIfExists("TraditionalBalance", modalTraditional);
                SetIfExists("RothBalance", modalRoth);

                // per-account returns if model supports them
                SetIfExists("TaxableReturn", modalTaxableReturn);
                SetIfExists("TraditionalReturn", modalTraditionalReturn);
                SetIfExists("RothReturn", modalRothReturn);

                // set overall InvestmentReturn as weighted average if property exists
                var total = TotalSavings;
                if (total > 0)
                {
                    var overall = (modalTaxable * modalTaxableReturn + modalTraditional * modalTraditionalReturn + modalRoth * modalRothReturn) / total;
                    SetIfExists("InvestmentReturn", overall);
                }

                SetIfExists("SocialSecurityStartAgeYour", modalSSStartAgeYou);
                SetIfExists("SocialSecurityStartAgePartner", modalSSStartAgePartner);
                SetIfExists("SocialSecurityMonthlyYour", modalSSMonthlyYou);
                SetIfExists("SocialSecurityMonthlyPartner", modalSSMonthlyPartner);

                SetIfExists("InflationRate", modalInflation);
                SetIfExists("TraditionalTaxRate", modalTraditionalTaxRate);
                SetIfExists("Strategy", modalWithdrawalStrategy);
                SetIfExists("PriorityStrategy", modalPriorityStrategy);
                SetIfExists("WithdrawalPriorityStrategy", modalPriorityStrategy);

                // Attempt to sync retirement-year helpers if present
                var sync = t.GetMethod("SyncRetirementYearsFromAges", BindingFlags.Public | BindingFlags.Instance);
                try { sync?.Invoke(Model, null); } catch { }
            }
            catch { }
        }

        // request parent save for final step before finishing
        if (OnSave.HasDelegate)
        {
            await OnSave.InvokeAsync();
        }

        if (OnFinished.HasDelegate)
        {
            // send retirement ages for both people
            await OnFinished.InvokeAsync((modalRetirementAgeYou, modalRetirementAgePartner));
        }

        // hide modal
        Visible = false;
        await VisibleChanged.InvokeAsync(false);

        // reset step for next time
        wizardStep = 1;
    }

    private void ApplyStepToModel(int step)
    {
        if (Model == null) return;
        try
        {
            var t = Model.GetType();
            void SetIfExists(string propName, object value)
            {
                var prop = t.GetProperty(propName, BindingFlags.Public | BindingFlags.Instance);
                if (prop != null && prop.CanWrite)
                {
                    try
                    {
                        if (prop.PropertyType.IsEnum)
                        {
                            var enumVal = Enum.Parse(prop.PropertyType, value.ToString() ?? string.Empty);
                            prop.SetValue(Model, enumVal);
                        }
                        else
                        {
                            prop.SetValue(Model, Convert.ChangeType(value, prop.PropertyType));
                        }
                    }
                    catch { }
                }
            }

            if (step == 1)
            {
                SetIfExists("RetirementAgeYou", modalRetirementAgeYou);
                SetIfExists("RetirementAgePartner", modalRetirementAgePartner);

                SetIfExists("LifeExpectancy", modalLifeExpectancyYou);

                var p = t.GetProperty("LifeExpectancyYou");
                if (p != null && p.CanWrite)
                {
                    try
                    {
                        var existing = p.GetValue(Model);
                        if (existing is int ex && ex > 1900)
                        {
                            var baseAge = modalAgeYou > 0 ? modalAgeYou : (int?)null;
                            var year = DateTime.Now.Year + (modalLifeExpectancyYou - (baseAge ?? modalLifeExpectancyYou));
                            p.SetValue(Model, year);
                        }
                        else
                        {
                            p.SetValue(Model, modalLifeExpectancyYou);
                        }
                    }
                    catch { }
                }

                var pp = t.GetProperty("LifeExpectancyPartner");
                if (pp != null && pp.CanWrite)
                {
                    try
                    {
                        var existing = pp.GetValue(Model);
                        if (existing is int ex && ex > 1900)
                        {
                            var baseAgeP = modalAgePartner > 0 ? modalAgePartner : (int?)null;
                            var year = DateTime.Now.Year + (modalLifeExpectancyPartner - (baseAgeP ?? modalLifeExpectancyPartner));
                            pp.SetValue(Model, year);
                        }
                        else
                        {
                            pp.SetValue(Model, modalLifeExpectancyPartner);
                        }
                    }
                    catch { }
                }
            }
            else if (step == 2)
            {
                SetIfExists("CurrentAgePartner", modalAgePartner);
            }
            else if (step == 3)
            {
                SetIfExists("TaxableBalance", modalTaxable);
                SetIfExists("TraditionalBalance", modalTraditional);
                SetIfExists("RothBalance", modalRoth);

                SetIfExists("TaxableReturn", modalTaxableReturn);
                SetIfExists("TraditionalReturn", modalTraditionalReturn);
                SetIfExists("RothReturn", modalRothReturn);

                var total = TotalSavings;
                if (total > 0)
                {
                    var overall = (modalTaxable * modalTaxableReturn + modalTraditional * modalTraditionalReturn + modalRoth * modalRothReturn) / total;
                    SetIfExists("InvestmentReturn", overall);
                }
            }
            else if (step == 4)
            {
                if (modalReverseMortgageEnabled)
                {
                    SetIfExists("ReverseMortgageStartAge", modalReverseMortgageStartAge);
                    SetIfExists("ReverseMortgageMonthly", modalReverseMortgageMonthly);
                }
                else
                {
                    SetIfExists("ReverseMortgageStartAge", 0);
                    SetIfExists("ReverseMortgageMonthly", 0m);
                }

                SetIfExists("AnnualWithdrawalOne", modalAnnualWithdrawalOne);
                SetIfExists("AnnualWithdrawalBoth", modalAnnualWithdrawalBoth);

                SetIfExists("SocialSecurityStartAgeYour", modalSSStartAgeYou);
                SetIfExists("SocialSecurityStartAgePartner", modalSSStartAgePartner);
                SetIfExists("SocialSecurityMonthlyYour", modalSSMonthlyYou);
                SetIfExists("SocialSecurityMonthlyPartner", modalSSMonthlyPartner);
            }
            else if (step == 5)
            {
                SetIfExists("CurrentAgeYou", modalAgeYou);
                SetIfExists("CurrentAgePartner", modalAgePartner);

                SetIfExists("InflationRate", modalInflation);
                SetIfExists("TraditionalTaxRate", modalTraditionalTaxRate);
                SetIfExists("Strategy", modalWithdrawalStrategy);
                SetIfExists("PriorityStrategy", modalPriorityStrategy);
                SetIfExists("WithdrawalPriorityStrategy", modalPriorityStrategy);
            }
        }
        catch { }
    }

    private async Task CloseClicked()
    {
        // simply hide modal without saving
        Visible = false;
        await VisibleChanged.InvokeAsync(false);
        wizardStep = 1;
    }

    private string GetBreakdownText()
    {
        if (TotalSavings <= 0) return "No starting savings entered.";
        var t = TotalSavings;
        var pt = modalTaxable / t * 100;
        var tr = modalTraditional / t * 100;
        var ro = modalRoth / t * 100;
        return $"Post-Tax {pt:F0}% • Traditional {tr:F0}% • Roth {ro:F0}%";
    }
}
