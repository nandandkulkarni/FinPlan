@using Microsoft.AspNetCore.Components
@using System.Collections.Generic
@using FinPlan.Web.Components
@using FinPlan.Shared.Models.Spending
@using FinPlan.Web.Components.Shared
@using Microsoft.AspNetCore.Components.Web

@code {
    private bool showToolTipYear = false;
    private bool showToolTipYourAge = false;
    private bool showToolTipPartnerAge = false;
    private bool showToolTipMilestones = false;
    private bool showToolTipAmountNeeded = false;
    private bool showToolTipAmountWithdrawn = false;
    private bool showToolTipTaxableWithdrawal = false;
    private bool showToolTipTraditionalWithdrawal = false;
    private bool showToolTipRothWithdrawal = false;
    private bool showToolTipSSYou = false;
    private bool showToolTipSSPartner = false;
    private bool showToolTipReverseMortgage = false;
    private bool showToolTipGrowth = false;
    private bool showToolTipTaxableEnding = false;
    private bool showToolTipTraditionalEnding = false;
    private bool showToolTipRothEnding = false;
    private bool showToolTipTaxesPaid = false;
    private bool showToolTipTaxPaid = false;

    [Parameter]
    public CalendarSpendingModel Model { get; set; }
    public List<CalendarYearRow> YearRows => Model?.YearRows ?? new();

    // New parameter to toggle showing column numbers
    public bool IsShowColumnNumber { get; set; } = true;

    // Helper to prefix column labels when enabled
    private string Numbered(int n) => IsShowColumnNumber ? $"{n}. " : string.Empty;
    // Overload to allow fractional labels like "13.5"
    private string Numbered(string label) => IsShowColumnNumber ? $"{label} " : string.Empty;


}
@code {

    // Group definitions using an enum + metadata dictionary (safer than raw strings)
    private enum GroupKey
    {
        Timeline,
        RetirementEquation,
        WithdrawalCOLBreakDown,
        IncomeBreakDown,
        IncomeConsolidated,
        EndingBalances,
        TaxGrowthIncome,
        TaxTraditional
    }

    private record GroupInfo(string Label, bool DefaultVisible = true, int ColSpan = 1, string? Tooltip = null);

    private static Dictionary<GroupKey, GroupInfo> GroupMap = new()
    {
        { GroupKey.Timeline, new GroupInfo("Timeline & Milestones", true, 4) },
        { GroupKey.RetirementEquation, new GroupInfo("Retirement Equation", true, 2, "Cost of Living") },
        { GroupKey.WithdrawalCOLBreakDown, new GroupInfo("Withdrawals for Cost Of Living", true, 3, "Actual withdrawals for Cost of Living") },
        { GroupKey.IncomeBreakDown, new GroupInfo("Income and Growth", true, 4) },
        { GroupKey.IncomeConsolidated, new GroupInfo("Total Inflow", true, 1) },
        { GroupKey.EndingBalances, new GroupInfo("Ending Balances", true, 3) },
        { GroupKey.TaxGrowthIncome, new GroupInfo("Tax (Growth & Income)", true, 4) },
        { GroupKey.TaxTraditional, new GroupInfo("Tax (Traditional A/c withdrawal for Income Tax)", true, 3) }
    };

    // Visible groups set based on GroupMap defaults
    private HashSet<GroupKey> VisibleGroups = new(GroupMap.Where(kv => kv.Value.DefaultVisible).Select(kv => kv.Key));

    // Toggle group visibility (can be bound to a switch)
    void ToggleGroup(GroupKey group)
    {
        if (!VisibleGroups.Add(group))
            VisibleGroups.Remove(group);
    }

    // UI state for the small groups panel and an aria-live announcement
    private bool showGroupPanel = false;
    private string groupAnnouncement = string.Empty;

    // Wrapper that toggles the group and announces the change for screen readers
    void ToggleGroupAndAnnounce(GroupKey group)
    {
        ToggleGroup(group);
        groupAnnouncement = VisibleGroups.Contains(group) ? $"{GroupMap[group].Label} shown" : $"{GroupMap[group].Label} hidden";
    }

    private string GetGroupLabel(GroupKey group) => GroupMap.ContainsKey(group) ? GroupMap[group].Label : group.ToString();
    private string GetGroupLabelMessage(GroupKey group, bool isShown) => isShown ? $"{GetGroupLabel(group)} shown" : $"{GetGroupLabel(group)} hidden";

    const string shown = "shown";

    // Modal state and helper
    private bool showGroupModal = false;
    void CloseGroupModal() => showGroupModal = false;
}

<!-- Groups picker: gear button centered; opens a top-center modal -->
<div class="d-flex justify-content-center mb-2">
    <button class="btn btn-sm btn-outline-secondary" @onclick="() => showGroupModal = true" aria-haspopup="dialog" aria-expanded="@showGroupModal" aria-controls="groupModal">
        <span class="bi bi-gear"></span>
        <span style="margin-left:6px;">Groups</span>
    </button>
</div>

@if (showGroupModal)
{
    <div class="modal-backdrop" @onclick="CloseGroupModal" aria-hidden="true"></div>

    <div id="groupModal" class="group-modal" role="dialog" aria-modal="true" aria-labelledby="groupModalTitle">
        <div class="group-modal-content">
            <div class="group-modal-header">
                <h5 id="groupModalTitle" class="m-0">Columns & Groups</h5>
                <button class="btn btn-sm btn-outline-secondary" aria-label="Close" @onclick="CloseGroupModal"><span class="bi bi-x-lg"></span></button>
            </div>

            <div class="group-modal-body">
                <div class="form-check form-switch" style="display:flex; align-items:center; gap:12px;">
              <input class="form-check-input" type="checkbox" role="switch" id="cbWithdrawal" checked="@VisibleGroups.Contains(GroupKey.WithdrawalCOLBreakDown)"
                  @onchange="(ChangeEventArgs e) => ToggleGroupAndAnnounce(GroupKey.WithdrawalCOLBreakDown)" />
                    <label class="form-check-label" for="cbWithdrawal">Show Withdrawals for Cost Of Living</label>
                </div>
                <div class="form-check form-switch" style="display:flex; align-items:center; gap:12px; margin-top:8px;">
                    <input class="form-check-input" type="checkbox" role="switch" id="cbIncomeBreakDown" checked="@VisibleGroups.Contains(GroupKey.IncomeBreakDown)"
                           @onchange="(ChangeEventArgs e) => ToggleGroupAndAnnounce(GroupKey.IncomeBreakDown)" />
                    <label class="form-check-label" for="cbIncomeBreakDown">Show Income & Growth</label>
                </div>
                <div class="form-check form-switch" style="display:flex; align-items:center; gap:12px; margin-top:8px;">
                    <input class="form-check-input" type="checkbox" role="switch" id="cbEndingBalances" checked="@VisibleGroups.Contains(GroupKey.EndingBalances)"
                           @onchange="(ChangeEventArgs e) => ToggleGroupAndAnnounce(GroupKey.EndingBalances)" />
                    <label class="form-check-label" for="cbEndingBalances">Show Ending Balances</label>
                </div>
            </div>

            <div class="group-modal-footer" style="display:flex; justify-content:flex-end; gap:8px; margin-top:12px;">
                <button class="btn btn-sm btn-primary" @onclick="CloseGroupModal">Done</button>
                <button class="btn btn-sm btn-link" @onclick="() => { VisibleGroups.Remove(GroupKey.WithdrawalCOLBreakDown); groupAnnouncement = GetGroupLabelMessage(GroupKey.WithdrawalCOLBreakDown,false); }">Hide</button>
            </div>
        </div>
    </div>

    <div class="visually-hidden" aria-live="polite">@groupAnnouncement</div>

    <style>
        .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,0.45); z-index:1040; }
        .group-modal { position:fixed; left:50%; top:12%; transform:translateX(-50%); z-index:1050; width:420px; max-width:90%; }
        .group-modal-content { background:#fff; border-radius:8px; padding:12px; box-shadow:0 8px 24px rgba(0,0,0,0.12); border:1px solid rgba(0,0,0,0.06); }
        .group-modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
        .group-modal-body { padding:6px 2px; }
    </style>
}

<div id="table-scrollbar-bottom" style="width:100%; overflow-x:auto;">
    <table aria-label="Yearly grid wireframe">
        <thead class="table-light">
            <!-- Top Row: Groupings with separators -->
            <tr>
                <th colspan="4" style="background-color: #f8f9fa; border-right: 2px solid #d1d5db; text-align: center;">Timeline & Milestones</th>
                <th colspan="2" style="background-color: #f8f9fa; border-right: 2px solid #d1d5db; text-align: center;">
                    Retirement Equation
                    <span style="display:block; font-size:0.72em; color:#6c757d; font-weight:400; margin-top:2px;">Cost of Living </span>

                </th>
                @* Withdrawals for Cost Of Living *@
                @if (VisibleGroups.Contains(GroupKey.WithdrawalCOLBreakDown))
                {

                    <th colspan="3" style="background-color: #f8f9fa; border-right: 2px solid #d1d5db; text-align: center;">
                        Withdrawals for Cost Of Living
                        <span style="display:block; font-size:0.72em; color:#6c757d; font-weight:400; margin-top:2px;">Actual withdrawals for Cost of Living </span>
                    </th>
                }
                @if (VisibleGroups.Contains(GroupKey.IncomeBreakDown))
                {
                    <th colspan="4" class="col-income-sources" style="background-color: rgba(5,150,105,0.08); border-right: 2px solid #d1d5db; text-align: center;">Income and Growth</th>
                }
                    <th colspan="1" class="col-income-sources" style="background-color: rgba(5,150,105,0.08); border-right: 2px solid #d1d5db; text-align: center;">Total Inflow</th>

                @if (VisibleGroups.Contains(GroupKey.EndingBalances))
                {
                    <th colspan="3" class="col-ending-balances" style="background-color: rgba(107,114,128,0.08); text-align: center;">Ending Balances</th>
                }
                <th colspan="1" class="col-ending-balances" style="background-color: rgba(107,114,128,0.08); text-align: center;">Total Ending Balance</th>

                <th colspan="4" class="col-ending-balances" style="background-color: rgba(107,114,128,0.08); text-align: center;">Tax (Growth & Income)</th>

                <th colspan="3" class="col-ending-balances" style="background-color: rgba(107,114,128,0.08); text-align: center;">Tax (Traditional A/c withdrawal for Income Tax)</th>

            </tr>
            <!-- Second Row: Specific Columns with separators and tooltips -->
            <tr>
                <th style="border-right: 2px solid #d1d5db;">
                    <span class="bi bi-info-circle info-icon" @onclick="() => showToolTipYear = !showToolTipYear" tabindex="0" title="Click for more info"></span>
                    @Numbered(1)Year
                    @if (showToolTipYear)
                    {
                        <div class="info-tooltip">
                            <strong>Year:</strong> The calendar year for the projection.
                            <span class="float-end" style="cursor:pointer;" @onclick="() => showToolTipYear = false"><span class="bi bi-x-lg"></span></span>
                        </div>
                    }
                </th>
                <th style="border-right: 2px solid #d1d5db;">
                    <span class="bi bi-info-circle info-icon" @onclick="() => showToolTipYourAge = !showToolTipYourAge" tabindex="0" title="Click for more info"></span>
                    @Numbered(2)Your Age
                    @if (showToolTipYourAge)
                    {
                        <div class="info-tooltip">
                            <strong>Your Age:</strong> Your age during the specified year.
                            <span class="float-end" style="cursor:pointer;" @onclick="() => showToolTipYourAge = false"><span class="bi bi-x-lg"></span></span>
                        </div>
                    }
                </th>
                <th style="border-right: 2px solid #d1d5db;">
                    <span class="bi bi-info-circle info-icon" @onclick="() => showToolTipPartnerAge = !showToolTipPartnerAge" tabindex="0" title="Click for more info"></span>
                    @Numbered(3)Partner Age
                    @if (showToolTipPartnerAge)
                    {
                        <div class="info-tooltip">
                            <strong>Partner Age:</strong> Your partner's age during the specified year.
                            <span class="float-end" style="cursor:pointer;" @onclick="() => showToolTipPartnerAge = false"><span class="bi bi-x-lg"></span></span>
                        </div>
                    }
                </th>
                <th style="border-right: 2px solid #d1d5db;">
                    <span class="bi bi-info-circle info-icon" @onclick="() => showToolTipMilestones = !showToolTipMilestones" tabindex="0" title="Click for more info"></span>
                    @Numbered(4)Milestones
                    @if (showToolTipMilestones)
                    {
                        <div class="info-tooltip">
                            <strong>Milestones:</strong> Key events or goals for the year.
                            <span class="float-end" style="cursor:pointer;" @onclick="() => showToolTipMilestones = false"><span class="bi bi-x-lg"></span></span>
                        </div>
                    }
                </th>
                <th style="border-right: 2px solid #d1d5db;">
                    <span class="bi bi-info-circle info-icon" @onclick="() => showToolTipAmountNeeded = !showToolTipAmountNeeded" tabindex="0" title="Click for more info"></span>
                    @Numbered(5)Amount Needed
                    @if (showToolTipAmountNeeded)
                    {
                        <div class="info-tooltip">
                            <strong>Amount Needed:</strong> The total amount required for the year.
                            <span class="float-end" style="cursor:pointer;" @onclick="() => showToolTipAmountNeeded = false"><span class="bi bi-x-lg"></span></span>
                        </div>
                    }
                </th>
                <th style="border-right: 2px solid #d1d5db;">
                    <span class="bi bi-info-circle info-icon" @onclick="() => showToolTipAmountWithdrawn = !showToolTipAmountWithdrawn" tabindex="0" title="Click for more info"></span>
                    @Numbered(6)Amount Withdrawn
                    <span style="display:block; font-size:0.72em; color:#6c757d; font-weight:400; margin-top:2px;">Excl. Taxes</span>
                    @if (showToolTipAmountWithdrawn)
                    {
                        <div class="info-tooltip">
                            <strong>Amount Withdrawn:</strong> Amount withdrawn for living expenses, excluding taxes.
                            <span class="float-end" style="cursor:pointer;" @onclick="() => showToolTipAmountWithdrawn = false"><span class="bi bi-x-lg"></span></span>
                        </div>
                    }
                </th>
                @* Withdrawals for Cost Of Living *@
                @if (VisibleGroups.Contains(GroupKey.WithdrawalCOLBreakDown))
                {
                    <th style="border-right: 2px solid #d1d5db;">
                        <span class="bi bi-info-circle info-icon" @onclick="() => showToolTipTaxableWithdrawal = !showToolTipTaxableWithdrawal" tabindex="0" title="Click for more info"></span>
                        @Numbered(7)Taxable A/c
                        @if (showToolTipTaxableWithdrawal)
                        {
                            <div class="info-tooltip">
                                <strong>Taxable Withdrawal:</strong> Amount withdrawn from taxable accounts for living expenses.
                                <span class="float-end" style="cursor:pointer;" @onclick="() => showToolTipTaxableWithdrawal = false"><span class="bi bi-x-lg"></span></span>
                            </div>
                        }
                    </th>
                    <th style="border-right: 2px solid #d1d5db;">
                        <span class="bi bi-info-circle info-icon" @onclick="() => showToolTipTraditionalWithdrawal = !showToolTipTraditionalWithdrawal" tabindex="0" title="Click for more info"></span>
                        @Numbered(8)Traditional A/c
                        @if (showToolTipTraditionalWithdrawal)
                        {
                            <div class="info-tooltip">
                                <strong>Traditional Withdrawal:</strong> Amount withdrawn from traditional retirement accounts for living expenses.
                                <span class="float-end" style="cursor:pointer;" @onclick="() => showToolTipTraditionalWithdrawal = false"><span class="bi bi-x-lg"></span></span>
                            </div>
                        }
                    </th>
                    <th style="border-right: 2px solid #d1d5db;">
                        <span class="bi bi-info-circle info-icon" @onclick="() => showToolTipRothWithdrawal = !showToolTipRothWithdrawal" tabindex="0" title="Click for more info"></span>
                        @Numbered(9)Roth A/c
                        @if (showToolTipRothWithdrawal)
                        {
                            <div class="info-tooltip">
                                <strong>Roth Withdrawal:</strong> Amount withdrawn from Roth accounts for living expenses.
                                <span class="float-end" style="cursor:pointer;" @onclick="() => showToolTipRothWithdrawal = false"><span class="bi bi-x-lg"></span></span>
                            </div>
                        }
                    </th>
                }
                @if (VisibleGroups.Contains(GroupKey.IncomeBreakDown))
                {
                    <th style="border-right: 2px solid #d1d5db;">
                        <span class="bi bi-info-circle info-icon" @onclick="() => showToolTipSSYou = !showToolTipSSYou" tabindex="0" title="Click for more info"></span>
                        @Numbered(10)SS (You)
                        @if (showToolTipSSYou)
                        {
                            <div class="info-tooltip">
                                <strong>Social Security (You):</strong> Your annual Social Security benefit.
                                <span class="float-end" style="cursor:pointer;" @onclick="() => showToolTipSSYou = false"><span class="bi bi-x-lg"></span></span>
                            </div>
                        }
                    </th>
                    <th style="border-right: 2px solid #d1d5db;">
                        <span class="bi bi-info-circle info-icon" @onclick="() => showToolTipSSPartner = !showToolTipSSPartner" tabindex="0" title="Click for more info"></span>
                        @Numbered(11)SS (Partner)
                        @if (showToolTipSSPartner)
                        {
                            <div class="info-tooltip">
                                <strong>Social Security (Partner):</strong> Your partner's annual Social Security benefit.
                                <span class="float-end" style="cursor:pointer;" @onclick="() => showToolTipSSPartner = false"><span class="bi bi-x-lg"></span></span>
                            </div>
                        }
                    </th>
                    <th style="border-right: 2px solid #d1d5db;">
                        <span class="bi bi-info-circle info-icon" @onclick="() => showToolTipReverseMortgage = !showToolTipReverseMortgage" tabindex="0" title="Click for more info"></span>
                        @Numbered(12)Rev. Mortgage
                        <span style="display:block; font-size:0.72em; color:#6c757d; font-weight:400; margin-top:2px;">Reverse Mortgage is a Loan</span>

                        @if (showToolTipReverseMortgage)
                        {
                            <div class="info-tooltip">
                                <strong>Reverse Mortgage:</strong> Annual income from reverse mortgage.
                                <span class="float-end" style="cursor:pointer;" @onclick="() => showToolTipReverseMortgage = false"><span class="bi bi-x-lg"></span></span>
                            </div>
                        }
                    </th>
                    <th style="border-right: 2px solid #d1d5db;">
                        <span class="bi bi-info-circle info-icon" @onclick="() => showToolTipGrowth = !showToolTipGrowth" tabindex="0" title="Click for more info"></span>
                        @Numbered(13)Growth
                        <span style="display:block; font-size:0.72em; color:#6c757d; font-weight:400; margin-top:2px;">Prior to taxes</span>
                        @if (showToolTipGrowth)
                        {
                            <div class="info-tooltip">
                                <strong>Growth:</strong> Interest, Dividend & Investment growth for the year.
                                <span class="float-end" style="cursor:pointer;" @onclick="() => showToolTipGrowth = false"><span class="bi bi-x-lg"></span></span>
                            </div>
                        }
                    </th>

                }

                    <th style="border-right: 2px solid #d1d5db;">
                        <span class="bi bi-info-circle info-icon" tabindex="0" title="Click for more info"></span>
                        @Numbered("13.5")Income
                    </th>
                @if (VisibleGroups.Contains(GroupKey.EndingBalances))
                {
                    <th style="border-right: 2px solid #d1d5db;">
                        <span class="bi bi-info-circle info-icon" @onclick="() => showToolTipTaxableEnding = !showToolTipTaxableEnding" tabindex="0" title="Click for more info"></span>
                        @Numbered(14)Taxable A/c
                        @if (showToolTipTaxableEnding)
                        {
                            <div class="info-tooltip">
                                <strong>Taxable Balance:</strong> Year-end balance of taxable accounts.
                                <span class="float-end" style="cursor:pointer;" @onclick="() => showToolTipTaxableEnding = false"><span class="bi bi-x-lg"></span></span>
                            </div>
                        }
                    </th>
                    <th style="border-right: 2px solid #d1d5db;">
                        <span class="bi bi-info-circle info-icon" @onclick="() => showToolTipTraditionalEnding = !showToolTipTraditionalEnding" tabindex="0" title="Click for more info"></span>
                        @Numbered(15)Traditional A/c
                        @if (showToolTipTraditionalEnding)
                        {
                            <div class="info-tooltip">
                                <strong>Traditional Balance:</strong> Year-end balance of traditional retirement accounts.
                                <span class="float-end" style="cursor:pointer;" @onclick="() => showToolTipTraditionalEnding = false"><span class="bi bi-x-lg"></span></span>
                            </div>
                        }
                    </th>

                    <th>
                        <span class="bi bi-info-circle info-icon" @onclick="() => showToolTipRothEnding = !showToolTipRothEnding" tabindex="0" title="Click for more info"></span>
                        @Numbered(16)Roth A/c
                        @if (showToolTipRothEnding)
                        {
                            <div class="info-tooltip">
                                <strong>Roth Balance:</strong> Year-end balance of Roth accounts.
                                <span class="float-end" style="cursor:pointer;" @onclick="() => showToolTipRothEnding = false"><span class="bi bi-x-lg"></span></span>
                            </div>
                        }
                    </th>

         
                }
                <th style="border-right: 2px solid #d1d5db;">
                    <span class="bi bi-info-circle info-icon" tabindex="0" title="Click for more info"></span>
                    @Numbered("16.5")Total Ending Balance
                </th>

                <th style="border-right: 2px solid #d1d5db;">
                    <span class="bi bi-info-circle info-icon" @onclick="() => showToolTipTaxesPaid = !showToolTipTaxesPaid" tabindex="0" title="Click for more info"></span>
                    @Numbered(17)Taxes Due (Growth & Income)
                    @if (showToolTipTaxesPaid)
                    {
                        <div class="info-tooltip">
                            <strong>Taxes Due:</strong> Taxes due on all taxable growth and income.
                            <span class="float-end" style="cursor:pointer;" @onclick="() => showToolTipTaxesPaid = false"><span class="bi bi-x-lg"></span></span>
                        </div>
                    }
                </th>
                <th style="border-right: 2px solid #d1d5db;">
                    <span class="bi bi-info-circle info-icon" @onclick="() => showToolTipTaxableWithdrawal = !showToolTipTaxableWithdrawal" tabindex="0" title="Click for more info"></span>
                    @Numbered(18)Taxable A/c
                    @if (showToolTipTaxableWithdrawal)
                    {
                        <div class="info-tooltip">
                            <strong>Taxable Withdrawal:</strong> Amount withdrawn from taxable accounts for tax payments.
                            <span class="float-end" style="cursor:pointer;" @onclick="() => showToolTipTaxableWithdrawal = false"><span class="bi bi-x-lg"></span></span>
                        </div>
                    }
                </th>
                <th style="border-right: 2px solid #d1d5db;">
                    <span class="bi bi-info-circle info-icon" @onclick="() => showToolTipTraditionalWithdrawal = !showToolTipTraditionalWithdrawal" tabindex="0" title="Click for more info"></span>
                    @Numbered(19)Traditional A/c
                    @if (showToolTipTraditionalWithdrawal)
                    {
                        <div class="info-tooltip">
                            <strong>Traditional Withdrawal:</strong> Amount withdrawn from traditional retirement accounts for tax payments.
                            <span class="float-end" style="cursor:pointer;" @onclick="() => showToolTipTraditionalWithdrawal = false"><span class="bi bi-x-lg"></span></span>
                        </div>
                    }
                </th>
                <th style="border-right: 2px solid #d1d5db;">
                    <span class="bi bi-info-circle info-icon" @onclick="() => showToolTipRothWithdrawal = !showToolTipRothWithdrawal" tabindex="0" title="Click for more info"></span>
                    @Numbered(20)Roth A/c
                    @if (showToolTipRothWithdrawal)
                    {
                        <div class="info-tooltip">
                            <strong>Roth Withdrawal:</strong> Amount withdrawn from Roth accounts for tax payments.
                            <span class="float-end" style="cursor:pointer;" @onclick="() => showToolTipRothWithdrawal = false"><span class="bi bi-x-lg"></span></span>
                        </div>
                    }
                </th>
                <th style="border-right: 2px solid #d1d5db;">
                    <span class="bi bi-info-circle info-icon" @onclick="() => showToolTipTaxPaid = !showToolTipTaxPaid" tabindex="0" title="Click for more info"></span>
                    @Numbered(21)Tax Due
                    @if (showToolTipTaxPaid)
                    {
                        <div class="info-tooltip">
                            <strong>Tax Due:</strong> Tax due to traditional withdrawals for tax on traditional.
                            <span class="float-end" style="cursor:pointer;" @onclick="() => showToolTipTaxPaid = false"><span class="bi bi-x-lg"></span></span>
                        </div>
                    }
                </th>
                <th style="border-right: 2px solid #d1d5db;">
                    <span class="bi bi-info-circle info-icon" @onclick="() => showToolTipTaxPaid = !showToolTipTaxPaid" tabindex="0" title="Click for more info"></span>
                    @Numbered(22)Tax Paid (Traditional A/c)
                    @if (showToolTipTaxPaid)
                    {
                        <div class="info-tooltip">
                            <strong>Traditional Withdrawal:</strong> Traditional withdrawn for tax on traditional.
                            <span class="float-end" style="cursor:pointer;" @onclick="() => showToolTipTaxPaid = false"><span class="bi bi-x-lg"></span></span>
                        </div>
                    }
                </th>
                <th style="border-right: 2px solid #d1d5db;">
                    <span class="bi bi-info-circle info-icon" @onclick="() => showToolTipTaxPaid = !showToolTipTaxPaid" tabindex="0" title="Click for more info"></span>
                    @Numbered(23)Tax Paid (Roth A/c)
                    @if (showToolTipTaxPaid)
                    {
                        <div class="info-tooltip">
                            <strong>Roth Withdrawal:</strong> Roth withdrawn for tax on traditional.
                            <span class="float-end" style="cursor:pointer;" @onclick="() => showToolTipTaxPaid = false"><span class="bi bi-x-lg"></span></span>
                        </div>
                    }
                </th>

            </tr>
        </thead>
        <tbody>
            @foreach (var row in YearRows)
            {
                var rowClass = string.IsNullOrEmpty(row.Notes) ? string.Empty : "depleted";
                <tr class="@rowClass">
                    <td class="col-year" style="background-color: #f8f9fa; border-right: 2px solid #d1d5db;">@row.Year</td>
                    <td class="col-age" style="background-color: #f8f9fa; border-right: 2px solid #d1d5db;">@row.AgeYou</td>
                    <td class="col-age" style="background-color: #f8f9fa; border-right: 2px solid #d1d5db;">@row.AgePartner</td>
                    <td class="col-milestones" style="background-color: #f8f9fa; border-right: 2px solid #d1d5db; width: 100px; overflow-x: auto; white-space: nowrap;">@row.Milestone</td>

                    <td class="text-end" style="font-size:0.78rem; background-color: #f8f9fa; font-weight:600; text-align: right; font-variant-numeric: tabular-nums; border-right: 2px solid #d1d5db; color: #2563EB;">
                        @row.AmountNeededForCostOfLiving.ToString("C0")
                    </td>
                    <td class="text-end" style="font-size:0.78rem; background-color: #f8f9fa; font-weight:600; text-align: right; font-variant-numeric: tabular-nums; border-right: 2px solid #d1d5db; color: #2563EB;">
                        @row.TotalWithdrawForCostOfLivingExcludingTaxes.ToString("C0")
                    </td>

                    @* Withdrawals for Cost Of Living *@
                    @if (VisibleGroups.Contains(GroupKey.WithdrawalCOLBreakDown))
                    {

                        <td class="text-end col-account-activity" style="font-size:0.78rem; background-color: rgba(37, 99, 235, 0.08); font-weight:600; text-align: right; font-variant-numeric: tabular-nums;">
                            @row.TaxableWithdrawnForCostOfLivingIfAtAll.ToString("C0")
                        </td>

                        <td class="text-end col-account-activity" style="font-size:0.78rem; background-color: rgba(37, 99, 235, 0.08); font-weight:600; text-align: right; font-variant-numeric: tabular-nums;">
                            @row.TradWithdrawnForCostOfLivingIfAtAll.ToString("C0")
                        </td>
                        <td class="text-end col-account-activity" style="font-size:0.78rem; background-color: rgba(37, 99, 235, 0.08); font-weight:600; text-align: right; font-variant-numeric: tabular-nums; border-right: 2px solid #d1d5db;">
                            @row.RothWithdrawnForCostOfLivingIfAtAll.ToString("C0")
                        </td>
                    }


                    @if (VisibleGroups.Contains(GroupKey.IncomeBreakDown))
                    {
                        <td class="text-end col-income-sources" style="font-size:0.78rem; background-color: rgba(5, 150, 105, 0.08); font-weight:600; text-align: right; font-variant-numeric: tabular-nums;">
                            @row.SSYou.ToString("C0")
                        </td>
                        <td class="text-end col-income-sources" style="font-size:0.78rem; background-color: rgba(5, 150, 105, 0.08); font-weight:600; text-align: right; font-variant-numeric: tabular-nums;">
                            @row.SSPartner.ToString("C0")
                        </td>
                        <td class="text-end col-income-sources" style="font-size:0.78rem; background-color: rgba(5, 150, 105, 0.08); font-weight:600; text-align: right; font-variant-numeric: tabular-nums; border-right: 2px solid #d1d5db;">
                            @row.ReverseMortgage.ToString("C0")
                        </td>
                        <td class="text-end col-income-sources" style="font-size:0.78rem; background-color: rgba(5, 150, 105, 0.08); font-weight:600; text-align: right; font-variant-numeric: tabular-nums; border-right: 2px solid #d1d5db;">
                            @row.GrowthBeforeTaxes.ToString("C0")
                        </td>
                        <td class="text-end col-income-sources" style="font-size:0.78rem; background-color: rgba(5, 150, 105, 0.08); font-weight:600; text-align: right; font-variant-numeric: tabular-nums; border-right: 2px solid #d1d5db;">
                            @( (row.SSYou + row.SSPartner + row.ReverseMortgage + row.GrowthBeforeTaxes).ToString("C0") )
                        </td>
                    }



                    @if (VisibleGroups.Contains(GroupKey.EndingBalances))
                    {
                        <td class="text-end col-ending-balances" style="font-size:0.78rem; background-color: rgba(107, 114, 128, 0.08); font-weight:600; text-align: right; font-variant-numeric: tabular-nums;">
                            @row.EndingTaxable.ToString("C0")
                        </td>
                        <td class="text-end col-ending-balances" style="font-size:0.78rem; background-color: rgba(107, 114, 128, 0.08); font-weight:600; text-align: right; font-variant-numeric: tabular-nums;">
                            @row.EndingTraditional.ToString("C0")
                        </td>
                        <td class="text-end col-ending-balances" style="font-size:0.78rem; background-color: rgba(107, 114, 128, 0.08); font-weight:600; text-align: right; font-variant-numeric: tabular-nums;">
                            @row.EndingRoth.ToString("C0")
                        </td>

                        <td class="text-end col-ending-balances" style="font-size:0.78rem; background-color: rgba(107, 114, 128, 0.08); font-weight:600; text-align: right; font-variant-numeric: tabular-nums; border-right: 2px solid #d1d5db;">
                            @( (row.EndingTaxable + row.EndingTraditional + row.EndingRoth).ToString("C0") )
                        </td>
                    }




                    <td class="text-end col-account-activity" style="font-size:0.78rem; background-color: rgba(37, 99, 235, 0.08); font-weight:600; text-align: right; font-variant-numeric: tabular-nums; color: #F56565;">
                        @row.TaxesDueOnAllTaxableGrowthAndIncome.ToString("C0")
                    </td>

                    <td class="text-end col-account-activity" style="font-size:0.78rem; background-color: rgba(37, 99, 235, 0.08); font-weight:600; text-align: right; font-variant-numeric: tabular-nums;">
                        @row.TaxableWithdrawForInitialAndProbablyOnlyTaxPaymenOnTaxableIncome.ToString("C0")
                    </td>
                    <td class="text-end col-account-activity" style="font-size:0.78rem; background-color: rgba(37, 99, 235, 0.08); font-weight:600; text-align: right; font-variant-numeric: tabular-nums;">
                        @row.TraditionalWithdrawForInitialTaxPaymentOnTaxableIncome.ToString("C0")
                    </td>
                    <td class="text-end col-account-activity" style="font-size:0.78rem; background-color: rgba(37, 99, 235, 0.08); font-weight:600; text-align: right; font-variant-numeric: tabular-nums;">
                        @row.RothWithdrawForInitialTaxPaymentOnTaxableIncome.ToString("C0")
                    </td>


                    <td class="text-end col-account-activity" style="font-size:0.78rem; background-color: rgba(37, 99, 235, 0.08); font-weight:600; text-align: right; font-variant-numeric: tabular-nums;">
                        @row.TaxDueDueToTraditionalWithdrawnForTaxOnTraditional.ToString("C0")
                    </td>
                    <td class="text-end col-account-activity" style="font-size:0.78rem; background-color: rgba(37, 99, 235, 0.08); font-weight:600; text-align: right; font-variant-numeric: tabular-nums;">
                        @row.TraditionalWithdrawnForTaxOnTraditional.ToString("C0")
                    </td>
                    <td class="text-end col-account-activity" style="font-size:0.78rem; background-color: rgba(37, 99, 235, 0.08); font-weight:600; text-align: right; font-variant-numeric: tabular-nums;">
                        @row.RothWithdrawnForTaxOnTraditional.ToString("C0")
                    </td>

                </tr>
            }
        </tbody>
    </table>
</div>
